<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>flask 报错BuildError</title>
    <link href="/2022/11/25/flask%E6%8A%A5werkzeug.routing.exceptions.BuildError%E9%94%99%E8%AF%AF/"/>
    <url>/2022/11/25/flask%E6%8A%A5werkzeug.routing.exceptions.BuildError%E9%94%99%E8%AF%AF/</url>
    
    <content type="html"><![CDATA[<p>flask返回模板文件时，抛出下列这个错误：</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">BuildErrorwerkzeug.routing.exceptions.BuildError: Could not build url for endpoint &#39; welcome &#39;. Did you mean &#39;welcome&#39; instead?</code></pre></div></figure><p>traceback显示：</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">return render_template(&#39;main.html&#39;,username&#x3D;current_user.username)</code></pre></div></figure><p>网上搜了很多方法都不能解决，最后发现是main.html模板文件内的src写法有问题。<code>src=&#39;&#123;&#123; url_for('welcome')&#125;&#125;&#39; </code>如果是两层单引号，保存文件时，eslint插件会自动在welcome前后添加空格，导致错误。</p><figure><div class="code-wrapper"><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>right<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>el-main<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&#123;&#123; url_for(<span class="token punctuation">'</span></span><span class="token attr-name">welcome')&#125;&#125;'</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre></div></figure><p>外面改成双引号<code>src=&quot;&#123;&#123; url_for('welcome')&#125;&#125;&quot; </code>即可解决。ESLINT插件就不会自动添加空格。</p><figure><div class="code-wrapper"><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>right<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>el-main<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; url_for('welcome')&#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>开发</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSL/TLS协议运行机制的概述-阮一峰</title>
    <link href="/2022/11/23/TLS%E5%8D%8F%E8%AE%AE%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E7%9A%84%E6%A6%82%E8%BF%B0/"/>
    <url>/2022/11/23/TLS%E5%8D%8F%E8%AE%AE%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E7%9A%84%E6%A6%82%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原文链接：<a href="https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html</a></p></blockquote><p>互联网的通信安全，建立在SSL&#x2F;TLS协议之上。</p><p>本文简要介绍SSL&#x2F;TLS协议的运行机制。文章的重点是设计思想和运行过程，不涉及具体的实现细节。如果想了解这方面的内容，请参阅<a href="https://tools.ietf.org/html/rfc5246">RFC文档</a>。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201402/bg2014020501.jpg"></p><p><strong>一、作用</strong></p><p>不使用SSL&#x2F;TLS的HTTP通信，就是不加密的通信。所有信息明文传播，带来了三大风险。</p><blockquote><p>（1） <strong>窃听风险</strong>（eavesdropping）：第三方可以获知通信内容。</p><p>（2） <strong>篡改风险</strong>（tampering）：第三方可以修改通信内容。</p><p>（3） <strong>冒充风险</strong>（pretending）：第三方可以冒充他人身份参与通信。</p></blockquote><p>SSL&#x2F;TLS协议是为了解决这三大风险而设计的，希望达到：</p><blockquote><p>（1） 所有信息都是<strong>加密传播</strong>，第三方无法窃听。</p><p>（2） 具有<strong>校验机制</strong>，一旦被篡改，通信双方会立刻发现。</p><p>（3） 配备<strong>身份证书</strong>，防止身份被冒充。</p></blockquote><p>互联网是开放环境，通信双方都是未知身份，这为协议的设计带来了很大的难度。而且，协议还必须能够经受所有匪夷所思的攻击，这使得SSL&#x2F;TLS协议变得异常复杂。</p><p><strong>二、历史</strong></p><p>互联网加密通信协议的历史，几乎与互联网一样长。</p><blockquote><p>1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但是未发布。</p><p>1995年，NetScape公司发布SSL 2.0版，很快发现有严重漏洞。</p><p>1996年，SSL 3.0版问世，得到大规模应用。</p><p>1999年，互联网标准化组织ISOC接替NetScape公司，发布了SSL的升级版<a href="https://en.wikipedia.org/wiki/Secure_Sockets_Layer">TLS</a> 1.0版。</p><p>2006年和2008年，TLS进行了两次升级，分别为TLS 1.1版和TLS 1.2版。最新的变动是2011年TLS 1.2的<a href="https://tools.ietf.org/html/rfc6176">修订版</a>。</p></blockquote><p>目前，应用最广泛的是TLS 1.0，接下来是SSL 3.0。但是，主流浏览器都已经实现了TLS 1.2的支持。</p><p>TLS 1.0通常被标示为SSL 3.1，TLS 1.1为SSL 3.2，TLS 1.2为SSL 3.3。</p><p><strong>三、基本的运行过程</strong></p><p>SSL&#x2F;TLS协议的基本思路是采用<a href="https://en.wikipedia.org/wiki/Public-key_cryptography">公钥加密法</a>，也就是说，客户端先向服务器端索要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。</p><p>但是，这里有两个问题。</p><p><strong>（1）如何保证公钥不被篡改？</strong></p><blockquote><p>解决方法：将公钥放在<a href="https://en.wikipedia.org/wiki/Digital_certificate">数字证书</a>中。只要证书是可信的，公钥就是可信的。</p></blockquote><p><strong>（2）公钥加密计算量太大，如何减少耗用的时间？</strong></p><blockquote><p>解决方法：每一次对话（session），客户端和服务器端都生成一个”对话密钥”（session key），用它来加密信息。由于”对话密钥”是对称加密，所以运算速度非常快，而服务器公钥只用于加密”对话密钥”本身，这样就减少了加密运算的消耗时间。</p></blockquote><p>因此，SSL&#x2F;TLS协议的基本过程是这样的：</p><blockquote><p>（1） 客户端向服务器端索要并验证公钥。</p><p>（2） 双方协商生成”对话密钥”。</p><p>（3） 双方采用”对话密钥”进行加密通信。</p></blockquote><p>上面过程的前两步，又称为”握手阶段”（handshake）。</p><p><strong>四、握手阶段的详细过程</strong></p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201402/bg2014020502.png"></p><p>“握手阶段”涉及四次通信，我们一个个来看。需要注意的是，”握手阶段”的所有通信都是明文的。</p><p><strong>4.1 客户端发出请求（ClientHello）</strong></p><p>首先，客户端（通常是浏览器）先向服务器发出加密通信的请求，这被叫做ClientHello请求。</p><p>在这一步，客户端主要向服务器提供以下信息。</p><blockquote><p>（1） 支持的协议版本，比如TLS 1.0版。</p><p>（2） 一个客户端生成的随机数，稍后用于生成”对话密钥”。</p><p>（3） 支持的加密方法，比如RSA公钥加密。</p><p>（4） 支持的压缩方法。</p></blockquote><p>这里需要注意的是，客户端发送的信息之中不包括服务器的域名。也就是说，理论上服务器只能包含一个网站，否则会分不清应该向客户端提供哪一个网站的数字证书。这就是为什么通常一台服务器只能有一张数字证书的原因。</p><p>对于虚拟主机的用户来说，这当然很不方便。2006年，TLS协议加入了一个<a href="https://tools.ietf.org/html/rfc4366">Server Name Indication扩展</a>，允许客户端向服务器提供它所请求的域名。</p><p><strong>4.2 服务器回应（SeverHello）</strong></p><p>服务器收到客户端请求后，向客户端发出回应，这叫做SeverHello。服务器的回应包含以下内容。</p><blockquote><p>（1） 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。</p><p>（2） 一个服务器生成的随机数，稍后用于生成”对话密钥”。</p><p>（3） 确认使用的加密方法，比如RSA公钥加密。</p><p>（4） 服务器证书。</p></blockquote><p>除了上面这些信息，如果服务器需要确认客户端的身份，就会再包含一项请求，要求客户端提供”客户端证书”。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供USB密钥，里面就包含了一张客户端证书。</p><p><strong>4.3 客户端回应</strong></p><p>客户端收到服务器回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。</p><p>如果证书没有问题，客户端就会从证书中取出服务器的公钥。然后，向服务器发送下面三项信息。</p><blockquote><p>（1） 一个随机数。该随机数用服务器公钥加密，防止被窃听。</p><p>（2） 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。</p><p>（3） 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。</p></blockquote><p>上面第一项的随机数，是整个握手阶段出现的第三个随机数，又称”pre-master key”。有了它以后，客户端和服务器就同时有了三个随机数，接着双方就用事先商定的加密方法，各自生成本次会话所用的同一把”会话密钥”。</p><p>至于为什么一定要用三个随机数，来生成”会话密钥”，<a href="http://blog.csdn.net/dog250/article/details/5717162">dog250</a>解释得很好：</p><blockquote><p>“不管是客户端还是服务器，都需要随机数，这样生成的密钥才不会每次都一样。由于SSL协议中证书是静态的，因此十分有必要引入一种随机因素来保证协商出来的密钥的随机性。</p><p>对于RSA密钥交换算法来说，pre-master-key本身就是一个随机数，再加上hello消息中的随机，三个随机数通过一个密钥导出器最终导出一个对称密钥。</p><p>pre master的存在在于SSL协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么pre master secret就有可能被猜出来，那么仅适用pre master secret作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上pre master secret三个随机数一同生成的密钥就不容易被猜出了，一个伪随机可能完全不随机，可是是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。”</p></blockquote><p>此外，如果前一步，服务器要求客户端证书，客户端会在这一步发送证书及相关信息。</p><p><strong>4.4 服务器的最后回应</strong></p><p>服务器收到客户端的第三个随机数pre-master key之后，计算生成本次会话所用的”会话密钥”。然后，向客户端最后发送下面信息。</p><blockquote><p>（1）编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。</p><p>（2）服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。</p></blockquote><p>至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，就完全是使用普通的HTTP协议，只不过用”会话密钥”加密内容。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201402/bg2014020503.gif"></p><p><strong>五、参考链接</strong></p><ul><li>MicroSoft TechNet, <a href="https://technet.microsoft.com/en-us/library/cc785811(v=ws.10).aspx">SSL&#x2F;TLS in Detail</a></li><li>Jeff Moser, <a href="http://www.moserware.com/2009/06/first-few-milliseconds-of-https.html">The First Few Milliseconds of an HTTPS Connection</a></li><li>Wikipedia, <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a></li><li>StackExchange, <a href="https://security.stackexchange.com/questions/20803/how-does-ssl-work">How does SSL work?</a></li></ul><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MVC，MVP 和 MVVM 的图示-阮一峰</title>
    <link href="/2022/11/21/MVC%EF%BC%8CMVP%20%E5%92%8C%20MVVM%20%E7%9A%84%E5%9B%BE%E7%A4%BA-%E9%98%AE%E4%B8%80%E5%B3%B0/"/>
    <url>/2022/11/21/MVC%EF%BC%8CMVP%20%E5%92%8C%20MVVM%20%E7%9A%84%E5%9B%BE%E7%A4%BA-%E9%98%AE%E4%B8%80%E5%B3%B0/</url>
    
    <content type="html"><![CDATA[<p>复杂的软件必须有清晰合理的架构，否则无法开发和维护。</p><p><a href="https://zh.wikipedia.org/wiki/MVC">MVC</a>（Model-View-Controller）是最常见的软件架构之一，业界有着广泛应用。它本身<a href="https://www.ruanyifeng.com/blog/2007/11/mvc.html">很容易理解</a>，但是要讲清楚，它与衍生的 MVP 和 MVVM 架构的区别就不容易了。</p><p>昨天晚上，我读了<a href="http://blog.nodejitsu.com/scaling-isomorphic-javascript-code/">《Scaling Isomorphic Javascript Code》</a>，突然意识到，它们的区别非常简单。我用几段话，就可以说清。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020102.jpg"></p><p>（题图：摄于瓦伦西亚，西班牙，2014年8月）</p><h2 id="一、MVC"><a href="#一、MVC" class="headerlink" title="一、MVC"></a>一、MVC</h2><p>MVC模式的意思是，软件可以分成三个部分。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020104.png"></p><blockquote><ul><li>视图（View）：用户界面。</li><li>控制器（Controller）：业务逻辑</li><li>模型（Model）：数据保存</li></ul></blockquote><p>各部分之间的通信方式如下。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020105.png"></p><blockquote><ol><li>View 传送指令到 Controller</li><li>Controller 完成业务逻辑后，要求 Model 改变状态</li><li>Model 将新的数据发送到 View，用户得到反馈</li></ol></blockquote><p>所有通信都是单向的。</p><h2 id="二、互动模式"><a href="#二、互动模式" class="headerlink" title="二、互动模式"></a>二、互动模式</h2><p>接受用户指令时，MVC 可以分成两种方式。一种是通过 View 接受指令，传递给 Controller。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020106.png"></p><p>另一种是直接通过controller接受指令。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020107.png"></p><h2 id="三、实例：Backbone"><a href="#三、实例：Backbone" class="headerlink" title="三、实例：Backbone"></a>三、实例：Backbone</h2><p>实际项目往往采用更灵活的方式，以 <a href="https://documentcloud.github.com/backbone">Backbone.js</a> 为例。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020108.png"></p><p>1. 用户可以向 View 发送指令（DOM 事件），再由 View 直接要求 Model 改变状态。</p><p>2. 用户也可以直接向 Controller 发送指令（改变 URL 触发 hashChange 事件），再由 Controller 发送给 View。</p><p>3. Controller 非常薄，只起到路由的作用，而 View 非常厚，业务逻辑都部署在 View。所以，Backbone 索性取消了 Controller，只保留一个 Router（路由器） 。</p><h2 id="四、MVP"><a href="#四、MVP" class="headerlink" title="四、MVP"></a>四、MVP</h2><p>MVP 模式将 Controller 改名为 Presenter，同时改变了通信方向。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020109.png"></p><p>1. 各部分之间的通信，都是双向的。</p><p>2. View 与 Model 不发生联系，都通过 Presenter 传递。</p><p>3. View 非常薄，不部署任何业务逻辑，称为”被动视图”（Passive View），即没有任何主动性，而 Presenter非常厚，所有逻辑都部署在那里。</p><h2 id="五、MVVM"><a href="#五、MVVM" class="headerlink" title="五、MVVM"></a>五、MVVM</h2><p>MVVM 模式将 Presenter 改名为 ViewModel，基本上与 MVP 模式完全一致。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015020110.png"></p><p>唯一的区别是，它采用双向绑定（data-binding）：View的变动，自动反映在 ViewModel，反之亦然。<a href="https://angularjs.org/">Angular</a> 和 <a href="http://emberjs.com/">Ember</a> 都采用这种模式。</p><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>开发</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTTP/2 协议入门-阮一峰</title>
    <link href="/2022/11/21/HTTPS%20%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97-%E9%98%AE%E4%B8%80%E5%B3%B0/"/>
    <url>/2022/11/21/HTTPS%20%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97-%E9%98%AE%E4%B8%80%E5%B3%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原文链接：<a href="https://www.ruanyifeng.com/blog/2016/08/migrate-from-http-to-https.html">https://www.ruanyifeng.com/blog/2016/08/migrate-from-http-to-https.html</a></p></blockquote><p>上一篇文章我介绍了 <a href="https://www.ruanyifeng.com/blog/2016/08/http.html">HTTP&#x2F;2 协议</a> ，它只有在 HTTPS 环境才会生效。</p><p>为了升级到 HTTP&#x2F;2 协议，必须先启用 HTTPS。如果你不了解 HTTPS 协议（学名 TLS 协议），可以参考我以前的文章。</p><blockquote><ul><li><a href="https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">《HTTPS 协议概述》</a></li><li><a href="https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html">《图解 HTTPS 协议》</a></li><li><a href="https://www.ruanyifeng.com/blog/2011/02/seven_myths_about_https.html">《HTTPS 协议的七个误解》</a></li><li><a href="https://www.ruanyifeng.com/blog/2014/09/ssl-latency.html">《HTTPS 协议的延迟有多大？》</a></li></ul></blockquote><p>本文介绍如何将一个 HTTP 网站升级到 HTTPS 。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016082601.png"></p><h2 id="一、获取证书"><a href="#一、获取证书" class="headerlink" title="一、获取证书"></a>一、获取证书</h2><p>升级到 HTTPS 协议的第一步，就是要获得一张证书。</p><p>证书是一个二进制文件，里面包含经过认证的网站公钥和一些元数据，要从经销商购买。</p><blockquote><ul><li><a href="https://www.gogetssl.com/">GoGetSSL</a></li><li><a href="https://www.ssls.com/">SSLs.com</a></li><li><a href="https://sslmate.com/">SSLmate.com</a></li></ul></blockquote><p>证书有很多类型，首先分为三种认证级别。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016082602.png"></p><blockquote><ul><li><strong>域名认证</strong>（Domain Validation）：最低级别认证，可以确认申请人拥有这个域名。对于这种证书，浏览器会在地址栏显示一把锁。</li><li><strong>公司认证</strong>（Company Validation）：确认域名所有人是哪一家公司，证书里面会包含公司信息。</li><li><strong>扩展认证</strong>（Extended Validation）：最高级别的认证，浏览器地址栏会显示公司名。</li></ul></blockquote><p>还分为三种覆盖范围。</p><blockquote><ul><li><strong>单域名证书</strong>：只能用于单一域名，<code>foo.com</code>的证书不能用于<code>www.foo.com</code></li><li><strong>通配符证书</strong>：可以用于某个域名及其所有一级子域名，比如<code>*.foo.com</code>的证书可以用于<code>foo.com</code>，也可以用于<code>www.foo.com</code></li><li><strong>多域名证书</strong>：可以用于多个域名，比如<code>foo.com</code>和<code>bar.com</code></li></ul></blockquote><p>认证级别越高、覆盖范围越广的证书，价格越贵。</p><p>还有一个免费证书的选择。为了推广HTTPS协议，电子前哨基金会EFF成立了 <a href="https://letsencrypt.org/">Let’s Encrypt</a>，提供免费证书（<a href="https://www.digitalocean.com/community/tags/let-s-encrypt?type=tutorials">教程</a>和<a href="https://certbot.eff.org/">工具</a>）。</p><p>拿到证书以后，可以用 <a href="https://tools.keycdn.com/ssl">SSL Certificate Check</a> 检查一下，信息是否正确。</p><h2 id="二、安装证书"><a href="#二、安装证书" class="headerlink" title="二、安装证书"></a>二、安装证书</h2><p>证书可以放在<code>/etc/ssl</code>目录（Linux 系统），然后根据你使用的Web服务器进行配置。</p><blockquote><ul><li><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">证书配置文件生成器</a>，by Mozilla</li><li><a href="https://github.com/SSLMate/tlsconfigguide/tree/master/templates">配置文件模板</a>，by SSLMate</li></ul></blockquote><p>如果使用 Let’s Encrypt 证书，请使用自动安装工具 <a href="https://certbot.eff.org/">Certbot</a>。</p><p>安装成功后，使用 <a href="https://www.ssllabs.com/ssltest/analyze.html">SSL Labs Server Test</a> 检查一下证书是否生效。</p><h2 id="三、修改链接"><a href="#三、修改链接" class="headerlink" title="三、修改链接"></a>三、修改链接</h2><p>下一步，网页加载的 HTTP 资源，要全部改成 HTTPS 链接。因为加密网页内如果有非加密的资源，浏览器是不会加载那些资源的。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&lt;script src&#x3D;&quot;http:&#x2F;&#x2F;foo.com&#x2F;jquery.js&quot;&gt;&lt;&#x2F;script&gt;</code></pre></div></figure></blockquote><p>上面这行加载命令，有两种改法。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&lt;!-- 改法一 --&gt;&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;foo.com&#x2F;jquery.js&quot;&gt;&lt;&#x2F;script&gt;&lt;!-- 改法二 --&gt;&lt;script src&#x3D;&quot;&#x2F;&#x2F;foo.com&#x2F;jquery.js&quot;&gt;&lt;&#x2F;script&gt;</code></pre></div></figure></blockquote><p>其中，改法二会根据当前网页的协议，加载相同协议的外部资源，更灵活一些。</p><p>另外，如果页面头部用到了<code>rel=&quot;canonical&quot;</code>，也要改成HTTPS网址。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&lt;link rel&#x3D;&quot;canonical&quot; href&#x3D;&quot;https:&#x2F;&#x2F;foo.com&#x2F;bar.html&quot; &#x2F;&gt;</code></pre></div></figure></blockquote><h2 id="四、301重定向"><a href="#四、301重定向" class="headerlink" title="四、301重定向"></a>四、301重定向</h2><p>下一步，修改 Web 服务器的配置文件，使用 301 重定向，将 HTTP 协议的访问导向 HTTPS 协议。</p><p><a href="https://serverfault.com/questions/67316/in-nginx-how-can-i-rewrite-all-http-requests-to-https-while-maintaining-sub-dom">Nginx 的写法</a>。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">server &#123;  listen 80;  server_name domain.com www.domain.com;  return 301 https:&#x2F;&#x2F;domain.com$request_uri;&#125;</code></pre></div></figure></blockquote><p><a href="https://httpd.apache.org/docs/2.4/rewrite/remapping.html#canonicalhost">Apache 的写法</a>（<code>.htaccess</code>文件）。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">RewriteEngine OnRewriteCond %&#123;HTTPS&#125; offRewriteRule (.*) https:&#x2F;&#x2F;%&#123;HTTP_HOST&#125;%&#123;REQUEST_URI&#125; [R&#x3D;301,L]</code></pre></div></figure></blockquote><h2 id="五、安全措施"><a href="#五、安全措施" class="headerlink" title="五、安全措施"></a>五、安全措施</h2><p>以下措施可以进一步保证通信安全。</p><h3 id="5-1-HTTP-Strict-Transport-Security-HSTS"><a href="#5-1-HTTP-Strict-Transport-Security-HSTS" class="headerlink" title="5.1 HTTP Strict Transport Security (HSTS)"></a>5.1 HTTP Strict Transport Security (HSTS)</h3><p>访问网站时，用户很少直接在地址栏输入<code>https://</code>，总是通过点击链接，或者3xx重定向，从<code>HTTP</code>页面进入<code>HTTPS</code>页面。攻击者完全可以在用户发出<code>HTTP</code>请求时，劫持并篡改该请求。</p><p>另一种情况是恶意网站使用自签名证书，冒充另一个网站，这时浏览器会给出警告，但是许多用户会忽略警告继续访问。</p><p>“HTTP严格传输安全”（简称 HSTS）的作用，就是强制浏览器只能发出<code>HTTPS</code>请求，并阻止用户接受不安全的证书。</p><p>它在网站的响应头里面，加入一个强制性声明。以下例子摘自<a href="https://zh.wikipedia.org/wiki/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8">维基百科</a>。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Strict-Transport-Security: max-age&#x3D;31536000; includeSubDomains</code></pre></div></figure></blockquote><p>上面这段头信息有两个作用。</p><blockquote><p>（1）在接下来的一年（即31536000秒）中，浏览器只要向<code>example.com</code>或其子域名发送HTTP请求时，必须采用HTTPS来发起连接。用户点击超链接或在地址栏输入<code>http://www.example.com/</code>，浏览器应当自动将<code>http</code>转写成<code>https</code>，然后直接向<code>https://www.example.com/</code>发送请求。</p><p>（2）在接下来的一年中，如果<code>example.com</code>服务器发送的证书无效，用户不能忽略浏览器警告，将无法继续访问该网站。</p></blockquote><p>HSTS 很大程度上解决了 SSL 剥离攻击。只要浏览器曾经与服务器建立过一次安全连接，之后浏览器会强制使用<code>HTTPS</code>，即使链接被换成了<code>HTTP</code>。</p><p>该方法的主要不足是，用户首次访问网站发出HTTP请求时，是不受HSTS保护的。</p><p>如果想要全面分析网站的安全程度，可以使用 Mozilla 的 <a href="https://observatory.mozilla.org/">Observatory</a>。</p><h3 id="5-2-Cookie"><a href="#5-2-Cookie" class="headerlink" title="5.2 Cookie"></a>5.2 Cookie</h3><p>另一个需要注意的地方是，确保浏览器只在使用 HTTPS 时，才发送Cookie。</p><p>网站响应头里面，<code>Set-Cookie</code>字段加上<code>Secure</code>标志即可。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Set-Cookie: LSID&#x3D;DQAAAK...Eaem_vYg; Secure</code></pre></div></figure></blockquote><h2 id="六、参考链接"><a href="#六、参考链接" class="headerlink" title="六、参考链接"></a>六、参考链接</h2><ul><li><a href="https://docs.google.com/document/d/1oRXJUIttqQxuxmjj2tgYjj096IKw4Zcw6eAoIKWZ2oQ/edit#">How To Migrate To HTTPS</a>, by Chris Palmer</li><li><a href="https://www.keycdn.com/blog/http-to-https/">Complete Guide - How to Migrate from HTTP to HTTPS</a>, by KeyCDN</li><li><a href="http://smallbiztrends.com/2015/04/changing-from-http-to-https.html">What You Need to Know About Changing From Http to Https</a>, by Matt Mansfield</li></ul><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTTP 协议入门-阮一峰</title>
    <link href="/2022/11/21/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8-%E9%98%AE%E4%B8%80%E5%B3%B0/"/>
    <url>/2022/11/21/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8-%E9%98%AE%E4%B8%80%E5%B3%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原文链接：<a href="https://www.ruanyifeng.com/blog/2016/08/http.html">https://www.ruanyifeng.com/blog/2016/08/http.html</a></p></blockquote><p>HTTP 协议是互联网的基础协议，也是网页开发的必备知识，最新版本 HTTP&#x2F;2 更是让它成为技术热点。</p><p>本文介绍 HTTP 协议的历史演变和设计思路。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016081901.jpg"></p><h2 id="一、HTTP-x2F-0-9"><a href="#一、HTTP-x2F-0-9" class="headerlink" title="一、HTTP&#x2F;0.9"></a>一、HTTP&#x2F;0.9</h2><p>HTTP 是基于 TCP&#x2F;IP 协议的<a href="https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html"><strong>应用层协议</strong></a>。它不涉及数据包（packet）传输，主要规定了客户端和服务器之间的通信格式，默认使用80端口。</p><p>最早版本是1991年发布的0.9版。该版本极其简单，只有一个命令<code>GET</code>。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">GET &#x2F;index.html</code></pre></div></figure></blockquote><p>上面命令表示，TCP 连接（connection）建立后，客户端向服务器请求（request）网页<code>index.html</code>。</p><p>协议规定，服务器只能回应HTML格式的字符串，不能回应别的格式。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&lt;html&gt;  &lt;body&gt;Hello World&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</code></pre></div></figure></blockquote><p>服务器发送完毕，就关闭TCP连接。</p><h2 id="二、HTTP-x2F-1-0"><a href="#二、HTTP-x2F-1-0" class="headerlink" title="二、HTTP&#x2F;1.0"></a>二、HTTP&#x2F;1.0</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>1996年5月，HTTP&#x2F;1.0 版本发布，内容大大增加。</p><p>首先，任何格式的内容都可以发送。这使得互联网不仅可以传输文字，还能传输图像、视频、二进制文件。这为互联网的大发展奠定了基础。</p><p>其次，除了<code>GET</code>命令，还引入了<code>POST</code>命令和<code>HEAD</code>命令，丰富了浏览器与服务器的互动手段。</p><p>再次，HTTP请求和回应的格式也变了。除了数据部分，每次通信都必须包括头信息（HTTP header），用来描述一些元数据。</p><p>其他的新增功能还包括状态码（status code）、多字符集支持、多部分发送（multi-part type）、权限（authorization）、缓存（cache）、内容编码（content encoding）等。</p><h3 id="2-2-请求格式"><a href="#2-2-请求格式" class="headerlink" title="2.2 请求格式"></a>2.2 请求格式</h3><p>下面是一个1.0版的HTTP请求的例子。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">GET &#x2F; HTTP&#x2F;1.0User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_10_5)Accept: *&#x2F;*</code></pre></div></figure></blockquote><p>可以看到，这个格式与0.9版有很大变化。</p><p>第一行是请求命令，必须在尾部添加协议版本（<code>HTTP/1.0</code>）。后面就是多行头信息，描述客户端的情况。</p><h3 id="2-3-回应格式"><a href="#2-3-回应格式" class="headerlink" title="2.3 回应格式"></a>2.3 回应格式</h3><p>服务器的回应如下。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">HTTP&#x2F;1.0 200 OK Content-Type: text&#x2F;plainContent-Length: 137582Expires: Thu, 05 Dec 1997 16:00:00 GMTLast-Modified: Wed, 5 August 1996 15:55:28 GMTServer: Apache 0.84&lt;html&gt;  &lt;body&gt;Hello World&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</code></pre></div></figure></blockquote><p>回应的格式是”头信息 + 一个空行（<code>\r\n</code>） + 数据”。其中，第一行是”协议版本 + 状态码（status code） + 状态描述”。</p><h3 id="2-4-Content-Type-字段"><a href="#2-4-Content-Type-字段" class="headerlink" title="2.4 Content-Type 字段"></a>2.4 Content-Type 字段</h3><p>关于字符的编码，1.0版规定，头信息必须是 ASCII 码，后面的数据可以是任何格式。因此，服务器回应的时候，必须告诉客户端，数据是什么格式，这就是<code>Content-Type</code>字段的作用。</p><p>下面是一些常见的<code>Content-Type</code>字段的值。</p><blockquote><ul><li>text&#x2F;plain</li><li>text&#x2F;html</li><li>text&#x2F;css</li><li>image&#x2F;jpeg</li><li>image&#x2F;png</li><li>image&#x2F;svg+xml</li><li>audio&#x2F;mp4</li><li>video&#x2F;mp4</li><li>application&#x2F;javascript</li><li>application&#x2F;pdf</li><li>application&#x2F;zip</li><li>application&#x2F;atom+xml</li></ul></blockquote><p>这些数据类型总称为<code>MIME type</code>，每个值包括一级类型和二级类型，之间用斜杠分隔。</p><p>除了预定义的类型，厂商也可以自定义类型。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">application&#x2F;vnd.debian.binary-package</code></pre></div></figure></blockquote><p>上面的类型表明，发送的是Debian系统的二进制数据包。</p><p><code>MIME type</code>还可以在尾部使用分号，添加参数。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Content-Type: text&#x2F;html; charset&#x3D;utf-8</code></pre></div></figure></blockquote><p>上面的类型表明，发送的是网页，而且编码是UTF-8。</p><p>客户端请求的时候，可以使用<code>Accept</code>字段声明自己可以接受哪些数据格式。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Accept: *&#x2F;*</code></pre></div></figure></blockquote><p>上面代码中，客户端声明自己可以接受任何格式的数据。</p><p><code>MIME type</code>不仅用在HTTP协议，还可以用在其他地方，比如HTML网页。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;UTF-8&quot; &#x2F;&gt;&lt;!-- 等同于 --&gt;&lt;meta charset&#x3D;&quot;utf-8&quot; &#x2F;&gt; </code></pre></div></figure></blockquote><h3 id="2-5-Content-Encoding-字段"><a href="#2-5-Content-Encoding-字段" class="headerlink" title="2.5 Content-Encoding 字段"></a>2.5 Content-Encoding 字段</h3><p>由于发送的数据可以是任何格式，因此可以把数据压缩后再发送。<code>Content-Encoding</code>字段说明数据的压缩方法。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Content-Encoding: gzipContent-Encoding: compressContent-Encoding: deflate</code></pre></div></figure></blockquote><p>客户端在请求时，用<code>Accept-Encoding</code>字段说明自己可以接受哪些压缩方法。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Accept-Encoding: gzip, deflate</code></pre></div></figure></blockquote><h3 id="2-6-缺点"><a href="#2-6-缺点" class="headerlink" title="2.6 缺点"></a>2.6 缺点</h3><p>HTTP&#x2F;1.0 版的主要缺点是，每个TCP连接只能发送一个请求。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。</p><p>TCP连接的新建成本很高，因为需要客户端和服务器三次握手，并且开始时发送速率较慢（slow start）。所以，HTTP 1.0版本的性能比较差。随着网页加载的外部资源越来越多，这个问题就愈发突出了。</p><p>为了解决这个问题，有些浏览器在请求时，用了一个非标准的<code>Connection</code>字段。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Connection: keep-alive</code></pre></div></figure></blockquote><p>这个字段要求服务器不要关闭TCP连接，以便其他请求复用。服务器同样回应这个字段。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Connection: keep-alive</code></pre></div></figure></blockquote><p>一个可以复用的TCP连接就建立了，直到客户端或服务器主动关闭连接。但是，这不是标准字段，不同实现的行为可能不一致，因此不是根本的解决办法。</p><h2 id="三、HTTP-x2F-1-1"><a href="#三、HTTP-x2F-1-1" class="headerlink" title="三、HTTP&#x2F;1.1"></a>三、HTTP&#x2F;1.1</h2><p>1997年1月，HTTP&#x2F;1.1 版本发布，只比 1.0 版本晚了半年。它进一步完善了 HTTP 协议，一直用到了20年后的今天，直到现在还是最流行的版本。</p><h3 id="3-1-持久连接"><a href="#3-1-持久连接" class="headerlink" title="3.1 持久连接"></a>3.1 持久连接</h3><p>1.1 版的最大变化，就是引入了持久连接（persistent connection），即TCP连接默认不关闭，可以被多个请求复用，不用声明<code>Connection: keep-alive</code>。</p><p>客户端和服务器发现对方一段时间没有活动，就可以主动关闭连接。不过，规范的做法是，客户端在最后一个请求时，发送<code>Connection: close</code>，明确要求服务器关闭TCP连接。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Connection: close</code></pre></div></figure></blockquote><p>目前，对于同一个域名，大多数浏览器允许同时建立6个持久连接。</p><h3 id="3-2-管道机制"><a href="#3-2-管道机制" class="headerlink" title="3.2 管道机制"></a>3.2 管道机制</h3><p>1.1 版还引入了管道机制（pipelining），即在同一个TCP连接里面，客户端可以同时发送多个请求。这样就进一步改进了HTTP协议的效率。</p><p>举例来说，客户端需要请求两个资源。以前的做法是，在同一个TCP连接里面，先发送A请求，然后等待服务器做出回应，收到后再发出B请求。管道机制则是允许浏览器同时发出A请求和B请求，但是服务器还是按照顺序，先回应A请求，完成后再回应B请求。</p><h3 id="3-3-Content-Length-字段"><a href="#3-3-Content-Length-字段" class="headerlink" title="3.3 Content-Length 字段"></a>3.3 Content-Length 字段</h3><p>一个TCP连接现在可以传送多个回应，势必就要有一种机制，区分数据包是属于哪一个回应的。这就是<code>Content-length</code>字段的作用，声明本次回应的数据长度。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Content-Length: 3495</code></pre></div></figure></blockquote><p>上面代码告诉浏览器，本次回应的长度是3495个字节，后面的字节就属于下一个回应了。</p><p>在1.0版中，<code>Content-Length</code>字段不是必需的，因为浏览器发现服务器关闭了TCP连接，就表明收到的数据包已经全了。</p><h3 id="3-4-分块传输编码"><a href="#3-4-分块传输编码" class="headerlink" title="3.4 分块传输编码"></a>3.4 分块传输编码</h3><p>使用<code>Content-Length</code>字段的前提条件是，服务器发送回应之前，必须知道回应的数据长度。</p><p>对于一些很耗时的动态操作来说，这意味着，服务器要等到所有操作完成，才能发送数据，显然这样的效率不高。更好的处理方法是，产生一块数据，就发送一块，采用”流模式”（stream）取代”缓存模式”（buffer）。</p><p>因此，1.1版规定可以不使用<code>Content-Length</code>字段，而使用<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81">“分块传输编码”</a>（chunked transfer encoding）。只要请求或回应的头信息有<code>Transfer-Encoding</code>字段，就表明回应将由数量未定的数据块组成。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Transfer-Encoding: chunked</code></pre></div></figure></blockquote><p>每个非空的数据块之前，会有一个16进制的数值，表示这个块的长度。最后是一个大小为0的块，就表示本次回应的数据发送完了。下面是一个例子。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">HTTP&#x2F;1.1 200 OKContent-Type: text&#x2F;plainTransfer-Encoding: chunked25This is the data in the first chunk1Cand this is the second one3con8sequence0</code></pre></div></figure></blockquote><h3 id="3-5-其他功能"><a href="#3-5-其他功能" class="headerlink" title="3.5 其他功能"></a>3.5 其他功能</h3><p>1.1版还新增了许多动词方法：<code>PUT</code>、<code>PATCH</code>、<code>HEAD</code>、 <code>OPTIONS</code>、<code>DELETE</code>。</p><p>另外，客户端请求的头信息新增了<code>Host</code>字段，用来指定服务器的域名。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">Host: www.example.com</code></pre></div></figure></blockquote><p>有了<code>Host</code>字段，就可以将请求发往同一台服务器上的不同网站，为虚拟主机的兴起打下了基础。</p><h3 id="3-6-缺点"><a href="#3-6-缺点" class="headerlink" title="3.6 缺点"></a>3.6 缺点</h3><p>虽然1.1版允许复用TCP连接，但是同一个TCP连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。要是前面的回应特别慢，后面就会有许多请求排队等着。这称为<a href="https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E">“队头堵塞”</a>（Head-of-line blocking）。</p><p>为了避免这个问题，只有两种方法：一是减少请求数，二是同时多开持久连接。这导致了很多的网页优化技巧，比如合并脚本和样式表、将图片嵌入CSS代码、域名分片（domain sharding）等等。如果HTTP协议设计得更好一些，这些额外的工作是可以避免的。</p><h2 id="四、SPDY-协议"><a href="#四、SPDY-协议" class="headerlink" title="四、SPDY 协议"></a>四、SPDY 协议</h2><p>2009年，谷歌公开了自行研发的 SPDY 协议，主要解决 HTTP&#x2F;1.1 效率不高的问题。</p><p>这个协议在Chrome浏览器上证明可行以后，就被当作 HTTP&#x2F;2 的基础，主要特性都在 HTTP&#x2F;2 之中得到继承。</p><h2 id="五、HTTP-x2F-2"><a href="#五、HTTP-x2F-2" class="headerlink" title="五、HTTP&#x2F;2"></a>五、HTTP&#x2F;2</h2><p>2015年，HTTP&#x2F;2 发布。它不叫 HTTP&#x2F;2.0，是因为标准委员会不打算再发布子版本了，下一个新版本将是 HTTP&#x2F;3。</p><h3 id="5-1-二进制协议"><a href="#5-1-二进制协议" class="headerlink" title="5.1 二进制协议"></a>5.1 二进制协议</h3><p>HTTP&#x2F;1.1 版的头信息肯定是文本（ASCII编码），数据体可以是文本，也可以是二进制。HTTP&#x2F;2 则是一个彻底的二进制协议，头信息和数据体都是二进制，并且统称为”帧”（frame）：头信息帧和数据帧。</p><p>二进制协议的一个好处是，可以定义额外的帧。HTTP&#x2F;2 定义了近十种帧，为将来的高级应用打好了基础。如果使用文本实现这种功能，解析数据将会变得非常麻烦，二进制解析则方便得多。</p><h3 id="5-2-多工"><a href="#5-2-多工" class="headerlink" title="5.2 多工"></a>5.2 多工</h3><p>HTTP&#x2F;2 复用TCP连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了”队头堵塞”。</p><p>举例来说，在一个TCP连接里面，服务器同时收到了A请求和B请求，于是先回应A请求，结果发现处理过程非常耗时，于是就发送A请求已经处理好的部分， 接着回应B请求，完成后，再发送A请求剩下的部分。</p><p>这样双向的、实时的通信，就叫做多工（Multiplexing）。</p><h3 id="5-3-数据流"><a href="#5-3-数据流" class="headerlink" title="5.3 数据流"></a>5.3 数据流</h3><p>因为 HTTP&#x2F;2 的数据包是不按顺序发送的，同一个连接里面连续的数据包，可能属于不同的回应。因此，必须要对数据包做标记，指出它属于哪个回应。</p><p>HTTP&#x2F;2 将每个请求或回应的所有数据包，称为一个数据流（stream）。每个数据流都有一个独一无二的编号。数据包发送的时候，都必须标记数据流ID，用来区分它属于哪个数据流。另外还规定，客户端发出的数据流，ID一律为奇数，服务器发出的，ID为偶数。</p><p>数据流发送到一半的时候，客户端和服务器都可以发送信号（<code>RST_STREAM</code>帧），取消这个数据流。1.1版取消数据流的唯一方法，就是关闭TCP连接。这就是说，HTTP&#x2F;2 可以取消某一次请求，同时保证TCP连接还打开着，可以被其他请求使用。</p><p>客户端还可以指定数据流的优先级。优先级越高，服务器就会越早回应。</p><h3 id="5-4-头信息压缩"><a href="#5-4-头信息压缩" class="headerlink" title="5.4 头信息压缩"></a>5.4 头信息压缩</h3><p>HTTP 协议不带有状态，每次请求都必须附上所有信息。所以，请求的很多字段都是重复的，比如<code>Cookie</code>和<code>User Agent</code>，一模一样的内容，每次请求都必须附带，这会浪费很多带宽，也影响速度。</p><p>HTTP&#x2F;2 对这一点做了优化，引入了头信息压缩机制（header compression）。一方面，头信息使用<code>gzip</code>或<code>compress</code>压缩后再发送；另一方面，客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。</p><h3 id="5-5-服务器推送"><a href="#5-5-服务器推送" class="headerlink" title="5.5 服务器推送"></a>5.5 服务器推送</h3><p>HTTP&#x2F;2 允许服务器未经请求，主动向客户端发送资源，这叫做服务器推送（server push）。</p><p>常见场景是客户端请求一个网页，这个网页里面包含很多静态资源。正常情况下，客户端必须收到网页后，解析HTML源码，发现有静态资源，再发出静态资源请求。其实，服务器可以预期到客户端请求网页后，很可能会再请求静态资源，所以就主动把这些静态资源随着网页一起发给客户端了。</p><h3 id="六、参考链接"><a href="#六、参考链接" class="headerlink" title="六、参考链接"></a>六、参考链接</h3><ul><li><a href="http://kamranahmed.info/blog/2016/08/13/http-in-depth/">Journey to HTTP&#x2F;2</a>, by Kamran Ahmed</li><li><a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a>, by Wikipedia</li><li><a href="https://tools.ietf.org/html/rfc1945">HTTP&#x2F;1.0 Specification</a></li><li><a href="https://http2.github.io/http2-spec/">HTTP&#x2F;2 Specification</a></li></ul><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WebSocket 教程-阮一峰</title>
    <link href="/2022/11/21/WebSocket%20%E6%95%99%E7%A8%8B-%E9%98%AE%E4%B8%80%E5%B3%B0/"/>
    <url>/2022/11/21/WebSocket%20%E6%95%99%E7%A8%8B-%E9%98%AE%E4%B8%80%E5%B3%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原文链接：<a href="https://www.ruanyifeng.com/blog/2017/05/websocket.html">https://www.ruanyifeng.com/blog/2017/05/websocket.html</a></p></blockquote><p><a href="https://websocket.org/">WebSocket</a> 是一种网络通信协议，很多高级功能都需要它。</p><p>本文介绍 WebSocket 协议的使用方法。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051501.png"></p><h2 id="一、为什么需要-WebSocket？"><a href="#一、为什么需要-WebSocket？" class="headerlink" title="一、为什么需要 WebSocket？"></a>一、为什么需要 WebSocket？</h2><p>初次接触 WebSocket 的人，都会问同样的问题：我们已经有了 HTTP 协议，为什么还需要另一个协议？它能带来什么好处？</p><p>答案很简单，因为 HTTP 协议有一个缺陷：通信只能由客户端发起。</p><p>举例来说，我们想了解今天的天气，只能是客户端向服务器发出请求，服务器返回查询结果。HTTP 协议做不到服务器主动向客户端推送信息。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051507.jpg"></p><p>这种单向请求的特点，注定了如果服务器有连续的状态变化，客户端要获知就非常麻烦。我们只能使用<a href="https://www.pubnub.com/blog/2014-12-01-http-long-polling/">“轮询”</a>：每隔一段时候，就发出一个询问，了解服务器有没有新的信息。最典型的场景就是聊天室。</p><p>轮询的效率低，非常浪费资源（因为必须不停连接，或者 HTTP 连接始终打开）。因此，工程师们一直在思考，有没有更好的方法。WebSocket 就是这样发明的。</p><h2 id="二、简介"><a href="#二、简介" class="headerlink" title="二、简介"></a>二、简介</h2><p>WebSocket 协议在2008年诞生，2011年成为国际标准。所有浏览器都已经支持了。</p><p>它的最大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话，属于<a href="https://en.wikipedia.org/wiki/Push_technology">服务器推送技术</a>的一种。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051502.png"></p><p>其他特点包括：</p><p>（1）建立在 TCP 协议之上，服务器端的实现比较容易。</p><p>（2）与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。</p><p>（3）数据格式比较轻量，性能开销小，通信高效。</p><p>（4）可以发送文本，也可以发送二进制数据。</p><p>（5）没有同源限制，客户端可以与任意服务器通信。</p><p>（6）协议标识符是<code>ws</code>（如果加密，则为<code>wss</code>），服务器网址就是 URL。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ws:&#x2F;&#x2F;example.com:80&#x2F;some&#x2F;path</code></pre></div></figure></blockquote><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051503.jpg"></p><h2 id="三、客户端的简单示例"><a href="#三、客户端的简单示例" class="headerlink" title="三、客户端的简单示例"></a>三、客户端的简单示例</h2><p>WebSocket 的用法相当简单。</p><p>下面是一个网页脚本的例子（点击<a href="http://jsbin.com/muqamiqimu/edit?js,console">这里</a>看运行结果），基本上一眼就能明白。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">var ws &#x3D; new WebSocket(&quot;wss:&#x2F;&#x2F;echo.websocket.org&quot;);ws.onopen &#x3D; function(evt) &#123;   console.log(&quot;Connection open ...&quot;);   ws.send(&quot;Hello WebSockets!&quot;);&#125;;ws.onmessage &#x3D; function(evt) &#123;  console.log( &quot;Received Message: &quot; + evt.data);  ws.close();&#125;;ws.onclose &#x3D; function(evt) &#123;  console.log(&quot;Connection closed.&quot;);&#125;;      </code></pre></div></figure></blockquote><h2 id="四、客户端的-API"><a href="#四、客户端的-API" class="headerlink" title="四、客户端的 API"></a>四、客户端的 API</h2><p>WebSocket 客户端的 API 如下。</p><h3 id="4-1-WebSocket-构造函数"><a href="#4-1-WebSocket-构造函数" class="headerlink" title="4.1 WebSocket 构造函数"></a>4.1 WebSocket 构造函数</h3><p>WebSocket 对象作为一个构造函数，用于新建 WebSocket 实例。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">var ws &#x3D; new WebSocket(&#39;ws:&#x2F;&#x2F;localhost:8080&#39;);</code></pre></div></figure></blockquote><p>执行上面语句之后，客户端就会与服务器进行连接。</p><p>实例对象的所有属性和方法清单，参见<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">这里</a>。</p><h3 id="4-2-webSocket-readyState"><a href="#4-2-webSocket-readyState" class="headerlink" title="4.2 webSocket.readyState"></a>4.2 webSocket.readyState</h3><p><code>readyState</code>属性返回实例对象的当前状态，共有四种。</p><blockquote><ul><li>CONNECTING：值为0，表示正在连接。</li><li>OPEN：值为1，表示连接成功，可以通信了。</li><li>CLOSING：值为2，表示连接正在关闭。</li><li>CLOSED：值为3，表示连接已经关闭，或者打开连接失败。</li></ul></blockquote><p>下面是一个示例。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">switch (ws.readyState) &#123;  case WebSocket.CONNECTING:    &#x2F;&#x2F; do something    break;  case WebSocket.OPEN:    &#x2F;&#x2F; do something    break;  case WebSocket.CLOSING:    &#x2F;&#x2F; do something    break;  case WebSocket.CLOSED:    &#x2F;&#x2F; do something    break;  default:    &#x2F;&#x2F; this never happens    break;&#125;</code></pre></div></figure></blockquote><h3 id="4-3-webSocket-onopen"><a href="#4-3-webSocket-onopen" class="headerlink" title="4.3 webSocket.onopen"></a>4.3 webSocket.onopen</h3><p>实例对象的<code>onopen</code>属性，用于指定连接成功后的回调函数。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ws.onopen &#x3D; function () &#123;  ws.send(&#39;Hello Server!&#39;);&#125;</code></pre></div></figure></blockquote><p>如果要指定多个回调函数，可以使用<code>addEventListener</code>方法。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ws.addEventListener(&#39;open&#39;, function (event) &#123;  ws.send(&#39;Hello Server!&#39;);&#125;);</code></pre></div></figure></blockquote><h3 id="4-4-webSocket-onclose"><a href="#4-4-webSocket-onclose" class="headerlink" title="4.4 webSocket.onclose"></a>4.4 webSocket.onclose</h3><p>实例对象的<code>onclose</code>属性，用于指定连接关闭后的回调函数。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ws.onclose &#x3D; function(event) &#123;  var code &#x3D; event.code;  var reason &#x3D; event.reason;  var wasClean &#x3D; event.wasClean;  &#x2F;&#x2F; handle close event&#125;;ws.addEventListener(&quot;close&quot;, function(event) &#123;  var code &#x3D; event.code;  var reason &#x3D; event.reason;  var wasClean &#x3D; event.wasClean;  &#x2F;&#x2F; handle close event&#125;);</code></pre></div></figure></blockquote><h3 id="4-5-webSocket-onmessage"><a href="#4-5-webSocket-onmessage" class="headerlink" title="4.5 webSocket.onmessage"></a>4.5 webSocket.onmessage</h3><p>实例对象的<code>onmessage</code>属性，用于指定收到服务器数据后的回调函数。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ws.onmessage &#x3D; function(event) &#123;  var data &#x3D; event.data;  &#x2F;&#x2F; 处理数据&#125;;ws.addEventListener(&quot;message&quot;, function(event) &#123;  var data &#x3D; event.data;  &#x2F;&#x2F; 处理数据&#125;);</code></pre></div></figure></blockquote><p>注意，服务器数据可能是文本，也可能是二进制数据（<code>blob</code>对象或<code>Arraybuffer</code>对象）。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ws.onmessage &#x3D; function(event)&#123;  if(typeof event.data &#x3D;&#x3D;&#x3D; String) &#123;    console.log(&quot;Received data string&quot;);  &#125;  if(event.data instanceof ArrayBuffer)&#123;    var buffer &#x3D; event.data;    console.log(&quot;Received arraybuffer&quot;);  &#125;&#125;</code></pre></div></figure></blockquote><p>除了动态判断收到的数据类型，也可以使用<code>binaryType</code>属性，显式指定收到的二进制数据类型。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#x2F;&#x2F; 收到的是 blob 数据ws.binaryType &#x3D; &quot;blob&quot;;ws.onmessage &#x3D; function(e) &#123;  console.log(e.data.size);&#125;;&#x2F;&#x2F; 收到的是 ArrayBuffer 数据ws.binaryType &#x3D; &quot;arraybuffer&quot;;ws.onmessage &#x3D; function(e) &#123;  console.log(e.data.byteLength);&#125;;</code></pre></div></figure></blockquote><h3 id="4-6-webSocket-send"><a href="#4-6-webSocket-send" class="headerlink" title="4.6 webSocket.send()"></a>4.6 webSocket.send()</h3><p>实例对象的<code>send()</code>方法用于向服务器发送数据。</p><p>发送文本的例子。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ws.send(&#39;your message&#39;);</code></pre></div></figure></blockquote><p>发送 Blob 对象的例子。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">var file &#x3D; document  .querySelector(&#39;input[type&#x3D;&quot;file&quot;]&#39;)  .files[0];ws.send(file);</code></pre></div></figure></blockquote><p>发送 ArrayBuffer 对象的例子。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#x2F;&#x2F; Sending canvas ImageData as ArrayBuffervar img &#x3D; canvas_context.getImageData(0, 0, 400, 320);var binary &#x3D; new Uint8Array(img.data.length);for (var i &#x3D; 0; i &lt; img.data.length; i++) &#123;  binary[i] &#x3D; img.data[i];&#125;ws.send(binary.buffer);</code></pre></div></figure></blockquote><h3 id="4-7-webSocket-bufferedAmount"><a href="#4-7-webSocket-bufferedAmount" class="headerlink" title="4.7 webSocket.bufferedAmount"></a>4.7 webSocket.bufferedAmount</h3><p>实例对象的<code>bufferedAmount</code>属性，表示还有多少字节的二进制数据没有发送出去。它可以用来判断发送是否结束。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">var data &#x3D; new ArrayBuffer(10000000);socket.send(data);if (socket.bufferedAmount &#x3D;&#x3D;&#x3D; 0) &#123;  &#x2F;&#x2F; 发送完毕&#125; else &#123;  &#x2F;&#x2F; 发送还没结束&#125;</code></pre></div></figure></blockquote><h3 id="4-8-webSocket-onerror"><a href="#4-8-webSocket-onerror" class="headerlink" title="4.8 webSocket.onerror"></a>4.8 webSocket.onerror</h3><p>实例对象的<code>onerror</code>属性，用于指定报错时的回调函数。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">socket.onerror &#x3D; function(event) &#123;  &#x2F;&#x2F; handle error event&#125;;socket.addEventListener(&quot;error&quot;, function(event) &#123;  &#x2F;&#x2F; handle error event&#125;);</code></pre></div></figure></blockquote><h2 id="五、服务端的实现"><a href="#五、服务端的实现" class="headerlink" title="五、服务端的实现"></a>五、服务端的实现</h2><p>WebSocket 服务器的实现，可以查看维基百科的<a href="https://en.wikipedia.org/wiki/Comparison_of_WebSocket_implementations">列表</a>。</p><p>常用的 Node 实现有以下三种。</p><ul><li><a href="https://github.com/uWebSockets/uWebSockets">µWebSockets</a></li><li><a href="http://socket.io/">Socket.IO</a></li><li><a href="https://github.com/theturtle32/WebSocket-Node">WebSocket-Node</a></li></ul><p>具体的用法请查看它们的文档，这里不详细介绍了。</p><h2 id="六、WebSocketd"><a href="#六、WebSocketd" class="headerlink" title="六、WebSocketd"></a>六、WebSocketd</h2><p>下面，我要推荐一款非常特别的 WebSocket 服务器：<a href="http://websocketd.com/">Websocketd</a>。</p><p>它的最大特点，就是后台脚本不限语言，标准输入（stdin）就是 WebSocket 的输入，标准输出（stdout）就是 WebSocket 的输出。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051504.png"></p><p>举例来说，下面是一个 Bash 脚本<code>counter.sh</code>。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">#!&#x2F;bin&#x2F;bashecho 1sleep 1echo 2sleep 1echo 3</code></pre></div></figure></blockquote><p>命令行下运行这个脚本，会输出1、2、3，每个值之间间隔1秒。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ bash .&#x2F;counter.sh123</code></pre></div></figure></blockquote><p>现在，启动<code>websocketd</code>，指定这个脚本作为服务。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ websocketd --port&#x3D;8080 bash .&#x2F;counter.sh</code></pre></div></figure></blockquote><p>上面的命令会启动一个 WebSocket 服务器，端口是<code>8080</code>。每当客户端连接这个服务器，就会执行<code>counter.sh</code>脚本，并将它的输出推送给客户端。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">var ws &#x3D; new WebSocket(&#39;ws:&#x2F;&#x2F;localhost:8080&#x2F;&#39;);ws.onmessage &#x3D; function(event) &#123;  console.log(event.data);&#125;;</code></pre></div></figure></blockquote><p>上面是客户端的 JavaScript 代码，运行之后会在控制台依次输出1、2、3。</p><p>有了它，就可以很方便地将命令行的输出，发给浏览器。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ websocketd --port&#x3D;8080 ls</code></pre></div></figure></blockquote><p>上面的命令会执行<code>ls</code>命令，从而将当前目录的内容，发给浏览器。使用这种方式实时监控服务器，简直是轻而易举（<a href="https://github.com/joewalnes/web-vmstats">代码</a>）。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051505.jpg"></p><p>更多的用法可以参考<a href="https://github.com/joewalnes/websocketd/tree/master/examples/bash">官方示例</a>。</p><blockquote><ul><li>Bash 脚本<a href="https://github.com/joewalnes/websocketd/blob/master/examples/bash/greeter.sh">读取客户端输入</a>的例子</li><li>五行代码实现一个最简单的<a href="https://github.com/joewalnes/websocketd/blob/master/examples/bash/chat.sh">聊天服务器</a></li></ul></blockquote><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051506.png"></p><p>websocketd 的实质，就是命令行的 WebSocket 代理。只要命令行可以执行的程序，都可以通过它与浏览器进行 WebSocket 通信。下面是一个 Node 实现的回声服务<a href="https://github.com/joewalnes/websocketd/blob/master/examples/nodejs/greeter.js"><code>greeter.js</code></a>。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">process.stdin.setEncoding(&#39;utf8&#39;);process.stdin.on(&#39;readable&#39;, function() &#123;  var chunk &#x3D; process.stdin.read();  if (chunk !&#x3D;&#x3D; null) &#123;    process.stdout.write(&#39;data: &#39; + chunk);  &#125;&#125;);</code></pre></div></figure></blockquote><p>启动这个脚本的命令如下。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ websocketd --port&#x3D;8080 node .&#x2F;greeter.js</code></pre></div></figure></blockquote><p>官方仓库还有其他<a href="https://github.com/joewalnes/websocketd/tree/master/examples">各种语言</a>的例子。</p><h2 id="七、参考链接"><a href="#七、参考链接" class="headerlink" title="七、参考链接"></a>七、参考链接</h2><ul><li><a href="http://cjihrig.com/blog/how-to-use-websockets/">How to Use WebSockets</a></li><li><a href="https://www.tutorialspoint.com/websockets/websockets_send_receive_messages.htm">WebSockets - Send &amp; Receive Messages</a></li><li><a href="https://www.html5rocks.com/en/tutorials/websockets/basics/">Introducing WebSockets: Bringing Sockets to the Web</a></li></ul><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DNS查询原理入门-阮一峰</title>
    <link href="/2022/11/21/DNS%20%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%20-%20%E9%98%AE%E4%B8%80%E5%B3%B0/"/>
    <url>/2022/11/21/DNS%20%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%20-%20%E9%98%AE%E4%B8%80%E5%B3%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原文链接：<a href="https://www.ruanyifeng.com/blog/2022/08/dns-query.html">https://www.ruanyifeng.com/blog/2022/08/dns-query.html</a></p></blockquote><p>通过 DNS 查询，得到域名的 IP 地址，才能访问网站。</p><p>那么，DNS 查询到底是怎么完成的？本文通过实例，详细介绍背后的步骤。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080102.webp"></p><h2 id="一、DNS-服务器"><a href="#一、DNS-服务器" class="headerlink" title="一、DNS 服务器"></a>一、DNS 服务器</h2><p>域名对应的 IP 地址，都保存在 DNS 服务器。</p><p>我们输入域名，浏览器就会在后台，自动向 DNS 服务器发出请求，获取对应的 IP 地址。这就是 DNS 查询。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080103.webp"></p><p>举例来说，我输入 <code>es6.ruanyifeng.com</code> 这个域名，浏览器就要向 DNS 服务器查询，它的 IP 地址是什么，然后向该 IP 发出访问请求。</p><p>网上有很多公用的 DNS 服务器，这篇文章选择 Cloudflare 公司提供的 1.1.1.1 进行演示。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080104.webp"></p><h2 id="二、dig-命令"><a href="#二、dig-命令" class="headerlink" title="二、dig 命令"></a>二、dig 命令</h2><p>命令行工具 dig 可以跟 DNS 服务器互动，我们就用它演示 DNS 查询。如果你还没有安装，可以搜一下安装方法，在 Linux 系统下是非常容易的。</p><p>它的查询语法如下（美元符号<code>$</code>是命令行提示符）。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig @[DNS 服务器] [域名]</code></pre></div></figure></blockquote><p>向 1.1.1.1 查询域名，就执行下面的命令。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig @1.1.1.1 es6.ruanyifeng.com</code></pre></div></figure></blockquote><p>正常情况下，它会输出一大堆内容。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080105.webp"></p><p>在其中找到 ANSWER SECTION 这个部分，它给出了查询的答案，域名对应的 IP 地址是 104.198.14.52。</p><h2 id="三、域名的树状结构"><a href="#三、域名的树状结构" class="headerlink" title="三、域名的树状结构"></a>三、域名的树状结构</h2><p>你可能会问，难道 DNS 服务器（比如 1.1.1.1）保存了世界上所有域名（包括二级域名、三级域名）的 IP 地址？</p><p>当然不是。DNS 是一个分布式系统，1.1.1.1 只是用户查询入口，它也需要再向其他 DNS 服务器查询，才能获得最终的 IP 地址。</p><p>要说清楚 DNS 完整的查询过程，就必须了解 <strong>域名是一个树状结构</strong>。</p><p>最顶层的域名是根域名（root），然后是顶级域名（top-level domain，简写 TLD），再是一级域名、二级域名、三级域名。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080106.webp"></p><p><strong>（1）根域名</strong></p><p>所有域名的起点都是根域名，它写作一个点<code>.</code>，放在域名的结尾。因为这部分对于所有域名都是相同的，所以就省略不写了，比如<code>example.com</code>等同于<code>example.com.</code>（结尾多一个点）。</p><p>你可以试试，任何一个域名结尾加一个点，浏览器都可以正常解读。</p><p><strong>（2）顶级域名</strong></p><p>根域名的下一级是顶级域名。它分成两种：通用顶级域名（gTLD，比如 .com 和 .net）和国别顶级域名（ccTLD，比如 .cn 和 .us）。</p><p>顶级域名由国际域名管理机构 ICANN 控制，它委托商业公司管理 gTLD，委托各国管理自己的国别域名。</p><p><strong>（3）一级域名</strong></p><p>一级域名就是你在某个顶级域名下面，自己注册的域名。比如，<code>ruanyifeng.com</code>就是我在顶级域名<code>.com</code>下面注册的。</p><p><strong>（4）二级域名</strong></p><p>二级域名是一级域名的子域名，是域名拥有者自行设置的，不用得到许可。比如，<code>es6</code> 就是 <code>ruanyifeng.com</code> 的二级域名。</p><h2 id="四、域名的逐级查询"><a href="#四、域名的逐级查询" class="headerlink" title="四、域名的逐级查询"></a>四、域名的逐级查询</h2><p>这种树状结构的意义在于，<strong>只有上级域名，才知道下一级域名的 IP 地址，需要逐级查询。</strong></p><p>每一级域名都有自己的 DNS 服务器，存放下级域名的 IP 地址。</p><p>所以，如果想要查询二级域名 <code>es6.ruanyifeng.com</code> 的 IP 地址，需要三个步骤。</p><blockquote><p>第一步，查询根域名服务器，获得顶级域名服务器<code>.com</code>（又称 TLD 服务器）的 IP 地址。</p><p>第二步，查询 TLD 服务器 <code>.com</code>，获得一级域名服务器 <code>ruanyifeng.com</code> 的 IP 地址。</p><p>第三步，查询一级域名服务器 <code>ruanyifeng.com</code>，获得二级域名 <code>es6</code> 的 IP 地址。</p></blockquote><p>下面依次演示这三个步骤。</p><h2 id="五、根域名服务器"><a href="#五、根域名服务器" class="headerlink" title="五、根域名服务器"></a>五、根域名服务器</h2><p>根域名服务器全世界一共有13台（都是服务器集群）。它们的域名和 IP 地址如下。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080107.webp"></p><p>根域名服务器的 IP 地址是不变的，集成在操作系统里面。</p><p>操作系统会选其中一台，查询 TLD 服务器的 IP 地址。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig @192.33.4.12 es6.ruanyifeng.com</code></pre></div></figure></blockquote><p>上面示例中，我们选择<code>192.33.4.12</code>，向它发出查询，询问<code>es6.ruanyifeng.com</code>的 TLD 服务器的 IP 地址。</p><p>dig 命令的输出结果如下。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080108.webp"></p><p>因为它给不了 <code>es6.ruanyifeng.com</code> 的 IP 地址，所以输出结果中没有 ANSWER SECTION，只有一个 AUTHORITY SECTION，给出了<code>com.</code>的13台 TLD 服务器的域名。</p><p>下面还有一个 ADDITIONAL SECTION，给出了这13台 TLD 服务器的 IP 地址（包含 IPv4 和 IPv6 两个地址）。</p><h2 id="六、TLD-服务器"><a href="#六、TLD-服务器" class="headerlink" title="六、TLD 服务器"></a>六、TLD 服务器</h2><p>有了 TLD 服务器的 IP 地址以后，我们再选一台接着查询。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig @192.41.162.30 es6.ruanyifeng.com</code></pre></div></figure></blockquote><p>上面示例中，192.41.162.30 是随便选的一台 .com 的 TLD 服务器，我们向它询问 <code>es6.ruanyifeng.com</code> 的 IP 地址。</p><p>返回结果如下。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080109.webp"></p><p>它依然没有 ANSWER SECTION 的部分，只有 AUTHORITY SECTION，给出了一级域名 ruanyifeng.com 的两台 DNS 服务器。</p><p>下面的 ADDITIONAL SECTION 就是这两台 DNS 服务器对应的 IP 地址。</p><h2 id="七、一级域名的-DNS-服务器"><a href="#七、一级域名的-DNS-服务器" class="headerlink" title="七、一级域名的 DNS 服务器"></a>七、一级域名的 DNS 服务器</h2><p>第三步，再向一级域名的 DNS 服务器查询二级域名的 IP 地址。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig @172.64.32.123 es6.ruanyifeng.com</code></pre></div></figure></blockquote><p>返回结果如下。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080110.webp"></p><p>这次终于有了 ANSWER SECTION，得到了最终的二级域名的 IP 地址。</p><p>至此，三个步骤的 DNS 查询全部完成。</p><h2 id="八、DNS-服务器的种类"><a href="#八、DNS-服务器的种类" class="headerlink" title="八、DNS 服务器的种类"></a>八、DNS 服务器的种类</h2><p>总结一下，上面一共提到了四种服务器。</p><blockquote><ul><li>1.1.1.1</li><li>根域名服务器</li><li>TLD 服务器</li><li>一级域名服务器</li></ul></blockquote><p>它们都属于 DNS 服务器，都用来接受 DNS 查询。但是作用不一样，属于不同的类别。</p><h3 id="8-1-递归-DNS-服务器"><a href="#8-1-递归-DNS-服务器" class="headerlink" title="8.1 递归 DNS 服务器"></a>8.1 递归 DNS 服务器</h3><p>后三种服务器只用来查询下一级域名的 IP 地址，而 1.1.1.1 则把分步骤的查询过程自动化，方便用户一次性得到结果，所以它称为<strong>递归 DNS 服务器</strong>（recursive DNS server），即可以自动递归查询。</p><p>我们平常说的 DNS 服务器，一般都是指递归 DNS 服务器。它把 DNS 查询自动化了，只要向它查询就可以了。</p><p>它内部有缓存，可以保存以前查询的结果，下次再有人查询，就直接返回缓存里面的结果。所以它能加快查询，减轻源头 DNS 服务器的负担。</p><h3 id="8-2-权威-DNS-服务器"><a href="#8-2-权威-DNS-服务器" class="headerlink" title="8.2 权威 DNS 服务器"></a>8.2 权威 DNS 服务器</h3><p>一级域名服务器的正式名称叫做<strong>权威域名服务器</strong>（Authoritative Name Server）。</p><p>“权威”的意思是域名的 IP 地址由它给定，不像递归服务器自己做不了主。我们购买域名后，设置 DNS 服务器就是在设置该域名的权威服务器。</p><h3 id="8-3-四种-DNS-服务器"><a href="#8-3-四种-DNS-服务器" class="headerlink" title="8.3 四种 DNS 服务器"></a>8.3 四种 DNS 服务器</h3><p>综上所述，DNS 服务器可以分成四种：</p><blockquote><ul><li>根域名服务器</li><li>TLD 服务器</li><li>权威域名服务器</li><li>递归域名服务器</li></ul></blockquote><p>它们的关系如下图。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080112.webp"></p><p>知道了 DNS 查询的原理，完全可以自己写一个 DNS 的递归服务器，这是不难的。网上有很多参考资料，有兴趣的话，大家可以试试看。</p><p><img src="https://cdn.beekka.com/blogimg/asset/202208/bg2022080111.webp"></p><h2 id="九、参考网址"><a href="#九、参考网址" class="headerlink" title="九、参考网址"></a>九、参考网址</h2><ul><li><a href="https://timothya.com/blog/dns/">Building a Recursive DNS Resolver</a>, Timothy Andrew</li><li><a href="https://www.dnsfilter.com/blog/authoritative-vs-recursive-dns">Authoritative Vs Recursive DNS: What You Need To Know</a>, Serena Raymond</li><li><a href="https://www.cloudflare.com/zh-cn/learning/dns/dns-server-types/">DNS 服务器类型</a>，Cloudflare</li></ul><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DNS原理入门-阮一峰</title>
    <link href="/2022/11/21/DNS%E5%8E%9F%E7%90%86%E5%85%A5%E9%97%A8-%E9%98%AE%E4%B8%80%E5%B3%B0/"/>
    <url>/2022/11/21/DNS%E5%8E%9F%E7%90%86%E5%85%A5%E9%97%A8-%E9%98%AE%E4%B8%80%E5%B3%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原文链接：<a href="https://www.ruanyifeng.com/blog/2016/06/dns.html">https://www.ruanyifeng.com/blog/2016/06/dns.html</a></p></blockquote><p>DNS 是互联网核心协议之一。不管是上网浏览，还是编程开发，都需要了解一点它的知识。</p><p>本文详细介绍DNS的原理，以及如何运用工具软件观察它的运作。我的目标是，读完此文后，你就能完全理解DNS。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061513.png"></p><h2 id="一、DNS-是什么？"><a href="#一、DNS-是什么？" class="headerlink" title="一、DNS 是什么？"></a>一、DNS 是什么？</h2><p>DNS （Domain Name System 的缩写）的作用非常简单，就是根据域名查出IP地址。你可以把它想象成一本巨大的电话本。</p><p>举例来说，如果你要访问域名<code>math.stackexchange.com</code>，首先要通过DNS查出它的IP地址是<code>151.101.129.69</code>。</p><p>如果你不清楚为什么一定要查出IP地址，才能进行网络通信，建议先阅读我写的<a href="https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html">《互联网协议入门》</a>。</p><h2 id="二、查询过程"><a href="#二、查询过程" class="headerlink" title="二、查询过程"></a>二、查询过程</h2><p>虽然只需要返回一个IP地址，但是DNS的查询过程非常复杂，分成多个步骤。</p><p>工具软件<code>dig</code>可以显示整个查询过程。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig math.stackexchange.com</code></pre></div></figure></blockquote><p>上面的命令会输出六段信息。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061501.png"></p><p>第一段是查询参数和统计。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061502.png"></p><p>第二段是查询内容。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061503.png"></p><p>上面结果表示，查询域名<code>math.stackexchange.com</code>的<code>A</code>记录，<code>A</code>是address的缩写。</p><p>第三段是DNS服务器的答复。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061504.png"></p><p>上面结果显示，<code>math.stackexchange.com</code>有四个<code>A</code>记录，即四个IP地址。<code>600</code>是TTL值（Time to live 的缩写），表示缓存时间，即600秒之内不用重新查询。</p><p>第四段显示<code>stackexchange.com</code>的NS记录（Name Server的缩写），即哪些服务器负责管理<code>stackexchange.com</code>的DNS记录。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061505.png"></p><p>上面结果显示<code>stackexchange.com</code>共有四条NS记录，即四个域名服务器，向其中任一台查询就能知道<code>math.stackexchange.com</code>的IP地址是什么。</p><p>第五段是上面四个域名服务器的IP地址，这是随着前一段一起返回的。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061506.png"></p><p>第六段是DNS服务器的一些传输信息。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061514.png"></p><p>上面结果显示，本机的DNS服务器是<code>192.168.1.253</code>，查询端口是53（DNS服务器的默认端口），以及回应长度是305字节。</p><p>如果不想看到这么多内容，可以使用<code>+short</code>参数。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig +short math.stackexchange.com151.101.129.69151.101.65.69151.101.193.69151.101.1.69</code></pre></div></figure></blockquote><p>上面命令只返回<code>math.stackexchange.com</code>对应的4个IP地址（即<code>A</code>记录）。</p><h2 id="三、DNS服务器"><a href="#三、DNS服务器" class="headerlink" title="三、DNS服务器"></a>三、DNS服务器</h2><p>下面我们根据前面这个例子，一步步还原，本机到底怎么得到域名<code>math.stackexchange.com</code>的IP地址。</p><p>首先，本机一定要知道DNS服务器的IP地址，否则上不了网。通过DNS服务器，才能知道某个域名的IP地址到底是什么。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061507.jpg"></p><p>DNS服务器的IP地址，有可能是动态的，每次上网时由网关分配，这叫做DHCP机制；也有可能是事先指定的固定地址。Linux系统里面，DNS服务器的IP地址保存在<code>/etc/resolv.conf</code>文件。</p><p>上例的DNS服务器是<code>192.168.1.253</code>，这是一个内网地址。有一些公网的DNS服务器，也可以使用，其中最有名的就是Google的<a href="https://developers.google.com/speed/public-dns/"><code>8.8.8.8</code></a>和Level 3的<a href="https://www.tummy.com/articles/famous-dns-server/"><code>4.2.2.2</code></a>。</p><p>本机只向自己的DNS服务器查询，<code>dig</code>命令有一个<code>@</code>参数，显示向其他DNS服务器查询的结果。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig @4.2.2.2 math.stackexchange.com</code></pre></div></figure></blockquote><p>上面命令指定向DNS服务器<code>4.2.2.2</code>查询。</p><h2 id="四、域名的层级"><a href="#四、域名的层级" class="headerlink" title="四、域名的层级"></a>四、域名的层级</h2><p>DNS服务器怎么会知道每个域名的IP地址呢？答案是分级查询。</p><p>请仔细看前面的例子，每个域名的尾部都多了一个点。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061503.png"></p><p>比如，域名<code>math.stackexchange.com</code>显示为<code>math.stackexchange.com.</code>。这不是疏忽，而是所有域名的尾部，实际上都有一个根域名。</p><p>举例来说，<code>www.example.com</code>真正的域名是<code>www.example.com.root</code>，简写为<code>www.example.com.</code>。因为，根域名<code>.root</code>对于所有域名都是一样的，所以平时是省略的。</p><p>根域名的下一级，叫做”顶级域名”（top-level domain，缩写为TLD），比如<code>.com</code>、<code>.net</code>；再下一级叫做”次级域名”（second-level domain，缩写为SLD），比如<code>www.example.com</code>里面的<code>.example</code>，这一级域名是用户可以注册的；再下一级是主机名（host），比如<code>www.example.com</code>里面的<code>www</code>，又称为”三级域名”，这是用户在自己的域里面为服务器分配的名称，是用户可以任意分配的。</p><p>总结一下，域名的层级结构如下。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">主机名.次级域名.顶级域名.根域名# 即host.sld.tld.root</code></pre></div></figure></blockquote><h2 id="五、根域名服务器"><a href="#五、根域名服务器" class="headerlink" title="五、根域名服务器"></a>五、根域名服务器</h2><p>DNS服务器根据域名的层级，进行分级查询。</p><p>需要明确的是，每一级域名都有自己的NS记录，NS记录指向该级域名的域名服务器。这些服务器知道下一级域名的各种记录。</p><p>所谓”分级查询”，就是从根域名开始，依次查询每一级域名的NS记录，直到查到最终的IP地址，过程大致如下。</p><blockquote><ol><li>从”根域名服务器”查到”顶级域名服务器”的NS记录和A记录（IP地址）</li><li>从”顶级域名服务器”查到”次级域名服务器”的NS记录和A记录（IP地址）</li><li>从”次级域名服务器”查出”主机名”的IP地址</li></ol></blockquote><p>仔细看上面的过程，你可能发现了，没有提到DNS服务器怎么知道”根域名服务器”的IP地址。回答是”根域名服务器”的NS记录和IP地址一般是不会变化的，所以内置在DNS服务器里面。</p><p>下面是内置的根域名服务器IP地址的一个<a href="http://www.cyberciti.biz/faq/unix-linux-update-root-hints-data-file/">例子</a>。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061508.png"></p><p>上面列表中，列出了根域名（<code>.root</code>）的三条NS记录<code>A.ROOT-SERVERS.NET</code>、<code>B.ROOT-SERVERS.NET</code>和<code>C.ROOT-SERVERS.NET</code>，以及它们的IP地址（即<code>A</code>记录）<code>198.41.0.4</code>、<code>192.228.79.201</code>、<code>192.33.4.12</code>。</p><p>另外，可以看到所有记录的TTL值是3600000秒，相当于1000小时。也就是说，每1000小时才查询一次根域名服务器的列表。</p><p>目前，世界上一共有十三组根域名服务器，从<code>A.ROOT-SERVERS.NET</code>一直到<code>M.ROOT-SERVERS.NET</code>。</p><h2 id="六、分级查询的实例"><a href="#六、分级查询的实例" class="headerlink" title="六、分级查询的实例"></a>六、分级查询的实例</h2><p><code>dig</code>命令的<code>+trace</code>参数可以显示DNS的整个分级查询过程。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig +trace math.stackexchange.com</code></pre></div></figure></blockquote><p>上面命令的第一段列出根域名<code>.</code>的所有NS记录，即所有根域名服务器。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061509.png"></p><p>根据内置的根域名服务器IP地址，DNS服务器向所有这些IP地址发出查询请求，询问<code>math.stackexchange.com</code>的顶级域名服务器<code>com.</code>的NS记录。最先回复的根域名服务器将被缓存，以后只向这台服务器发请求。</p><p>接着是第二段。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061510.png"></p><p>上面结果显示<code>.com</code>域名的13条NS记录，同时返回的还有每一条记录对应的IP地址。</p><p>然后，DNS服务器向这些顶级域名服务器发出查询请求，询问<code>math.stackexchange.com</code>的次级域名<code>stackexchange.com</code>的NS记录。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061511.png"></p><p>上面结果显示<code>stackexchange.com</code>有四条NS记录，同时返回的还有每一条NS记录对应的IP地址。</p><p>然后，DNS服务器向上面这四台NS服务器查询<code>math.stackexchange.com</code>的主机名。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2016/bg2016061512.png"></p><p>上面结果显示，<code>math.stackexchange.com</code>有4条<code>A</code>记录，即这四个IP地址都可以访问到网站。并且还显示，最先返回结果的NS服务器是<code>ns-463.awsdns-57.com</code>，IP地址为<code>205.251.193.207</code>。</p><h2 id="七、NS-记录的查询"><a href="#七、NS-记录的查询" class="headerlink" title="七、NS 记录的查询"></a>七、NS 记录的查询</h2><p><code>dig</code>命令可以单独查看每一级域名的NS记录。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig ns com$ dig ns stackexchange.com</code></pre></div></figure></blockquote><p><code>+short</code>参数可以显示简化的结果。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig +short ns com$ dig +short ns stackexchange.com</code></pre></div></figure></blockquote><h2 id="八、DNS的记录类型"><a href="#八、DNS的记录类型" class="headerlink" title="八、DNS的记录类型"></a>八、DNS的记录类型</h2><p>域名与IP之间的对应关系，称为”记录”（record）。根据使用场景，”记录”可以分成不同的类型（type），前面已经看到了有<code>A</code>记录和<code>NS</code>记录。</p><p>常见的DNS记录类型如下。</p><blockquote><p>（1） <code>A</code>：地址记录（Address），返回域名指向的IP地址。</p><p>（2） <code>NS</code>：域名服务器记录（Name Server），返回保存下一级域名信息的服务器地址。该记录只能设置为域名，不能设置为IP地址。</p><p>（3）<code>MX</code>：邮件记录（Mail eXchange），返回接收电子邮件的服务器地址。</p><p>（4）<code>CNAME</code>：规范名称记录（Canonical Name），返回另一个域名，即当前查询的域名是另一个域名的跳转，详见下文。</p><p>（5）<code>PTR</code>：逆向查询记录（Pointer Record），只用于从IP地址查询域名，详见下文。</p></blockquote><p>一般来说，为了服务的安全可靠，至少应该有两条<code>NS</code>记录，而<code>A</code>记录和<code>MX</code>记录也可以有多条，这样就提供了服务的冗余性，防止出现单点失败。</p><p><code>CNAME</code>记录主要用于域名的内部跳转，为服务器配置提供灵活性，用户感知不到。举例来说，<code>facebook.github.io</code>这个域名就是一个<code>CNAME</code>记录。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig facebook.github.io...;; ANSWER SECTION:facebook.github.io. 3370    IN  CNAME   github.map.fastly.net.github.map.fastly.net.  600 IN  A   103.245.222.133</code></pre></div></figure></blockquote><p>上面结果显示，<code>facebook.github.io</code>的CNAME记录指向<code>github.map.fastly.net</code>。也就是说，用户查询<code>facebook.github.io</code>的时候，实际上返回的是<code>github.map.fastly.net</code>的IP地址。这样的好处是，变更服务器IP地址的时候，只要修改<code>github.map.fastly.net</code>这个域名就可以了，用户的<code>facebook.github.io</code>域名不用修改。</p><p>由于<code>CNAME</code>记录就是一个替换，所以域名一旦设置<code>CNAME</code>记录以后，就不能再设置其他记录了（比如<code>A</code>记录和<code>MX</code>记录），这是为了防止产生冲突。举例来说，<code>foo.com</code>指向<code>bar.com</code>，而两个域名各有自己的<code>MX</code>记录，如果两者不一致，就会产生问题。由于顶级域名通常要设置<code>MX</code>记录，所以一般不允许用户对顶级域名设置<code>CNAME</code>记录。</p><p><code>PTR</code>记录用于从IP地址反查域名。<code>dig</code>命令的<code>-x</code>参数用于查询<code>PTR</code>记录。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig -x 192.30.252.153...;; ANSWER SECTION:153.252.30.192.in-addr.arpa. 3600 IN    PTR pages.github.com.</code></pre></div></figure></blockquote><p>上面结果显示，<code>192.30.252.153</code>这台服务器的域名是<code>pages.github.com</code>。</p><p>逆向查询的一个应用，是可以防止垃圾邮件，即验证发送邮件的IP地址，是否真的有它所声称的域名。</p><p><code>dig</code>命令可以查看指定的记录类型。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ dig a github.com$ dig ns github.com$ dig mx github.com</code></pre></div></figure></blockquote><h2 id="九、其他DNS工具"><a href="#九、其他DNS工具" class="headerlink" title="九、其他DNS工具"></a>九、其他DNS工具</h2><p>除了<code>dig</code>，还有一些其他小工具也可以使用。</p><p><strong>（1）host 命令</strong></p><p><code>host</code>命令可以看作<code>dig</code>命令的简化版本，返回当前请求域名的各种记录。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ host github.comgithub.com has address 192.30.252.121github.com mail is handled by 5 ALT2.ASPMX.L.GOOGLE.COM.github.com mail is handled by 10 ALT4.ASPMX.L.GOOGLE.COM.github.com mail is handled by 10 ALT3.ASPMX.L.GOOGLE.COM.github.com mail is handled by 5 ALT1.ASPMX.L.GOOGLE.COM.github.com mail is handled by 1 ASPMX.L.GOOGLE.COM.$ host facebook.github.comfacebook.github.com is an alias for github.map.fastly.net.github.map.fastly.net has address 103.245.222.133</code></pre></div></figure></blockquote><p><code>host</code>命令也可以用于逆向查询，即从IP地址查询域名，等同于<code>dig -x &lt;ip&gt;</code>。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ host 192.30.252.153153.252.30.192.in-addr.arpa domain name pointer pages.github.com.</code></pre></div></figure></blockquote><p><strong>（2）nslookup 命令</strong></p><p><code>nslookup</code>命令用于互动式地查询域名记录。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ nslookup&gt; facebook.github.ioServer:     192.168.1.253Address:    192.168.1.253#53Non-authoritative answer:facebook.github.io  canonical name &#x3D; github.map.fastly.net.Name:   github.map.fastly.netAddress: 103.245.222.133&gt; </code></pre></div></figure></blockquote><p><strong>（3）whois 命令</strong></p><p><code>whois</code>命令用来查看域名的注册情况。</p><blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">$ whois github.com</code></pre></div></figure></blockquote><h2 id="十、参考链接"><a href="#十、参考链接" class="headerlink" title="十、参考链接"></a>十、参考链接</h2><ul><li><a href="https://www.petekeen.net/dns-the-good-parts">DNS: The Good Parts</a>, by Pete Keen</li><li><a href="http://www.integralist.co.uk/posts/dnsbasics.html">DNS 101</a>, by Mark McDonnell</li></ul><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TCP协议入门-阮一峰</title>
    <link href="/2022/11/21/TCP%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8-%E9%98%AE%E4%B8%80%E5%B3%B0/"/>
    <url>/2022/11/21/TCP%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8-%E9%98%AE%E4%B8%80%E5%B3%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原文链接：<a href="https://www.ruanyifeng.com/blog/2017/06/tcp-protocol.html">https://www.ruanyifeng.com/blog/2017/06/tcp-protocol.html</a><br>TCP 是互联网核心协议之一，本文介绍它的基础知识。</p></blockquote><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060801.png"></p><h2 id="一、TCP-协议的作用"><a href="#一、TCP-协议的作用" class="headerlink" title="一、TCP 协议的作用"></a>一、TCP 协议的作用</h2><p>互联网由<a href="https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html">一整套协议</a>构成。TCP 只是其中的一层，有着自己的分工。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060804.png"></p><p>（图片说明：TCP 是以太网协议和 IP 协议的上层协议，也是应用层协议的下层协议。）</p><p>最底层的以太网协议（Ethernet）规定了电子信号如何组成数据包（packet），解决了子网内部的点对点通信。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060802.jpg"></p><p>（图片说明：以太网协议解决了局域网的点对点通信。）</p><p>但是，以太网协议不能解决多个局域网如何互通，这由 IP 协议解决。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060803.png"></p><p>（图片说明：IP 协议可以连接多个局域网。）</p><p>IP 协议定义了一套自己的地址规则，称为 IP 地址。它实现了路由功能，允许某个局域网的 A 主机，向另一个局域网的 B 主机发送消息。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060805.jpg"></p><p>（图片说明：路由器就是基于 IP 协议。局域网之间要靠路由器连接。）</p><p>路由的原理很简单。市场上所有的路由器，背后都有很多网口，要接入多根网线。路由器内部有一张路由表，规定了 A 段 IP 地址走出口一，B 段地址走出口二，……通过这套”指路牌”，实现了数据包的转发。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060806.jpg"></p><p>（图片说明：本机的路由表注明了不同 IP 目的地的数据包，要发送到哪一个网口（interface）。）</p><p>IP 协议只是一个地址协议，并不保证数据包的完整。如果路由器丢包（比如缓存满了，新进来的数据包就会丢失），就需要发现丢了哪一个包，以及如何重新发送这个包。这就要依靠 TCP 协议。</p><p>简单说，TCP 协议的作用是，保证数据通信的完整性和可靠性，防止丢包。</p><h2 id="二、TCP-数据包的大小"><a href="#二、TCP-数据包的大小" class="headerlink" title="二、TCP 数据包的大小"></a>二、TCP 数据包的大小</h2><p>以太网数据包（packet）的大小是固定的，最初是1518字节，后来增加到1522字节。其中， 1500 字节是负载（payload），22字节是头信息（head）。</p><p>IP 数据包在以太网数据包的负载里面，它也有自己的头信息，最少需要20字节，所以 IP 数据包的负载最多为1480字节。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052913.png"></p><p>（图片说明：IP 数据包在以太网数据包里面，TCP 数据包在 IP 数据包里面。）</p><p>TCP 数据包在 IP 数据包的负载里面。它的头信息最少也需要20字节，因此 TCP 数据包的最大负载是 1480 - 20 &#x3D; 1460 字节。由于 IP 和 TCP 协议往往有额外的头信息，所以 TCP 负载实际为1400字节左右。</p><p>因此，一条1500字节的信息需要两个 TCP 数据包。HTTP&#x2F;2 协议的一大改进， 就是压缩 HTTP 协议的头信息，使得一个 HTTP 请求可以放在一个 TCP 数据包里面，而不是分成多个，这样就提高了速度。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg20170060810.png"></p><p>（图片说明：以太网数据包的负载是1500字节，TCP 数据包的负载在1400字节左右。）</p><h2 id="三、TCP-数据包的编号（SEQ）"><a href="#三、TCP-数据包的编号（SEQ）" class="headerlink" title="三、TCP 数据包的编号（SEQ）"></a>三、TCP 数据包的编号（SEQ）</h2><p>一个包1400字节，那么一次性发送大量数据，就必须分成多个包。比如，一个 10MB 的文件，需要发送7100多个包。</p><p>发送的时候，TCP 协议为每个包编号（sequence number，简称 SEQ），以便接收的一方按照顺序还原。万一发生丢包，也可以知道丢失的是哪一个包。</p><p>第一个包的编号是一个随机数。为了便于理解，这里就把它称为1号包。假定这个包的负载长度是100字节，那么可以推算出下一个包的编号应该是101。这就是说，每个数据包都可以得到两个编号：自身的编号，以及下一个包的编号。接收方由此知道，应该按照什么顺序将它们还原成原始文件。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060807.png"></p><p>（图片说明：当前包的编号是45943，下一个数据包的编号是46183，由此可知，这个包的负载是240字节。）</p><h2 id="四、TCP-数据包的组装"><a href="#四、TCP-数据包的组装" class="headerlink" title="四、TCP 数据包的组装"></a>四、TCP 数据包的组装</h2><p>收到 TCP 数据包以后，组装还原是操作系统完成的。应用程序不会直接处理 TCP 数据包。</p><p>对于应用程序来说，不用关心数据通信的细节。除非线路异常，收到的总是完整的数据。应用程序需要的数据放在 TCP 数据包里面，有自己的格式（比如 HTTP 协议）。</p><p>TCP 并没有提供任何机制，表示原始文件的大小，这由应用层的协议来规定。比如，HTTP 协议就有一个头信息<code>Content-Length</code>，表示信息体的大小。对于操作系统来说，就是持续地接收 TCP 数据包，将它们按照顺序组装好，一个包都不少。</p><p>操作系统不会去处理 TCP 数据包里面的数据。一旦组装好 TCP 数据包，就把它们转交给应用程序。TCP 数据包里面有一个端口（port）参数，就是用来指定转交给监听该端口的应用程序。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060808.jpg"></p><p>（图片说明：系统根据 TCP 数据包里面的端口，将组装好的数据转交给相应的应用程序。上图中，21端口是 FTP 服务器，25端口是 SMTP 服务，80端口是 Web 服务器。）</p><p>应用程序收到组装好的原始数据，以浏览器为例，就会根据 HTTP 协议的<code>Content-Length</code>字段正确读出一段段的数据。这也意味着，一次 TCP 通信可以包括多个 HTTP 通信。</p><h2 id="五、慢启动和-ACK"><a href="#五、慢启动和-ACK" class="headerlink" title="五、慢启动和 ACK"></a>五、慢启动和 ACK</h2><p>服务器发送数据包，当然越快越好，最好一次性全发出去。但是，发得太快，就有可能丢包。带宽小、路由器过热、缓存溢出等许多因素都会导致丢包。线路不好的话，发得越快，丢得越多。</p><p>最理想的状态是，在线路允许的情况下，达到最高速率。但是我们怎么知道，对方线路的理想速率是多少呢？答案就是慢慢试。</p><p>TCP 协议为了做到效率与可靠性的统一，设计了一个慢启动（slow start）机制。开始的时候，发送得较慢，然后根据丢包的情况，调整速率：如果不丢包，就加快发送速度；如果丢包，就降低发送速度。</p><p>Linux 内核里面<a href="http://elixir.free-electrons.com/linux/v4.5/source/include/net/tcp.h#L220">设定</a>了（常量<code>TCP_INIT_CWND</code>），刚开始通信的时候，发送方一次性发送10个数据包，即”发送窗口”的大小为10。然后停下来，等待接收方的确认，再继续发送。</p><p>默认情况下，接收方每收到<a href="https://serverfault.com/questions/348666/when-the-tcp-engine-decides-to-send-an-ack">两个</a> TCP 数据包，就要<a href="https://stackoverflow.com/a/3604882/1194049">发送</a>一个确认消息。”确认”的英语是 acknowledgement，所以这个确认消息就简称 ACK。</p><p>ACK 携带两个信息。</p><blockquote><ul><li>期待要收到下一个数据包的编号</li><li>接收方的接收窗口的剩余容量</li></ul></blockquote><p>发送方有了这两个信息，再加上自己已经发出的数据包的最新编号，就会推测出接收方大概的接收速度，从而降低或增加发送速率。这被称为”发送窗口”，这个窗口的大小是可变的。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060809.png"></p><p>（图片说明：每个 ACK 都带有下一个数据包的编号，以及接收窗口的剩余容量。双方都会发送 ACK。）</p><p>注意，由于 TCP 通信是双向的，所以双方都需要发送 ACK。两方的窗口大小，很可能是不一样的。而且 ACK 只是很简单的几个字段，通常与数据合并在一个数据包里面发送。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060812.jpg"></p><p>（图片说明：上图一共4次通信。第一次通信，A 主机发给B 主机的数据包编号是1，长度是100字节，因此第二次通信 B 主机的 ACK 编号是 1 + 100 &#x3D; 101，第三次通信 A 主机的数据包编号也是 101。同理，第二次通信 B 主机发给 A 主机的数据包编号是1，长度是200字节，因此第三次通信 A 主机的 ACK 是201，第四次通信 B 主机的数据包编号也是201。）</p><p>即使对于带宽很大、线路很好的连接，TCP 也总是从10个数据包开始慢慢试，过了一段时间以后，才达到最高的传输速率。这就是 TCP 的慢启动。</p><h2 id="六、数据包的遗失处理"><a href="#六、数据包的遗失处理" class="headerlink" title="六、数据包的遗失处理"></a>六、数据包的遗失处理</h2><p>TCP 协议可以保证数据通信的完整性，这是怎么做到的？</p><p>前面说过，每一个数据包都带有下一个数据包的编号。如果下一个数据包没有收到，那么 ACK 的编号就不会发生变化。</p><p>举例来说，现在收到了4号包，但是没有收到5号包。ACK 就会记录，期待收到5号包。过了一段时间，5号包收到了，那么下一轮 ACK 会更新编号。如果5号包还是没收到，但是收到了6号包或7号包，那么 ACK 里面的编号不会变化，总是显示5号包。这会导致大量重复内容的 ACK。</p><p>如果发送方发现收到<a href="https://stackoverflow.com/questions/4233851/why-does-tcp-wait-for-three-duplicate-ack-before-fast-retransmit">三个</a>连续的重复 ACK，或者超时了还没有收到任何 ACK，就会确认丢包，即5号包遗失了，从而再次发送这个包。通过这种机制，TCP 保证了不会有数据包丢失。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/2017/bg2017060811.png"></p><p>（图片说明：Host B 没有收到100号数据包，会连续发出相同的 ACK，触发 Host A 重发100号数据包。）</p><h2 id="七、参考链接"><a href="#七、参考链接" class="headerlink" title="七、参考链接"></a>七、参考链接</h2><ul><li><a href="https://www.destroyallsoftware.com/compendium/network-protocols">Network protocols for programmers who know at least one programming language</a></li></ul><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>互联网协议入门-阮一峰</title>
    <link href="/2022/11/21/%E4%BA%92%E8%81%94%E7%BD%91%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E9%98%AE%E4%B8%80%E5%B3%B0%E7%9A%84%E7%BD%91%E7%BB%9C%E6%97%A5%E5%BF%97/"/>
    <url>/2022/11/21/%E4%BA%92%E8%81%94%E7%BD%91%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E9%98%AE%E4%B8%80%E5%B3%B0%E7%9A%84%E7%BD%91%E7%BB%9C%E6%97%A5%E5%BF%97/</url>
    
    <content type="html"><![CDATA[<p>我们每天使用互联网，你是否想过，它是如何实现的？</p><p>全世界几十亿台电脑，连接在一起，两两通信。上海的某一块网卡送出信号，洛杉矶的另一块网卡居然就收到了，两者实际上根本不知道对方的物理位置，你不觉得这是很神奇的事情吗？</p><p>互联网的核心是一系列协议，总称为”互联网协议”（Internet Protocol Suite）。它们对电脑如何连接和组网，做出了详尽的规定。理解了这些协议，就理解了互联网的原理。</p><p>下面就是我的学习笔记。因为这些协议实在太复杂、太庞大，我想整理一个简洁的框架，帮助自己从总体上把握它们。为了保证简单易懂，我做了大量的简化，有些地方并不全面和精确，但是应该能够说清楚互联网的原理。</p><p>=&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p><h2 id="互联网协议入门"><a href="#互联网协议入门" class="headerlink" title="互联网协议入门"></a><strong>互联网协议入门</strong></h2><p>作者：阮一峰<br>原文地址：<a href="https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html">https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html</a></p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052901.jpg"></p><h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a><strong>一、概述</strong></h2><h3 id="1-1-五层模型"><a href="#1-1-五层模型" class="headerlink" title="1.1 五层模型"></a><strong>1.1 五层模型</strong></h3><p>互联网的实现，分成好几层。每一层都有自己的功能，就像建筑物一样，每一层都靠下一层支持。</p><p>用户接触到的，只是最上面的一层，根本没有感觉到下面的层。要理解互联网，必须从最下层开始，自下而上理解每一层的功能。</p><p>如何分层有不同的模型，有的模型分七层，有的分四层。我觉得，把互联网分成五层，比较容易解释。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052902.png"></p><p>如上图所示，最底下的一层叫做”实体层”（Physical Layer），最上面的一层叫做”应用层”（Application Layer），中间的三层（自下而上）分别是”链接层”（Link Layer）、”网络层”（Network Layer）和”传输层”（Transport Layer）。越下面的层，越靠近硬件；越上面的层，越靠近用户。</p><p>它们叫什么名字，其实并不重要。只需要知道，互联网分成若干层就可以了。</p><h3 id="1-2-层与协议"><a href="#1-2-层与协议" class="headerlink" title="1.2 层与协议"></a><strong>1.2 层与协议</strong></h3><p>每一层都是为了完成一种功能。为了实现这些功能，就需要大家都遵守共同的规则。</p><p>大家都遵守的规则，就叫做”协议”（protocol）。</p><p>互联网的每一层，都定义了很多协议。这些协议的总称，就叫做”互联网协议”（Internet Protocol Suite）。它们是互联网的核心，下面介绍每一层的功能，主要就是介绍每一层的主要协议。</p><h2 id="二、实体层"><a href="#二、实体层" class="headerlink" title="二、实体层"></a><strong>二、实体层</strong></h2><p>我们从最底下的一层开始。</p><p>电脑要组网，第一件事要干什么？当然是先把电脑连起来，可以用光缆、电缆、双绞线、无线电波等方式。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052903.png"></p><p><strong>这就叫做”实体层”，它就是把电脑连接起来的物理手段。它主要规定了网络的一些电气特性，作用是负责传送0和1的电信号。</strong></p><h2 id="三、链接层"><a href="#三、链接层" class="headerlink" title="三、链接层"></a><strong>三、链接层</strong></h2><h3 id="3-1-定义"><a href="#3-1-定义" class="headerlink" title="3.1 定义"></a><strong>3.1 定义</strong></h3><p>单纯的0和1没有任何意义，必须规定解读方式：多少个电信号算一组？每个信号位有何意义？</p><p><strong>这就是”链接层”的功能，它在”实体层”的上方，确定了0和1的分组方式。</strong></p><h3 id="3-2-以太网协议"><a href="#3-2-以太网协议" class="headerlink" title="3.2 以太网协议"></a><strong>3.2 以太网协议</strong></h3><p>早期的时候，每家公司都有自己的电信号分组方式。逐渐地，一种叫做<a href="https://zh.wikipedia.org/wiki/%E4%BB%A5%E5%A4%AA%E7%BD%91">“以太网”</a>（Ethernet）的协议，占据了主导地位。</p><p>以太网规定，一组电信号构成一个数据包，叫做”帧”（Frame）。每一帧分成两个部分：标头（Head）和数据（Data）。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052904.png"></p><p>“标头”包含数据包的一些说明项，比如发送者、接受者、数据类型等等；”数据”则是数据包的具体内容。</p><p>“标头”的长度，固定为18字节。”数据”的长度，最短为46字节，最长为1500字节。因此，整个”帧”最短为64字节，最长为1518字节。如果数据很长，就必须分割成多个帧进行发送。</p><h3 id="3-3-MAC地址"><a href="#3-3-MAC地址" class="headerlink" title="3.3 MAC地址"></a><strong>3.3 MAC地址</strong></h3><p>上面提到，以太网数据包的”标头”，包含了发送者和接受者的信息。那么，发送者和接受者是如何标识呢？</p><p>以太网规定，连入网络的所有设备，都必须具有”网卡”接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052905.jpg"></p><p>每块网卡出厂的时候，都有一个全世界独一无二的MAC地址，长度是48个二进制位，通常用12个十六进制数表示。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052906.png"></p><p>前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。有了MAC地址，就可以定位网卡和数据包的路径了。</p><h3 id="3-4-广播"><a href="#3-4-广播" class="headerlink" title="3.4 广播"></a><strong>3.4 广播</strong></h3><p>定义地址只是第一步，后面还有更多的步骤。</p><p>首先，一块网卡怎么会知道另一块网卡的MAC地址？</p><p>回答是有一种ARP协议，可以解决这个问题。这个留到后面介绍，这里只需要知道，以太网数据包必须知道接收方的MAC地址，然后才能发送。</p><p>其次，就算有了MAC地址，系统怎样才能把数据包准确送到接收方？</p><p>回答是以太网采用了一种很”原始”的方式，它不是把数据包准确送到接收方，而是向本网络内所有计算机发送，让每台计算机自己判断，是否为接收方。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052907.png"></p><p>上图中，1号计算机向2号计算机发送一个数据包，同一个子网络的3号、4号、5号计算机都会收到这个包。它们读取这个包的”标头”，找到接收方的MAC地址，然后与自身的MAC地址相比较，如果两者相同，就接受这个包，做进一步处理，否则就丢弃这个包。这种发送方式就叫做”广播”（broadcasting）。</p><p>有了数据包的定义、网卡的MAC地址、广播的发送方式，”链接层”就可以在多台计算机之间传送数据了。</p><h2 id="四、网络层"><a href="#四、网络层" class="headerlink" title="四、网络层"></a><strong>四、网络层</strong></h2><h3 id="4-1-网络层的由来"><a href="#4-1-网络层的由来" class="headerlink" title="4.1 网络层的由来"></a><strong>4.1 网络层的由来</strong></h3><p>以太网协议，依靠MAC地址发送数据。理论上，单单依靠MAC地址，上海的网卡就可以找到洛杉矶的网卡了，技术上是可以实现的。</p><p>但是，这样做有一个重大的缺点。以太网采用广播方式发送数据包，所有成员人手一”包”，不仅效率低，而且局限在发送者所在的子网络。也就是说，如果两台计算机不在同一个子网络，广播是传不过去的。这种设计是合理的，否则互联网上每一台计算机都会收到所有包，那会引起灾难。</p><p>互联网是无数子网络共同组成的一个巨型网络，很像想象上海和洛杉矶的电脑会在同一个子网络，这几乎是不可能的。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052914.png"></p><p>因此，必须找到一种方法，能够区分哪些MAC地址属于同一个子网络，哪些不是。如果是同一个子网络，就采用广播方式发送，否则就采用”路由”方式发送。（”路由”的意思，就是指如何向不同的子网络分发数据包，这是一个很大的主题，本文不涉及。）遗憾的是，MAC地址本身无法做到这一点。它只与厂商有关，与所处网络无关。</p><p><strong>这就导致了”网络层”的诞生。它的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做”网络地址”，简称”网址”。</strong></p><p>于是，”网络层”出现以后，每台计算机有了两种地址，一种是MAC地址，另一种是网络地址。两种地址之间没有任何联系，MAC地址是绑定在网卡上的，网络地址则是管理员分配的，它们只是随机组合在一起。</p><p>网络地址帮助我们确定计算机所在的子网络，MAC地址则将数据包送到该子网络中的目标网卡。因此，从逻辑上可以推断，必定是先处理网络地址，然后再处理MAC地址。</p><h3 id="4-2-IP协议"><a href="#4-2-IP协议" class="headerlink" title="4.2 IP协议"></a><strong>4.2 IP协议</strong></h3><p>规定网络地址的协议，叫做IP协议。它所定义的地址，就被称为IP地址。</p><p>目前，广泛采用的是IP协议第四版，简称IPv4。这个版本规定，网络地址由32个二进制位组成。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052908.png"></p><p>习惯上，我们用分成四段的十进制数表示IP地址，从0.0.0.0一直到255.255.255.255。</p><p>互联网上的每一台计算机，都会分配到一个IP地址。这个地址分成两个部分，前一部分代表网络，后一部分代表主机。比如，IP地址172.16.254.1，这是一个32位的地址，假定它的网络部分是前24位（172.16.254），那么主机部分就是后8位（最后的那个1）。处于同一个子网络的电脑，它们IP地址的网络部分必定是相同的，也就是说172.16.254.2应该与172.16.254.1处在同一个子网络。</p><p>但是，问题在于单单从IP地址，我们无法判断网络部分。还是以172.16.254.1为例，它的网络部分，到底是前24位，还是前16位，甚至前28位，从IP地址上是看不出来的。</p><p>那么，怎样才能从IP地址，判断两台计算机是否属于同一个子网络呢？这就要用到另一个参数”子网掩码”（subnet mask）。</p><p>所谓”子网掩码”，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.254.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。</p><p>知道”子网掩码”，我们就能判断，任意两个IP地址是否处在同一个子网络。方法是将两个IP地址与子网掩码分别进行AND运算（两个数位都为1，运算结果为1，否则为0），然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是。</p><p>比如，已知IP地址172.16.254.1和172.16.254.233的子网掩码都是255.255.255.0，请问它们是否在同一个子网络？两者与子网掩码分别进行AND运算，结果都是172.16.254.0，因此它们在同一个子网络。</p><p>总结一下，IP协议的作用主要有两个，一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络。</p><h3 id="4-3-IP数据包"><a href="#4-3-IP数据包" class="headerlink" title="4.3 IP数据包"></a>4.3 IP数据包</h3><p>根据IP协议发送的数据，就叫做IP数据包。不难想象，其中必定包括IP地址信息。</p><p>但是前面说过，以太网数据包只包含MAC地址，并没有IP地址的栏位。那么是否需要修改数据定义，再添加一个栏位呢？</p><p>回答是不需要，我们可以把IP数据包直接放进以太网数据包的”数据”部分，因此完全不用修改以太网的规格。这就是互联网分层结构的好处：上层的变动完全不涉及下层的结构。</p><p>具体来说，IP数据包也分为”标头”和”数据”两个部分。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052909.png"></p><p>“标头”部分主要包括版本、长度、IP地址等信息，”数据”部分则是IP数据包的具体内容。它放进以太网数据包后，以太网数据包就变成了下面这样。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052910.png"></p><p>IP数据包的”标头”部分的长度为20到60字节，整个数据包的总长度最大为65,535字节。因此，理论上，一个IP数据包的”数据”部分，最长为65,515字节。前面说过，以太网数据包的”数据”部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了。</p><h3 id="4-4-ARP协议"><a href="#4-4-ARP协议" class="headerlink" title="4.4 ARP协议"></a><strong>4.4 ARP协议</strong></h3><p>关于”网络层”，还有最后一点需要说明。</p><p>因为IP数据包是放在以太网数据包里发送的，所以我们必须同时知道两个地址，一个是对方的MAC地址，另一个是对方的IP地址。通常情况下，对方的IP地址是已知的（后文会解释），但是我们不知道它的MAC地址。</p><p>所以，我们需要一种机制，能够从IP地址得到MAC地址。</p><p>这里又可以分成两种情况。第一种情况，如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的”网关”（gateway），让网关去处理。</p><p>第二种情况，如果两台主机在同一个子网络，那么我们可以用ARP协议，得到对方的MAC地址。ARP协议也是发出一个数据包（包含在以太网数据包中），其中包含它所要查询主机的IP地址，在对方的MAC地址这一栏，填的是FF:FF:FF:FF:FF:FF，表示这是一个”广播”地址。它所在子网络的每一台主机，都会收到这个数据包，从中取出IP地址，与自身的IP地址进行比较。如果两者相同，都做出回复，向对方报告自己的MAC地址，否则就丢弃这个包。</p><p>总之，有了ARP协议之后，我们就可以得到同一个子网络内的主机MAC地址，可以把数据包发送到任意一台主机之上了。</p><h2 id="五、传输层"><a href="#五、传输层" class="headerlink" title="五、传输层"></a><strong>五、传输层</strong></h2><h3 id="5-1-传输层的由来"><a href="#5-1-传输层的由来" class="headerlink" title="5.1 传输层的由来"></a><strong>5.1 传输层的由来</strong></h3><p>有了MAC地址和IP地址，我们已经可以在互联网上任意两台主机上建立通信。</p><p>接下来的问题是，同一台主机上有许多程序都需要用到网络，比如，你一边浏览网页，一边与朋友在线聊天。当一个数据包从互联网上发来的时候，你怎么知道，它是表示网页的内容，还是表示在线聊天的内容？</p><p>也就是说，我们还需要一个参数，表示这个数据包到底供哪个程序（进程）使用。这个参数就叫做”端口”（port），它其实是每一个使用网卡的程序的编号。每个数据包都发到主机的特定端口，所以不同的程序就能取到自己所需要的数据。</p><p>“端口”是0到65535之间的一个整数，正好16个二进制位。0到1023的端口被系统占用，用户只能选用大于1023的端口。不管是浏览网页还是在线聊天，应用程序会随机选用一个端口，然后与服务器的相应端口联系。</p><p><strong>“传输层”的功能，就是建立”端口到端口”的通信。相比之下，”网络层”的功能是建立”主机到主机”的通信。只要确定主机和端口，我们就能实现程序之间的交流。</strong>因此，Unix系统就把主机+端口，叫做”套接字”（socket）。有了它，就可以进行网络应用程序开发了。</p><h3 id="5-2-UDP协议"><a href="#5-2-UDP协议" class="headerlink" title="5.2 UDP协议"></a><strong>5.2 UDP协议</strong></h3><p>现在，我们必须在数据包中加入端口信息，这就需要新的协议。最简单的实现叫做UDP协议，它的格式几乎就是在数据前面，加上端口号。</p><p>UDP数据包，也是由”标头”和”数据”两部分组成。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052911.png"></p><p>“标头”部分主要定义了发出端口和接收端口，”数据”部分就是具体的内容。然后，把整个UDP数据包放入IP数据包的”数据”部分，而前面说过，IP数据包又是放在以太网数据包之中的，所以整个以太网数据包现在变成了下面这样：</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052912.png"></p><p>UDP数据包非常简单，”标头”部分一共只有8个字节，总长度不超过65,535字节，正好放进一个IP数据包。</p><h3 id="5-3-TCP协议"><a href="#5-3-TCP协议" class="headerlink" title="5.3 TCP协议"></a><strong>5.3 TCP协议</strong></h3><p>UDP协议的优点是比较简单，容易实现，但是缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。</p><p>为了解决这个问题，提高网络可靠性，TCP协议就诞生了。这个协议非常复杂，但可以近似认为，它就是有确认机制的UDP协议，每发出一个数据包都要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包了。</p><p>因此，TCP协议能够确保数据不会遗失。它的缺点是过程复杂、实现困难、消耗较多的资源。</p><p>TCP数据包和UDP数据包一样，都是内嵌在IP数据包的”数据”部分。TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。</p><h2 id="六、应用层"><a href="#六、应用层" class="headerlink" title="六、应用层"></a><strong>六、应用层</strong></h2><p>应用程序收到”传输层”的数据，接下来就要进行解读。由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。</p><p><strong>“应用层”的作用，就是规定应用程序的数据格式。</strong></p><p>举例来说，TCP协议可以为各种各样的程序传递数据，比如Email、WWW、FTP等等。那么，必须有不同协议规定电子邮件、网页、FTP数据的格式，这些应用程序协议就构成了”应用层”。</p><p>这是最高的一层，直接面对用户。它的数据就放在TCP数据包的”数据”部分。因此，现在的以太网的数据包就变成下面这样。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052913.png"></p><p>至此，整个互联网的五层结构，自下而上全部讲完了。这是从系统的角度，解释互联网是如何构成的。<a href="https://www.ruanyifeng.com/blog/2012/06/internet_protocol_suite_part_ii.html">下一篇</a>，我反过来，从用户的角度，自上而下看看这个结构是如何发挥作用，完成一次网络数据交换的。</p><p>（完）</p><p><a href="https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html">上一篇文章</a>分析了互联网的总体构思，从下至上，每一层协议的设计思想。</p><p>这是从设计者的角度看问题，今天我想切换到用户的角度，看看用户是如何从上至下，与这些协议互动的。</p><p>=&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p><h2 id="互联网协议入门（二）"><a href="#互联网协议入门（二）" class="headerlink" title="互联网协议入门（二）"></a><strong>互联网协议入门（二）</strong></h2><p>作者：阮一峰</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061109.jpg"></p><p>（接上文）</p><h2 id="七、一个小结"><a href="#七、一个小结" class="headerlink" title="七、一个小结"></a><strong>七、一个小结</strong></h2><p>先对前面的内容，做一个小结。</p><p>我们已经知道，网络通信就是交换数据包。电脑A向电脑B发送一个数据包，后者收到了，回复一个数据包，从而实现两台电脑之间的通信。数据包的结构，基本上是下面这样：</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201205/bg2012052913.png"></p><p>发送这个包，需要知道两个地址：</p><blockquote><p>　　* 对方的MAC地址</p><p>　　* 对方的IP地址</p></blockquote><p>有了这两个地址，数据包才能准确送到接收者手中。但是，前面说过，MAC地址有局限性，如果两台电脑不在同一个子网络，就无法知道对方的MAC地址，必须通过网关（gateway）转发。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061101.jpg"></p><p>上图中，1号电脑要向4号电脑发送一个数据包。它先判断4号电脑是否在同一个子网络，结果发现不是（后文介绍判断方法），于是就把这个数据包发到网关A。网关A通过路由协议，发现4号电脑位于子网络B，又把数据包发给网关B，网关B再转发到4号电脑。</p><p>1号电脑把数据包发到网关A，必须知道网关A的MAC地址。所以，数据包的目标地址，实际上分成两种情况：</p><table><tbody><tr><td>场景</td><td>数据包地址</td></tr><tr><td>同一个子网络</td><td>对方的MAC地址，对方的IP地址</td></tr><tr><td>非同一个子网络</td><td>网关的MAC地址，对方的IP地址</td></tr></tbody></table><p>发送数据包之前，电脑必须判断对方是否在同一个子网络，然后选择相应的MAC地址。接下来，我们就来看，实际使用中，这个过程是怎么完成的。</p><h2 id="八、用户的上网设置"><a href="#八、用户的上网设置" class="headerlink" title="八、用户的上网设置"></a><strong>八、用户的上网设置</strong></h2><h3 id="8-1-静态IP地址"><a href="#8-1-静态IP地址" class="headerlink" title="8.1 静态IP地址"></a><strong>8.1 静态IP地址</strong></h3><p>你买了一台新电脑，插上网线，开机，这时电脑能够上网吗？</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061110.jpg"></p><p>通常你必须做一些设置。有时，管理员（或者ISP）会告诉你下面四个参数，你把它们填入操作系统，计算机就能连上网了：</p><blockquote><p>　　* 本机的IP地址<br>　　* 子网掩码<br>　　* 网关的IP地址<br>　　* DNS的IP地址</p></blockquote><p>下图是Windows系统的设置窗口。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061111.png"></p><p>这四个参数缺一不可，后文会解释为什么需要知道它们才能上网。由于它们是给定的，计算机每次开机，都会分到同样的IP地址，所以这种情况被称作”静态IP地址上网”。</p><p>但是，这样的设置很专业，普通用户望而生畏，而且如果一台电脑的IP地址保持不变，其他电脑就不能使用这个地址，不够灵活。出于这两个原因，大多数用户使用”动态IP地址上网”。</p><h3 id="8-2-动态IP地址"><a href="#8-2-动态IP地址" class="headerlink" title="8.2 动态IP地址"></a><strong>8.2 动态IP地址</strong></h3><p>所谓”动态IP地址”，指计算机开机后，会自动分配到一个IP地址，不用人为设定。它使用的协议叫做<a href="https://zh.wikipedia.org/zh/DHCP">DHCP协议</a>。</p><p>这个协议规定，每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做”DHCP服务器”。新的计算机加入网络，必须向”DHCP服务器”发送一个”DHCP请求”数据包，申请IP地址和相关的网络参数。</p><p>前面说过，如果两台计算机在同一个子网络，必须知道对方的MAC地址和IP地址，才能发送数据包。但是，新加入的计算机不知道这两个地址，怎么发送数据包呢？</p><p>DHCP协议做了一些巧妙的规定。</p><h3 id="8-3-DHCP协议"><a href="#8-3-DHCP协议" class="headerlink" title="8.3 DHCP协议"></a><strong>8.3 DHCP协议</strong></h3><p>首先，它是一种应用层协议，建立在UDP协议之上，所以整个数据包是这样的：</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061102.png"></p><p>　　（1）最前面的”以太网标头”，设置发出方（本机）的MAC地址和接收方（DHCP服务器）的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播地址：FF-FF-FF-FF-FF-FF。</p><p>　　（2）后面的”IP标头”，设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址就设为0.0.0.0，接收方的IP地址设为255.255.255.255。</p><p>　　（3）最后的”UDP标头”，设置发出方的端口和接收方的端口。这一部分是DHCP协议规定好的，发出方是68端口，接收方是67端口。</p><p>这个数据包构造完成后，就可以发出了。以太网是广播发送，同一个子网络的每台计算机都收到了这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的IP地址，才能确定是不是发给自己的。当看到发出方IP地址是0.0.0.0，接收方是255.255.255.255，于是DHCP服务器知道”这个包是发给我的”，而其他计算机就可以丢弃这个包。</p><p>接下来，DHCP服务器读出这个包的数据内容，分配好IP地址，发送回去一个”DHCP响应”数据包。这个响应包的结构也是类似的，以太网标头的MAC地址是双方的网卡地址，IP标头的IP地址是DHCP服务器的IP地址（发出方）和255.255.255.255（接收方），UDP标头的端口是67（发出方）和68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。</p><p>新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数。</p><h3 id="8-4-上网设置：小结"><a href="#8-4-上网设置：小结" class="headerlink" title="8.4 上网设置：小结"></a><strong>8.4 上网设置：小结</strong></h3><p>这个部分，需要记住的就是一点：不管是”静态IP地址”还是”动态IP地址”，电脑上网的首要步骤，是确定四个参数。这四个值很重要，值得重复一遍：</p><blockquote><p>　　* 本机的IP地址<br>　　* 子网掩码<br>　　* 网关的IP地址<br>　　* DNS的IP地址</p></blockquote><p>有了这几个数值，电脑就可以上网”冲浪”了。接下来，我们来看一个实例，当用户访问网页的时候，互联网协议是怎么运作的。</p><h2 id="九、一个实例：访问网页"><a href="#九、一个实例：访问网页" class="headerlink" title="九、一个实例：访问网页"></a><strong>九、一个实例：访问网页</strong></h2><h3 id="9-1-本机参数"><a href="#9-1-本机参数" class="headerlink" title="9.1 本机参数"></a><strong>9.1 本机参数</strong></h3><p>我们假定，经过上一节的步骤，用户设置好了自己的网络参数：</p><blockquote><p>　　* 本机的IP地址：192.168.1.100<br>　　* 子网掩码：255.255.255.0<br>　　* 网关的IP地址：192.168.1.1<br>　　* DNS的IP地址：8.8.8.8</p></blockquote><p>然后他打开浏览器，想要访问Google，在地址栏输入了网址：<a href="http://www.google.com./">www.google.com。</a></p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061103.png"></p><p>这意味着，浏览器要向Google发送一个网页请求的数据包。</p><h3 id="9-2-DNS协议"><a href="#9-2-DNS协议" class="headerlink" title="9.2 DNS协议"></a><strong>9.2 DNS协议</strong></h3><p>我们知道，发送数据包，必须要知道对方的IP地址。但是，现在，我们只知道网址<a href="http://www.google.com,不知道它的ip地址./">www.google.com，不知道它的IP地址。</a></p><p><a href="https://en.wikipedia.org/wiki/Domain_Name_System">DNS协议</a>可以帮助我们，将这个网址转换成IP地址。已知DNS服务器为8.8.8.8，于是我们向这个地址发送一个DNS数据包（53端口）。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061105.png"></p><p>然后，DNS服务器做出响应，告诉我们Google的IP地址是172.194.72.105。于是，我们知道了对方的IP地址。</p><h3 id="9-3-子网掩码"><a href="#9-3-子网掩码" class="headerlink" title="9.3 子网掩码"></a><strong>9.3 子网掩码</strong></h3><p>接下来，我们要判断，这个IP地址是不是在同一个子网络，这就要用到子网掩码。</p><p>已知子网掩码是255.255.255.0，本机用它对自己的IP地址192.168.1.100，做一个二进制的AND运算（两个数位都为1，结果为1，否则为0），计算结果为192.168.1.0；然后对Google的IP地址172.194.72.105也做一个AND运算，计算结果为172.194.72.0。这两个结果不相等，所以结论是，Google与本机不在同一个子网络。</p><p>因此，我们要向Google发送数据包，必须通过网关192.168.1.1转发，也就是说，接收方的MAC地址将是网关的MAC地址。</p><h3 id="9-4-应用层协议"><a href="#9-4-应用层协议" class="headerlink" title="9.4 应用层协议"></a><strong>9.4 应用层协议</strong></h3><p>浏览网页用的是HTTP协议，它的整个数据包构造是这样的：</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061106.png"></p><p>HTTP部分的内容，类似于下面这样：</p><blockquote><p>　　GET &#x2F; HTTP&#x2F;1.1<br>　　Host: <a href="http://www.google.com/">www.google.com</a><br>　　Connection: keep-alive<br>　　User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.1) ……<br>　　Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8<br>　　Accept-Encoding: gzip,deflate,sdch<br>　　Accept-Language: zh-CN,zh;q&#x3D;0.8<br>　　Accept-Charset: GBK,utf-8;q&#x3D;0.7,*;q&#x3D;0.3<br>　　Cookie: … …</p></blockquote><p>我们假定这个部分的长度为4960字节，它会被嵌在TCP数据包之中。</p><h3 id="9-5-TCP协议"><a href="#9-5-TCP协议" class="headerlink" title="9.5 TCP协议"></a><strong>9.5 TCP协议</strong></h3><p>TCP数据包需要设置端口，接收方（Google）的HTTP端口默认是80，发送方（本机）的端口是一个随机生成的1024-65535之间的整数，假定为51775。</p><p>TCP数据包的标头长度为20字节，加上嵌入HTTP的数据包，总长度变为4980字节。</p><h3 id="9-6-IP协议"><a href="#9-6-IP协议" class="headerlink" title="9.6 IP协议"></a><strong>9.6 IP协议</strong></h3><p>然后，TCP数据包再嵌入IP数据包。IP数据包需要设置双方的IP地址，这是已知的，发送方是192.168.1.100（本机），接收方是172.194.72.105（Google）。</p><p>IP数据包的标头长度为20字节，加上嵌入的TCP数据包，总长度变为5000字节。</p><h3 id="9-7-以太网协议"><a href="#9-7-以太网协议" class="headerlink" title="9.7 以太网协议"></a><strong>9.7 以太网协议</strong></h3><p>最后，IP数据包嵌入以太网数据包。以太网数据包需要设置双方的MAC地址，发送方为本机的网卡MAC地址，接收方为网关192.168.1.1的MAC地址（通过ARP协议得到）。</p><p>以太网数据包的数据部分，最大长度为1500字节，而现在的IP数据包长度为5000字节。因此，IP数据包必须分割成四个包。因为每个包都有自己的IP标头（20字节），所以四个包的IP数据包的长度分别为1500、1500、1500、560。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061107.png"></p><h3 id="9-8-服务器端响应"><a href="#9-8-服务器端响应" class="headerlink" title="9.8 服务器端响应"></a><strong>9.8 服务器端响应</strong></h3><p>经过多个网关的转发，Google的服务器172.194.72.105，收到了这四个以太网数据包。</p><p>根据IP标头的序号，Google将四个包拼起来，取出完整的TCP数据包，然后读出里面的”HTTP请求”，接着做出”HTTP响应”，再用TCP协议发回来。</p><p>本机收到HTTP响应以后，就可以将网页显示出来，完成一次网络通信。</p><p><img src="https://www.ruanyifeng.com/blogimg/asset/201206/bg2012061104.jpg"></p><p>这个例子就到此为止，虽然经过了简化，但它大致上反映了互联网协议的整个通信过程。</p><p>（完）</p>]]></content>
    
    
    <categories>
      
      <category>计算机</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>互联网协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo 自定义字体方法</title>
    <link href="/2022/11/19/hexo%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E4%BD%93%E6%96%B9%E6%B3%95/"/>
    <url>/2022/11/19/hexo%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E4%BD%93%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>可使用在线字体和本地字体。</p>          </div><h3 id="本地使用系统字体"><a href="#本地使用系统字体" class="headerlink" title="本地使用系统字体"></a>本地使用系统字体</h3><ul><li>找到fluid文件夹下的source&#x2F;css目录,新建一个custom_css.css文件，里面配置字体风格，类似：</li></ul><figure><div class="code-wrapper"><pre class="language-css" data-language="css"><code class="language-css"><span class="token selector">html,body,header,.markdown-body</span> <span class="token punctuation">&#123;</span>    <span class="token property">font-family</span><span class="token punctuation">:</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>    <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre></div></figure><ul><li>找到_config.fluid.yml配置文件，引入custom.css目录即可。</li></ul><h3 id="本地使用自定义字体"><a href="#本地使用自定义字体" class="headerlink" title="本地使用自定义字体"></a>本地使用自定义字体</h3><p>如果不满足系统自带字体，可以去<a href="https://google-webfonts-helper.herokuapp.com/fonts/pt-sans?subsets=latin">google-webfonts-helper</a>这个网站下载。</p><p>找到想要的字体后，将字体解压出来，<em>置于根目录下的fonts文件夹（如果没有就新建一个）</em>。然后复制google-webfonts-helper字体的CSS代码到上述custom.css文件内，接着找到themes&#x2F;fluid&#x2F;source&#x2F;_variables&#x2F;base.styl文件，在</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#x2F;&#x2F; font$font-size &#x3D; theme-config(&quot;font.font_size&quot;, &quot;16px&quot;)$letter-spacing &#x3D; theme-config(&quot;font.letter_spacing&quot;, &quot;0.02em&quot;)$font-family &#x3D; theme-config(&quot;font.font_family&quot;, &quot;PT Sans&quot;,&quot;var(--font-family-sans-serif)&quot;)$code-font-size &#x3D; theme-config(&quot;font.code_font_size&quot;, &quot;85%&quot;)</code></pre></div></figure><p>中的<code>$font-family = theme-config(&quot;font.font_family&quot;,</code>后面添加字体名。然后保存，<code>hexo clean</code> &#x3D;&#x3D;&gt; <code>hexo g</code> &#x3D;&#x3D;&gt; <code>hexo d</code> 就OK。</p><blockquote><p>备用链接 ：<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/@font-face">https://developer.mozilla.org/zh-CN/docs/Web/CSS/@font-face</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/font-family">https://developer.mozilla.org/zh-CN/docs/Web/CSS/font-family</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>博客</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>技术导航</title>
    <link href="/2022/11/16/%E6%8A%80%E6%9C%AF%E5%AF%BC%E8%88%AA/"/>
    <url>/2022/11/16/%E6%8A%80%E6%9C%AF%E5%AF%BC%E8%88%AA/</url>
    
    <content type="html"><![CDATA[<h3 id="👇-Java语言相关"><a href="#👇-Java语言相关" class="headerlink" title="👇 Java语言相关"></a>👇 Java语言相关</h3><ul><li>Java 学习路线: <a href="https://www.pdai.tech/md/outline/x-outline.html">https://www.pdai.tech/md/outline/x-outline.html</a></li><li>Java 入门教程: <a href="https://www.liaoxuefeng.com/wiki/1252599548343744">https://www.liaoxuefeng.com/wiki/1252599548343744</a></li><li>Jvm 手册: <a href="http://www.ityouknow.com/java.html">http://www.ityouknow.com/java.html</a></li><li>Dubbo手册: <a href="https://dubbo.apache.org/zh/docs/">https://dubbo.apache.org/zh/docs/</a>)</li><li>Netty: <a href="https://netty.io/wiki/index.html">https://netty.io/wiki/index.html</a>)</li><li>Java NIO 教程: <a href="http://www.ityouknow.com/java.html">http://www.ityouknow.com/java.html</a></li><li>Spring 实战: <a href="https://potoyang.gitbook.io/spring-in-action-v5/">https://potoyang.gitbook.io/spring-in-action-v5/</a></li><li>Spring Boot 手册: <a href="http://www.ityouknow.com/spring-boot.html">http://www.ityouknow.com/spring-boot.html</a></li><li>Spring Cloud 手册: <a href="http://www.ityouknow.com/spring-cloud.html">http://www.ityouknow.com/spring-cloud.html</a></li><li>Spring Data JPA - 参考文档: <a href="https://www.springcloud.cc/spring-data-jpa.html">https://www.springcloud.cc/spring-data-jpa.html</a></li><li>Apache Shiro 中文文档: <a href="https://www.docs4dev.com/docs/zh/apache-shiro/1.5.3/reference/introduction.html">https://www.docs4dev.com/docs/zh/apache-shiro/1.5.3/reference/introduction.html</a></li><li>Netty 4.x 用户指南: <a href="https://waylau.com/netty-4-user-guide/">https://waylau.com/netty-4-user-guide/</a></li><li>MyBatis中文文档: <a href="https://mybatis.org/mybatis-3/zh/index.html">https://mybatis.org/mybatis-3/zh/index.html</a></li><li>Tomcat 8 权威指南: <a href="https://wiki.jikexueyuan.com/project/tomcat/">https://wiki.jikexueyuan.com/project/tomcat/</a></li></ul><h3 id="👉-Python语言相关"><a href="#👉-Python语言相关" class="headerlink" title="👉 Python语言相关"></a>👉 Python语言相关</h3><ul><li>Python 零基础入门: <a href="http://www.ityouknow.com/python.html">http://www.ityouknow.com/python.html</a></li><li>Python CookBook 中文版: <a href="https://www.kancloud.cn/kancloud/python3-cookbook">https://www.kancloud.cn/kancloud/python3-cookbook</a></li><li>Python进阶: <a href="https://docs.pythontab.com/interpy/">https://docs.pythontab.com/interpy/</a></li><li>Django 教程: <a href="https://docs.djangoproject.com/zh-hans/3.2//">https://docs.djangoproject.com/zh-hans/3.2//</a></li><li>Flask 教程: <a href="http://docs.jinkan.org/docs/flask/quickstart.html#quickstart">http://docs.jinkan.org/docs/flask/quickstart.html#quickstart</a></li><li>Scrapy 教程: <a href="https://www.osgeo.cn/scrapy/index.html">https://www.osgeo.cn/scrapy/index.html</a></li></ul><h3 id="🖐-其他编程语言文档"><a href="#🖐-其他编程语言文档" class="headerlink" title="🖐 其他编程语言文档"></a>🖐 其他编程语言文档</h3><ul><li>C 语言教程: <a href="https://www.nowcoder.com/tutorial/10002/8f7c3e0e7efd441d8f7c9c8d43c2a0f4">https://www.nowcoder.com/tutorial/10002/8f7c3e0e7efd441d8f7c9c8d43c2a0f4</a></li><li>C++ 学习教程（中）: <a href="https://www.w3cschool.cn/cpp/">https://www.w3cschool.cn/cpp/</a></li><li>Laravel 8 中文教程: <a href="https://learnku.com/docs/laravel/8.x/releases/9351">https://learnku.com/docs/laravel/8.x/releases/9351</a></li><li>Go 语言教程: <a href="http://www.topgoer.com/">http://www.topgoer.com/</a></li><li>Go Web 编程: <a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/preface.md">https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/preface.md</a></li><li>PHP 教程: <a href="https://phpbestpractices.justjavac.com/#">https://phpbestpractices.justjavac.com/#</a></li><li>PHP 开发者实践: <a href="https://ryancao.gitbooks.io/php-developer-prepares/content/">https://ryancao.gitbooks.io/php-developer-prepares/content/</a></li><li>ThinkPHP 教程: <a href="https://www.kancloud.cn/agdholo/thinkphp">https://www.kancloud.cn/agdholo/thinkphp</a></li><li>Visual Basic 教程: <a href="https://docs.microsoft.com/zh-cn/visualstudio/get-started/visual-basic/?view=vs-2019">https://docs.microsoft.com/zh-cn/visualstudio/get-started/visual-basic/?view=vs-2019</a></li><li>R语言教程: <a href="https://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/intro.html">https://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/intro.html</a></li><li>Swift 教程: <a href="https://swift.bootcss.com/">https://swift.bootcss.com/</a></li><li>Ruby 教程: <a href="https://www.ruby-lang.org/zh_cn/documentation/">https://www.ruby-lang.org/zh_cn/documentation/</a></li></ul><h3 id="👨开发工具必备"><a href="#👨开发工具必备" class="headerlink" title="👨开发工具必备"></a>👨开发工具必备</h3><ul><li>Git 学习手册: <a href="https://git-scm.com/book/zh/v2">https://git-scm.com/book/zh/v2</a></li><li>Git互动教程: <a href="https://learngitbranching.js.org/?locale=zh_CN">https://learngitbranching.js.org/?locale=zh_CN</a></li><li>SQL 教程: <a href="https://www.kancloud.cn/wizardforcel/w3school-sql/93915">https://www.kancloud.cn/wizardforcel/w3school-sql/93915</a></li><li>LeetCode 刷题手册: <a href="https://books.halfrost.com/leetcode/ChapterOne/">https://books.halfrost.com/leetcode/ChapterOne/</a></li><li>Nginx 极简教程: <a href="https://dunwu.github.io/nginx-tutorial/#/nginx-quickstart">https://dunwu.github.io/nginx-tutorial/#/nginx-quickstart</a></li><li>图说设计模式: <a href="https://design-patterns.readthedocs.io/zh_CN/latest/index.html">https://design-patterns.readthedocs.io/zh_CN/latest/index.html</a></li><li>JSON 手册: <a href="http://www.dingding.team/book/json/">http://www.dingding.team/book/json/</a></li><li>IDEA 使用教程: <a href="https://github.com/judasn/IntelliJ-IDEA-Tutorial">https://github.com/judasn/IntelliJ-IDEA-Tutorial</a></li><li>Docker 教程: <a href="https://yeasy.gitbook.io/docker_practice/">https://yeasy.gitbook.io/docker_practice/</a></li></ul><h3 id="👩大数据相关"><a href="#👩大数据相关" class="headerlink" title="👩大数据相关"></a>👩大数据相关</h3><ul><li>Apache 教程: <a href="https://www.yiibai.com/apache_http/">https://www.yiibai.com/apache_http/</a></li><li>hadoop 文档: <a href="https://hadoop.apache.org/docs/r1.0.4/cn/index.html">https://hadoop.apache.org/docs/r1.0.4/cn/index.html</a></li><li>Hive 文档: <a href="https://hive.apache.org/">https://hive.apache.org/</a></li><li>HBase 文档: <a href="https://blogs.apache.org/hbase/">https://blogs.apache.org/hbase/</a></li><li>Impala 文档: <a href="https://impala.apache.org/">https://impala.apache.org/</a></li><li>Oozie 调度框架文档: <a href="https://oozie.apache.org/">https://oozie.apache.org/</a></li><li>Apache Sentry: <a href="https://sentry.apache.org/">https://sentry.apache.org/</a></li><li>ZooKeeper: <a href="https://github.com/apache/zookeeper/">https://github.com/apache/zookeeper/</a></li><li>Spark 官方文档: <a href="https://spark.apache.org/">https://spark.apache.org/</a></li><li>Spark 教程: <a href="https://aiyanbo.gitbooks.io/spark-programming-guide-zh-cn/content/">https://aiyanbo.gitbooks.io/spark-programming-guide-zh-cn/content/</a></li><li>Flink 官方文档: <a href="https://flink.apache.org/">https://flink.apache.org/</a></li></ul><h3 id="👨存储相关"><a href="#👨存储相关" class="headerlink" title="👨存储相关"></a>👨存储相关</h3><ul><li>Redis 中文教程: <a href="https://www.redis.com.cn/tutorial.html">https://www.redis.com.cn/tutorial.html</a></li><li>memcached 教程: <a href="https://www.twle.cn/l/yufei/memcached/memcached-basic-index.html">https://www.twle.cn/l/yufei/memcached/memcached-basic-index.html</a></li><li>Mysql 简单教程: <a href="https://segmentfault.com/a/1190000006876419">https://segmentfault.com/a/1190000006876419</a></li><li>MongoDB 教程: <a href="https://www.mongodb.org.cn/tutorial/">https://www.mongodb.org.cn/tutorial/</a></li><li>Elasticsearch 教程: <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/getting-started.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/getting-started.html</a></li><li>OpenResty 最佳实践: <a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/">https://moonbingbing.gitbooks.io/openresty-best-practices/content/</a></li></ul><h3 id="🙆Linux-相关"><a href="#🙆Linux-相关" class="headerlink" title="🙆Linux 相关"></a>🙆Linux 相关</h3><ul><li>鸟哥的 Linux 私房菜: <a href="http://cn.linux.vbird.org/linux_basic/linux_basic.php">http://cn.linux.vbird.org/linux_basic/linux_basic.php</a></li><li>Bash Shell 教程: <a href="https://wangdoc.com/bash/intro.html">https://wangdoc.com/bash/intro.html</a></li><li>Shell 教程: <a href="http://billie66.github.io/TLCL/book/index.html">http://billie66.github.io/TLCL/book/index.html</a></li><li>HTTP 2.0 翻译: <a href="https://yuedu.baidu.com/ebook/478d1a62376baf1ffc4fad99?pn=1###">https://yuedu.baidu.com/ebook/478d1a62376baf1ffc4fad99?pn=1###</a></li></ul><h3 id="🤦移动端手册"><a href="#🤦移动端手册" class="headerlink" title="🤦移动端手册"></a>🤦移动端手册</h3><ul><li>鸿蒙OS 手册: <a href="https://developer.harmonyos.com/cn/documentation/">https://developer.harmonyos.com/cn/documentation/</a></li><li>Android 手册: <a href="https://developer.android.com/guide?hl=zh-cn">https://developer.android.com/guide?hl=zh-cn</a></li><li>IOS 手册: <a href="https://developer.apple.com/cn/documentation/">https://developer.apple.com/cn/documentation/</a></li><li>微信小程序手册: <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/">https://developers.weixin.qq.com/miniprogram/dev/framework/</a></li><li>React Native 手册: <a href="https://reactnative.cn/docs/getting-started">https://reactnative.cn/docs/getting-started</a></li><li>Flutter 手册: <a href="https://flutter.cn/docs">https://flutter.cn/docs</a></li><li>MUI 手册: <a href="https://dev.dcloud.net.cn/mui/">https://dev.dcloud.net.cn/mui/</a></li><li>WeUI 手册: <a href="https://weui.io/">https://weui.io/</a></li><li>VUX 手册: <a href="https://doc.vux.li/zh-CN/">https://doc.vux.li/zh-CN/</a></li><li>FrozenUI 手册: <a href="http://frozenui.github.io/getting-started">http://frozenui.github.io/getting-started</a></li><li>Cube-UI 手册: <a href="https://didi.github.io/cube-ui/#/zh-CN/docs/introduction">https://didi.github.io/cube-ui/#/zh-CN/docs/introduction</a></li></ul><h3 id="💇前端手册"><a href="#💇前端手册" class="headerlink" title="💇前端手册"></a>💇前端手册</h3><ul><li>Html 教程: <a href="https://developer.mozilla.org/zh-CN/docs/learn/HTML">https://developer.mozilla.org/zh-CN/docs/learn/HTML</a></li><li>JS 教程: <a href="https://developer.mozilla.org/zh-CN/docs/learn/HTML">https://developer.mozilla.org/zh-CN/docs/learn/HTML</a></li><li>CSS参考手册: <a href="http://css.doyoe.com/">http://css.doyoe.com/</a></li><li>jQuery 操作手册: <a href="https://www.jquery123.com/">https://www.jquery123.com/</a></li><li>Bootstrap 操作手册: <a href="https://v4.bootcss.com/docs/getting-started/introduction/">https://v4.bootcss.com/docs/getting-started/introduction/</a></li><li>Vue.js手册: <a href="https://v3.cn.vuejs.org/guide/introduction.html">https://v3.cn.vuejs.org/guide/introduction.html</a></li><li>React教程: <a href="https://zh-hans.reactjs.org/tutorial/tutorial.html">https://zh-hans.reactjs.org/tutorial/tutorial.html</a></li><li>AngularJS教程: <a href="https://www.angularjs.net.cn/tutorial/">https://www.angularjs.net.cn/tutorial/</a></li><li>七天学会NodeJS: <a href="http://nqdeng.github.io/7-days-nodejs/">http://nqdeng.github.io/7-days-nodejs/</a></li><li>Vue cli 教程: <a href="https://cli.vuejs.org/zh/guide/">https://cli.vuejs.org/zh/guide/</a></li><li>Angular 手册: <a href="https://angular.cn/docs">https://angular.cn/docs</a></li><li>ES6 教程: <a href="https://es6.ruanyifeng.com/">https://es6.ruanyifeng.com/</a></li></ul><h3 id="👇转换工具"><a href="#👇转换工具" class="headerlink" title="👇转换工具"></a>👇转换工具</h3><ul><li>时间戳转换: <a href="https://tool.lu/timestamp/">https://tool.lu/timestamp/</a></li><li>图片base64编码: <a href="https://tool.lu/base64image/">https://tool.lu/base64image/</a></li><li>进制转换: <a href="https://tool.lu/hexconvert/">https://tool.lu/hexconvert/</a></li></ul><h3 id="🤠代码格式化工具"><a href="#🤠代码格式化工具" class="headerlink" title="🤠代码格式化工具"></a>🤠代码格式化工具</h3><ul><li>SQL格式转换: <a href="https://tool.lu/sql/">https://tool.lu/sql/</a></li><li>Json格式转换: <a href="https://tool.lu/json/">https://tool.lu/json/</a></li><li>Java格式化: <a href="https://tool.oschina.net/codeformat/java">https://tool.oschina.net/codeformat/java</a></li><li>PHP格式化: <a href="https://tool.lu/php/">https://tool.lu/php/</a></li><li>Python格式化: <a href="https://tool.lu/pyc/">https://tool.lu/pyc/</a></li><li>Html格式转换: <a href="https://tool.chinaz.com/tools/jsformat.aspx">https://tool.chinaz.com/tools/jsformat.aspx</a></li><li>Js格式转换: <a href="https://tool.chinaz.com/tools/jsformat.aspx">https://tool.chinaz.com/tools/jsformat.aspx</a></li><li>CSS格式转换: <a href="https://tool.chinaz.com/Tools/CssFormat.aspx">https://tool.chinaz.com/Tools/CssFormat.aspx</a></li><li>Xml格式转换: <a href="https://tool.lu/xml/">https://tool.lu/xml/</a></li></ul><h3 id="😍常用工具"><a href="#😍常用工具" class="headerlink" title="😍常用工具"></a>😍常用工具</h3><ul><li>在线文本对比: <a href="https://text-compare.com/zh-hans/">https://text-compare.com/zh-hans/</a></li><li>正则表达式测试: <a href="https://tool.oschina.net/regex/">https://tool.oschina.net/regex/</a></li><li>SQL工具: <a href="https://tool.lu/sql/">https://tool.lu/sql/</a></li><li>加密解密: <a href="https://tool.oschina.net/encrypt">https://tool.oschina.net/encrypt</a></li><li>Cron查询: <a href="https://www.matools.com/cron/">https://www.matools.com/cron/</a></li><li>二维码制作工具: <a href="https://cli.im/">https://cli.im/</a></li><li>IP地址查询: <a href="https://tool.lu/ip/">https://tool.lu/ip/</a></li><li>下载链接转换工具: <a href="https://tool.lu/urlconvert/">https://tool.lu/urlconvert/</a></li><li>curl命令转代码: <a href="https://tool.lu/curl/">https://tool.lu/curl/</a></li><li>字数统计: <a href="https://www.eteste.com/">https://www.eteste.com/</a></li><li>数字大写转换器: <a href="https://tool.gaodun.com/rmb.html">https://tool.gaodun.com/rmb.html</a></li><li>颜色转化器: <a href="https://www.sioe.cn/yingyong/yanse-rgb-16/">https://www.sioe.cn/yingyong/yanse-rgb-16/</a></li><li>在线代码测试: <a href="https://tool.lu/coderunner/">https://tool.lu/coderunner/</a></li></ul><h3 id="🤣技术社区"><a href="#🤣技术社区" class="headerlink" title="🤣技术社区"></a>🤣技术社区</h3><ul><li>博客园: <a href="https://www.cnblogs.com/">https://www.cnblogs.com</a></li><li>掘金: <a href="https://juejin.im/">https://juejin.im</a></li><li>开源中国: <a href="https://www.oschina.net/">https://www.oschina.net</a></li><li>InfoQ: <a href="https://xie.infoq.cn/">https://xie.infoq.cn</a></li><li>51CTO: <a href="https://www.51cto.com/">https://www.51cto.com</a></li><li>腾讯云社区: <a href="https://cloud.tencent.com/developer">https://cloud.tencent.com/developer</a></li><li>阿里云社区: <a href="https://developer.aliyun.com/">https://developer.aliyun.com</a></li><li>华为云社区: <a href="https://bbs.huaweicloud.com/community/">https://bbs.huaweicloud.com/community/</a></li><li>SF思否: <a href="https://segmentfault.com/">https://segmentfault.com</a></li><li>CSDN: <a href="https://www.csdn.net/">https://www.csdn.net</a></li><li>Golang中文社区: <a href="https://studygolang.com/">https://studygolang.com</a></li><li>开发者头条: <a href="https://toutiao.io/">https://toutiao.io</a></li><li>StackOverflow: <a href="https://stackoverflow.com/">https://stackoverflow.com</a></li><li>ChinaUnix: <a href="http://www.chinaunix.net/">http://www.chinaunix.net</a></li><li>简书: <a href="https://www.jianshu.com/">https://www.jianshu.com</a></li></ul><h3 id="🤡开发工具大全"><a href="#🤡开发工具大全" class="headerlink" title="🤡开发工具大全"></a>🤡开发工具大全</h3><ul><li>IntelliJ IDEA: <a href="https://www.jetbrains.com/idea">https://www.jetbrains.com/idea</a></li><li>VS Code: <a href="https://code.visualstudio.com/">https://code.visualstudio.com</a></li><li>Mac破解应用: <a href="https://xclient.info/">https://xclient.info</a></li><li>IDEA 破解: <a href="http://itmooc.tech/">http://itmooc.tech</a></li><li>Eclipse: <a href="https://www.eclipse.org/downloads">https://www.eclipse.org/downloads</a></li><li>Pycharm: <a href="https://www.jetbrains.com/pycharm">https://www.jetbrains.com/pycharm</a></li><li>Sublime Text: <a href="https://www.sublimetext.com/">https://www.sublimetext.com</a></li><li>Nodepad++: <a href="https://notepad-plus.en.softonic.com/">https://notepad-plus.en.softonic.com</a></li><li>EditPlus: <a href="https://www.editplus.com/download.html">https://www.editplus.com/download.html</a></li><li>atom: <a href="https://atom.io/">https://atom.io</a></li><li>WebStorm: <a href="https://www.jetbrains.com/webstorm">https://www.jetbrains.com/webstorm</a></li><li>secureCRT\u0026FX: <a href="https://www.vandyke.com/download/index.html">https://www.vandyke.com/download/index.html</a></li><li>Navicat: <a href="https://www.navicat.com.cn/download/navicat-premium">https://www.navicat.com.cn/download/navicat-premium</a></li><li>DBeaver: <a href="https://dbeaver.io/">https://dbeaver.io</a></li><li>Postman: <a href="https://www.postman.com/downloads">https://www.postman.com/downloads</a></li><li>ApiPost: <a href="https://www.apipost.cn/download.html">https://www.apipost.cn/download.html</a></li><li>DataGrip: <a href="https://www.jetbrains.com/datagrip">https://www.jetbrains.com/datagrip</a></li><li>studio3t: <a href="https://studio3t.com/download">https://studio3t.com/download</a></li><li>Redis Desktop Manager: <a href="https://rdm.dev/">https://rdm.dev</a></li><li>Another Redis Desktop Manager: <a href="https://github.com/qishibo/AnotherRedisDesktopManager">https://github.com/qishibo/AnotherRedisDesktopManager</a></li><li>Fiddler: <a href="https://www.telerik.com/download/fiddler">https://www.telerik.com/download/fiddler</a></li><li>Beyond Compare: <a href="https://www.scootersoftware.com/download.php">https://www.scootersoftware.com/download.php</a></li><li>FinalShell: <a href="https://www.hostbuf.com/t/988.html">https://www.hostbuf.com/t/988.html</a></li><li>XMind: <a href="https://www.xmind.cn/download">https://www.xmind.cn/download</a></li><li>SnipPaste: <a href="https://www.snipaste.com/">https://www.snipaste.com</a></li></ul><h3 id="😱-编程学习平台"><a href="#😱-编程学习平台" class="headerlink" title="😱 编程学习平台"></a>😱 编程学习平台</h3><ul><li>B站学习网: <a href="https://www.bilibili.com/">https://www.bilibili.com</a></li><li>中国大学MOOC(慕课）: <a href="https://www.icourse163.org/">https://www.icourse163.org</a></li><li>网易云课堂: <a href="https://study.163.com/">https://study.163.com</a></li><li>网易公开课: <a href="https://open.163.com/">https://open.163.com</a></li><li>码农教程: <a href="http://www.manongjc.com/">http://www.manongjc.com</a></li><li>菜鸟教程: <a href="https://www.runoob.com/">https://www.runoob.com</a></li><li>易百教程: <a href="https://www.yiibai.com/">https://www.yiibai.com</a></li><li>W3school: <a href="https://www.w3school.com.cn/">https://www.w3school.com.cn</a></li><li>慕课网: <a href="https://www.imooc.com/">https://www.imooc.com</a></li><li>Gitchat: <a href="https://gitbook.cn/">https://gitbook.cn</a></li><li>Bootstrap中文网: <a href="https://www.bootcss.com/">https://www.bootcss.com</a></li><li>GitHub: <a href="https://github.com/">https://github.com</a></li><li>Gitee: <a href="https://gitee.com/">https://gitee.com</a></li><li>SpringBoot中文导航: <a href="http://springboot.fun/">http://springboot.fun</a></li><li>SpringCloud中文导航: <a href="http://springcloud.fun/">http://springcloud.fun</a></li><li>技术博客: <a href="http://techblog.pub/">http://techblog.pub</a></li><li>coursera: <a href="https://www.coursera.org/">https://www.coursera.org</a></li><li>拉钩教育: <a href="https://kaiwu.lagou.com/">https://kaiwu.lagou.com</a></li><li>极客时间: <a href="https://time.geekbang.org/">https://time.geekbang.org</a></li><li>极客学院: <a href="https://wiki.jikexueyuan.com/">https://wiki.jikexueyuan.com</a></li><li>人工智能教程: <a href="https://www.captainai.net/puresmilex">https://www.captainai.net/puresmilex</a></li><li>百度前端技术学院: <a href="http://ife.baidu.com/">http://ife.baidu.com</a></li></ul><h3 id="🤤-刷题练习网站"><a href="#🤤-刷题练习网站" class="headerlink" title="🤤 刷题练习网站"></a>🤤 刷题练习网站</h3><ul><li>LeetCode: <a href="https://leetcode-cn.com/">https://leetcode-cn.com</a></li><li>牛客网: <a href="https://www.nowcoder.com/">https://www.nowcoder.com</a></li><li>LintCode: <a href="https://www.lintcode.com/">https://www.lintcode.com</a></li></ul><h3 id="😎-代码练习网站"><a href="#😎-代码练习网站" class="headerlink" title="😎 代码练习网站"></a>😎 代码练习网站</h3><ul><li>北京大学POJ: <a href="http://poj.org/">http://poj.org</a></li><li>AlgoMooc算法慕课网: <a href="https://www.algomooc.com/">https://www.algomooc.com</a></li><li>自学SQL网: <a href="http://xuesql.cn/">http://xuesql.cn</a></li><li>SQLZOO练习: <a href="https://sqlzoo.net/wiki/SQL_Tutorial/zh">https://sqlzoo.net/wiki/SQL_Tutorial/zh</a></li><li>赛码: <a href="http://www.acmcoder.com/#/practice/company">http://www.acmcoder.com/#/practice/company</a></li><li>UOJ: <a href="https://uoj.ac/">https://uoj.ac</a></li><li>Hihocoder: <a href="http://hihocoder.com/problemset">http://hihocoder.com/problemset</a></li><li>趣IT: <a href="https://www.funit.cn/">https://www.funit.cn</a></li></ul><h3 id="👨在线画图工具"><a href="#👨在线画图工具" class="headerlink" title="👨在线画图工具"></a>👨在线画图工具</h3><ul><li>Processon: <a href="https://www.processon.com/">https://www.processon.com</a></li><li>Draw.io: <a href="https://app.diagrams.net/">https://app.diagrams.net</a></li><li>思维导图mindline: <a href="http://www.mindline.cn/webapp">http://www.mindline.cn/webapp</a></li><li>Omnigraffle: <a href="https://www.omnigroup.com/download">https://www.omnigroup.com/download</a></li></ul><h3 id="🦸视频工具"><a href="#🦸视频工具" class="headerlink" title="🦸视频工具"></a>🦸视频工具</h3><ul><li>Videezy: <a href="https://www.videezy.com/">https://www.videezy.com/</a></li><li>Videovo: <a href="https://www.videvo.net/">https://www.videvo.net/</a></li><li>mixkit: <a href="https://mixkit.co/">https://mixkit.co/</a></li><li>distill: <a href="https://wedistill.io/">https://wedistill.io/</a></li></ul><h3 id="💃-图片（图像）处理"><a href="#💃-图片（图像）处理" class="headerlink" title="💃 图片（图像）处理"></a>💃 图片（图像）处理</h3><ul><li>图片处理（超级能耐）: <a href="https://www.iloveimg.com/zh-cn">https://www.iloveimg.com/zh-cn</a></li><li>pixabay: <a href="https://pixabay.com/zh/">https://pixabay.com/zh/</a></li><li>Unsplash: <a href="https://unsplash.com/">https://unsplash.com/</a></li><li>Pexels: <a href="https://www.pexels.com/zh-cn/">https://www.pexels.com/zh-cn/</a></li><li>Foodiesfeed : <a href="https://www.foodiesfeed.com/">https://www.foodiesfeed.com</a></li><li>CC零图片网: <a href="https://cc0.cn/">https://cc0.cn/</a></li><li>Logo神器: <a href="https://www.logosc.cn/so/">https://www.logosc.cn/so/</a></li><li>iconfont: <a href="https://www.iconfont.cn/">https://www.iconfont.cn/</a></li><li>字由: <a href="https://www.hellofont.cn/">https://www.hellofont.cn/</a></li><li>100font: <a href="https://www.100font.com/">https://www.100font.com/</a></li></ul><h3 id="💁-PDF免费工具"><a href="#💁-PDF免费工具" class="headerlink" title="💁 PDF免费工具"></a>💁 PDF免费工具</h3><ul><li>最实用PDF工具包: <a href="https://www.ilovepdf.com/zh-cn">https://www.ilovepdf.com/zh-cn</a></li><li>Light PDF: <a href="https://lightpdf.com/zh/">https://lightpdf.com/zh/</a></li><li>PDF格式转换: <a href="http://app.xunjiepdf.com/">http://app.xunjiepdf.com/</a></li></ul><h3 id="👨🔧-站长工具汇总"><a href="#👨🔧-站长工具汇总" class="headerlink" title="👨🔧 站长工具汇总"></a>👨🔧 站长工具汇总</h3><ul><li>站长之家: <a href="https://tool.chinaz.com/">https://tool.chinaz.com</a></li><li>百度统计: <a href="https://tongji.baidu.com/">https://tongji.baidu.com</a></li><li>网站排名: <a href="http://www.alexa.cn/">http://www.alexa.cn</a></li><li>友盟: <a href="https://www.umeng.com/web">https://www.umeng.com/web</a></li><li>阿里云ECS: <a href="https://www.aliyun.com/">https://www.aliyun.com/</a></li><li>腾讯云: <a href="https://curl.qcloud.com/Rqy4Deo2">https://curl.qcloud.com/Rqy4Deo2</a></li><li>华为云: <a href="https://www.huaweicloud.com/">https://www.huaweicloud.com</a></li><li>极客增长: <a href="https://yinliu.club/member/KeywordHot/index">https://yinliu.club/member/KeywordHot/index</a></li><li>二十次幂: <a href="https://www.cimidata.com/?refcode=PEyZMk">https://www.cimidata.com/?refcode=PEyZMk</a></li><li>大数据导航: <a href="http://hao.199it.com/">http://hao.199it.com</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL优化</title>
    <link href="/2022/11/15/MySQL%E4%BC%98%E5%8C%96/"/>
    <url>/2022/11/15/MySQL%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<blockquote><p>有情怀，有干货，微信搜索【<strong>三太子敖丙</strong>】关注这个不一样的程序员。</p><p>本文 <strong>GitHub</strong> <a href="https://link.juejin.cn/?target=https://github.com/AobingJava/JavaFamily" title="https://github.com/AobingJava/JavaFamily">github.com&#x2F;JavaFamily</a> 已收录，有一线大厂面试完整考点、资料以及我的系列文章。<br>原文链接:<a href="https://juejin.cn/post/6895507965899063310#heading-1">https://juejin.cn/post/6895507965899063310#heading-1</a></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这天我正在午休呢，公司DBA就把我喊醒了，说某库出现大量慢SQL，很快啊，很快，我还没反应过来，库就挂了，我心想现在的用户不讲武德啊，怎么在我睡觉的时候大量请求呢。</p><p>这是很常见的一个场景哈，因为很多业务开始数据量级不大，所以写sql的时候就没注意性能，等量级上去，很多业务就需要做调优了，在电商公司工作的这几年我也总结了不少，下面就分享给大家吧。</p><p>在代码开发过程中，我们都会遵循一些SQL开发规范去编写高质量SQL，来提高接口的Response Time(RT)，对一些核心接口要求RT在100ms以内甚至更低。</p><p>由于业务前期数据量比较小，基本都能满足这个要求，但随着业务量的增长，数据量也随之增加，对应接口的SQL耗时也在变长，直接影响了用户的体验，这时候就需要对SQL进行优化。</p><p>优化点主要包括SQL规范性检查，表结构索引检查，SQL优化案例分析，下面从这三方面结合实际案例聊聊如何优化SQL。</p><h2 id="SQL规范性检查"><a href="#SQL规范性检查" class="headerlink" title="SQL规范性检查"></a>SQL规范性检查</h2><p>每个公司都有自己的MySQL开发规范，基本上大同小异，这里罗列一些比较重要的，我工作期间经常接触的给大家。</p><h3 id="select检查"><a href="#select检查" class="headerlink" title="select检查"></a>select检查</h3><p><strong>UDF用户自定义函数</strong></p><p>SQL语句的select后面使用了自定义函数UDF，SQL返回多少行，那么UDF函数就会被调用多少次，这是非常影响性能的。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#getOrderNo是用户自定义一个函数用户来根据order_sn来获取订单编号select id, payment_id, order_sn, getOrderNo(order_sn) from payment_transaction where status &#x3D; 1 and create_time between &#39;2020-10-01 10:00:00&#39; and &#39;2020-10-02 10:00:00&#39;;</code></pre></div></figure><p><strong>text类型检查</strong></p><p>如果select出现text类型的字段，就会消耗大量的网络和IO带宽，由于返回的内容过大超过max_allowed_packet设置会导致程序报错，需要评估谨慎使用。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#表request_log的中content是text类型。select user_id, content, status, url, type from request_log where user_id &#x3D; 32121;</code></pre></div></figure><p><strong>group_concat谨慎使用</strong></p><p>gorup_concat是一个字符串聚合函数，会影响SQL的响应时间，如果返回的值过大超过了max_allowed_packet设置会导致程序报错。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select batch_id, group_concat(name) from buffer_batch where status &#x3D; 0 and create_time between &#39;2020-10-01 10:00:00&#39; and &#39;2020-10-02 10:00:00&#39;;</code></pre></div></figure><p><strong>内联子查询</strong></p><p>在select后面有子查询的情况称为内联子查询，SQL返回多少行，子查询就需要执行过多少次，严重影响SQL性能。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id,(select rule_name from member_rule limit 1) as rule_name, member_id, member_type, member_name, status  from member_info m where status &#x3D; 1 and create_time between &#39;2020-09-02 10:00:00&#39; and &#39;2020-10-01 10:00:00&#39;;</code></pre></div></figure><h3 id="from检查"><a href="#from检查" class="headerlink" title="from检查"></a>from检查</h3><p><strong>表的链接方式</strong></p><p>在MySQL中不建议使用Left Join，即使ON过滤条件列索引，一些情况也不会走索引，导致大量的数据行被扫描，SQL性能变得很差，同时要清楚ON和Where的区别。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT a.member_id,a.create_time,b.active_time FROM operation_log a LEFT JOIN member_info b ON a.member_id &#x3D; b.member_id where  b.&#96;status&#96; &#x3D; 1and a.create_time between &#39;2020-10-01 00:00:00&#39; and &#39;2020-10-30 00:00:00&#39; limit 100, 0;</code></pre></div></figure><p><strong>子查询</strong></p><p>由于MySQL的基于成本的优化器CBO对子查询的处理能力比较弱，不建议使用子查询，可以改写成Inner Join。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select b.member_id,b.member_type, a.create_time,a.device_model from member_operation_log a inner join (select member_id,member_type from member_base_info where &#96;status&#96; &#x3D; 1and create_time between &#39;2020-10-01 00:00:00&#39; and &#39;2020-10-30 00:00:00&#39;) as b on a.member_id &#x3D; b.member_id;</code></pre></div></figure><h3 id="where检查"><a href="#where检查" class="headerlink" title="where检查"></a>where检查</h3><p><strong>索引列被运算</strong></p><p>当一个字段被索引，同时出现where条件后面，是不能进行任何运算，会导致索引失效。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#device_no列上有索引，由于使用了ltrim函数导致索引失效select id, name , phone, address, device_no from users where ltrim(device_no) &#x3D; &#39;Hfs1212121&#39;;#balance列有索引,由于做了运算导致索引失效select account_no, balance from accounts where balance + 100 &#x3D; 10000 and status &#x3D; 1;</code></pre></div></figure><p><strong>类型转换</strong></p><p>对于Int类型的字段，传varchar类型的值是可以走索引，MySQL内部自动做了隐式类型转换；相反对于varchar类型字段传入Int值是无法走索引的，应该做到对应的字段类型传对应的值总是对的。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#user_id是bigint类型，传入varchar值发生了隐式类型转换，可以走索引。select id, name , phone, address, device_no from users where user_id &#x3D; &#39;23126&#39;;#card_no是varchar(20)，传入int值是无法走索引select id, name , phone, address, device_no from users where card_no &#x3D; 2312612121;</code></pre></div></figure><p><strong>列字符集</strong></p><p>从MySQL 5.6开始建议所有对象字符集应该使用用utf8mb4，包括MySQL实例字符集，数据库字符集，表字符集，列字符集。避免在关联查询Join时字段字符集不匹配导致索引失效，同时目前只有utf8mb4支持emoji表情存储。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">character_set_server  &#x3D;  utf8mb4    #数据库实例字符集character_set_connection &#x3D; utf8mb4  #连接字符集character_set_database &#x3D; utf8mb4    #数据库字符集character_set_results &#x3D; utf8mb4     #结果集字符集</code></pre></div></figure><h3 id="group-by检查"><a href="#group-by检查" class="headerlink" title="group by检查"></a>group by检查</h3><p><strong>前缀索引</strong></p><p>group by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#device_no字段类型varchar(200)，创建了前缀索引。mysql&gt; alter table users add index idx_device_no(device_no(64));mysql&gt; select device_no, count(*) from users where create_time between &#39;2020-10-01 00:00:00&#39; and &#39;2020-10-30 00:00:00&#39; group by device_no;</code></pre></div></figure><p><strong>函数运算</strong></p><p>假设需要统计某月每天的新增用户量，参考如下SQL语句，虽然可以走create_time的索引，但是不能消除排序，可以考虑冗余一个字段stats_date date类型来解决这种问题。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select DATE_FORMAT(create_time, &#39;%Y-%m-%d&#39;), count(*) from users where create_time between &#39;2020-09-01 00:00:00&#39; and &#39;2020-09-30 23:59:59&#39; group by DATE_FORMAT(create_time, &#39;%Y-%m-%d&#39;);</code></pre></div></figure><h3 id="order-by检查"><a href="#order-by检查" class="headerlink" title="order by检查"></a>order by检查</h3><p><strong>前缀索引</strong></p><p>order by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</p><p><strong>字段顺序</strong></p><p>排序字段顺序，asc&#x2F;desc升降要跟索引保持一致，充分利用索引的有序性来消除排序带来的CPU开销。</p><h3 id="limit检查"><a href="#limit检查" class="headerlink" title="limit检查"></a>limit检查</h3><p><strong>limit m,n要慎重</strong></p><p>对于limit m, n分页查询，越往后面翻页即m越大的情况下SQL的耗时会越来越长，对于这种应该先取出主键id，然后通过主键id跟原表进行Join关联查询。</p><h2 id="表结构检查"><a href="#表结构检查" class="headerlink" title="表结构检查"></a>表结构检查</h2><h3 id="表-amp-列名关键字"><a href="#表-amp-列名关键字" class="headerlink" title="表&amp;列名关键字"></a>表&amp;列名关键字</h3><p>在数据库设计建模阶段，对表名及字段名设置要合理，不能使用MySQL的关键字，如desc, order, status, group等。同时建议设置lower_case_table_names &#x3D; 1表名不区分大小写。</p><h3 id="表存储引擎"><a href="#表存储引擎" class="headerlink" title="表存储引擎"></a>表存储引擎</h3><p>对于OLTP业务系统，建议使用InnoDB引擎获取更好的性能，可以通过参数default_storage_engine控制。</p><h3 id="AUTO-INCREMENT属性"><a href="#AUTO-INCREMENT属性" class="headerlink" title="AUTO_INCREMENT属性"></a>AUTO_INCREMENT属性</h3><p>建表的时候主键id带有AUTO_INCREMENT属性，而且AUTO_INCREMENT&#x3D;1，在InnoDB内部是通过一个系统全局变量dict_sys.row_id来计数，row_id是一个8字节的bigint unsigned，InnoDB在设计时只给row_id保留了6个字节的长度，这样row_id取值范围就是0到2^48 - 1，如果id的值达到了最大值，下一个值就从0开始继续循环递增，在代码中禁止指定主键id值插入。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#新插入的id值会从10001开始，这是不对的，应该从1开始。create table booking( &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;主键id&#39;,......) engine &#x3D; InnoDB auto_increment &#x3D; 10000;#指定了id值插入，后续自增就会从该值开始+1，索引禁止指定id值插入。insert into booking(id, book_sn) values(1234551121, &#39;N12121&#39;);</code></pre></div></figure><h3 id="NOT-NULL属性"><a href="#NOT-NULL属性" class="headerlink" title="NOT NULL属性"></a>NOT NULL属性</h3><p>根据业务含义，尽量将字段都添加上NOT NULL DEFAULT VALUE属性，如果列值存储了大量的NULL，会影响索引的稳定性。</p><h3 id="DEFAULT属性"><a href="#DEFAULT属性" class="headerlink" title="DEFAULT属性"></a>DEFAULT属性</h3><p>在创建表的时候，建议每个字段尽量都有默认值，禁止DEFAULT NULL，而是对字段类型填充响应的默认值。</p><h3 id="COMMENT属性"><a href="#COMMENT属性" class="headerlink" title="COMMENT属性"></a>COMMENT属性</h3><p>字段的备注要能明确该字段的作用，尤其是某些表示状态的字段，要显式的写出该字段所有可能的状态数值以及该数值的含义。</p><h3 id="TEXT类型"><a href="#TEXT类型" class="headerlink" title="TEXT类型"></a>TEXT类型</h3><p>不建议使用Text数据类型，一方面由于传输大量的数据包可能会超过max_allowed_packet设置导致程序报错，另一方面表上的DML操作都会变的很慢，建议采用es或者对象存储OSS来存储和检索。</p><h2 id="索引检查"><a href="#索引检查" class="headerlink" title="索引检查"></a>索引检查</h2><h3 id="索引属性"><a href="#索引属性" class="headerlink" title="索引属性"></a>索引属性</h3><p>索引基数指的是被索引的列唯一值的个数，唯一值越多接近表的count(*)说明索引的选择率越高，通过索引扫描的行数就越少，性能就越高，例如主键id的选择率是100%，在MySQL中尽量所有的update都使用主键id去更新，因为id是聚集索引存储着整行数据，不需要回表，性能是最高的。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">mysql&gt; select count(*) from member_info;+----------+| count(*) |+----------+|   148416 |+----------+1 row in set (0.35 sec)mysql&gt; show index from member_base_info;+------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| Table            | Non_unique | Key_name                   | Seq_in_index | Column_name       | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |+------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| member_info |          0 | PRIMARY                    |            1 | id                | A         |      131088 | NULL     | NULL   |      | BTREE      |         |               || member_info |          0 | uk_member_id               |            1 | member_id         | A         |      131824 | NULL     | NULL   |      | BTREE      |         |               || member_info |          1 | idx_create_time            |            1 | create_time       | A         |        6770 | NULL     | NULL   |      | BTREE      |         |               |+------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+#Table： 表名#Non_unique ：是否为unique index，0-是，1-否。#Key_name：索引名称#Seq_in_index：索引中的顺序号，单列索引-都是1；复合索引-根据索引列的顺序从1开始递增。#Column_name：索引的列名#Collation：排序顺序，如果没有指定asc&#x2F;desc，默认都是升序ASC。#Cardinality：索引基数-索引列唯一值的个数。#sub_part：前缀索引的长度；例如index (member_name(10)，长度就是10。#Packed：索引的组织方式，默认是NULL。#Null：YES:索引列包含Null值；&#39;&#39;:索引不包含Null值。#Index_type：默认是BTREE，其他的值FULLTEXT，HASH，RTREE。#Comment：在索引列中没有被描述的信息，例如索引被禁用。#Index_comment：创建索引时的备注。</code></pre></div></figure><h3 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h3><p>对于变长字符串类型varchar(m)，为了减少key_len，可以考虑创建前缀索引，但是前缀索引不能消除group by， order by带来排序开销。如果字段的实际最大值比m小很多，建议缩小字段长度。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">alter table member_info add index idx_member_name_part(member_name(10));</code></pre></div></figure><h3 id="复合索引顺序"><a href="#复合索引顺序" class="headerlink" title="复合索引顺序"></a>复合索引顺序</h3><p>有很多人喜欢在创建复合索引的时候，总以为前导列一定是唯一值多的列，例如索引index idx_create_time_status(create_time, status)，这个索引往往是无法命中，因为扫描的IO次数太多，总体的cost的比全表扫描还大，CBO最终的选择是走full table scan。</p><p>MySQL遵循的是索引最左匹配原则，对于复合索引，从左到右依次扫描索引列，到遇到第一个范围查询（&gt;&#x3D;, &gt;,&lt;, &lt;&#x3D;, between ….. and ….）就停止扫描，索引正确的索引顺序应该是index idx_status_create_time(status, create_time)。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select account_no, balance from accounts where status &#x3D; 1 and create_time between &#39;2020-09-01 00:00:00&#39; and &#39;2020-09-30 23:59:59&#39;;</code></pre></div></figure><h3 id="时间列索引"><a href="#时间列索引" class="headerlink" title="时间列索引"></a>时间列索引</h3><p>对于默认字段created_at(create_time)、updated_at(update_time)这种默认就应该创建索引，这一般来说是默认的规则。</p><h2 id="SQL优化案例"><a href="#SQL优化案例" class="headerlink" title="SQL优化案例"></a>SQL优化案例</h2><p>通过对慢查询的监控告警，经常发现一些SQL语句where过滤字段都有索引，但是由于SQL写法的问题导致索引失效，下面二个案例告诉大家如何通过SQL改写来查询。可以通过以下SQL来捞取最近5分钟的慢查询进行告警。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select CONCAT( &#39;# Time: &#39;, DATE_FORMAT(start_time, &#39;%y%m%d %H%i%s&#39;), &#39;\n&#39;, &#39;# User@Host: &#39;, user_host, &#39;\n&#39;, &#39;# Query_time: &#39;, TIME_TO_SEC(query_time),  &#39;  Lock_time: &#39;, TIME_TO_SEC(lock_time), &#39;  Rows_sent: &#39;, rows_sent, &#39;  Rows_examined: &#39;, rows_examined, &#39;\n&#39;, sql_text, &#39;;&#39; ) FROM mysql.slow_log where start_time between current_timestamp and date_add(CURRENT_TIMESTAMP,INTERVAL -5 MINUTE);</code></pre></div></figure><h3 id="慢查询SQL"><a href="#慢查询SQL" class="headerlink" title="慢查询SQL"></a>慢查询SQL</h3><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| 2020-10-02 19:17:23 | w_mini_user[w_mini_user] @  [10.200.20.11] | 00:00:02   | 00:00:00  |         9 |        443117 | mini_user |              0 |         0 | 168387936 | select id,club_id,reason,status,type,created_time,invite_id,falg_admin,file_id from t_user_msg where 1 and (team_id in (3212) and app_id is not null) or (invite_id&#x3D;12395 or applicant_id&#x3D;12395) order by created_time desc limit 0,10; | 1219921665 |</code></pre></div></figure><p>从慢查询slow_log可以看到，执行时间2s，扫描了443117行，只返回了9行，这是不合理的。</p><h3 id="SQL分析"><a href="#SQL分析" class="headerlink" title="SQL分析"></a>SQL分析</h3><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#原始SQL，频繁访问的接口，目前执行时间2s。select id,team_id,reason,status,type,created_time,invite_id,falg_admin,file_id from t_user_msg where 1 and (team_id in (3212) and app_id is not null) or (invite_id&#x3D;12395 or app_id&#x3D;12395) order by created_time desc limit 0,10;#执行计划+----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+| id | select_type | table        | type  | possible_keys                   | key        | key_len | ref  | rows | Extra       |+----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+|  1 | SIMPLE      | t_user_msg | index | invite_id,app_id,team_id | created_time | 5       | NULL |   10 | Using where |+----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+1 row in set (0.00 sec)</code></pre></div></figure><p>从执行计划可以看到，表上有单列索引invite_id,app_id,team_id,created_time，走的是create_time的索引，而且type&#x3D;index索引全扫描，因为create_time没有出现在where条件后，只出现在order by后面，只能是type&#x3D;index，这也预示着表数据量越大该SQL越慢，我们期望是走三个单列索引invite_id，app_id，team_id，然后type&#x3D;index_merge操作。</p><p>按照常规思路，对于OR条件拆分两部分，分别进行分析。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id, ……. from t_user_msg where 1 and  **(team_id in (3212) and app_id is not null)** order by created_time desc limit 0,10;</code></pre></div></figure><p>从执行计划看走的是team_id的索引，没有问题。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| id | select_type | table        | type | possible_keys        | key     | key_len | ref   | rows | Extra                       |+----+-------------+--------------+------+----------------------+---------+---------+-------+------+-----------------------------+|  1 | SIMPLE      | t_user_msg | ref  | app_id,team_id | team_id | 8       | const |   30 | Using where; Using filesort |</code></pre></div></figure><p>再看另外一个sql语句：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id, ……. from t_user_msg where 1 and  **(invite_id&#x3D;12395 or app_id&#x3D;12395)** order by created_time desc limit 0,10;</code></pre></div></figure><p>从执行计划上看，分别走的是invite_id,app_id的单列索引，同时做了index_merge合并操作，也没有问题。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| id | select_type | table        | type        | possible_keys           | key                     | key_len | ref  | rows | Extra                                                             |+----+-------------+--------------+-------------+-------------------------+-------------------------+---------+------+------+-------------------------------------------------------------------+|  1 | SIMPLE      | t_user_msg | index_merge | invite_id,app_id | invite_id,app_id | 9,9     | NULL |    2 | Using union(invite_id,app_id); Using where; Using filesort |</code></pre></div></figure><p><strong>通过上面的分析，第一部分SQL走的执行计划走team_id索引没问题，第二部分SQL分别走invite_id,app_id索引并且index_merge也没问题，为什么两部分SQL进行OR关联之后走create_time的单列索引呢，不应该是三个单列索引的index_merge吗？</strong></p><p><strong>index_merge默认是在优化器选项是开启的，主要是将多个范围扫描的结果集合并成一个，可以通过变量查看。</strong></p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">mysql &gt;select @@optimizer_switch;| index_merge&#x3D;on,index_merge_union&#x3D;on,index_merge_sort_union&#x3D;on,index_merge_intersection&#x3D;on,</code></pre></div></figure><p>其他三个字段都传入的是具体的值，而且都走了相应的索引，只能怀疑app_id is not null这个条件影响了CBO对最终执行计划的选择，去掉这个条件来看执行计划，竟然走了三个单列索引且type&#x3D;index_merge，那下面只要搞定<strong>app_id is not null</strong>这个条件就OK了吧。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| id | select_type | table        | type        | possible_keys                   | key                             | key_len | ref  | rows | Extra                                                                     |+----+-------------+--------------+-------------+---------------------------------+---------------------------------+---------+------+------+---------------------------------------------------------------------------+|  1 | SIMPLE      | t_user_msg | index_merge | invite_id,app_id,teadm_id | team_id,invite_id,app_id | 8,9,9   | NULL |   32 | Using union(team_id,invite_id,app_id); Using where; Using filesort |</code></pre></div></figure><h3 id="SQL改写"><a href="#SQL改写" class="headerlink" title="SQL改写"></a>SQL改写</h3><p>通过上面分析得知，条件app_id is not null影响了CBO的选择，下面进行改造。</p><p><strong>改写优化1</strong></p><p>根据SQL开发规范改写，将OR改写成Union All方式即可，最终的SQL如下：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id, ……. from (select id, ……. from t_user_msg where **1 and (club_id in (5821) and applicant_id is not null)**        **union all** select id, ……. from t_user_msg where **1 and invitee_id&#x3D;&#39;146737&#39;**        **union all** select id, ……. from  t_user_msg where **1 and app_id&#x3D;&#39;146737&#39;**       ) as a order by created_time desc limit 0,10;</code></pre></div></figure><p>一般情况下，Java代码和SQL是分开的，SQL是配置在xml文件中，根据业务需求，除了team_id是必填，其他两个都是可选的，所以这种改写虽然能提高SQL执行效率，但不适合这种业务场景。</p><p><strong>改写优化2</strong></p><p>app_id is not null 改写为**IFNULL(app_id, 0) &gt;0)**，最终的SQL为：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id,team_id,reason,status,type,created_time,invite_id,falg_admin,file_id from t_user_msg where 1 and (team_id in (3212) and **IFNULL(app_id, 0) &gt;0)**) or (invite_id&#x3D;12395 or app_id&#x3D;12395) order by created_time desc limit 0,10;</code></pre></div></figure><p><strong>改写优化3</strong></p><p>将字段app_id bigint(20) DEFAULT NULL，变更为app_id bigint(20) <strong>NOT NULL DEFAULT 0</strong>，同时更新将app_id is null的时候全部更新成0，就可以将条件app_id is not null 转换为app_id &gt; 0，最终的SQL为：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id,team_id,reason,status,type,created_at,invite_id,falg_admin,file_id from t_user_msg where 1 and (team_id in (3212) and **app_id &gt; 0)**) or (invite_id&#x3D;12395 or app_id&#x3D;12395) order by created_time desc limit 0,10;</code></pre></div></figure><p>从执行计划看，两种改写优化方式都走三个单列索引，执行时间从2s降低至10ms，线上采用的是<strong>优化1</strong>的方式，如果一开始能遵循MySQL开发规范就就会避免问题的发生。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面介绍了SQL规范性检查，表结构检查，索引检查以及通过SQL改写来优化查询，在编写代码的过程，如果能提前做这些规范性检查，评估出自己认为理想的执行计划，然后通过explain解析出MySQL CBO的执行计划，两者做对比分析差异，弄清楚自己的选择和CBO的不同，不但能够编写高质量的SQL，同时也能清楚CBO的工作原理。</p><blockquote><p>文章持续更新，可以微信搜一搜「 <strong>三太子敖丙</strong> 」第一时间阅读，回复【<strong>资料</strong>】有我准备的一线大厂面试资料和简历模板，本文 <strong>GitHub</strong> <a href="https://link.juejin.cn/?target=https://github.com/AobingJava/JavaFamily" title="https://github.com/AobingJava/JavaFamily">github.com&#x2F;JavaFamily</a> 已经收录，有大厂面试完整考点，欢迎Star。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>数据分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>SQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python高级内容</title>
    <link href="/2022/11/15/Python%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/11/15/Python%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>摘自廖雪峰老师python教程：<br>原文链接：<a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017451662295584">https://www.liaoxuefeng.com/wiki/1016959663602400/1017451662295584</a><br>参考链接：<a href="https://www.bilibili.com/video/BV1Vv411x7hj/?p=1&amp;vd_source=356ed72c41c85a755e40d7f41bb5e733">https://www.bilibili.com/video/BV1Vv411x7hj/?p=1&amp;vd_source=356ed72c41c85a755e40d7f41bb5e733</a></p></blockquote><h2 id="可变参数和关键字参数"><a href="#可变参数和关键字参数" class="headerlink" title="可变参数和关键字参数"></a>可变参数和关键字参数</h2><p>可变参数<br>参数个数不确定，我们首先想到可以把a，b，c……作为一个list或tuple传进来，这样，函数可以定义如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token operator">*</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> n <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>        <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token operator">+</span> n <span class="token operator">*</span> n    <span class="token keyword">return</span> <span class="token builtin">sum</span></code></pre></div></figure><p>关键字参数<br>可变参数允许你传入0个或任意个参数，这些可变参数在函数调用时自动组装为一个tuple。而关键字参数允许你传入0个或任意个含参数名的参数，这些关键字参数在函数内部自动组装为一个dict。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">'age:'</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token string">'other:'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">'Bob'</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">'Beijing'</span><span class="token punctuation">)</span>name<span class="token punctuation">:</span> Bob age<span class="token punctuation">:</span> <span class="token number">35</span> other<span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'Beijing'</span><span class="token punctuation">&#125;</span><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">'Adam'</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token string">'M'</span><span class="token punctuation">,</span> job<span class="token operator">=</span><span class="token string">'Engineer'</span><span class="token punctuation">)</span>name<span class="token punctuation">:</span> Adam age<span class="token punctuation">:</span> <span class="token number">45</span> other<span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'gender'</span><span class="token punctuation">:</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'job'</span><span class="token punctuation">:</span> <span class="token string">'Engineer'</span><span class="token punctuation">&#125;</span></code></pre></div></figure><h2 id="递归函数"><a href="#递归函数" class="headerlink" title="递归函数"></a>递归函数</h2><p>在函数内部，可以调用其他函数。如果一个函数在内部调用自身本身，这个函数就是递归函数。</p><p>举个例子，我们来计算阶乘n! &#x3D; 1 x 2 x 3 x … x n，用函数fact(n)表示，可以看出：</p><p>fact(n)=n!=1×2×3×⋅⋅⋅×(n−1)×n=(n−1)!×n=fact(n−1)×nfact(n)&#x3D;n!&#x3D;1\times2\times3\times\cdot\cdot\cdot\times(n-1)\times n&#x3D;(n-1)!\times n&#x3D;fact(n-1)\times n</p><p>所以，fact(n)可以表示为n x fact(n-1)，只有n&#x3D;1时需要特殊处理。</p><p>于是，fact(n)用递归的方式写出来就是：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fact</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">1</span>    <span class="token keyword">return</span> n <span class="token operator">*</span> fact<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></code></pre></div></figure><h2 id="列表生成式"><a href="#列表生成式" class="headerlink" title="列表生成式"></a>列表生成式</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code></pre></div></figure><p>写列表生成式时，把要生成的元素x * x放到前面，后面跟for循环，就可以把list创建出来，十分有用，多写几次，很快就可以熟悉这种语法。</p><p>for循环后面还可以加上if判断，这样我们就可以筛选出仅偶数的平方：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code></pre></div></figure><p>还可以使用两层循环，可以生成全排列：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>m <span class="token operator">+</span> n <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token string">'ABC'</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token string">'XYZ'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'AX'</span><span class="token punctuation">,</span> <span class="token string">'AY'</span><span class="token punctuation">,</span> <span class="token string">'AZ'</span><span class="token punctuation">,</span> <span class="token string">'BX'</span><span class="token punctuation">,</span> <span class="token string">'BY'</span><span class="token punctuation">,</span> <span class="token string">'BZ'</span><span class="token punctuation">,</span> <span class="token string">'CX'</span><span class="token punctuation">,</span> <span class="token string">'CY'</span><span class="token punctuation">,</span> <span class="token string">'CZ'</span><span class="token punctuation">]</span></code></pre></div></figure><p>三层和三层以上的循环就很少用到了。</p><h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><p>只要把一个列表生成式的[]改成()，就创建了一个generator：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> g<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> <span class="token operator">&lt;</span>genexpr<span class="token operator">></span> at <span class="token number">0x1022ef630</span><span class="token operator">></span></code></pre></div></figure><p>可以通过next()函数获得generator的下一个返回值：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">0</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">4</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">9</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">16</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">25</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">36</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">49</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">64</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token number">81</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>StopIteration</code></pre></div></figure><p>generator保存的是算法，每次调用next(g)，就计算出g的下一个元素的值，直到计算到最后一个元素，没有更多的元素时，抛出StopIteration的错误。</p><p>当然，上面这种不断调用next(g)实在是太变态了，正确的方法是使用for循环，因为generator也是可迭代对象：</p><figure><div class="code-wrapper"><pre class="language-java" data-language="java"><code class="language-java"><span class="token operator">>>></span> g <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">>>></span> <span class="token keyword">for</span> n in g<span class="token operator">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token function">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">0</span><span class="token number">1</span><span class="token number">4</span><span class="token number">9</span><span class="token number">16</span><span class="token number">25</span><span class="token number">36</span><span class="token number">49</span><span class="token number">64</span><span class="token number">81</span></code></pre></div></figure><p>所以，我们创建了一个generator后，基本上永远不会调用next()，而是通过for循环来迭代它，并且不需要关心StopIteration的错误。</p><h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>我们已经知道，可以直接作用于<code>for</code>循环的数据类型有以下几种：</p><p>一类是集合数据类型，如<code>list</code>、<code>tuple</code>、<code>dict</code>、<code>set</code>、<code>str</code>等；</p><p>一类是<code>generator</code>，包括生成器和带<code>yield</code>的generator function。</p><p>这些可以直接作用于<code>for</code>循环的对象统称为可迭代对象：<code>Iterable</code>。</p><p>可以使用<code>isinstance()</code>判断一个对象是否是<code>Iterable</code>对象：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterable<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span><span class="token boolean">False</span></code></pre></div></figure><p>而生成器不但可以作用于<code>for</code>循环，还可以被<code>next()</code>函数不断调用并返回下一个值，直到最后抛出<code>StopIteration</code>错误表示无法继续返回下一个值了。</p><p>可以被<code>next()</code>函数调用并不断返回下一个值的对象称为迭代器：<code>Iterator</code>。</p><p>可以使用<code>isinstance()</code>判断一个对象是否是<code>Iterator</code>对象：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterator<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token boolean">False</span></code></pre></div></figure><p>生成器都是<code>Iterator</code>对象，但<code>list</code>、<code>dict</code>、<code>str</code>虽然是<code>Iterable</code>，却不是<code>Iterator</code>。</p><p>把<code>list</code>、<code>dict</code>、<code>str</code>等<code>Iterable</code>变成<code>Iterator</code>可以使用<code>iter()</code>函数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token boolean">True</span></code></pre></div></figure><p>你可能会问，为什么<code>list</code>、<code>dict</code>、<code>str</code>等数据类型不是<code>Iterator</code>？</p><p>这是因为Python的<code>Iterator</code>对象表示的是一个数据流，Iterator对象可以被<code>next()</code>函数调用并不断返回下一个数据，直到没有数据时抛出<code>StopIteration</code>错误。可以把这个数据流看做是一个有序序列，但我们却不能提前知道序列的长度，只能不断通过<code>next()</code>函数实现按需计算下一个数据，所以<code>Iterator</code>的计算是惰性的，只有在需要返回下一个数据时它才会计算。</p><p><code>Iterator</code>甚至可以表示一个无限大的数据流，例如全体自然数。而使用list是永远不可能存储全体自然数的。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>凡是可作用于<code>for</code>循环的对象都是<code>Iterable</code>类型；</p><p>凡是可作用于<code>next()</code>函数的对象都是<code>Iterator</code>类型，它们表示一个惰性计算的序列；</p><p>集合数据类型如<code>list</code>、<code>dict</code>、<code>str</code>等是<code>Iterable</code>但不是<code>Iterator</code>，不过可以通过<code>iter()</code>函数获得一个<code>Iterator</code>对象。</p><p>Python的<code>for</code>循环本质上就是通过不断调用<code>next()</code>函数实现的，例如：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre></div></figure><p>实际上完全等价于：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 首先获得Iterator对象:</span>it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 循环:</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token comment"># 获得下一个值:</span>        x <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>    <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>        <span class="token comment"># 遇到StopIteration就退出循环</span>        <span class="token keyword">break</span></code></pre></div></figure><h3 id="参考源码"><a href="#参考源码" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/advance/do_iter.py">do_iter.py</a></p><h2 id="高级函数-map"><a href="#高级函数-map" class="headerlink" title="高级函数-map"></a>高级函数-map</h2><p>Python内建了<code>map()</code>和<code>reduce()</code>函数。</p><p>如果你读过Google的那篇大名鼎鼎的论文“<a href="http://research.google.com/archive/mapreduce.html">MapReduce: Simplified Data Processing on Large Clusters</a>”，你就能大概明白map&#x2F;reduce的概念。</p><p>我们先看map。<code>map()</code>函数接收两个参数，一个是函数，一个是<code>Iterable</code>，<code>map</code>将传入的函数依次作用到序列的每个元素，并把结果作为新的<code>Iterator</code>返回。</p><p>举例说明，比如我们有一个函数f(x)&#x3D;x<sup>2</sup>，要把这个函数作用在一个list <code>[1, 2, 3, 4, 5, 6, 7, 8, 9]</code>上，就可以用<code>map()</code>实现如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">            f<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> x <span class="token operator">*</span> x                  │                  │  ┌───┬───┬───┬───┼───┬───┬───┬───┐  │   │   │   │   │   │   │   │   │  ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼<span class="token punctuation">[</span> <span class="token number">1</span>   <span class="token number">2</span>   <span class="token number">3</span>   <span class="token number">4</span>   <span class="token number">5</span>   <span class="token number">6</span>   <span class="token number">7</span>   <span class="token number">8</span>   <span class="token number">9</span> <span class="token punctuation">]</span>  │   │   │   │   │   │   │   │   │  │   │   │   │   │   │   │   │   │  ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼<span class="token punctuation">[</span> <span class="token number">1</span>   <span class="token number">4</span>   <span class="token number">9</span>  <span class="token number">16</span>  <span class="token number">25</span>  <span class="token number">36</span>  <span class="token number">49</span>  <span class="token number">64</span>  <span class="token number">81</span> <span class="token punctuation">]</span></code></pre></div></figure><p>现在，我们用Python代码实现：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">*</span> x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span></code></pre></div></figure><p><code>map()</code>传入的第一个参数是<code>f</code>，即函数对象本身。由于结果<code>r</code>是一个<code>Iterator</code>，<code>Iterator</code>是惰性序列，因此通过<code>list()</code>函数让它把整个序列都计算出来并返回一个list。</p><p>你可能会想，不需要<code>map()</code>函数，写一个循环，也可以计算出结果：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span></code></pre></div></figure><p>的确可以，但是，从上面的循环代码，能一眼看明白“把f(x)作用在list的每一个元素并把结果生成一个新的list”吗？</p><p>所以，<code>map()</code>作为高阶函数，事实上它把运算规则抽象了，因此，我们不但可以计算简单的f(x)&#x3D;x<sup>2</sup>，还可以计算任意复杂的函数，比如，把这个list所有数字转为字符串：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">]</span></code></pre></div></figure><p>只需要一行代码。</p><p>再看<code>reduce</code>的用法。<code>reduce</code>把一个函数作用在一个序列<code>[x1, x2, x3, ...]</code>上，这个函数必须接收两个参数，<code>reduce</code>把结果继续和序列的下一个元素做累积计算，其效果就是：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token builtin">reduce</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> x4<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> f<span class="token punctuation">(</span>f<span class="token punctuation">(</span>f<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> x4<span class="token punctuation">)</span></code></pre></div></figure><p>比方说对一个序列求和，就可以用<code>reduce</code>实现：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">25</span></code></pre></div></figure><p>当然求和运算可以直接用Python内建函数<code>sum()</code>，没必要动用<code>reduce</code>。</p><p>但是如果要把序列<code>[1, 3, 5, 7, 9]</code>变换成整数<code>13579</code>，<code>reduce</code>就可以派上用场：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">13579</span></code></pre></div></figure><p>这个例子本身没多大用处，但是，如果考虑到字符串<code>str</code>也是一个序列，对上面的例子稍加改动，配合<code>map()</code>，我们就可以写出把<code>str</code>转换为<code>int</code>的函数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">char2num</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     digits <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> digits<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">(</span>char2num<span class="token punctuation">,</span> <span class="token string">'13579'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">13579</span></code></pre></div></figure><p>整理成一个<code>str2int</code>的函数就是：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>DIGITS <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">str2int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y    <span class="token keyword">def</span> <span class="token function">char2num</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> DIGITS<span class="token punctuation">[</span>s<span class="token punctuation">]</span>    <span class="token keyword">return</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">(</span>char2num<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>还可以用lambda函数进一步简化成：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>DIGITS <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">char2num</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> DIGITS<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">str2int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">(</span>char2num<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>也就是说，假设Python没有提供<code>int()</code>函数，你完全可以自己写一个把字符串转化为整数的函数，而且只需要几行代码！</p><p>lambda函数的用法在后面介绍。</p><h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>利用<code>map()</code>函数，把用户输入的不规范的英文名字，变为首字母大写，其他小写的规范名字。输入：<code>[&#39;adam&#39;, &#39;LISA&#39;, &#39;barT&#39;]</code>，输出：<code>[&#39;Adam&#39;, &#39;Lisa&#39;, &#39;Bart&#39;]</code>：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 测试:</span>L1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'adam'</span><span class="token punctuation">,</span> <span class="token string">'LISA'</span><span class="token punctuation">,</span> <span class="token string">'barT'</span><span class="token punctuation">]</span>L2 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span>normalize<span class="token punctuation">,</span> L1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>L2<span class="token punctuation">)</span></code></pre></div></figure><p>Python提供的<code>sum()</code>函数可以接受一个list并求和，请编写一个<code>prod()</code>函数，可以接受一个list并利用<code>reduce()</code>求积：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'3 * 5 * 7 * 9 ='</span><span class="token punctuation">,</span> prod<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> prod<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">945</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试成功!'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span></code></pre></div></figure><p>利用<code>map</code>和<code>reduce</code>编写一个<code>str2float</code>函数，把字符串<code>&#39;123.456&#39;</code>转换成浮点数<code>123.456</code>：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span><span class="token keyword">def</span> <span class="token function">str2float</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'str2float(\'123.456\') ='</span><span class="token punctuation">,</span> str2float<span class="token punctuation">(</span><span class="token string">'123.456'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>str2float<span class="token punctuation">(</span><span class="token string">'123.456'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">123.456</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.00001</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试成功!'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/functional/do_map.py">do_map.py</a></p><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/functional/do_reduce.py">do_reduce.py</a></p><h2 id="返回函数"><a href="#返回函数" class="headerlink" title="返回函数"></a>返回函数</h2><h3 id="函数作为返回值"><a href="#函数作为返回值" class="headerlink" title="函数作为返回值"></a>函数作为返回值</h3><p>高阶函数除了可以接受函数作为参数外，还可以把函数作为结果值返回。</p><p>我们来实现一个可变参数的求和。通常情况下，求和的函数是这样定义的：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calc_sum</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>    ax <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> n <span class="token keyword">in</span> args<span class="token punctuation">:</span>        ax <span class="token operator">=</span> ax <span class="token operator">+</span> n    <span class="token keyword">return</span> ax</code></pre></div></figure><p>但是，如果不需要立刻求和，而是在后面的代码中，根据需要再计算怎么办？可以不返回求和的结果，而是返回求和的函数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">lazy_sum</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        ax <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> n <span class="token keyword">in</span> args<span class="token punctuation">:</span>            ax <span class="token operator">=</span> ax <span class="token operator">+</span> n        <span class="token keyword">return</span> ax    <span class="token keyword">return</span> <span class="token builtin">sum</span></code></pre></div></figure><p>当我们调用<code>lazy_sum()</code>时，返回的并不是求和结果，而是求和函数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token operator">&lt;</span>function lazy_sum<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token builtin">sum</span> at <span class="token number">0x101c6ed90</span><span class="token operator">></span></code></pre></div></figure><p>调用函数<code>f</code>时，才真正计算求和的结果：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">25</span></code></pre></div></figure><p>在这个例子中，我们在函数<code>lazy_sum</code>中又定义了函数<code>sum</code>，并且，内部函数<code>sum</code>可以引用外部函数<code>lazy_sum</code>的参数和局部变量，当<code>lazy_sum</code>返回函数<code>sum</code>时，相关参数和变量都保存在返回的函数中，这种称为“闭包（Closure）”的程序结构拥有极大的威力。</p><p>请再注意一点，当我们调用<code>lazy_sum()</code>时，每次调用都会返回一个新的函数，即使传入相同的参数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f1 <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> f2 <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> f1<span class="token operator">==</span>f2<span class="token boolean">False</span></code></pre></div></figure><p><code>f1()</code>和<code>f2()</code>的调用结果互不影响。</p><h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p>注意到返回的函数在其定义内部引用了局部变量<code>args</code>，所以，当一个函数返回了一个函数后，其内部的局部变量还被新函数引用，所以，闭包用起来简单，实现起来可不容易。</p><p>另一个需要注意的问题是，返回的函数并没有立刻执行，而是直到调用了<code>f()</code>才执行。我们来看一个例子：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    fs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token keyword">return</span> i<span class="token operator">*</span>i        fs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">)</span>    <span class="token keyword">return</span> fsf1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3 <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p>在上面的例子中，每次循环，都创建了一个新的函数，然后，把创建的3个函数都返回了。</p><p>你可能认为调用<code>f1()</code>，<code>f2()</code>和<code>f3()</code>结果应该是<code>1</code>，<code>4</code>，<code>9</code>，但实际结果是：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">9</span><span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">9</span><span class="token operator">>></span><span class="token operator">></span> f3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">9</span></code></pre></div></figure><p>全部都是<code>9</code>！原因就在于返回的函数引用了变量<code>i</code>，但它并非立刻执行。等到3个函数都返回时，它们所引用的变量<code>i</code>已经变成了<code>3</code>，因此最终结果为<code>9</code>。</p><p>返回闭包时牢记一点：返回函数不要引用任何循环变量，或者后续会发生变化的变量。</p><p>如果一定要引用循环变量怎么办？方法是再创建一个函数，用该函数的参数绑定循环变量当前的值，无论该循环变量后续如何更改，已绑定到函数参数的值不变：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> j<span class="token operator">*</span>j        <span class="token keyword">return</span> g    fs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        fs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># f(i)立刻被执行，因此i的当前值被传入f()</span>    <span class="token keyword">return</span> fs</code></pre></div></figure><p>再看看结果：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3 <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">4</span><span class="token operator">>></span><span class="token operator">></span> f3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">9</span></code></pre></div></figure><p>缺点是代码较长，可利用lambda函数缩短代码。</p><h3 id="nonlocal"><a href="#nonlocal" class="headerlink" title="nonlocal"></a>nonlocal</h3><p>使用闭包，就是内层函数引用了外层函数的局部变量。如果只是读外层变量的值，我们会发现返回的闭包函数调用一切正常：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    x <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 仅读取x的值:</span>        <span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">return</span> fnf <span class="token operator">=</span> inc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span></code></pre></div></figure><p>但是，如果对外层变量赋值，由于Python解释器会把<code>x</code>当作函数<code>fn()</code>的局部变量，它会报错：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span></code></pre></div></figure><p>原因是<code>x</code>作为局部变量并没有初始化，直接计算<code>x+1</code>是不行的。但我们其实是想引用<code>inc()</code>函数内部的<code>x</code>，所以需要在<code>fn()</code>函数内部加一个<code>nonlocal x</code>的声明。加上这个声明后，解释器把<code>fn()</code>的<code>x</code>看作外层函数的局部变量，它已经被初始化了，可以正确计算<code>x+1</code>。</p><p>使用闭包时，对外层变量赋值前，需要先使用nonlocal声明该变量不是当前函数的局部变量。</p><h3 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h3><p>利用闭包返回一个计数器函数，每次调用它返回递增整数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 测试:</span>counterA <span class="token operator">=</span> createCounter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>counterA<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counterA<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counterA<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counterA<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counterA<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1 2 3 4 5</span>counterB <span class="token operator">=</span> createCounter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">[</span>counterB<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counterB<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counterB<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counterB<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试通过!'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>一个函数可以返回一个计算结果，也可以返回一个函数。</p><p>返回一个函数时，牢记该函数并未执行，返回函数中不要引用任何可能会变化的变量。</p><h3 id="参考源码-1"><a href="#参考源码-1" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/functional/return_func.py">return_func.py</a></p><h2 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h2><blockquote><p>原文链接：<a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017451662295584">https://www.liaoxuefeng.com/wiki/1016959663602400/1017451662295584</a><br>参考链接：<a href="https://www.bilibili.com/video/BV1Vv411x7hj/?p=1&amp;vd_source=356ed72c41c85a755e40d7f41bb5e733">https://www.bilibili.com/video/BV1Vv411x7hj/?p=1&amp;vd_source=356ed72c41c85a755e40d7f41bb5e733</a></p></blockquote><p>由于函数也是一个对象，而且函数对象可以被赋值给变量，所以，通过变量也能调用该函数。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'2015-3-25'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> now<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code></pre></div></figure><p>函数对象有一个<code>__name__</code>属性（注意：是前后各两个下划线），可以拿到函数的名字：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">.</span>__name__<span class="token string">'now'</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>__name__<span class="token string">'now'</span></code></pre></div></figure><p><em><strong>现在，假设我们要增强<code>now()</code>函数的功能，比如，在函数调用前后自动打印日志，但又不希望修改<code>now()</code>函数的定义，这种在代码运行期间动态增加功能的方式，称之为“装饰器”（Decorator）。</strong></em></p><p>本质上，decorator就是一个返回函数的高阶函数。所以，我们要定义一个能打印日志的decorator，可以定义如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'call %s():'</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper</code></pre></div></figure><p>观察上面的<code>log</code>，因为它是一个decorator，所以接受一个函数作为参数，并返回一个函数。我们要借助<strong>Python的@语法，把decorator置于函数的定义处：</strong></p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@log</span> <span class="token comment"># 这个@log等于上面的外层log函数</span><span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'2015-3-25'</span><span class="token punctuation">)</span></code></pre></div></figure><p>调用<code>now()</code>函数，不仅会运行<code>now()</code>函数本身，还会在运行<code>now()</code>函数前打印一行日志：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">(</span><span class="token punctuation">)</span>call now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code></pre></div></figure><p>把<code>@log</code>放到<code>now()</code>函数的定义处，相当于执行了语句：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">now <span class="token operator">=</span> log<span class="token punctuation">(</span>now<span class="token punctuation">)</span></code></pre></div></figure><p>由于<code>log()</code>是一个decorator，返回一个函数，所以，原来的<code>now()</code>函数仍然存在，只是现在同名的<code>now</code>变量指向了新的函数，于是调用<code>now()</code>将执行新函数，即在<code>log()</code>函数中返回的<code>wrapper()</code>函数。</p><p><code>wrapper()</code>函数的参数定义是<code>(*args, **kw)</code>，因此，<code>wrapper()</code>函数可以接受任意参数的调用。在<code>wrapper()</code>函数内，首先打印日志，再紧接着调用原始函数。</p><p>如果decorator本身需要传入参数，那就需要编写一个返回decorator的高阶函数，写出来会更复杂。比如，要自定义log的文本：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s %s():'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>text<span class="token punctuation">,</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>        <span class="token keyword">return</span> wrapper    <span class="token keyword">return</span> decorator</code></pre></div></figure><p>这个3层嵌套的decorator用法如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@log</span><span class="token punctuation">(</span><span class="token string">'execute'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'2015-3-25'</span><span class="token punctuation">)</span></code></pre></div></figure><p>执行结果如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">(</span><span class="token punctuation">)</span>execute now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code></pre></div></figure><p>和两层嵌套的decorator相比，3层嵌套的效果是这样的：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> now <span class="token operator">=</span> log<span class="token punctuation">(</span><span class="token string">'execute'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span></code></pre></div></figure><p>我们来剖析上面的语句，首先执行<code>log(&#39;execute&#39;)</code>，返回的是<code>decorator</code>函数，再调用返回的函数，参数是<code>now</code>函数，返回值最终是<code>wrapper</code>函数。</p><p>以上两种decorator的定义都没有问题，但还差最后一步。因为我们讲了函数也是对象，它有<code>__name__</code>等属性，但你去看经过decorator装饰之后的函数，它们的<code>__name__</code>已经从原来的<code>&#39;now&#39;</code>变成了<code>&#39;wrapper&#39;</code>：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">.</span>__name__<span class="token string">'wrapper'</span></code></pre></div></figure><p>因为返回的那个<code>wrapper()</code>函数名字就是<code>&#39;wrapper&#39;</code>，所以，<strong>需要把原始函数的<code>__name__</code>等属性复制到<code>wrapper()</code>函数中</strong>，否则，有些依赖函数签名的代码执行就会出错。</p><p><strong>不需要编写<code>wrapper.__name__ = func.__name__</code>这样的代码，Python内置的<code>functools.wraps</code>就是干这个事的，所以，一个完整的decorator的写法如下：</strong></p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> functools<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@functools<span class="token punctuation">.</span>wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'call %s():'</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper</code></pre></div></figure><p>或者针对带参数的decorator：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> functools<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token decorator annotation punctuation">@functools<span class="token punctuation">.</span>wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s %s():'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>text<span class="token punctuation">,</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>        <span class="token keyword">return</span> wrapper    <span class="token keyword">return</span> decorator</code></pre></div></figure><p><code>import functools</code>是导入<code>functools</code>模块。<strong>模块的概念稍候讲解。现在，只需记住在定义<code>wrapper()</code>的前面加上<code>@functools.wraps(func)</code>即可。</strong></p><h3 id="练习-2"><a href="#练习-2" class="headerlink" title="练习"></a>练习</h3><p><em>请设计一个decorator，它可作用于任何函数上，并打印该函数的执行时间：</em></p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> time<span class="token punctuation">,</span> functools</code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 测试</span><span class="token decorator annotation punctuation">@metric</span><span class="token keyword">def</span> <span class="token function">fast</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.0012</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><span class="token decorator annotation punctuation">@metric</span><span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">:</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> x <span class="token operator">*</span> y <span class="token operator">*</span> z<span class="token punctuation">;</span>f <span class="token operator">=</span> fast<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span>s <span class="token operator">=</span> slow<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token keyword">if</span> f <span class="token operator">!=</span> <span class="token number">33</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span><span class="token keyword">elif</span> s <span class="token operator">!=</span> <span class="token number">7986</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>在面向对象（OOP）的设计模式中，decorator被称为装饰模式。OOP的装饰模式需要通过继承和组合来实现，而Python除了能支持OOP的decorator外，直接从语法层次支持decorator。Python的decorator可以用函数实现，也可以用类实现。</p><p>decorator可以增强函数的功能，定义起来虽然有点复杂，但使用起来非常灵活和方便。</p><p>请编写一个decorator，能在函数调用的前后打印出<code>&#39;begin call&#39;</code>和<code>&#39;end call&#39;</code>的日志。</p><p>再思考一下能否写出一个<code>@log</code>的decorator，使它既支持：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@log</span><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre></div></figure><p>又支持：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@log</span><span class="token punctuation">(</span><span class="token string">'execute'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre></div></figure><h3 id="参考源码-2"><a href="#参考源码-2" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/functional/decorator.py">decorator.py</a></p><h2 id="偏函数"><a href="#偏函数" class="headerlink" title="偏函数"></a>偏函数</h2><p>Python的<code>functools</code>模块提供了很多有用的功能，其中一个就是偏函数（Partial function）。要注意，这里的偏函数和数学意义上的偏函数不一样。</p><p>在介绍函数参数的时候，我们讲到，通过设定参数的默认值，可以降低函数调用的难度。而偏函数也可以做到这一点。举例如下：</p><p><code>int()</code>函数可以把字符串转换为整数，当仅传入字符串时，<code>int()</code>函数默认按十进制转换：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">'12345'</span><span class="token punctuation">)</span><span class="token number">12345</span></code></pre></div></figure><p>但<code>int()</code>函数还提供额外的<code>base</code>参数，默认值为<code>10</code>。如果传入<code>base</code>参数，就可以做N进制的转换：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">'12345'</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token number">5349</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">'12345'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token number">74565</span></code></pre></div></figure><p>假设要转换大量的二进制字符串，每次都传入<code>int(x, base=2)</code>非常麻烦，于是，我们想到，可以定义一个<code>int2()</code>的函数，默认把<code>base=2</code>传进去：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">int2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> base<span class="token punctuation">)</span></code></pre></div></figure><p>这样，我们转换二进制就非常方便了：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">'1000000'</span><span class="token punctuation">)</span><span class="token number">64</span><span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">'1010101'</span><span class="token punctuation">)</span><span class="token number">85</span></code></pre></div></figure><p><code>functools.partial</code>就是帮助我们创建一个偏函数的，不需要我们自己定义<code>int2()</code>，可以直接使用下面的代码创建一个新的函数<code>int2</code>：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> functools<span class="token operator">>></span><span class="token operator">></span> int2 <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">'1000000'</span><span class="token punctuation">)</span><span class="token number">64</span><span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">'1010101'</span><span class="token punctuation">)</span><span class="token number">85</span></code></pre></div></figure><p>所以，简单总结<code>functools.partial</code>的作用就是，把一个函数的某些参数给固定住（也就是设置默认值），返回一个新的函数，调用这个新函数会更简单。</p><p>注意到上面的新的<code>int2</code>函数，仅仅是把<code>base</code>参数重新设定默认值为<code>2</code>，但也可以在函数调用时传入其他值：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">'1000000'</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token number">1000000</span></code></pre></div></figure><p>最后，创建偏函数时，实际上可以接收函数对象、<code>*args</code>和<code>**kw</code>这3个参数，当传入：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">int2 <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></code></pre></div></figure><p>实际上固定了int()函数的关键字参数<code>base</code>，也就是：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">int2<span class="token punctuation">(</span><span class="token string">'10010'</span><span class="token punctuation">)</span></code></pre></div></figure><p>相当于：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">kw <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'base'</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">'10010'</span><span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span></code></pre></div></figure><p>当传入：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">max2 <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></code></pre></div></figure><p>实际上会把<code>10</code>作为<code>*args</code>的一部分自动加到左边，也就是：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">max2<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span></code></pre></div></figure><p>相当于：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span></code></pre></div></figure><p>结果为<code>10</code>。</p><h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><p>当函数的参数个数太多，需要简化时，使用<code>functools.partial</code>可以创建一个新的函数，这个新函数可以固定住原函数的部分参数，从而在调用时更简单。</p><h3 id="参考源码-3"><a href="#参考源码-3" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/functional/do_partial.py">do_partial.py</a></p><h2 id="类和实例"><a href="#类和实例" class="headerlink" title="类和实例"></a>类和实例</h2><p>面向对象最重要的概念就是类（Class）和实例（Instance），必须牢记类是抽象的模板，比如Student类，而实例是根据类创建出来的一个个具体的“对象”，每个对象都拥有相同的方法，但各自的数据可能不同。</p><p>仍以Student类为例，在Python中，定义类是通过<code>class</code>关键字：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre></div></figure><p><code>class</code>后面紧接着是类名，即<code>Student</code>，类名通常是大写开头的单词，紧接着是<code>(object)</code>，表示该类是从哪个类继承下来的，继承的概念我们后面再讲，通常，如果没有合适的继承类，就使用<code>object</code>类，这是所有类最终都会继承的类。</p><p>定义好了<code>Student</code>类，就可以根据<code>Student</code>类创建出<code>Student</code>的实例，创建实例是通过类名+()实现的：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x10a67a590</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> Student<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'__main__.Student'</span><span class="token operator">></span></code></pre></div></figure><p>可以看到，变量<code>bart</code>指向的就是一个<code>Student</code>的实例，后面的<code>0x10a67a590</code>是内存地址，每个object的地址都不一样，而<code>Student</code>本身则是一个类。</p><p>可以自由地给一个实例变量绑定属性，比如，给实例<code>bart</code>绑定一个<code>name</code>属性：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Bart Simpson'</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name<span class="token string">'Bart Simpson'</span></code></pre></div></figure><p>由于类可以起到模板的作用，因此，可以在创建实例的时候，把一些我们认为必须绑定的属性强制填写进去。通过定义一个特殊的<code>__init__</code>方法，在创建实例的时候，就把<code>name</code>，<code>score</code>等属性绑上去：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score</code></pre></div></figure><p>注意：特殊方法“__init__”前后分别有两个下划线！！！</p><p>注意到<code>__init__</code>方法的第一个参数永远是<code>self</code>，表示创建的实例本身，因此，在<code>__init__</code>方法内部，就可以把各种属性绑定到<code>self</code>，因为<code>self</code>就指向创建的实例本身。</p><p>有了<code>__init__</code>方法，在创建实例的时候，就不能传入空的参数了，必须传入与<code>__init__</code>方法匹配的参数，但<code>self</code>不需要传，Python解释器自己会把实例变量传进去：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Bart Simpson'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name<span class="token string">'Bart Simpson'</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score<span class="token number">59</span></code></pre></div></figure><p>和普通的函数相比，在类中定义的函数只有一点不同，就是第一个参数永远是实例变量<code>self</code>，并且，调用时，不用传递该参数。除此之外，类的方法和普通函数没有什么区别，所以，你仍然可以用默认参数、可变参数、关键字参数和命名关键字参数。</p><h3 id="数据封装"><a href="#数据封装" class="headerlink" title="数据封装"></a>数据封装</h3><p>面向对象编程的一个重要特点就是数据封装。在上面的<code>Student</code>类中，每个实例就拥有各自的<code>name</code>和<code>score</code>这些数据。我们可以通过函数来访问这些数据，比如打印一个学生的成绩：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>std<span class="token punctuation">.</span>name<span class="token punctuation">,</span> std<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> print_score<span class="token punctuation">(</span>bart<span class="token punctuation">)</span>Bart Simpson<span class="token punctuation">:</span> <span class="token number">59</span></code></pre></div></figure><p>但是，既然<code>Student</code>实例本身就拥有这些数据，要访问这些数据，就没有必要从外面的函数去访问，可以直接在<code>Student</code>类的内部定义访问数据的函数，这样，就把“数据”给封装起来了。这些封装数据的函数是和<code>Student</code>类本身是关联起来的，我们称之为类的方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>要定义一个方法，除了第一个参数是<code>self</code>外，其他和普通函数一样。要调用一个方法，只需要在实例变量上直接调用，除了<code>self</code>不用传递，其他参数正常传入：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>print_score<span class="token punctuation">(</span><span class="token punctuation">)</span>Bart Simpson<span class="token punctuation">:</span> <span class="token number">59</span></code></pre></div></figure><p>这样一来，我们从外部看<code>Student</code>类，就只需要知道，创建实例需要给出<code>name</code>和<code>score</code>，而如何打印，都是在<code>Student</code>类的内部定义的，这些数据和逻辑被“封装”起来了，调用很容易，但却不用知道内部实现的细节。</p><p>封装的另一个好处是可以给<code>Student</code>类增加新的方法，比如<code>get_grade</code>：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">get_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">90</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'A'</span>        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">60</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'B'</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'C'</span></code></pre></div></figure><p>同样的，<code>get_grade</code>方法可以直接在实例变量上调用，不需要知道内部实现细节：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">lisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Lisa'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Bart'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>lisa<span class="token punctuation">.</span>name<span class="token punctuation">,</span> lisa<span class="token punctuation">.</span>get_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>bart<span class="token punctuation">.</span>name<span class="token punctuation">,</span> bart<span class="token punctuation">.</span>get_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h3><p>类是创建实例的模板，而实例则是一个一个具体的对象，各个实例拥有的数据都互相独立，互不影响；</p><p>方法就是与实例绑定的函数，和普通函数不同，方法可以直接访问实例的数据；</p><p>通过在实例上调用方法，我们就直接操作了对象内部的数据，但无需知道方法内部的实现细节。</p><p>和静态语言不同，Python允许对实例变量绑定任何数据，也就是说，对于两个实例变量，虽然它们都是同一个类的不同实例，但拥有的变量名称都可能不同：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Bart Simpson'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> lisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Lisa Simpson'</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">8</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>age<span class="token number">8</span><span class="token operator">>></span><span class="token operator">></span> lisa<span class="token punctuation">.</span>ageTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>AttributeError<span class="token punctuation">:</span> <span class="token string">'Student'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'age'</span></code></pre></div></figure><h3 id="参考源码-4"><a href="#参考源码-4" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_basic/student.py">student.py</a></p><h2 id="访问限制"><a href="#访问限制" class="headerlink" title="访问限制"></a>访问限制</h2><p>在Class内部，可以有属性和方法，而外部代码可以通过直接调用实例变量的方法来操作数据，这样，就隐藏了内部的复杂逻辑。</p><p>但是，从前面Student类的定义来看，外部代码还是可以自由地修改一个实例的<code>name</code>、<code>score</code>属性：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Bart Simpson'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score<span class="token number">59</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">99</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score<span class="token number">99</span></code></pre></div></figure><p>如果要让内部属性不被外部访问，可以把属性的名称前加上两个下划线<code>__</code>，在Python中，实例的变量名如果以<code>__</code>开头，就变成了一个私有变量（private），只有内部可以访问，外部不能访问，所以，我们把Student类改一改：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>__name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>__score<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>改完后，对于外部代码来说，没什么变动，但是已经无法从外部访问<code>实例变量.__name</code>和<code>实例变量.__score</code>了：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Bart Simpson'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__nameTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>AttributeError<span class="token punctuation">:</span> <span class="token string">'Student'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'__name'</span></code></pre></div></figure><p>这样就确保了外部代码不能随意修改对象内部的状态，这样通过访问限制的保护，代码更加健壮。</p><p>但是如果外部代码要获取name和score怎么办？可以给Student类增加<code>get_name</code>和<code>get_score</code>这样的方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">get_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__name    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__score</code></pre></div></figure><p>如果又要允许外部代码修改score怎么办？可以再给Student类增加<code>set_score</code>方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score</code></pre></div></figure><p>你也许会问，原先那种直接通过<code>bart.score = 99</code>也可以修改啊，为什么要定义一个方法大费周折？因为在方法中，可以对参数做检查，避免传入无效的参数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> score <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'bad score'</span><span class="token punctuation">)</span></code></pre></div></figure><p>需要注意的是，在Python中，变量名类似<code>__xxx__</code>的，也就是以双下划线开头，并且以双下划线结尾的，是特殊变量，特殊变量是可以直接访问的，不是private变量，所以，不能用<code>__name__</code>、<code>__score__</code>这样的变量名。</p><p>有些时候，你会看到以一个下划线开头的实例变量名，比如<code>_name</code>，这样的实例变量外部是可以访问的，但是，按照约定俗成的规定，当你看到这样的变量时，意思就是，“虽然我可以被访问，但是，请把我视为私有变量，不要随意访问”。</p><p>双下划线开头的实例变量是不是一定不能从外部访问呢？其实也不是。不能直接访问<code>__name</code>是因为Python解释器对外把<code>__name</code>变量改成了<code>_Student__name</code>，所以，仍然可以通过<code>_Student__name</code>来访问<code>__name</code>变量：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>_Student__name<span class="token string">'Bart Simpson'</span></code></pre></div></figure><p>但是强烈建议你不要这么干，因为不同版本的Python解释器可能会把<code>__name</code>改成不同的变量名。</p><p>总的来说就是，Python本身没有任何机制阻止你干坏事，一切全靠自觉。</p><p>最后注意下面的这种_错误写法_：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Bart Simpson'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">'Bart Simpson'</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name <span class="token operator">=</span> <span class="token string">'New Name'</span> <span class="token comment"># 设置__name变量！</span><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name<span class="token string">'New Name'</span></code></pre></div></figure><p>表面上看，外部代码“成功”地设置了<code>__name</code>变量，但实际上这个<code>__name</code>变量和class内部的<code>__name</code>变量_不是_一个变量！内部的<code>__name</code>变量已经被Python解释器自动改成了<code>_Student__name</code>，而外部代码给<code>bart</code>新增了一个<code>__name</code>变量。不信试试：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># get_name()内部返回self.__name</span><span class="token string">'Bart Simpson'</span></code></pre></div></figure><h3 id="练习-3"><a href="#练习-3" class="headerlink" title="练习"></a>练习</h3><p>请把下面的<code>Student</code>对象的<code>gender</code>字段对外隐藏起来，用<code>get_gender()</code>和<code>set_gender()</code>代替，并检查参数有效性：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 测试:</span>bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Bart'</span><span class="token punctuation">,</span> <span class="token string">'male'</span><span class="token punctuation">)</span><span class="token keyword">if</span> bart<span class="token punctuation">.</span>get_gender<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'male'</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    bart<span class="token punctuation">.</span>set_gender<span class="token punctuation">(</span><span class="token string">'female'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> bart<span class="token punctuation">.</span>get_gender<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'female'</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试成功!'</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="参考源码-5"><a href="#参考源码-5" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_basic/protected_student.py">protected_student.py</a></p><h2 id="继承和多态"><a href="#继承和多态" class="headerlink" title="继承和多态"></a>继承和多态</h2><p>在OOP程序设计中，当我们定义一个class的时候，可以从某个现有的class继承，新的class称为子类（Subclass），而被继承的class称为基类、父类或超类（Base class、Super class）。</p><p>比如，我们已经编写了一个名为<code>Animal</code>的class，有一个<code>run()</code>方法可以直接打印：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Animal is running...'</span><span class="token punctuation">)</span></code></pre></div></figure><p>当我们需要编写<code>Dog</code>和<code>Cat</code>类时，就可以直接从<code>Animal</code>类继承：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span><span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre></div></figure><p>对于<code>Dog</code>来说，<code>Animal</code>就是它的父类，对于<code>Animal</code>来说，<code>Dog</code>就是它的子类。<code>Cat</code>和<code>Dog</code>类似。</p><p>继承有什么好处？最大的好处是子类获得了父类的全部功能。由于<code>Animial</code>实现了<code>run()</code>方法，因此，<code>Dog</code>和<code>Cat</code>作为它的子类，什么事也没干，就自动拥有了<code>run()</code>方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">dog <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span>dog<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>cat <span class="token operator">=</span> Cat<span class="token punctuation">(</span><span class="token punctuation">)</span>cat<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p>运行结果如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Animal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Animal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div></figure><p>当然，也可以对子类增加一些方法，比如Dog类：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Dog is running...'</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">eat</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Eating meat...'</span><span class="token punctuation">)</span></code></pre></div></figure><p>继承的第二个好处需要我们对代码做一点改进。你看到了，无论是<code>Dog</code>还是<code>Cat</code>，它们<code>run()</code>的时候，显示的都是<code>Animal is running...</code>，符合逻辑的做法是分别显示<code>Dog is running...</code>和<code>Cat is running...</code>，因此，对<code>Dog</code>和<code>Cat</code>类改进如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Dog is running...'</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Cat is running...'</span><span class="token punctuation">)</span></code></pre></div></figure><p>再次运行，结果如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Dog <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Cat <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div></figure><p>当子类和父类都存在相同的<code>run()</code>方法时，我们说，子类的<code>run()</code>覆盖了父类的<code>run()</code>，在代码运行的时候，总是会调用子类的<code>run()</code>。这样，我们就获得了继承的另一个好处：多态。</p><p>要理解什么是多态，我们首先要对数据类型再作一点说明。当我们定义一个class的时候，我们实际上就定义了一种数据类型。我们定义的数据类型和Python自带的数据类型，比如str、list、dict没什么两样：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># a是list类型</span>b <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># b是Animal类型</span>c <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># c是Dog类型</span></code></pre></div></figure><p>判断一个变量是否是某个类型可以用<code>isinstance()</code>判断：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span><span class="token boolean">True</span></code></pre></div></figure><p>看来<code>a</code>、<code>b</code>、<code>c</code>确实对应着<code>list</code>、<code>Animal</code>、<code>Dog</code>这3种类型。</p><p>但是等等，试试：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span><span class="token boolean">True</span></code></pre></div></figure><p>看来<code>c</code>不仅仅是<code>Dog</code>，<code>c</code>还是<code>Animal</code>！</p><p>不过仔细想想，这是有道理的，因为<code>Dog</code>是从<code>Animal</code>继承下来的，当我们创建了一个<code>Dog</code>的实例<code>c</code>时，我们认为<code>c</code>的数据类型是<code>Dog</code>没错，但<code>c</code>同时也是<code>Animal</code>也没错，<code>Dog</code>本来就是<code>Animal</code>的一种！</p><p>所以，在继承关系中，如果一个实例的数据类型是某个子类，那它的数据类型也可以被看做是父类。但是，反过来就不行：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span><span class="token boolean">False</span></code></pre></div></figure><p><code>Dog</code>可以看成<code>Animal</code>，但<code>Animal</code>不可以看成<code>Dog</code>。</p><p>要理解多态的好处，我们还需要再编写一个函数，这个函数接受一个<code>Animal</code>类型的变量：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">run_twice</span><span class="token punctuation">(</span>animal<span class="token punctuation">)</span><span class="token punctuation">:</span>    animal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>    animal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p>当我们传入<code>Animal</code>的实例时，<code>run_twice()</code>就打印出：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Animal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>Animal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Animal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div></figure><p>当我们传入<code>Dog</code>的实例时，<code>run_twice()</code>就打印出：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Dog<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>Dog <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Dog <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div></figure><p>当我们传入<code>Cat</code>的实例时，<code>run_twice()</code>就打印出：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Cat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>Cat <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Cat <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div></figure><p>看上去没啥意思，但是仔细想想，现在，如果我们再定义一个<code>Tortoise</code>类型，也从<code>Animal</code>派生：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Tortoise</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Tortoise is running slowly...'</span><span class="token punctuation">)</span></code></pre></div></figure><p>当我们调用<code>run_twice()</code>时，传入<code>Tortoise</code>的实例：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Tortoise<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>Tortoise <span class="token keyword">is</span> running slowly<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Tortoise <span class="token keyword">is</span> running slowly<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div></figure><p>你会发现，新增一个<code>Animal</code>的子类，不必对<code>run_twice()</code>做任何修改，实际上，任何依赖<code>Animal</code>作为参数的函数或者方法都可以不加修改地正常运行，原因就在于多态。</p><p>多态的好处就是，当我们需要传入<code>Dog</code>、<code>Cat</code>、<code>Tortoise</code>……时，我们只需要接收<code>Animal</code>类型就可以了，因为<code>Dog</code>、<code>Cat</code>、<code>Tortoise</code>……都是<code>Animal</code>类型，然后，按照<code>Animal</code>类型进行操作即可。由于<code>Animal</code>类型有<code>run()</code>方法，因此，传入的任意类型，只要是<code>Animal</code>类或者子类，就会自动调用实际类型的<code>run()</code>方法，这就是多态的意思：</p><p>对于一个变量，我们只需要知道它是<code>Animal</code>类型，无需确切地知道它的子类型，就可以放心地调用<code>run()</code>方法，而具体调用的<code>run()</code>方法是作用在<code>Animal</code>、<code>Dog</code>、<code>Cat</code>还是<code>Tortoise</code>对象上，由运行时该对象的确切类型决定，这就是多态真正的威力：调用方只管调用，不管细节，而当我们新增一种<code>Animal</code>的子类时，只要确保<code>run()</code>方法编写正确，不用管原来的代码是如何调用的。这就是著名的“开闭”原则：</p><p>对扩展开放：允许新增<code>Animal</code>子类；</p><p>对修改封闭：不需要修改依赖<code>Animal</code>类型的<code>run_twice()</code>等函数。</p><p>继承还可以一级一级地继承下来，就好比从爷爷到爸爸、再到儿子这样的关系。而任何类，最终都可以追溯到根类object，这些继承关系看上去就像一颗倒着的树。比如如下的继承树：</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">                ┌───────────────┐                │    object     │                └───────────────┘                        │           ┌────────────┴────────────┐           │                         │           ▼                         ▼    ┌─────────────┐           ┌─────────────┐    │   Animal    │           │    Plant    │    └─────────────┘           └─────────────┘           │                         │     ┌─────┴──────┐            ┌─────┴──────┐     │            │            │            │     ▼            ▼            ▼            ▼┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐│   Dog   │  │   Cat   │  │  Tree   │  │ Flower  │└─────────┘  └─────────┘  └─────────┘  └─────────┘</code></pre></div></figure><h3 id="静态语言-vs-动态语言"><a href="#静态语言-vs-动态语言" class="headerlink" title="静态语言 vs 动态语言"></a>静态语言 vs 动态语言</h3><p>对于静态语言（例如Java）来说，如果需要传入<code>Animal</code>类型，则传入的对象必须是<code>Animal</code>类型或者它的子类，否则，将无法调用<code>run()</code>方法。</p><p><strong>对于Python这样的动态语言来说，则不一定需要传入<code>Animal</code>类型。我们只需要保证传入的对象有一个<code>run()</code>方法就可以了：</strong></p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Start...'</span><span class="token punctuation">)</span></code></pre></div></figure><p>这就是动态语言的“鸭子类型”，它并不要求严格的继承体系，一个对象只要“看起来像鸭子，走起路来像鸭子”，那它就可以被看做是鸭子。</p><p>Python的“file-like object“就是一种鸭子类型。对真正的文件对象，它有一个<code>read()</code>方法，返回其内容。但是，许多对象，只要有<code>read()</code>方法，都被视为“file-like object“。许多函数接收的参数就是“file-like object“，你不一定要传入真正的文件对象，完全可以传入任何实现了<code>read()</code>方法的对象。</p><h3 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h3><p>继承可以把父类的所有功能都直接拿过来，这样就不必重零做起，子类只需要新增自己特有的方法，也可以把父类不适合的方法覆盖重写。</p><p>动态语言的鸭子类型特点决定了继承不像静态语言那样是必须的。</p><h3 id="参考源码-6"><a href="#参考源码-6" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_basic/animals.py">animals.py</a></p><h2 id="使用-slots-x3D-‘name’-‘age’-用tuple定义允许绑定的属性名称"><a href="#使用-slots-x3D-‘name’-‘age’-用tuple定义允许绑定的属性名称" class="headerlink" title="使用__slots__  &#x3D; (‘name’, ‘age’) # 用tuple定义允许绑定的属性名称"></a>使用__slots__  &#x3D; (‘name’, ‘age’) # 用tuple定义允许绑定的属性名称</h2><p>正常情况下，当我们定义了一个class，创建了一个class的实例后，我们可以给该实例绑定任何属性和方法，这就是动态语言的灵活性。先定义class：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre></div></figure><p>然后，尝试给实例绑定一个属性：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Michael'</span> <span class="token comment"># 动态给实例绑定一个属性</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span>Michael</code></pre></div></figure><p>还可以尝试给实例绑定一个方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">set_age</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 定义一个函数作为实例方法</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     self<span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> types <span class="token keyword">import</span> MethodType<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_age <span class="token operator">=</span> MethodType<span class="token punctuation">(</span>set_age<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token comment"># 给实例绑定一个方法</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token comment"># 调用实例方法</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age <span class="token comment"># 测试结果</span><span class="token number">25</span></code></pre></div></figure><p>但是，给一个实例绑定的方法，对另一个实例是不起作用的：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建新的实例</span><span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token comment"># 尝试调用方法</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>AttributeError<span class="token punctuation">:</span> <span class="token string">'Student'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'set_age'</span></code></pre></div></figure><p>为了给所有实例都绑定方法，可以给class绑定方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     self<span class="token punctuation">.</span>score <span class="token operator">=</span> score<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> Student<span class="token punctuation">.</span>set_score <span class="token operator">=</span> set_score</code></pre></div></figure><p>给class绑定方法后，所有实例均可调用：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score<span class="token number">100</span><span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>score<span class="token number">99</span></code></pre></div></figure><p>通常情况下，上面的<code>set_score</code>方法可以直接定义在class中，但动态绑定允许我们在程序运行的过程中动态给class加上功能，这在静态语言中很难实现。</p><h3 id="使用-slots"><a href="#使用-slots" class="headerlink" title="使用__slots__"></a>使用__slots__</h3><p>但是，如果我们想要限制实例的属性怎么办？比如，只允许对Student实例添加<code>name</code>和<code>age</code>属性。</p><p>为了达到限制的目的，Python允许在定义class的时候，定义一个特殊的<code>__slots__</code>变量，来限制该class实例能添加的属性：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    __slots__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">)</span> <span class="token comment"># 用tuple定义允许绑定的属性名称</span></code></pre></div></figure><p>然后，我们试试：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建新的实例</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Michael'</span> <span class="token comment"># 绑定属性'name'</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span> <span class="token comment"># 绑定属性'age'</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">99</span> <span class="token comment"># 绑定属性'score'</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>AttributeError<span class="token punctuation">:</span> <span class="token string">'Student'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'score'</span></code></pre></div></figure><p>由于<code>&#39;score&#39;</code>没有被放到<code>__slots__</code>中，所以不能绑定<code>score</code>属性，试图绑定<code>score</code>将得到<code>AttributeError</code>的错误。</p><p>使用<code>__slots__</code>要注意，<code>__slots__</code>定义的属性仅对当前类实例起作用，对继承的子类是不起作用的：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">GraduateStudent</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">pass</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> GraduateStudent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> g<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span></code></pre></div></figure><p>除非在子类中也定义<code>__slots__</code>，这样，子类实例允许定义的属性就是自身的<code>__slots__</code>加上父类的<code>__slots__</code>。</p><h3 id="参考源码-7"><a href="#参考源码-7" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_advance/use_slots.py">use_slots.py</a></p><h2 id="使用-property"><a href="#使用-property" class="headerlink" title="使用@property"></a>使用@property</h2><p>在绑定属性时，如果我们直接把属性暴露出去，虽然写起来很简单，但是，没办法检查参数，导致可以把成绩随便改：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span></code></pre></div></figure><p>这显然不合逻辑。为了限制score的范围，可以通过一个<code>set_score()</code>方法来设置成绩，再通过一个<code>get_score()</code>来获取成绩，这样，在<code>set_score()</code>方法里，就可以检查参数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>         <span class="token keyword">return</span> self<span class="token punctuation">.</span>_score    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'score must be an integer!'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> value <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'score must between 0 ~ 100!'</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_score <span class="token operator">=</span> value</code></pre></div></figure><p>现在，对任意的Student实例进行操作，就不能随心所欲地设置score了：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment"># ok!</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>get_score<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">60</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ValueError<span class="token punctuation">:</span> score must between <span class="token number">0</span> <span class="token operator">~</span> <span class="token number">100</span>!</code></pre></div></figure><p>但是，上面的调用方法又略显复杂，没有直接用属性这么直接简单。</p><p style="color:red">有没有既能检查参数，又可以用类似属性这样简单的方式来访问类的变量呢？对于追求完美的Python程序员来说，这是必须要做到的！</p><p>还记得装饰器（decorator）可以给函数动态加上功能吗？对于类的方法，装饰器一样起作用。Python内置的<code>@property</code>装饰器就是负责把一个方法变成属性调用的：</p><blockquote><p><strong>Python内置的<code>functools.wraps</code>就是干这个事的，所以，一个完整的decorator的写法如下：</strong></p></blockquote><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> functools<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@functools<span class="token punctuation">.</span>wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'call %s():'</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper</code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_score    <span class="token decorator annotation punctuation">@score<span class="token punctuation">.</span>setter</span>    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'score must be an integer!'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> value <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'score must between 0 ~ 100!'</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_score <span class="token operator">=</span> value</code></pre></div></figure><p><code>@property</code>的实现比较复杂，我们先考察如何使用。把一个getter方法变成属性，只需要加上<code>@property</code>就可以了，此时，<code>@property</code>本身又创建了另一个装饰器<code>@score.setter</code>，负责把一个setter方法变成属性赋值，于是，我们就拥有一个可控的属性操作：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">60</span> <span class="token comment"># OK，实际转化为s.set_score(60)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token comment"># OK，实际转化为s.get_score()</span><span class="token number">60</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ValueError<span class="token punctuation">:</span> score must between <span class="token number">0</span> <span class="token operator">~</span> <span class="token number">100</span>!</code></pre></div></figure><p>注意到这个神奇的<code>@property</code>，我们在对实例属性操作的时候，就知道该属性很可能不是直接暴露的，而是通过getter和setter方法来实现的。</p><p>还可以定义只读属性，只定义getter方法，不定义setter方法就是一个只读属性：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_birth    <span class="token decorator annotation punctuation">@birth<span class="token punctuation">.</span>setter</span>    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_birth <span class="token operator">=</span> value    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">age</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">2015</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>_birth</code></pre></div></figure><p>上面的<code>birth</code>是可读写属性，而<code>age</code>就是一个_只读_属性，因为<code>age</code>可以根据<code>birth</code>和当前时间计算出来。</p><p>要特别注意：属性的方法名不要和实例变量重名。例如，以下的代码是错误的：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 方法名称和实例变量均为birth:</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>birth</code></pre></div></figure><p>这是因为调用<code>s.birth</code>时，首先转换为方法调用，在执行<code>return self.birth</code>时，又视为访问<code>self</code>的属性，于是又转换为方法调用，造成无限递归，最终导致栈溢出报错<code>RecursionError</code>。</p><h3 id="小结-6"><a href="#小结-6" class="headerlink" title="小结"></a>小结</h3><p><code>@property</code>广泛应用在类的定义中，可以让调用者写出简短的代码，同时保证对参数进行必要的检查，这样，程序运行时就减少了出错的可能性。</p><h3 id="练习-4"><a href="#练习-4" class="headerlink" title="练习"></a>练习</h3><p>请利用<code>@property</code>给一个<code>Screen</code>对象加上<code>width</code>和<code>height</code>属性，以及一个只读属性<code>resolution</code>：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 测试:</span>s <span class="token operator">=</span> Screen<span class="token punctuation">(</span><span class="token punctuation">)</span>s<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">1024</span>s<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">768</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'resolution ='</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>resolution<span class="token punctuation">)</span><span class="token keyword">if</span> s<span class="token punctuation">.</span>resolution <span class="token operator">==</span> <span class="token number">786432</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试通过!'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试失败!'</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="参考源码-8"><a href="#参考源码-8" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_advance/use_property.py">use_property.py</a></p><h1 id="定制类-xxx"><a href="#定制类-xxx" class="headerlink" title="定制类 __xxx__"></a>定制类 <code>__xxx__</code></h1><p>看到类似<code>__slots__</code>这种形如<code>__xxx__</code>的变量或者函数名就要注意，这些在Python中是有特殊用途的。</p><p><code>__slots__</code>我们已经知道怎么用了，<code>__len__()</code>方法我们也知道是为了能让class作用于<code>len()</code>函数。</p><p>除此之外，Python的class中还有许多这样有特殊用途的函数，可以帮助我们定制类。</p><h3 id="str"><a href="#str" class="headerlink" title="__str__"></a>__str__</h3><p>我们先定义一个<code>Student</code>类，打印一个实例：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token string">'Michael'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x109afb190</span><span class="token operator">></span></code></pre></div></figure><p>打印出一堆<code>&lt;__main__.Student object at 0x109afb190&gt;</code>，不好看。</p><p>怎么才能打印得好看呢？只需要定义好<code>__str__()</code>方法，返回一个好看的字符串就可以了：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> <span class="token string">'Student object (name: %s)'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token string">'Michael'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>Student <span class="token builtin">object</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> Michael<span class="token punctuation">)</span></code></pre></div></figure><p>这样打印出来的实例，不但好看，而且容易看出实例内部重要的数据。</p><p>但是细心的朋友会发现直接敲变量不用<code>print</code>，打印出来的实例还是不好看：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Michael'</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x109afb310</span><span class="token operator">></span></code></pre></div></figure><p>这是因为直接显示变量调用的不是<code>__str__()</code>，而是<code>__repr__()</code>，两者的区别是<code>__str__()</code>返回用户看到的字符串，而<code>__repr__()</code>返回程序开发者看到的字符串，也就是说，<code>__repr__()</code>是为调试服务的。</p><p>解决办法是再定义一个<code>__repr__()</code>。但是通常<code>__str__()</code>和<code>__repr__()</code>代码都是一样的，所以，有个偷懒的写法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Student object (name=%s)'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name    __repr__ <span class="token operator">=</span> __str__</code></pre></div></figure><h3 id="iter"><a href="#iter" class="headerlink" title="__iter__"></a>__iter__</h3><p>如果一个类想被用于<code>for ... in</code>循环，类似list或tuple那样，就必须实现一个<code>__iter__()</code>方法，该方法返回一个迭代对象，然后，Python的for循环就会不断调用该迭代对象的<code>__next__()</code>方法拿到循环的下一个值，直到遇到<code>StopIteration</code>错误时退出循环。</p><p>我们以斐波那契数列为例，写一个Fib类，可以作用于for循环：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment"># 初始化两个计数器a，b</span>    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self <span class="token comment"># 实例本身就是迭代对象，故返回自己</span>    <span class="token keyword">def</span> <span class="token function">__next__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">,</span> self<span class="token punctuation">.</span>a <span class="token operator">+</span> self<span class="token punctuation">.</span>b <span class="token comment"># 计算下一个值</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>a <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">:</span> <span class="token comment"># 退出循环的条件</span>            <span class="token keyword">raise</span> StopIteration<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>a <span class="token comment"># 返回下一个值</span></code></pre></div></figure><p>现在，试试把Fib实例作用于for循环：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> n <span class="token keyword">in</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">46368</span><span class="token number">75025</span></code></pre></div></figure><h3 id="getitem"><a href="#getitem" class="headerlink" title="__getitem__"></a>__getitem__</h3><p>Fib实例虽然能作用于for循环，看起来和list有点像，但是，把它当成list来使用还是不行，比如，取第5个元素：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>TypeError<span class="token punctuation">:</span> <span class="token string">'Fib'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support indexing</code></pre></div></figure><p>要表现得像list那样按照下标取出元素，需要实现<code>__getitem__()</code>方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>        a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>            a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b        <span class="token keyword">return</span> a</code></pre></div></figure><p>现在，就可以按下标访问数列的任意一项了：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token number">3</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token number">89</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token number">573147844013817084101</span></code></pre></div></figure><p>但是list有个神奇的切片方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code></pre></div></figure><p>对于Fib却报错。原因是<code>__getitem__()</code>传入的参数可能是一个int，也可能是一个切片对象<code>slice</code>，所以要做判断：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># n是索引</span>            a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>                a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b            <span class="token keyword">return</span> a        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># n是切片</span>            start <span class="token operator">=</span> n<span class="token punctuation">.</span>start            stop <span class="token operator">=</span> n<span class="token punctuation">.</span>stop            <span class="token keyword">if</span> start <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                start <span class="token operator">=</span> <span class="token number">0</span>            a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>            L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> x <span class="token operator">>=</span> start<span class="token punctuation">:</span>                    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>                a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b            <span class="token keyword">return</span> L</code></pre></div></figure><p>现在试试Fib的切片：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span></code></pre></div></figure><p>但是没有对step参数作处理：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">]</span></code></pre></div></figure><p>也没有对负数作处理，所以，要正确实现一个<code>__getitem__()</code>还是有很多工作要做的。</p><p>此外，如果把对象看成<code>dict</code>，<code>__getitem__()</code>的参数也可能是一个可以作key的object，例如<code>str</code>。</p><p>与之对应的是<code>__setitem__()</code>方法，把对象视作list或dict来对集合赋值。最后，还有一个<code>__delitem__()</code>方法，用于删除某个元素。</p><p>总之，通过上面的方法，我们自己定义的类表现得和Python自带的list、tuple、dict没什么区别，这完全归功于动态语言的“鸭子类型”，不需要强制继承某个接口。</p><h3 id="getattr"><a href="#getattr" class="headerlink" title="__getattr__"></a>__getattr__</h3><p>正常情况下，当我们调用类的方法或属性时，如果不存在，就会报错。比如定义<code>Student</code>类：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Michael'</span></code></pre></div></figure><p>调用<code>name</code>属性，没问题，但是，调用不存在的<code>score</code>属性，就有问题了：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span>Michael<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>score<span class="token punctuation">)</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>AttributeError<span class="token punctuation">:</span> <span class="token string">'Student'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'score'</span></code></pre></div></figure><p>错误信息很清楚地告诉我们，没有找到<code>score</code>这个attribute。</p><p>要避免这个错误，除了可以加上一个<code>score</code>属性外，Python还有另一个机制，那就是写一个<code>__getattr__()</code>方法，动态返回一个属性。修改如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Michael'</span>    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">'score'</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token number">99</span></code></pre></div></figure><p>当调用不存在的属性时，比如<code>score</code>，Python解释器会试图调用<code>__getattr__(self, &#39;score&#39;)</code>来尝试获得属性，这样，我们就有机会返回<code>score</code>的值：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name<span class="token string">'Michael'</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score<span class="token number">99</span></code></pre></div></figure><p>返回函数也是完全可以的：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">'age'</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">25</span></code></pre></div></figure><p>只是调用方式要变为：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">25</span></code></pre></div></figure><p>注意，只有在没有找到属性的情况下，才调用<code>__getattr__</code>，已有的属性，比如<code>name</code>，不会在<code>__getattr__</code>中查找。</p><p>此外，注意到任意调用如<code>s.abc</code>都会返回<code>None</code>，这是因为我们定义的<code>__getattr__</code>默认返回就是<code>None</code>。要让class只响应特定的几个属性，我们就要按照约定，抛出<code>AttributeError</code>的错误：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">'age'</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">25</span>        <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">'\'Student\' object has no attribute \'%s\''</span> <span class="token operator">%</span> attr<span class="token punctuation">)</span></code></pre></div></figure><p>这实际上可以把一个类的所有属性和方法调用全部动态化处理了，不需要任何特殊手段。</p><p>这种完全动态调用的特性有什么实际作用呢？作用就是，可以针对完全动态的情况作调用。</p><p>举个例子：</p><p>现在很多网站都搞REST API，比如新浪微博、豆瓣啥的，调用API的URL类似：</p><ul><li><a href="http://api.server/user/friends">http://api.server/user/friends</a></li><li><a href="http://api.server/user/timeline/list">http://api.server/user/timeline/list</a></li></ul><p>如果要写SDK，给每个URL对应的API都写一个方法，那得累死，而且，API一旦改动，SDK也要改。</p><p>利用完全动态的<code>__getattr__</code>，我们可以写出一个链式调用：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_path <span class="token operator">=</span> path    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Chain<span class="token punctuation">(</span><span class="token string">'%s/%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_path    __repr__ <span class="token operator">=</span> __str__</code></pre></div></figure><p>试试：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>status<span class="token punctuation">.</span>user<span class="token punctuation">.</span>timeline<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token string">'/status/user/timeline/list'</span></code></pre></div></figure><p>这样，无论API怎么变，SDK都可以根据URL实现完全动态的调用，而且，不随API的增加而改变！</p><p>还有些REST API会把参数放到URL中，比如GitHub的API：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">GET <span class="token operator">/</span>users<span class="token operator">/</span><span class="token punctuation">:</span>user<span class="token operator">/</span>repos</code></pre></div></figure><p>调用时，需要把<code>:user</code>替换为实际用户名。如果我们能写出这样的链式调用：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>users<span class="token punctuation">(</span><span class="token string">'michael'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repos</code></pre></div></figure><p>就可以非常方便地调用API了。有兴趣的童鞋可以试试写出来。</p><h3 id="call"><a href="#call" class="headerlink" title="__call__"></a>__call__</h3><p>一个对象实例可以有自己的属性和方法，当我们调用实例方法时，我们用<code>instance.method()</code>来调用。能不能直接在实例本身上调用呢？在Python中，答案是肯定的。</p><p>任何类，只需要定义一个<code>__call__()</code>方法，就可以直接对实例进行调用。请看示例：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'My name is %s.'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code></pre></div></figure><p>调用方式如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Michael'</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># self参数不要传入</span>My name <span class="token keyword">is</span> Michael<span class="token punctuation">.</span></code></pre></div></figure><p><code>__call__()</code>还可以定义参数。对实例进行直接调用就好比对一个函数进行调用一样，所以你完全可以把对象看成函数，把函数看成对象，因为这两者之间本来就没啥根本的区别。</p><p>如果你把对象看成函数，那么函数本身其实也可以在运行期动态创建出来，因为类的实例都是运行期创建出来的，这么一来，我们就模糊了对象和函数的界限。</p><p>那么，怎么判断一个变量是对象还是函数呢？其实，更多的时候，我们需要判断一个对象是否能被调用，能被调用的对象就是一个<code>Callable</code>对象，比如函数和我们上面定义的带有<code>__call__()</code>的类实例：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token string">'str'</span><span class="token punctuation">)</span><span class="token boolean">False</span></code></pre></div></figure><p>通过<code>callable()</code>函数，我们就可以判断一个对象是否是“可调用”对象。</p><h3 id="小结-7"><a href="#小结-7" class="headerlink" title="小结"></a>小结</h3><p>Python的class允许定义许多定制方法，可以让我们非常方便地生成特定的类。</p><p>本节介绍的是最常用的几个定制方法，还有很多可定制的方法，请参考<a href="http://docs.python.org/3/reference/datamodel.html#special-method-names">Python的官方文档</a>。</p><h3 id="参考源码-9"><a href="#参考源码-9" class="headerlink" title="参考源码"></a>参考源码</h3><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_advance/special_str.py">special_str.py</a></p><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_advance/special_iter.py">special_iter.py</a></p><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_advance/special_getitem.py">special_getitem.py</a></p><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_advance/special_getattr.py">special_getattr.py</a></p><p><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/oop_advance/special_call.py">special_call.py</a></p>]]></content>
    
    
    <categories>
      
      <category>数据分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python基础知识</title>
    <link href="/2022/11/15/Python%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/11/15/Python%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<ul><li>列表是有序的可变容器</li><li>元组是有序的不可变容器</li><li>字典是无序的可变容器–&gt;字典也被称作关联数组或者哈希表</li><li>集合是无序且不可变类型容器</li></ul><table><thead><tr><th>元字符</th><th>说明</th></tr></thead><tbody><tr><td>[\b]</td><td>回退（删除）一个字符</td></tr><tr><td>\f</td><td>换页符</td></tr><tr><td>\n</td><td>换行符</td></tr><tr><td>\r</td><td>回车符</td></tr><tr><td>\t</td><td>制表符</td></tr><tr><td>\v</td><td>垂直制表符</td></tr></tbody></table><h2 id="字符串方法"><a href="#字符串方法" class="headerlink" title="字符串方法"></a>字符串方法</h2><ul><li>find–&gt;返回某个字符串位置</li><li>replace–&gt;替换某个字符串</li><li>strip–&gt;去除某个字符串</li><li>split–&gt;以某个字符串前后拆分，不保留分隔符号，返回列表</li><li>partition –&gt;以某个字符串前后拆分，保留分隔符号，返回元组</li><li>index–&gt;返回某个字符串的索引</li><li>upper&amp;lower–&gt;转换大小写</li><li>join –&gt;用于在指定字符串中间穿插其他字符串</li><li>format–&gt;格式化输出</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li>append–&gt;一次加一个</li><li>extend–&gt;一次加多个</li><li>insert–&gt;指定索引位置插入</li><li>pop –&gt;指定索引位置删除</li><li>remove–&gt;移除指定元素</li><li>del–&gt;删除整个对象</li><li>clear–&gt;清空整个列表</li><li>index–&gt;返回列表元素的索引</li><li>count–&gt;统计列表元素出现次数</li><li>in–&gt;</li><li>sort–&gt;排序，可选reverse&#x3D;True反转</li><li>reverse–&gt;反转列表</li></ul><h2 id="元组方法"><a href="#元组方法" class="headerlink" title="元组方法"></a>元组方法</h2><ul><li>count</li><li>index</li><li>in</li></ul><h2 id="字典方法"><a href="#字典方法" class="headerlink" title="字典方法"></a>字典方法</h2><ul><li>keys()&#x2F;Values()–&gt;返回键&#x2F;值对象，需要使用list和tuple转换</li><li>items–&gt;返回键值元组</li><li>update–&gt;有顺序更新，有方向更新，替换重复值</li><li>setdefault–&gt;选择性更新，原位置已有值返回原值，无值返回新值d.setdefault(‘A’, 5)</li></ul><h2 id="集合方法"><a href="#集合方法" class="headerlink" title="集合方法"></a>集合方法</h2><ul><li>add –&gt;添加一个元素</li><li>remove–&gt;移除一个元素</li><li>pop–&gt;随机删除一个元素</li><li>交集运算符–&gt;&amp;    intersectionintersection_update</li><li>并集运算符–&gt;|    union  update</li><li>差集运算符–&gt;-    differencedifference_update</li><li>补集运算符–&gt;^    symmetric_differencesymmetric_difference_update</li><li>集合关系判断 –&gt;     issubset issupersetisdisjoint</li><li>冻集合——不可变集合类型</li></ul><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>定义函数</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">sum_1</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""让输入的两个对象利用加号运算符进行相加    参数：\n    a：函数输入的第一个对象\n    b：函数输入的第二个对象\n    return，返回a+b的结果    """</span>    c <span class="token operator">=</span> a <span class="token operator">+</span> b                   <span class="token keyword">return</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>   </code></pre></div></figure><h2 id="形参和全局变量"><a href="#形参和全局变量" class="headerlink" title="形参和全局变量"></a>形参和全局变量</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"> <span class="token comment"># 定义时小括号中的参数，用来接收参数用的，称为 “形参”（形式参数），</span>    <span class="token comment"># 而调用时小括号中的参数，用来传递给函数用的，称为 “实参”（实际参数） </span><span class="token keyword">def</span> <span class="token function">sum_1</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>                c <span class="token operator">=</span> a <span class="token operator">+</span> b                    <span class="token keyword">return</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>      <span class="token keyword">def</span> <span class="token function">sum_2</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> a <span class="token comment"># 声明全局变量</span>    a <span class="token operator">+=</span> b    <span class="token keyword">return</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    </code></pre></div></figure><h2 id="可变长参数"><a href="#可变长参数" class="headerlink" title="可变长参数"></a>可变长参数</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">sum_2</span><span class="token punctuation">(</span><span class="token operator">*</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>               <span class="token comment"># 此时*num就是一个可变长参数</span>    r <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> num<span class="token punctuation">:</span>              <span class="token comment"># 但可变长参数名仍然是num而非*num</span>        r <span class="token operator">+=</span> i    <span class="token keyword">return</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span></code></pre></div></figure><h2 id="类Class"><a href="#类Class" class="headerlink" title="类Class"></a>类Class</h2><h3 id="定义静态属性"><a href="#定义静态属性" class="headerlink" title="定义静态属性"></a>定义静态属性</h3><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Human</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''人类'''</span>    mam <span class="token operator">=</span> <span class="token boolean">True</span>     定义动态属性<span class="token triple-quoted-string string">"""__init__函数解释：      是一种特殊函数，也称为是构造函数，多用于带参数属性的类的创建过程；self是一个特殊的参数，相当于类本身的一种表示，相当于是C中的指针“this”，是init函数必须设置的第一个参数；类中定义的函数也需要传入self参数；这些函数可以通过外部调用方法的方式进行调用。"""</span><span class="token keyword">class</span> <span class="token class-name">Human</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''人类'''</span>    mam <span class="token operator">=</span> <span class="token boolean">True</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> gender <span class="token operator">=</span> <span class="token string">'Unknow'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        self<span class="token punctuation">.</span>gender <span class="token operator">=</span> gender        zs <span class="token operator">=</span> Human<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">)</span>       <span class="token comment"># 重新设置属性</span><span class="token keyword">class</span> <span class="token class-name">Human1</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''人类'''</span>    mam <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token decorator annotation punctuation">@property</span>             <span class="token comment">#属性私有化，防止被修改</span>    <span class="token keyword">def</span> <span class="token function">mam</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token triple-quoted-string string">"""property，则可将方法转化为属性。因此，上述类的创建，相当于创建了一个属性mam和一个同名方法mam，并且将同名方法转化为了属性"""</span></code></pre></div></figure><h2 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Point</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                       self<span class="token punctuation">.</span>x <span class="token operator">=</span> x        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y    <span class="token keyword">def</span> <span class="token function">dis</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>x <span class="token operator">-</span> p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>y <span class="token operator">-</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">0.5</span><span class="token keyword">class</span> <span class="token class-name">Point1</span><span class="token punctuation">(</span>Point<span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment"># 继承自Point类</span>    <span class="token keyword">def</span> <span class="token function">dis</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>x <span class="token operator">-</span> p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>y <span class="token operator">-</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><h2 id="二维到多维"><a href="#二维到多维" class="headerlink" title="二维到多维"></a>二维到多维</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Point2</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 定义一个可变长数组，并将其转化为列表对象</span>        self<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Point2</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>                       self<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">dis</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>        t <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            t<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>l<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>l<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">0.5</span></code></pre></div></figure><h2 id="函数和方法的区别"><a href="#函数和方法的区别" class="headerlink" title="函数和方法的区别"></a>函数和方法的区别</h2><blockquote><p>函数和方法的区别：方法是定义在类里面的函数！</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>数据分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NumPy生成自定义数组</title>
    <link href="/2022/11/15/NumPy%E7%94%9F%E6%88%90%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E7%BB%84/"/>
    <url>/2022/11/15/NumPy%E7%94%9F%E6%88%90%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E7%BB%84/</url>
    
    <content type="html"><![CDATA[<h2 id="特殊数组的创建方法"><a href="#特殊数组的创建方法" class="headerlink" title="特殊数组的创建方法"></a>特殊数组的创建方法</h2><ul><li><p>numpy.arange 生成数值范围</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">numpy<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> step<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span></code></pre></div></figure></li><li><p>numpy.linspace 生成等差数列</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> endpoint<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> retstep<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></code></pre></div></figure></li><li><p>numpy.logspace 生成等比数列</p></li></ul><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>logspace<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> endpoint<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">10.0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></code></pre></div></figure><ul><li><p>np.zeros 全0数组</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>                      <span class="token comment"># 默认是浮点型</span></code></pre></div></figure></li><li><p>np.ones全1数组</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token comment"># 三行两列</span></code></pre></div></figure></li><li><p>随机数组：rand生成服从01分布的随机数</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>                <span class="token comment"># 返回服从01分布的5个数</span></code></pre></div></figure></li><li><p>随机数组：randn生成标准正态分布的随机数</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> </code></pre></div></figure></li><li><p>随机数组：normal生成元素是指定随机分布的数组</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">5.53705005</span><span class="token punctuation">,</span>  <span class="token number">1.95477989</span><span class="token punctuation">,</span>  <span class="token number">3.07768639</span><span class="token punctuation">]</span><span class="token punctuation">,</span>               <span class="token punctuation">[</span> <span class="token number">4.15457427</span><span class="token punctuation">,</span>  <span class="token number">3.69587242</span><span class="token punctuation">,</span>  <span class="token number">3.18715934</span><span class="token punctuation">]</span><span class="token punctuation">,</span>               <span class="token punctuation">[</span> <span class="token number">5.46093734</span><span class="token punctuation">,</span>  <span class="token number">6.60888084</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.55980278</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></figure></li><li><p>生成全数值相同的数组</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code></pre></div></figure></li><li><p>np.eye生成单位矩阵</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>eye<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>```       <span class="token operator">-</span> np<span class="token punctuation">.</span>diag生成对角矩阵```pythonnp<span class="token punctuation">.</span>diag<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>```       <span class="token operator">-</span> np<span class="token punctuation">.</span>array按照某种形状生成ndarray```pythone <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>e<span class="token punctuation">)</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>np<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>e<span class="token punctuation">)</span>np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>e<span class="token punctuation">)</span>np<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>e<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span></code></pre></div></figure></li></ul><h2 id="数组常用变形方法"><a href="#数组常用变形方法" class="headerlink" title="数组常用变形方法"></a>数组常用变形方法</h2><ul><li>reshape方法：调整数组行列结构<figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">a1 <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>a1array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.56262855</span><span class="token punctuation">,</span> <span class="token number">0.73129141</span><span class="token punctuation">,</span> <span class="token number">0.86289312</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.93186546</span><span class="token punctuation">,</span> <span class="token number">0.93884182</span><span class="token punctuation">,</span> <span class="token number">0.22485166</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></figure></li><li>flatten方法：将数组降为一维数组<figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">a1<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">)</span></code></pre></div></figure></li><li>.T方法：数组的转置<figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">a1array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.56262855</span><span class="token punctuation">,</span> <span class="token number">0.73129141</span><span class="token punctuation">,</span> <span class="token number">0.86289312</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.93186546</span><span class="token punctuation">,</span> <span class="token number">0.93884182</span><span class="token punctuation">,</span> <span class="token number">0.22485166</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>a1<span class="token punctuation">.</span>T                    <span class="token comment"># 就类似于矩阵的转置</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.56262855</span><span class="token punctuation">,</span> <span class="token number">0.93186546</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.73129141</span><span class="token punctuation">,</span> <span class="token number">0.93884182</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.86289312</span><span class="token punctuation">,</span> <span class="token number">0.22485166</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></figure></li></ul><h2 id="数组的拼接"><a href="#数组的拼接" class="headerlink" title="数组的拼接"></a>数组的拼接</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">a1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>a2 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>```        <span class="token operator">-</span> vstack：纵向拼接，按列拼接，新增行，上下拼接```pythonnp<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">]</span><span class="token punctuation">)</span>             <span class="token comment"># 需要输入一个序列</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></figure><ul><li>hstack：横向拼接，按行拼接，新增列，左右拼接</li></ul><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">[</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">]</span><span class="token punctuation">)</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></figure><h2 id="数组的切分"><a href="#数组的切分" class="headerlink" title="数组的切分"></a>数组的切分</h2><p>当然，有拼接就有切分。接下来，简单看下数组的切分方法。拼接时关键字是<code>stack</code>，切分时关键字是<code>split</code></p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span>          <span class="token comment"># 创建3行8列的二维数组</span>aarray<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></figure><ul><li>hsplit：左右切分<figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 当第二个参数只输入一个数时，是进行等分</span>np<span class="token punctuation">.</span>hsplit<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># 无法等分的情况会报错</span>np<span class="token punctuation">.</span>hsplit<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>```````python<span class="token comment"># 当第二个参数输入一个序列时，则是根据列标进行切分</span>np<span class="token punctuation">.</span>hsplit<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment"># 第一列、第二列、第三列后进行切分</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-</span> vsplit：上下切分```pythonnp<span class="token punctuation">.</span>vsplit<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>                <span class="token comment"># 三等分</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre></div></figure></li><li>array_split：通用切分方法<figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 均分</span>np<span class="token punctuation">.</span>array_split<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># axis = 1，左右切分</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># 根据列标进行切分</span>np<span class="token punctuation">.</span>array_split<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># 均分</span>np<span class="token punctuation">.</span>array_split<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment"># axis = 0，上下切分</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># 根据行标进行切分</span>np<span class="token punctuation">.</span>array_split<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre></div></figure></li></ul><h2 id="数组的算数运算"><a href="#数组的算数运算" class="headerlink" title="数组的算数运算"></a>数组的算数运算</h2><table><thead><tr><th><strong>数学运算函数</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>np.add(x1，x2 )</td><td>按元素添加参数，等效于 x1 + x2</td></tr><tr><td>np.subtract(x1，x2)</td><td>按元素方式减去参数，等效于x1 - x2</td></tr><tr><td>np.multiply(x1，x2)</td><td>逐元素乘法参数，等效于x1 * x2</td></tr><tr><td>np.divide(x1，x2)</td><td>逐元素除以参数，等效于x1 &#x2F; x2</td></tr><tr><td>np.exp(x)</td><td>计算e的x次方。</td></tr><tr><td>np.exp2(x)</td><td>计算2的x次方。</td></tr><tr><td>np.power(x1,x2)</td><td>计算x1的x2次幂。</td></tr><tr><td>np.mod(x)</td><td>返回输入数组中相应元素的除法余数.</td></tr><tr><td>np.log(x)</td><td>自然对数，逐元素。</td></tr><tr><td>np.log2(x)</td><td><em>x</em>的基础2对数。</td></tr><tr><td>np.log10(x)</td><td>以元素为单位返回输入数组的基数10的对数。</td></tr><tr><td>np.expm1(x)</td><td>对数组中的所有元素计算<code>exp（x） - 1</code></td></tr><tr><td>np.log1p(x)</td><td>返回一个加自然对数的输入数组。</td></tr><tr><td>np.sqrt(x)</td><td>按元素方式返回数组的正平方根。</td></tr><tr><td>np.square(x)</td><td>返回输入的元素平方。</td></tr><tr><td>np.sin(x)</td><td>三角正弦。</td></tr><tr><td>np.cos(x)</td><td>元素余弦。</td></tr><tr><td>np.tan(x)</td><td>逐元素计算切线。</td></tr><tr><td>np.round(x)</td><td>四舍五入</td></tr><tr><td>np.floor(x)</td><td>向下取整</td></tr><tr><td>np.ceil(x)</td><td>向上取整</td></tr><tr><td>数组的统计运算</td><td></td></tr><tr><td>NumPy有很多有用的统计函数，用于从数组中给定的元素中查找最小，最大，百分标准差和方差等。</td><td></td></tr><tr><td><strong>常用统计函数：</strong></td><td></td></tr></tbody></table><table><thead><tr><th><strong>函数名称</strong></th><th><strong>NaN安全版本</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>np.sum()</td><td>np.nansum()</td><td>计算元素的和</td></tr><tr><td>np.min()</td><td>np.nanmin()</td><td>找出最小值</td></tr><tr><td>np.max()</td><td>np.nanmax()</td><td>找出最大值</td></tr><tr><td>np.prod()</td><td>np.nanprod()</td><td>计算元素的积</td></tr><tr><td>np.ptp()</td><td>N&#x2F;A</td><td>计算元素的极差（最大值 - 最小值）</td></tr><tr><td>np.mean()</td><td>np.nanmean()</td><td>计算元素的算术平均值</td></tr><tr><td>np.std()</td><td>np.nanstd()</td><td>计算标准差</td></tr><tr><td>np.var()</td><td>np.nanvar()</td><td>计算方差</td></tr><tr><td>np.percentile()</td><td>np.nanpercentile()</td><td>计算百分位数</td></tr><tr><td>np.median()</td><td>np.nanmedian()</td><td>计算中位数</td></tr><tr><td>np.average()</td><td>N&#x2F;A</td><td>返回数组的加权平均值</td></tr><tr><td>np.any()</td><td>N&#x2F;A</td><td>验证任何一个元素是否为真</td></tr><tr><td>np.all()</td><td>N&#x2F;A</td><td>验证所有元素是否为真</td></tr></tbody></table><h2 id="数组的线性代数函数"><a href="#数组的线性代数函数" class="headerlink" title="数组的线性代数函数"></a>数组的线性代数函数</h2><p>NumPy拥有numpy.linalg 模块，提供线性代数所需的所有功能。</p><ul><li>np.dot() 返回两个数组的点积</li><li>np.vdot() 返回两个向量的点积</li><li>np.inner() 返回一维数组的向量内积</li><li>np.matmul() 返回两个数组的矩阵乘积</li><li>np.linalg.det() 计算输入矩阵的行列式</li><li>np.linalg.solve() 求解矩阵形式的线性方程的解</li><li>np.linalg.inv() 计算矩阵的逆</li></ul><h2 id="Pandas-DataFrame的创建"><a href="#Pandas-DataFrame的创建" class="headerlink" title="Pandas-DataFrame的创建"></a>Pandas-DataFrame的创建</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>                   index<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>                   columns<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>                  dtype<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>                   copy<span class="token operator">=</span><span class="token boolean">False</span>                  <span class="token punctuation">)</span></code></pre></div></figure><h2 id="由Series创建DataFrame"><a href="#由Series创建DataFrame" class="headerlink" title="由Series创建DataFrame"></a>由Series创建DataFrame</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">s1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>s2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></figure><h2 id="二维array创建DataFrame"><a href="#二维array创建DataFrame" class="headerlink" title="二维array创建DataFrame"></a>二维array创建DataFrame</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>a<span class="token punctuation">)</span></code></pre></div></figure><h2 id="利用字典创建DataFrame"><a href="#利用字典创建DataFrame" class="headerlink" title="利用字典创建DataFrame"></a>利用字典创建DataFrame</h2><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">d1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">:</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">:</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>d1<span class="token punctuation">)</span></code></pre></div></figure><p>在创建过程中，字典的Key会编程column名称，并且系统会自动生成index.</p>]]></content>
    
    
    <categories>
      
      <category>数据分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何在Markdown里使用Echarts图表？</title>
    <link href="/2022/11/14/%E5%A6%82%E4%BD%95%E5%9C%A8Markdown%E9%87%8C%E4%BD%BF%E7%94%A8Echarts%E5%9B%BE%E8%A1%A8%EF%BC%9F/"/>
    <url>/2022/11/14/%E5%A6%82%E4%BD%95%E5%9C%A8Markdown%E9%87%8C%E4%BD%BF%E7%94%A8Echarts%E5%9B%BE%E8%A1%A8%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<h2 id="使用HTML润色文本"><a href="#使用HTML润色文本" class="headerlink" title="使用HTML润色文本"></a>使用HTML润色文本</h2><p><span  style="color: #519D9E; ">#519D9E颜色演示</span></p><h2 id="Markdown里图片引入的三种方法"><a href="#Markdown里图片引入的三种方法" class="headerlink" title="Markdown里图片引入的三种方法"></a>Markdown里图片引入的三种方法</h2><ul><li>第一种</li></ul><figure><div class="code-wrapper"><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://images.unsplash.com/photo-1533257266619-e841826ce739?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2369&amp;q=80<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>some_text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre></div></figure><img src="https://images.unsplash.com/photo-1533257266619-e841826ce739?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2369&q=80" alt="some_text"><ul><li>第二种</li></ul><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">![图片引用方法二](&#x2F;image&#x2F;test.jpg)</code></pre></div></figure><p><img src="/image/test.jpg" alt="图片引用方法三"></p><ul><li>第三种</li></ul><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#123;% asset_img image&#x2F;test.png 图片引用方法一 %&#125;</code></pre></div></figure><img class="test.jpg 图片引用方法一"><h2 id="引入外部HTML-使用iframe"><a href="#引入外部HTML-使用iframe" class="headerlink" title="引入外部HTML - 使用iframe"></a>引入外部HTML - 使用iframe</h2><iframe src="//https://jaling9.github.io/index.html" width="100%" height="400" name="topFrame" scrolling="yes" noresize="noresize" frameborder="0" id="topFrame"> </iframe><p>也可以是视频音乐等</p><figure><div class="code-wrapper"><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//player.bilibili.com/player.html?aid=689464853&amp;bvid=BV1Wm4y1F7cs&amp;cid=871780885&amp;page=1<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>topFrame<span class="token punctuation">"</span></span> <span class="token attr-name">scrolling</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span> <span class="token attr-name">noresize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>noresize<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>topFrame<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span></code></pre></div></figure><iframe src="//player.bilibili.com/player.html?aid=689464853&bvid=BV1Wm4y1F7cs&cid=871780885&page=1" width="100%" height="400" name="topFrame" scrolling="yes" noresize="noresize" frameborder="0" id="topFrame"> </iframe><h2 id="引入本地echasrts-方法一-使用iframe引入html文件"><a href="#引入本地echasrts-方法一-使用iframe引入html文件" class="headerlink" title="引入本地echasrts 方法一 使用iframe引入html文件"></a>引入本地echasrts 方法一 使用iframe引入html文件</h2><iframe src="//html-echarts/render.html" width="100%" height="600" name="topFrame" scrolling="yes" noresize="noresize" frameborder="0" id="topFrame"></iframe><h2 id="引入本地echarts-方法二-直接写HTML和JS"><a href="#引入本地echarts-方法二-直接写HTML和JS" class="headerlink" title="引入本地echarts 方法二 直接写HTML和JS"></a>引入本地echarts 方法二 直接写HTML和JS</h2><figure><div class="code-wrapper"><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 600px<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token property">weight</span><span class="token punctuation">:</span>100%<span class="token punctuation">:</span> <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><span class="token property">weight</span><span class="token punctuation">:</span>100%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span><span class="token property">weight</span><span class="token punctuation">:</span>100%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://fastly.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">        <span class="token keyword">var</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> myChart <span class="token operator">=</span> echarts<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">renderer</span><span class="token operator">:</span> <span class="token string">'canvas'</span><span class="token punctuation">,</span>            <span class="token literal-property property">useDirtyRect</span><span class="token operator">:</span> <span class="token boolean">false</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> option<span class="token punctuation">;</span>        option <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'#2c343c'</span><span class="token punctuation">,</span>            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Customized Pie'</span><span class="token punctuation">,</span>                <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>                <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>                <span class="token literal-property property">textStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#ccc'</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">tooltip</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">trigger</span><span class="token operator">:</span> <span class="token string">'item'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">visualMap</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">show</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>                <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">600</span><span class="token punctuation">,</span>                <span class="token literal-property property">inRange</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">colorLightness</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">series</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Access From'</span><span class="token punctuation">,</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pie'</span><span class="token punctuation">,</span>                <span class="token literal-property property">radius</span><span class="token operator">:</span> <span class="token string">'55%'</span><span class="token punctuation">,</span>                <span class="token literal-property property">center</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>                    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">335</span><span class="token punctuation">,</span>                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Direct'</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">310</span><span class="token punctuation">,</span>                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Email'</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">274</span><span class="token punctuation">,</span>                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Union Ads'</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">235</span><span class="token punctuation">,</span>                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Video Ads'</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Search Engine'</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> a<span class="token punctuation">.</span>value <span class="token operator">-</span> b<span class="token punctuation">.</span>value<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token literal-property property">roseType</span><span class="token operator">:</span> <span class="token string">'radius'</span><span class="token punctuation">,</span>                <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'rgba(255, 255, 255, 0.3)'</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">labelLine</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">lineStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                        <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'rgba(255, 255, 255, 0.3)'</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                    <span class="token literal-property property">smooth</span><span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>                    <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>                    <span class="token literal-property property">length2</span><span class="token operator">:</span> <span class="token number">20</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">itemStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#c23531'</span><span class="token punctuation">,</span>                    <span class="token literal-property property">shadowBlur</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>                    <span class="token literal-property property">shadowColor</span><span class="token operator">:</span> <span class="token string">'rgba(0, 0, 0, 0.5)'</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">animationType</span><span class="token operator">:</span> <span class="token string">'scale'</span><span class="token punctuation">,</span>                <span class="token literal-property property">animationEasing</span><span class="token operator">:</span> <span class="token string">'elasticOut'</span><span class="token punctuation">,</span>                <span class="token function-variable function">animationDelay</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>option <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> option <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            myChart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> myChart<span class="token punctuation">.</span>resize<span class="token punctuation">)</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre></div></figure><body style="height: 600px;;weight:100%: margin: 0;weight:100%">    <div id="container" style="height: 400px;weight:100%"></div>    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>    <script type="text/javascript">        var dom = document.getElementById('container');        var myChart = echarts.init(dom, null, {            renderer: 'canvas',            useDirtyRect: false        });        var app = {};        var option;        option = {            backgroundColor: '#2c343c',            title: {                text: 'Customized Pie',                left: 'center',                top: 20,                textStyle: {                    color: '#ccc'                }            },            tooltip: {                trigger: 'item'            },            visualMap: {                show: false,                min: 80,                max: 600,                inRange: {                    colorLightness: [0, 1]                }            },            series: [{                name: 'Access From',                type: 'pie',                radius: '55%',                center: ['50%', '50%'],                data: [{                    value: 335,                    name: 'Direct'                }, {                    value: 310,                    name: 'Email'                }, {                    value: 274,                    name: 'Union Ads'                }, {                    value: 235,                    name: 'Video Ads'                }, {                    value: 400,                    name: 'Search Engine'                }].sort(function(a, b) {                    return a.value - b.value;                }),                roseType: 'radius',                label: {                    color: 'rgba(255, 255, 255, 0.3)'                },                labelLine: {                    lineStyle: {                        color: 'rgba(255, 255, 255, 0.3)'                    },                    smooth: 0.2,                    length: 10,                    length2: 20                },                itemStyle: {                    color: '#c23531',                    shadowBlur: 200,                    shadowColor: 'rgba(0, 0, 0, 0.5)'                },                animationType: 'scale',                animationEasing: 'elasticOut',                animationDelay: function(idx) {                    return Math.random() * 200;                }            }]        };        if (option && typeof option === 'object') {            myChart.setOption(option);        }        window.addEventListener('resize', myChart.resize);    </script></body><h2 id="引入本地echarts-方法三-使用tags语法引入JS代码"><a href="#引入本地echarts-方法三-使用tags语法引入JS代码" class="headerlink" title="引入本地echarts 方法三 使用tags语法引入JS代码"></a>引入本地echarts 方法三 使用tags语法引入JS代码</h2><p>通过jsDelivr的CDN引入echarts</p><script src="https://cdn.jsdelivr.net/npm/echarts@4.8.0/dist/echarts.min.js"></script><p>使用GL里的各种组件时需要添加，否则可不需要</p><script src="https://cdn.jsdelivr.net/npm/echarts-gl@1.1.1/dist/echarts-gl.min.js"></script><figure><div class="code-wrapper"><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">%</span> echarts <span class="token number">400</span> <span class="token string">'85%'</span> <span class="token operator">%</span><span class="token punctuation">&#125;</span>  <span class="token comment">// 基于准备好的dom，初始化echarts实例</span>    <span class="token keyword">var</span> myChart <span class="token operator">=</span> echarts<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 指定图表的配置项和数据</span>    <span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">&#123;</span> <span class="token operator">%</span> echarts <span class="token number">400</span> <span class="token string">'85%'</span> <span class="token operator">%</span>        <span class="token punctuation">&#125;</span>        option <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'堆叠区域图'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">tooltip</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">trigger</span><span class="token operator">:</span> <span class="token string">'axis'</span><span class="token punctuation">,</span>                <span class="token literal-property property">axisPointer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'cross'</span><span class="token punctuation">,</span>                    <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'#6a7985'</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">legend</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'邮件营销'</span><span class="token punctuation">,</span> <span class="token string">'联盟广告'</span><span class="token punctuation">,</span> <span class="token string">'视频广告'</span><span class="token punctuation">,</span> <span class="token string">'直接访问'</span><span class="token punctuation">,</span> <span class="token string">'搜索引擎'</span><span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">toolbox</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">feature</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">saveAsImage</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">grid</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token string">'3%'</span><span class="token punctuation">,</span>                <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">'4%'</span><span class="token punctuation">,</span>                <span class="token literal-property property">bottom</span><span class="token operator">:</span> <span class="token string">'3%'</span><span class="token punctuation">,</span>                <span class="token literal-property property">containLabel</span><span class="token operator">:</span> <span class="token boolean">true</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token literal-property property">xAxis</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'category'</span><span class="token punctuation">,</span>                <span class="token literal-property property">boundaryGap</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'周一'</span><span class="token punctuation">,</span> <span class="token string">'周二'</span><span class="token punctuation">,</span> <span class="token string">'周三'</span><span class="token punctuation">,</span> <span class="token string">'周四'</span><span class="token punctuation">,</span> <span class="token string">'周五'</span><span class="token punctuation">,</span> <span class="token string">'周六'</span><span class="token punctuation">,</span> <span class="token string">'周日'</span><span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token literal-property property">yAxis</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'value'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token literal-property property">series</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'邮件营销'</span><span class="token punctuation">,</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'line'</span><span class="token punctuation">,</span>                <span class="token literal-property property">stack</span><span class="token operator">:</span> <span class="token string">'总量'</span><span class="token punctuation">,</span>                <span class="token literal-property property">areaStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">132</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">134</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">210</span><span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'联盟广告'</span><span class="token punctuation">,</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'line'</span><span class="token punctuation">,</span>                <span class="token literal-property property">stack</span><span class="token operator">:</span> <span class="token string">'总量'</span><span class="token punctuation">,</span>                <span class="token literal-property property">areaStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">182</span><span class="token punctuation">,</span> <span class="token number">191</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token number">290</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">,</span> <span class="token number">310</span><span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'视频广告'</span><span class="token punctuation">,</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'line'</span><span class="token punctuation">,</span>                <span class="token literal-property property">stack</span><span class="token operator">:</span> <span class="token string">'总量'</span><span class="token punctuation">,</span>                <span class="token literal-property property">areaStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">232</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">154</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">,</span> <span class="token number">410</span><span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'直接访问'</span><span class="token punctuation">,</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'line'</span><span class="token punctuation">,</span>                <span class="token literal-property property">stack</span><span class="token operator">:</span> <span class="token string">'总量'</span><span class="token punctuation">,</span>                <span class="token literal-property property">areaStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">332</span><span class="token punctuation">,</span> <span class="token number">301</span><span class="token punctuation">,</span> <span class="token number">334</span><span class="token punctuation">,</span> <span class="token number">390</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'搜索引擎'</span><span class="token punctuation">,</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'line'</span><span class="token punctuation">,</span>                <span class="token literal-property property">stack</span><span class="token operator">:</span> <span class="token string">'总量'</span><span class="token punctuation">,</span>                <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">normal</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                        <span class="token literal-property property">show</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'top'</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">areaStyle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">820</span><span class="token punctuation">,</span> <span class="token number">932</span><span class="token punctuation">,</span> <span class="token number">901</span><span class="token punctuation">,</span> <span class="token number">934</span><span class="token punctuation">,</span> <span class="token number">1290</span><span class="token punctuation">,</span> <span class="token number">1330</span><span class="token punctuation">,</span> <span class="token number">1320</span><span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token punctuation">&#123;</span> <span class="token operator">%</span> endecharts <span class="token operator">%</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 使用刚指定的配置项和数据显示图表。</span>    myChart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 刷新调整</span>    window<span class="token punctuation">.</span><span class="token function-variable function">onresize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        myChart<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#123;</span><span class="token operator">%</span> endecharts <span class="token operator">%</span><span class="token punctuation">&#125;</span></code></pre></div></figure><div id="echarts6440" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts6440'));        // 指定图表的配置项和数据        var option =  option = { title: { text: '堆叠区域图' }, tooltip: { trigger: 'axis', axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } } }, legend: { data: ['邮件营销', '联盟广告', '视频广告', '直接访问', '搜索引擎'] }, toolbox: { feature: { saveAsImage: {} } }, grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true }, xAxis: [ { type: 'category', boundaryGap: false, data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'] } ], yAxis: [ { type: 'value' } ], series: [ { name: '邮件营销', type: 'line', stack: '总量', areaStyle: {}, data: [120, 132, 101, 134, 90, 230, 210] }, { name: '联盟广告', type: 'line', stack: '总量', areaStyle: {}, data: [220, 182, 191, 234, 290, 330, 310] }, { name: '视频广告', type: 'line', stack: '总量', areaStyle: {}, data: [150, 232, 201, 154, 190, 330, 410] }, { name: '直接访问', type: 'line', stack: '总量', areaStyle: {}, data: [320, 332, 301, 334, 390, 330, 320] }, { name: '搜索引擎', type: 'line', stack: '总量', label: { normal: { show: true, position: 'top' } }, areaStyle: {}, data: [820, 932, 901, 934, 1290, 1330, 1320] } ] };        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><div id="echarts2713" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts2713'));        // 指定图表的配置项和数据        var option =  option = { xAxis: { type: 'category', boundaryGap: false }, yAxis: { type: 'value', boundaryGap: [0, '30%'] }, visualMap: { type: 'piecewise', show: false, dimension: 0, seriesIndex: 0, pieces: [{ gt: 1, lt: 3, color: 'rgba(0, 180, 0, 0.5)' }, { gt: 5, lt: 7, color: 'rgba(0, 180, 0, 0.5)' }] }, series: [ { type: 'line', smooth: 0.6, symbol: 'none', lineStyle: { color: 'green', width: 5 }, markLine: { symbol: ['none', 'none'], label: {show: false}, data: [ {xAxis: 1}, {xAxis: 3}, {xAxis: 5}, {xAxis: 7} ] }, areaStyle: {}, data: [ ['2019-10-10', 200], ['2019-10-11', 400], ['2019-10-12', 650], ['2019-10-13', 500], ['2019-10-14', 250], ['2019-10-15', 300], ['2019-10-16', 450], ['2019-10-17', 300], ['2019-10-18', 100] ] } ] };         // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><div id="echarts6394" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts6394'));        // 指定图表的配置项和数据        var option = option = {           backgroundColor: '#2c343c',           title: {               text: 'Customized Pie',               left: 'center',               top: 20,               textStyle: {                   color: '#ccc'               }           },           tooltip: {               trigger: 'item'           },           visualMap: {               show: false,               min: 80,               max: 600,               inRange: {                   colorLightness: [0, 1]               }           },           series: [{               name: 'Access From',               type: 'pie',               radius: '55%',               center: ['50%', '50%'],               data: [{                   value: 335,                   name: 'Direct'               }, {                   value: 310,                   name: 'Email'               }, {                   value: 274,                   name: 'Union Ads'               }, {                   value: 235,                   name: 'Video Ads'               }, {                   value: 400,                   name: 'Search Engine'               }].sort(function(a, b) {                   return a.value - b.value;               }),               roseType: 'radius',               label: {                   color: 'rgba(255, 255, 255, 0.3)'               },               labelLine: {                   lineStyle: {                       color: 'rgba(255, 255, 255, 0.3)'                   },                   smooth: 0.2,                   length: 10,                   length2: 20               },               itemStyle: {                   color: '#c23531',                   shadowBlur: 200,                   shadowColor: 'rgba(0, 0, 0, 0.5)'               },               animationType: 'scale',               animationEasing: 'elasticOut',               animationDelay: function(idx) {                   return Math.random() * 200;               }           }]       };        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><blockquote><p>参考：<br><a href="https://hexo.fluid-dev.com/posts/hexo-echarts/#">https://hexo.fluid-dev.com/posts/hexo-echarts/#</a><br><a href="https://pxxyyz.com/posts/html-in-Fluid/#">https://pxxyyz.com/posts/html-in-Fluid/#</a><br><a href="https://echarts.apache.org/examples/zh/index.html#chart-type-bar">https://echarts.apache.org/examples/zh/index.html#chart-type-bar</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>博客</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>markdown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo d博客部署报错</title>
    <link href="/2022/11/14/hexo%E6%8A%A5%E9%94%99/"/>
    <url>/2022/11/14/hexo%E6%8A%A5%E9%94%99/</url>
    
    <content type="html"><![CDATA[<p><code>hexo d</code> 博客部署的时候出现下面这各错误，是网络问题，换个代理节点就好了。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">fatal: unable to access &#39;https:&#x2F;&#x2F;github.com&#x2F;xx&#x2F;xx.github.io&#x2F;&#39;: OpenSSL SSL_read: Connection was reset, errno 10054FATAL &#123;  err: Error: Spawn failed      at ChildProcess.&lt;anonymous&gt; (D:\Blog\hexo\node_modules\hexo-util\lib\spawn.js:51:21)      at ChildProcess.emit (events.js:315:20)      at ChildProcess.cp.emit (D:\Blog\hexo\node_modules\cross-spawn\lib\enoent.js:34:29)      at Process.ChildProcess._handle.onexit (internal&#x2F;child_process.js:277:12)&#123;    code: 128  &#125;&#125; Something&#39;s wrong. Maybe you can find the solution here: %s https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>博客</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PyEcharts学习总结</title>
    <link href="/2022/11/13/pyecharts%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/"/>
    <url>/2022/11/13/pyecharts%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<blockquote><p>pyecharts 分为 <code>v0.5.x</code> 和 <code>v1.0.0+</code> 两个版本，这篇总结针对新版本。</p></blockquote><blockquote><p>本文不包含基础例子的演示，主要记录一些细节方面的理解。简介中推荐的网站有相关示例。</p></blockquote><h2 id="一、简介-–-Echarts-amp-PyEcharts"><a href="#一、简介-–-Echarts-amp-PyEcharts" class="headerlink" title="一、简介 – Echarts &amp; PyEcharts"></a>一、简介 – Echarts &amp; PyEcharts</h2><p><a href="https://github.com/apache/echarts">Echarts</a> 是一个基于 JavaScript 的图表库，用于在 HTML 中生成可交互的图表。关于更多 js 图表库可以参考 CSDN 上的 <a href="https://blog.csdn.net/Pokemogo/article/details/78864664">这篇博客</a>。<a href="https://github.com/pyecharts/pyecharts">PyEcharts</a> 旨在提供在 Python 中使用 Echarts 的 API，以便将数据可视化的流程整合到 Python 数据处理的流程当中。</p><p><strong>以下是四个文档和示例网站，各有特点。利用好这几个网站基本上就可以解决所有可能遇到的问题，而不需要在搜索引擎中漫无目的地翻查。</strong>（喜欢这篇文章的新手朋友，建议先撸一遍下面 gallery.pyecharts.org 里面的代码再来看，因为文章写得不好，入门者很可能一头雾水）</p><ul><li><strong>Echarts</strong><ul><li><a href="https://www.w3cschool.cn/echarts_tutorial">https://www.w3cschool.cn/echarts_tutorial</a> （配置项的文档非常详尽）</li><li><a href="https://echarts.apache.org/zh/index.html">https://echarts.apache.org/zh/index.html</a> （<a href="https://echarts.apache.org/examples/zh/index.html">示例</a>中有很多出色的可视化例子）</li></ul></li><li><strong>PyEcharts</strong><ul><li><a href="https://pyecharts.org/#/zh-cn/intro">https://pyecharts.org/#/zh-cn/intro</a> （PyEcharts 的 API 文档）</li><li><a href="https://gallery.pyecharts.org/#/README">https://gallery.pyecharts.org/#/README</a> （PyEcharts 绘图的示例和代码）</li></ul></li></ul><h3 id="Echarts"><a href="#Echarts" class="headerlink" title="Echarts"></a>Echarts</h3><p>首先通过一个简单的例子了解 Echarts 的工作方式，注意到使用 Echarts 需要 HTML 语言基础，进阶则需要 js 和 css 的基础。（如果只是在 Python 中进行可视化，对前面三件套的要求不高，基本上看看例子就能摸索出来写法，编程语言都是共通的。）</p><figure><div class="code-wrapper"><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>MyCharts<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 引入echarts.js 很多cdn源都可以引用 视情况使用 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/echarts@latest/dist/echarts.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 图表容器--整个网页就是一个div 内容都是通过echarts.min.js渲染出来的 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 600px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>400px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 图表渲染的js代码 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">      <span class="token comment">// 初始化echarts实例</span>      <span class="token keyword">var</span> myChart <span class="token operator">=</span> echarts<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 指定图表的配置项和数据</span>      <span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token punctuation">&#123;</span>          <span class="token comment">// option变量的内容是一个js对象类型(Object) 类似python中的字典类型</span>          <span class="token comment">// option对象的属性(Attribute)可以赋值为各种js基本类型 包括对象类型</span>          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'ECharts 入门示例'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 图表标题选项</span>          <span class="token literal-property property">tooltip</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                      <span class="token comment">// 工具提示选项</span>          <span class="token literal-property property">legend</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'销量'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token comment">// 图例选项</span>          <span class="token literal-property property">xAxis</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"衬衫"</span><span class="token punctuation">,</span><span class="token string">"羊毛衫"</span><span class="token punctuation">,</span><span class="token string">"雪纺衫"</span><span class="token punctuation">,</span><span class="token string">"裤子"</span><span class="token punctuation">,</span><span class="token string">"高跟鞋"</span><span class="token punctuation">,</span><span class="token string">"袜子"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token literal-property property">yAxis</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">// 缺省时没有标注</span>          <span class="token literal-property property">series</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>  <span class="token comment">// series就是图表主体部分用到的数据</span>              <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'销量'</span><span class="token punctuation">,</span>   <span class="token comment">// name参数用于区分多个series</span>              <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>    <span class="token comment">// 图表类型 可以是line,scatter等</span>              <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span> <span class="token comment">// 图表主体的数据 这里就是bar的长度</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>      <span class="token comment">// 使用刚指定的配置项和数据显示图表。</span>      myChart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div></figure><p><img src="https://paradiseeee.github.io/post-assets/20201221/basic.png"></p><p>将上述代码保存为 html 文件在浏览器打开就可以看到图表了（左图），如果直接将 <code>&lt;head&gt;</code> 中引用的 js 文件保存到本地，将引用链接改为本地文件链接，那么无网络的情况下也可以显示。清楚了原理很容易就可以画出自己想要的图表，比如将上述代码中 <code>option.series[0].type</code> 的值改为 <code>line</code>，条形图就变成折线图了（右图）。将 <code>option.series[0].data</code> 中的数据改为自己的数据，就可以可视化自己的数据了。</p><h3 id="PyEcharts"><a href="#PyEcharts" class="headerlink" title="PyEcharts"></a>PyEcharts</h3><p>但是在实际的数据可视化中，我们的数据可能要成千上万行，绘制的图表也有很多个，不可能手动复制粘贴去修改，这时候就需要用到 pyecharts 了。首先通过 <code>pip install pyecharts --upgrade</code> 安装或更新到最新版。绘制以上同样的图表，只需要以下的代码：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 引入子模块</span><span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> charts <span class="token keyword">as</span> pyc<span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> options <span class="token keyword">as</span> opts<span class="token comment"># 这里链式调用，也可以先实例化一个 charts 对象再一步步设置</span>bar <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token comment"># 实例化：</span>    pyc<span class="token punctuation">.</span>Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 对应上面html文档中的 option.XAxis.data：</span>    <span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"衬衫"</span><span class="token punctuation">,</span> <span class="token string">"羊毛衫"</span><span class="token punctuation">,</span> <span class="token string">"雪纺衫"</span><span class="token punctuation">,</span> <span class="token string">"裤子"</span><span class="token punctuation">,</span> <span class="token string">"高跟鞋"</span><span class="token punctuation">,</span> <span class="token string">"袜子"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 对应上面html文档中的 option.series：</span>    <span class="token comment"># 注意到 option.series 是js数组类型，也就是可以添加多个序列</span>    <span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span><span class="token string">"销量"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment"># global_opts 对应上面html文档中的 option 的属性</span>    <span class="token comment"># 例如 option.title 通过 title_opts 参数设置</span>    <span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>title_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TitleOpts<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"Echarts 入门示例"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 在当前目录生成默认名称为 render.html 的文档</span>bar<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p>通过这个例子就可以理解，pyecharts 就是通过 python 代码设置 js 代码里面的变量，然后生成 html 文档。生成的 html 文档不同的是 pyecharts 会把缺省的参数自动填充默认值，所以生成的 html 代码会比上面自己写的长很多。从这里也可以明白为什么说使用 pyecharts 要使用开始介绍的两个 echarts 的网站，因为参数都是对应的。<strong>pyecharts 文档中没查到的参数设置，可以到 echarts 的教程上面查找。</strong></p><h2 id="二、常用图表"><a href="#二、常用图表" class="headerlink" title="二、常用图表"></a>二、常用图表</h2><p>pyecharts 整个项目结构见下图。绘图时用到的所有类都在 <code>pyecharts.charts</code> 子模块中，<code>pyecharts.charts</code> 中所有的图表类都直接或间接继承于 <code>pycharts.Base</code> 类。由于图表类型不同，中间又有不同图表类型的子类，如直角坐标系图表类、 3D 图表类、极坐标图表类，等。相同图表类型的图表绘图方法高度一致，在文章开始介绍的两个 pyecharts 网站中可以找到 API 文档和图表示例代码，比较简单，这里就不做示例了。</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/tree.png"></p><h2 id="三、选项配置"><a href="#三、选项配置" class="headerlink" title="三、选项配置"></a>三、选项配置</h2><p>选项配置主要是 set_global_opts 和 set_series_opts 两个方法，顾名思义前者设置的是对应的 js 代码中 <code>option</code> 变量的属性，后者设置的对应的 js 代码中 <code>option.series</code> 的属性。</p><h3 id="常用-options"><a href="#常用-options" class="headerlink" title="常用 options"></a>常用 options</h3><p>常用的 options 分为四类，对应一般绘图时的四个步骤，注意不是所有图表类的对应方法都通用，在 pyecharts.org 中参考对应方法的文档使用，或者在 ipython 中使用魔术命令： <code>Bar.set_global_opts?</code>、<code>opts.ItemStyleOpts?</code> 等查看对应参数和用法。另外这些 options 是层层嵌套的，比如在 <code>opts.AxisOpts</code> 里面，又有用到 <code>opts.LabelOpts</code> 来定义坐标轴标签的样式，这里就不深挖了，只列举第一层的常用选项。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 图表类的 init_opts，设置图表整体风格，大小等</span><span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> <span class="token builtin">globals</span> <span class="token keyword">as</span> glbsBar<span class="token punctuation">(</span>init_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>InitOpts<span class="token punctuation">(</span>    glbs<span class="token punctuation">.</span>ThemeType<span class="token punctuation">.</span>DARK<span class="token punctuation">,</span> bg_color<span class="token operator">=</span><span class="token string">'#1a1c1d'</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token string">'100%'</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token string">'400px'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-javascript" data-language="javascript"><code class="language-javascript"># 使用 add 方法（泛指 add_yaxis<span class="token punctuation">,</span> add_schema 等）时的 optionsitemstyle_opts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">ItemStyleOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           # 元素样式，如散点图的点emphasis_itemstyle_opts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">ItemStyleOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # 元素高亮样式linestyle_opts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">LineStyleOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           # 用于 Line<span class="token punctuation">.</span>add_yaxis 里面</code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-javascript" data-language="javascript"><code class="language-javascript"># set_series_opts 中的 optionstooltip_opts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">TooltipOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       # 工具提示itemstyle_opts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">ItemStyleOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   # 元素样式label_opts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">LabelOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           # 标签样式，例如条形图顶部显示的数值areastyle_opts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">AreaStyleOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   # 区域样式，例如线形图与坐标轴围成的区域</code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none"># set_global_opts 中的 optionstitle_opts &#x3D; opts.TitleOpts()           # 标题、副标题及其字体颜色等样式xaxis_opts &#x3D; opts.AxisOpts()            # 坐标轴的样式，如轴线样式，文字旋转等yaxis_opts &#x3D; opts.AxisOpts()            # 同上datazoom_opts &#x3D; opts.DataZoomOpts()     # 数据过多时可以使用类似滚动条的插件legend_opts &#x3D; opts.LegendOpts()         # 图例是否显示、样式及其位置等visualmap_opts &#x3D; opts.VisualMapOpts()   # 视觉映射，例如按系列值的大小给元素着色toolbox_opts &#x3D; opts.ToolboxOpts()       # 在图中加入放大缩小，导出图片等工具按钮graphic_opts &#x3D; [opts.GraphicGroup]      # 加入自定义的图形，如多边形，水印等内容</code></pre></div></figure><h3 id="经验总结"><a href="#经验总结" class="headerlink" title="经验总结"></a>经验总结</h3><p>要注意到 <code>pyecharts.options</code> 这个类，上述的两个方法的参数都是赋值为 <code>pyecharts.options</code> 的子类，例如 <code>pyecharts.options.AxisOpts</code>、<code>pyecharts.options.LabelOpts</code>，等。除了使用 options 的子类，还可以直接使用字典（如前文所述，Python 中的字典就相当于 js 的对象，把对应的字典传给对应的属性对象就可以了）。例如</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Line<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    legend_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>LegendOpts<span class="token punctuation">(</span>is_show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>可以写为：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Line<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    legend_opts<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'show'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre></div></figure><p>注意到这里也不是严格对应的，比如在 options 类的参数中是 <code>is_show</code>，在字典中的键是 <code>show</code>。个人觉得这是 pyecharts 的一个不足的地方，主要是因为这是一个 Python 的项目，它得默认使用者不懂 js，于是只能弄一堆的 options 对象（pyecharts.options 里面有大约 100 个 <code>***Opts</code> 对象）和一堆的 init 参数，虽然是很好地 “Python 化” 了，但是也搞到 API 十分的复杂，难记。如果在某些地方适当地使用 js 里面的内容，那整个逻辑会简化很多。可以看到文章一开始使用 echarts 绘图的时候就是一个很简单的逻辑。</p><p>另外这些 options 并不是全在上述两个方法中使用，比如 <code>add_yaxis</code> 中也有很多 options 参数，感觉有点混乱。而且也不是所有图表通用的，只能说是在大部分图表中通用。例如</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Scatter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_series_opts<span class="token punctuation">(</span>    emphasis_itemstyle_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>ItemStyleOpts<span class="token punctuation">(</span>color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>这段代码设置了散点图当鼠标悬停在某个点上时，该点的高亮颜色。在 Line、Bar 等很多图表中都适用，但是在地理图 Geo 的 set_series_opts 方法中没有这个参数。</p><p><strong>并且</strong>，尝试得多了，你可能会发现：</p><ul><li>在 echarts 中支持的属性，在 pyecharts 的 API 中不支持</li><li>在 pyecharts 中支持的参数，写到 html 中时被直接无视，也不报错</li><li>在 pyecharts 中不支持的参数，你给它直接写到 html 文档的 js 代码中时，它是有效的</li></ul><p>等等各种奇怪的问题，这也不知道是 pyecharts 不成熟的地方，还是我自己没理解透彻。<strong>总之说明了一个道理，如果想要精通 pyecharts，随心所欲地绘制各种图表，还是要从学习 echarts 入手。</strong></p><h2 id="四、进阶技巧"><a href="#四、进阶技巧" class="headerlink" title="四、进阶技巧"></a>四、进阶技巧</h2><p>基础的绘图例子都可以在文章开始的网站中找到示例代码，下面介绍一下一些比较有用的进阶技巧。</p><h3 id="更换-echarts-min-js-的引用源"><a href="#更换-echarts-min-js-的引用源" class="headerlink" title="更换 echarts.min.js 的引用源"></a>更换 echarts.min.js 的引用源</h3><p>pyecharts 默认的源是 <code>https://assets.pyecharts.org/assets/</code>，一般国内网络加载较慢，可以通过以下代码采用 CDN 加速。当然，也可以像简介部分提到的，将 echarts.min.js 保存到任意位置然后引用，比如 localhost。如果这样则要注意，有些图不仅仅会用到 echarts.min.js，还需要用到其他的 js 资源，例如地图、词云图等。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">cdn &#x3D; &quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;echarts@latest&#x2F;dist&#x2F;&quot;pyecharts.globals.CurrentConfig.ONLINE_HOST &#x3D; cdn</code></pre></div></figure><h3 id="参数数据类型"><a href="#参数数据类型" class="headerlink" title="参数数据类型"></a>参数数据类型</h3><p>一般我们会使用 pandas 处理数据，然后绘图。这时候要注意 pandas 里面的数值型使用的不是内置类型，而是 numpy 的数据类型。而 echarts 是不认识 numpy 数据类型的，这时候会画一个空的没有数据的图，让人一脸懵。可以如下显式更改数据类型：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Scatter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span>    <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> df<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span>    <span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> df<span class="token punctuation">[</span><span class="token string">'col'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 注意，以下写法是不行的</span><span class="token comment"># 虽然传递的参数是内置类型float，但是pandas还是会自作主张给你改成numpy.float64</span>df<span class="token punctuation">[</span><span class="token string">'col'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="遇到不支持或无效的参数怎么办"><a href="#遇到不支持或无效的参数怎么办" class="headerlink" title="遇到不支持或无效的参数怎么办"></a>遇到不支持或无效的参数怎么办</h3><p>遇到上一小节最后提到的那些问题，比如某些属性在 echarts 中有效，但是在 pyecharts 中没有对应参数或者无效，这种情况我们最直接的思路就是手动去改 html 里面 js 代码。还是以简介部分那个图为例，比如我想微调一下主图在整个画布中的位置（可能是出于想用 overlap 方法在主图上叠加其他图表等原因），在 echarts 中可以如下实现：</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/grid-html.png"></p><p>通过 grid 属性定义主图左上角的坐标和右下角的坐标，坐标可以是相对值，也可以是数值表示的绝对值，单位是 css 中的 px。为了好理解，这里故意将位置调得夸张一点，实际上我们经常需要微调主图的位置来适应布局。但是在 pyecharts 的常用图表类里是不能直接设置这个 grid 属性的（反正我没找到）：</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/grid-error.png"></p><p>可以看到 global options 没有该参数。series options 里面倒是有这个参数，但是设置的不是同一个东西了。唯一的可能就是使用 <code>pyecharts.charts.Grid</code> 这个图表类时才允许加入 grid 参数，如下图。但是 Grid 类和其他常用图表类（例如 Bar）直接继承的类是不一样的，所以用 Grid 类打包图表之后会导致很多原本支持的设置失效。</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/grid.png"></p><p>对此一开始我想到一个很笨拙的办法：强行在 js 中写入属性，替代手动修改属性的过程。首先按照简介中的代码，生成一个 render.html，然后如下写入属性：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">write_js</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> locate<span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        html <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>html<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>locate<span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># locate 用于定位修改位置，这里建议使用 option 里面参数来定位</span><span class="token comment"># 比如这里准备写到 "title" 属性的前面：</span>locate <span class="token operator">=</span> <span class="token string">'"title": [\n'</span> <span class="token comment"># 尽可能多的字符，否则可能定位错</span><span class="token comment"># 需要写入的属性</span>write <span class="token operator">=</span> <span class="token string">'"grid": &#123;"x": "20%", "y": "30%", "x2": "30%", "y2": "20%"&#125;, \n'</span>write_js<span class="token punctuation">(</span><span class="token string">'render.html'</span><span class="token punctuation">,</span> locate<span class="token punctuation">,</span> write<span class="token operator">+</span>locate<span class="token punctuation">)</span></code></pre></div></figure><p><img src="https://paradiseeee.github.io/post-assets/20201221/render.png"></p><p>好笨的方法，千万别学。后来经过进一步对 pycharts 图表类属性的研究，发现可以直接这样就搞定：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 首先绘图</span>bar <span class="token operator">=</span> Bar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token comment"># 然后还缺什么属性，直接往 options 里面添加，然后 render</span>bar<span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token string">'grid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"x"</span><span class="token punctuation">:</span> <span class="token string">"20%"</span><span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">:</span> <span class="token string">"30%"</span><span class="token punctuation">,</span> <span class="token string">"x2"</span><span class="token punctuation">:</span> <span class="token string">"30%"</span><span class="token punctuation">,</span> <span class="token string">"y2"</span><span class="token punctuation">:</span> <span class="token string">"20%"</span><span class="token punctuation">&#125;</span>bar<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 注意到 bar.options 是一个字典</span><span class="token comment"># 它的内容就是生成的 html 文档的 js 代码里面的 option 变量的内容</span></code></pre></div></figure><h3 id="运用-css-和-js-控制视觉效果"><a href="#运用-css-和-js-控制视觉效果" class="headerlink" title="运用 css 和 js 控制视觉效果"></a>运用 css 和 js 控制视觉效果</h3><p>如果想要随心所欲地自定义视觉效果，需要了解一些 css 的基础知识。如果仅仅使用 Python 代码，我们定义一个散点图中的散点的颜色时，可以这样写：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Scatter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span>index_data<span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span>    series_name<span class="token punctuation">,</span> value_data<span class="token punctuation">,</span> itemstyle_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>ItemStyleOpts<span class="token punctuation">(</span>color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>运用 css 代码，我们可以将 ItemStyleOpts 写成：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">opts<span class="token punctuation">.</span>ItemStyleOpts<span class="token punctuation">(</span>color<span class="token operator">=</span><span class="token string">'#ff0000'</span><span class="token punctuation">)</span>opts<span class="token punctuation">.</span>ItemStyleOpts<span class="token punctuation">(</span>color<span class="token operator">=</span><span class="token string">'rgba(255,0,0,1)'</span><span class="token punctuation">)</span></code></pre></div></figure><p>或者运用图表库提供的函数：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pyecharts<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>utils <span class="token keyword">import</span> JsCodeopts<span class="token punctuation">.</span>ItemStyleOpts<span class="token punctuation">(</span>color<span class="token operator">=</span>JsCode<span class="token punctuation">(</span>    <span class="token comment"># 引入echarts.min.js后就可以使用echarts库的方法</span>    <span class="token triple-quoted-string string">''' new echarts.graphic.RadialGradient(        0.5, 0.5, 0.5,          [&#123;offset: 0, color: 'rgba(255,0,0,1)'&#125;,        &#123;offset: 1, color: 'rgba(0,0,255, 1)'&#125;]    ) '''</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>直接在浏览器 console 中更改 option（还是简介中那个图），结果如下：</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/css.png"></p><p>或者对于一些在 API 中为数值常量的参数，可以通过 js 变成变量。例如在散点图中定义点的大小，可以通过 js 使每个点显示不同大小：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Scatter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span>    series_name<span class="token punctuation">,</span> data_pair<span class="token punctuation">,</span>    <span class="token comment"># 固定大小：symbol_size=5,</span>    <span class="token comment"># 由数据值决定大小：</span>    symbol_size<span class="token operator">=</span>JsCode<span class="token punctuation">(</span><span class="token string">'function (data) &#123;return data[1]*10;&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>这里用到的 js 代码其实并不复杂，Python 混 Java 的感觉，学过上述两种的凭感觉都会写。感兴趣的可以学一下。</p><h3 id="运用-js-控制交互效果"><a href="#运用-js-控制交互效果" class="headerlink" title="运用 js 控制交互效果"></a>运用 js 控制交互效果</h3><p>这里经常用于改变工具提示（tooltip），就是鼠标悬停某个数据点时显示出来的东西。以之前做的一个图表为例，主要涉及的 option 如下：</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/example-option.png"></p><p>默认情况下图表的工具提示格式是：<code>series_name \n x轴标签 y轴的值</code>，但是如果需要自定义格式，就要使用 js 回调函数。这个在 pyecharts.org 上也提到，但不是很详细。具体代码如下，参考上图给出的 option 就可以理解了。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pyecharts<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>utils <span class="token keyword">import</span> JsCodetooltipJS <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    function (param) &#123;         // param参数接收的就是上图中的option.series.data这个数组中对应的元素        var line1 = 'name: ' + param.data[0] + '&lt;br/>';        var line2 = 'value1: ' + param.data[1] + '&lt;br/>';        var line3 = 'value2: ' + Math.ceil(10**param.data[2]); // 引用js内置函数        return line1 + line2 + line3;   // return的内容就是到时工具提示显示的内容    &#125;'''</span><span class="token comment"># 然后通过 JsCode 传给 TooltipOpts 的 formatter</span>Scatter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    tooltip_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TooltipOpts<span class="token punctuation">(</span>formatter<span class="token operator">=</span>JsCode<span class="token punctuation">(</span>tooltipJS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>那么问题来了，上图的数据部分是绘图时传给 series 的参数，但是如果我还想在 tooltip 里说点别的东西怎么办？可以在 <code>add_yaxis</code> 时<strong>强行</strong>传进去再使用 js 回调函数。以下是一个完整的绘图例子：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> charts <span class="token keyword">as</span> pyc<span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> options <span class="token keyword">as</span> opts<span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> <span class="token builtin">globals</span> <span class="token keyword">as</span> glbsbar <span class="token operator">=</span> pyc<span class="token punctuation">.</span>Bar<span class="token punctuation">(</span>    init_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>InitOpts<span class="token punctuation">(</span>theme<span class="token operator">=</span>glbs<span class="token punctuation">.</span>ThemeType<span class="token punctuation">.</span>DARK<span class="token punctuation">,</span> bg_color<span class="token operator">=</span><span class="token string">'#1a1c1d'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span>    <span class="token string">'test charts'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>bar<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p><img src="https://paradiseeee.github.io/post-assets/20201221/tooltipjs.png"></p><p>如上图，这时是默认的工具提示格式，但是如果我想让它不显示为数值 <code>[1, 2, 3]</code>，而是描述性的信息，例如 <code>[&#39;低&#39;, &#39;中&#39;, &#39;高&#39;]</code> 或者更丰富的信息，那可以这样写：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">bar <span class="token operator">=</span> pyc<span class="token punctuation">.</span>Bar<span class="token punctuation">(</span>    init_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>InitOpts<span class="token punctuation">(</span>theme<span class="token operator">=</span>glbs<span class="token punctuation">.</span>ThemeType<span class="token punctuation">.</span>DARK<span class="token punctuation">,</span> bg_color<span class="token operator">=</span><span class="token string">'#1a1c1d'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span>    <span class="token string">'test charts'</span><span class="token punctuation">,</span>     <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'低'</span><span class="token punctuation">,</span><span class="token string">'更多信息'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'中'</span><span class="token punctuation">,</span><span class="token string">'更多信息'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'高'</span><span class="token punctuation">,</span><span class="token string">'更多信息'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment"># 通过元组列表强行传进更多的信息</span>    <span class="token comment"># 元组第一位是对应 xaxis 的序号，第二位是序列的值 这里就是bar的长度</span>    <span class="token comment"># 剩下的爱加多少加多少，每个点写一篇800字作文都行</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    tooltip_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TooltipOpts<span class="token punctuation">(</span>formatter<span class="token operator">=</span>JsCode<span class="token punctuation">(</span>        <span class="token triple-quoted-string string">'''        function (param) &#123;            var line1 = 'index: ' + param.data[0] + '&lt;br/>';            var line2 = 'value: ' + param.data[1] + '&lt;br/>';            var line3 = 'info1: ' + param.data[2] + '&lt;br/>';            var line4 = 'info2: ' + param.data[3];            return line1 + line2 + line3 + line4;        &#125;        '''</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>bar<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p>结果如下。如果没看懂这段代码，可以将 html 源码 render 出来，对应着看，自然就理解了。</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/tooltipjs2.png"></p><p><strong>再进一步深入</strong>，以上方法也不是万能的。例如在特别的图表中，根本就没有 <code>add_yaxis</code> 方法。比如 <code>Geo</code> 图表类型，是通过 <code>add</code> 方法传入 series 数据，于是传参的格式跟上面方法又不同。这时可以通过以下代码传入主图以外的数据，以作 tooltip 等其他用途：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">Geo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_schema<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_coordinate<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span>    series_name<span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment"># 这里传入的数据也是一个元组列表，但是它仅限两位的元组</span>    <span class="token comment"># 第一位是地图中区域的名称，也就是到时会在地图中 A, B, C 三个地点标上散点</span>    <span class="token comment"># 第一位在 js 中通过 param.data.name 引用</span>    <span class="token comment"># 第二位是包含额外数据的列表，通过 param.data.value(一个js数组) 引用</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    tooltip_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TooltipOpts<span class="token punctuation">(</span>formatter<span class="token operator">=</span>JsCode<span class="token punctuation">(</span>        <span class="token triple-quoted-string string">'''        function (param) &#123;            return param.data.name + ' | ' +                'info1:' + param.data.value[0] +                 ', info2:' + param.data.value[1] +                 ', info3:' + param.data.value[2];        &#125;        '''</span>        <span class="token comment"># 当鼠标悬停在 B 点时，返回“B | info1: 4, info2: 5, info3: 6”</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p><strong>更复杂的情况是</strong>，加上额外数据后格式就是不对，或者会影响图表的其他组件。比如在上例的 <code>set_global_opts</code> 中加入了 visualmap 组件时，直接传入额外数据会导致 visualmap 显示不正常。这里我没有找到好的办法，所以想了一个_投机取巧_的方法。就是由于 python 字典跟 js 对象的格式是一样的，可以直接生成个字典的字符串写入 js ，然后再引用。于是上例可以写成：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">data_pair <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># 上面的 10, 100, 1000 就是用在 visualmap 中的数据值</span><span class="token comment"># 下面的则是用于 tooltip 的额外数据</span>extend_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>tooltip_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> k<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> v<span class="token punctuation">&#125;</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> extend_data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># 返回 tooltips 的函数</span>tooltipjs <span class="token operator">=</span> <span class="token triple-quoted-string string">r'''    function (param) &#123;        var tooltip_data = __MARKER__; // 到时在 __MARKER__ 这里写入要传的数据        for (int i=0; i&lt;tooltip_data.length; i++) &#123;         // 遍历            if (param.data.name == tooltip_data[i].name) &#123;  // 匹配                var values = tooltip_data[i].value;         // 提取额外数据            &#125;        &#125;        // 返回给 tooltips        return param.data.name + ' | ' +            'info1:'+values[0]+', info2:'+values[1]+', info3:'+values[2];    &#125;'''</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'__MARKER__'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>tooltip_data<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 在这里加入了额外的数据</span><span class="token comment"># 绘图</span>Geo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_schema<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_coordinate<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span>    series_name<span class="token punctuation">,</span> data_pair<span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    tooltip_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TooltipOpts<span class="token punctuation">(</span>formatter<span class="token operator">=</span>Jscode<span class="token punctuation">(</span>tooltipjs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    visualmap_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>VisualMapOpts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 可以看到在调用 pyecharts 绘图时没有用到额外的数据，只有 data_pair</span><span class="token comment"># 用于 tooltip 的数据是写在 js 字符串里偷偷传进去的</span><span class="token comment"># 这时 tooltip 的效果跟上例一样，但是上例的写法不支持 visualmap</span></code></pre></div></figure><p>到这基本就到头了，因为上面的方法虽然很繁琐，但是基本可以所向披靡，对任何的图都通用。并且除了 tooltips，其他的数据交互的问题也可以按类似的思路来解决。</p><h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><h3 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h3><p>回到开始的问题：如何用 pyecharts 绘制一切你想象得到的交互式图表？根据前文的内容可以总结以下的流程：</p><ul><li>1） 根据需求，确定图表类型、基本内容、风格样式等</li><li>2） 粗略画个草图，如果不会画就上 gallery.pyechart.org 上抄个类似的</li><li>3） 通过各种 options 修改图中的细节部分，详细的文档在 pyecharts.org 上</li><li>4） 实在找不到的设置，在简介提到的 Echarts 网站中找配置，再写进 options 字典里</li><li>5） 跟据前面提到的技巧及其思路，修改还不符合要求的地方</li></ul><h3 id="实例验证"><a href="#实例验证" class="headerlink" title="实例验证"></a>实例验证</h3><p>最后用一个实例验证一下上述流程是否真的有用。<strong>第一步</strong>，先找一个属于常用图表类型的，并且相对较复杂的图。这里到 Apache 官网的示例上去找，就用如下<a href="https://echarts.apache.org/examples/zh/editor.html?c=line-aqi">这个图</a>，看起来花里胡俏挺唬人的。<del>这个图印象中 gallery.echarts.org 好像有个类似的例子，这里我们假装不知道先来自己做一下。</del></p><p><img src="https://paradiseeee.github.io/post-assets/20201221/example.png"></p><p>首先把 option 的内容折叠起来以免自己偷看作弊。它上面的数据没有直接写入 option 变量，而是用 jquery 加载的，我没找到接口在哪，所以就在 option 里面加了个 dataView 工具，然后运行，在数据视图中将数据 copy 下来，保存为 <code>data.csv</code>（文末可以下载）。</p><p><strong>第二步</strong>，粗略地画个草图。就是一个主题为 <code>pyecharts.globals.ThemeType.DARK</code> 的折线图，横轴为时间，纵轴为 AQI 数值。页面上加了标题、工具箱、图例、数据缩放工具四个组件。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> charts <span class="token keyword">as</span> pyc<span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> options <span class="token keyword">as</span> opts<span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> <span class="token builtin">globals</span> <span class="token keyword">as</span> glbsdata <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'data.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>line <span class="token operator">=</span> pyc<span class="token punctuation">.</span>Line<span class="token punctuation">(</span>init_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>InitOpts<span class="token punctuation">(</span>theme<span class="token operator">=</span>glbs<span class="token punctuation">.</span>ThemeType<span class="token punctuation">.</span>DARK<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token string">'100%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_xaxis<span class="token punctuation">(</span>    <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_yaxis<span class="token punctuation">(</span>    <span class="token string">'Beijing AQI'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>line<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p>首先画个最简单的图，结果长下面那样。对比一下，缺了上面提到的三个组件。图例默认有了，但是不是我们想要的样子。工具提示显示格式一样了，但是触发方式不一样，下图中要悬停到具体的点上才能触发。折线上多了数据标签，主图背景少了些分割线，等等。</p><p><img src="https://paradiseeee.github.io/post-assets/20201221/1.png"></p><p>然后先简单地使用默认参数，把完整的 options 加上去。可以看到加上组件了，已经离目标接近很多了。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>set_series_opts<span class="token punctuation">(</span>    label_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>LabelOpts<span class="token punctuation">(</span>is_show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    title_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TitleOpts<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">'Beijing AQI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     legend_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>LegendOpts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    visualmap_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>VisualMapOpts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     datazoom_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>DataZoomOpts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     tooltip_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TooltipOpts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    toolbox_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>ToolboxOpts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>line<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p><img src="https://paradiseeee.github.io/post-assets/20201221/2.png"></p><p><strong>第三、四、五步</strong>其实就是一个循环迭代的过程，用这个思路来修改每一个 options。接下来根据上图与原图不同的地方，具体定义组件的 options 参数：</p><p>Title 这里位置太靠边了，原图离最左边有点空隙：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    title_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>TitleOpts<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">'Beijing AQI'</span><span class="token punctuation">,</span> pos_left<span class="token operator">=</span><span class="token string">'1%'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">)</span></code></pre></div></figure><p>Legend 这里想了很久，不知道怎么改成原图那样。后来跳过了，做下面的内容才发现原图那个不是 Legend，而是 Visual Map 产生的图例。所以这里就简单把 Legend 禁用了就行了：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    legend_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>LegendOpts<span class="token punctuation">(</span>is_show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span></code></pre></div></figure><p>Viusal Map 这里明显的区别是，原图那个是离散的，这里目前是连续的，所以先找个参数将它离散化。然后需要定义一下分割的区间。这里我先是凭感觉写了个参数，发现不对，便上 <a href="https://pyecharts.org/#/zh-cn/global_options?id=visualmapopts%ef%bc%9a%e8%a7%86%e8%a7%89%e6%98%a0%e5%b0%84%e9%85%8d%e7%bd%ae%e9%a1%b9">官网</a> 查看了一下文档如下。至于每个区间的颜色，可以用取色器在原图获取：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 自定义的每一段的范围，以及每一段的文字，以及每一段的特别的样式。例如：</span><span class="token comment"># pieces: [</span><span class="token comment">#   &#123;"min": 1500&#125;, // 不指定 max，表示 max 为无限大（Infinity）。</span><span class="token comment">#   &#123;"min": 900, "max": 1500&#125;,</span><span class="token comment">#   &#123;"min": 310, "max": 1000&#125;,</span><span class="token comment">#   &#123;"min": 200, "max": 300&#125;,</span><span class="token comment">#   &#123;"min": 10, "max": 200, "label": '10 到 200（自定义label）'&#125;,</span><span class="token comment">#   &#123;"value": 123, "label": '123（自定义特殊颜色）', "color": 'grey'&#125;,</span><span class="token comment">#   &#123;"max": 5&#125;     // 不指定 min，表示 min 为无限大（-Infinity）。</span><span class="token comment"># ]</span>pieces<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Sequence<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    visualmap_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>VisualMapOpts<span class="token punctuation">(</span>        is_piecewise<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> pos_top<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> pos_right<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>        pieces<span class="token operator">=</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span><span class="token string">'min'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'#93CE07'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">'min'</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'#FBDB0F'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">'min'</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">:</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'#FC7D02'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">'min'</span><span class="token punctuation">:</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'#FD0100'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">'min'</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'#AA069F'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">'min'</span><span class="token punctuation">:</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'#AC3B2A'</span><span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">)</span></code></pre></div></figure><p>Data Zoom 组件默认显示 20%-80%，看一下文档，发现有个 start_value 参数，由于原图中就是显示最后一部分，所以可以使用这个参数搞定。但是第一次试了发现不行，原因是它已经给开始结束位置设置了默认值，所以要先将这两个值设为空值，start_value 参数才有效。另外发现原图是可以在主图里面直接拖动的，所以要改一下 type 参数。这里就出现问题了，改了 type 之后，里面可以拖动了，但是外面的滚动条不见了。这里只好查看原图的代码抄答案，原来它用数组的形式定义了两个 Data Zoom 组件，一个在里面，一个在外面：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    datazoom_opts<span class="token operator">=</span><span class="token punctuation">[</span>        opts<span class="token punctuation">.</span>DataZoomOpts<span class="token punctuation">(</span>            start_value<span class="token operator">=</span><span class="token string">'2014-06-01'</span><span class="token punctuation">,</span> range_start<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> range_end<span class="token operator">=</span><span class="token boolean">None</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>         opts<span class="token punctuation">.</span>DataZoomOpts<span class="token punctuation">(</span>type_<span class="token operator">=</span><span class="token string">'inside'</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span></code></pre></div></figure><p>Tooltip 组件需要更改触发方式，简单加上 trigger 参数即可：</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">1line.set_global_opts(tooltip_opts&#x3D;opts.TooltipOpts(trigger&#x3D;&#39;axis&#39;))</code></pre></div></figure><p>Toolbox 组件多了一堆按钮，简单研究一下文档，把不必要的删掉就 OK。实际写时发现 pyecharts 的那个缺点又出现了，就是太多 options 对象。执行 <code>opts.ToolBoxFeatureOpts?</code> 就可以看到，可以说看了头皮发麻。所以这里用字典传参，只需要把 python 中的变量名用下划线分割单词的习惯，改成 js 中用首字母大写分割单词，参数基本就对应上了。然后用字典代替 options 对象就行了。然后还要改一下它的位置，原图是靠右对齐，并且离最右边留有一点空隙，这里因为也已经有默认参数，一样要先把默认参数置空：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>set_global_opts<span class="token punctuation">(</span>    toolbox_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>ToolboxOpts<span class="token punctuation">(</span>        pos_left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> pos_right<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>        feature<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'dataZoom'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'restore'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'saveAsImage'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span></code></pre></div></figure><p>然后好像还差点什么？没错，Y 轴的分割线。估计应该是在 yaxis_opts 里添加，于是试一下。发现分割线是有了，但是还差那些带箭头的虚线，查了一下文档，发现应该在 <code>set_series_opts</code> 里面通过 <code>opts.MarkLineOpts</code> 设置：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>set_series_opts<span class="token punctuation">(</span>    markline_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>MarkLineOpts<span class="token punctuation">(</span>        label_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>LabelOpts<span class="token punctuation">(</span>position<span class="token operator">=</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        linestyle_opts<span class="token operator">=</span>opts<span class="token punctuation">.</span>LineStyleOpts<span class="token punctuation">(</span>color<span class="token operator">=</span><span class="token string">'#333'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'yAxis'</span><span class="token punctuation">:</span> y<span class="token punctuation">&#125;</span> <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></figure><p>最后主图的位置和原图不太一样，通过 grid 属性改一下。参考第四节中提到的关于<a href="https://paradiseeee.github.io/2020/12/21/PyEcharts-%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/#%E9%81%87%E5%88%B0%E4%B8%8D%E6%94%AF%E6%8C%81%E6%88%96%E6%97%A0%E6%95%88%E7%9A%84%E5%8F%82%E6%95%B0%E6%80%8E%E4%B9%88%E5%8A%9E">参数无效</a>的问题：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">line<span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token string">'grid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'left'</span><span class="token punctuation">:</span> <span class="token string">'6%'</span><span class="token punctuation">,</span> <span class="token string">'right'</span><span class="token punctuation">:</span> <span class="token string">'15%'</span><span class="token punctuation">,</span> <span class="token string">'bottom'</span><span class="token punctuation">:</span> <span class="token string">'12%'</span><span class="token punctuation">&#125;</span></code></pre></div></figure><p>结果如下，基本与原图一样了。有细微区别是因为 Apache 网站上的图表容器跟这里的不一样，并且上面的网页截图时浏览器开了扩展 DarkReader，所以颜色也有点改变的地方。</p><blockquote><p><a href="https://paradiseeee.github.io/post-assets/20201221/render.html">在新标签页打开交互式图表</a> | <a href="https://paradiseeee.github.io/post-assets/20201221/code.py">下载完整绘图代码</a> | <a href="https://paradiseeee.github.io/post-assets/20201221/data.csv">下载数据</a></p></blockquote><p><img src="https://paradiseeee.github.io/post-assets/20201221/3.png"></p><hr><p>鸣谢 &amp; 推荐：<a href="https://blog.csdn.net/qq_27484665">@AwesomeTang</a></p><p><strong>END</strong></p><blockquote><p>原文链接：<a href="https://paradiseeee.github.io/2020/12/21/PyEcharts-%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">https://paradiseeee.github.io/2020/12/21/PyEcharts-%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</a></p></blockquote><hr>]]></content>
    
    
    <categories>
      
      <category>数据分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Markdown语法</title>
    <link href="/2022/11/12/Markdown%E8%AF%AD%E6%B3%95/"/>
    <url>/2022/11/12/Markdown%E8%AF%AD%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><table><thead><tr><th>Syntax</th><th>Description</th></tr></thead><tbody><tr><td>Header</td><td>Title</td></tr><tr><td>Paragraph</td><td>Text</td></tr></tbody></table><table><thead><tr><th>Syntax</th><th>Description</th></tr></thead><tbody><tr><td>Header</td><td>Title</td></tr><tr><td>Paragraph</td><td>Text</td></tr></tbody></table><h2 id="任务列表"><a href="#任务列表" class="headerlink" title="任务列表"></a>任务列表</h2><ul><li><input checked="" disabled="" type="checkbox"> Write the press release</li><li><input checked="" disabled="" type="checkbox"> Update the website</li><li><input disabled="" type="checkbox"> Contact the media</li></ul><h2 id="表情符号"><a href="#表情符号" class="headerlink" title="表情符号"></a>表情符号</h2><p>sfs :unamused:</p><h2 id="行内标签"><a href="#行内标签" class="headerlink" title="行内标签"></a>行内标签</h2><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#123;% label primary @text %&#125;&lt;span class&#x3D;&quot;label label-primary&quot;&gt;Label&lt;&#x2F;span&gt;可选类别：primary default info success warning danger</code></pre></div></figure><p><span class="label label-primary">Label</span></p><h2 id="参考脚注"><a href="#参考脚注" class="headerlink" title="参考脚注"></a>参考脚注</h2><p>这是一句话<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="参考资料1">[1]</span></a></sup></p><h2 id="便签"><a href="#便签" class="headerlink" title="便签"></a>便签</h2><blockquote><p>可选类别<br>  primary<br>  secondary<br>  success<br>  danger<br>  warning<br>  info<br>  light</p></blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#123;% note success %&#125;文字 或者 &#96;markdown&#96; 均可&#123;% endnote %&#125;</code></pre></div></figure><div class="note note-success">            <p>两种方式：上面是第一种方式，下面是html方法</p>          </div><figure><div class="code-wrapper"><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>note note-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>便签<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></code></pre></div></figure><p class="note note-danger">便签</p><h2 id="按钮"><a href="#按钮" class="headerlink" title="按钮"></a>按钮</h2><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#123;% btn url, text, title %&#125;或者&lt;a class&#x3D;&quot;btn&quot; href&#x3D;&quot;https:&#x2F;&#x2F;hexo.fluid-dev.com&#x2F;docs&#x2F;guide&#x2F;#tag-%E6%8F%92%E4%BB%B6&quot; title&#x3D;&quot;title&quot;&gt;tag&lt;&#x2F;a&gt;</code></pre></div></figure><a class="btn" href="(https://hexo.fluid-dev.com/docs/guide/#tag-%E6%8F%92%E4%BB%B6)"  title="title" target="_blank">text</a><p><a class="btn" href="https://hexo.fluid-dev.com/docs/guide/#tag-%E6%8F%92%E4%BB%B6" title="title">tag</a><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>这是对应的脚注<br><a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:1" class="footnote-text"><span>参考资料1<br><a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>参考资料2<br><a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section></p>]]></content>
    
    
    <categories>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
      <tag>markdown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python如何与MySQL实现交互及常用sql语句</title>
    <link href="/2022/11/12/python%E8%BF%9E%E6%8E%A5MySQL/"/>
    <url>/2022/11/12/python%E8%BF%9E%E6%8E%A5MySQL/</url>
    
    <content type="html"><![CDATA[<p>9 月初，我对 <code>python 爬虫</code> 燃起兴趣，但爬取到的数据多通道实时同步读写用<code>文件</code>并不方便，于是开始用起<code>mysql</code>。这篇笔记，我将整理近一个月的实战中最常用到的 <code>mysql</code> 语句，同时也将涉及到如何在<code>python3</code>中与 <code>mysql</code> 实现数据交换。</p><p>关于工具&#x2F;库，特别说明下：</p><p>1、我安装了 <code>mysql</code> ，并直接采用管理员身份运行<code>命令行提示符（cmd）</code>查看 <code>mysql</code>，并没有安装任何 <code>mysql</code> 的可视化图形界面工具。</p><p>2、在 <code>python</code> 脚本中，我采用 <code>pymysql</code> 和 <code>sqlalchemy</code> 这两个库与 <code>mysql</code> 建立连接，用 <code>pandas</code> 来处理数据。</p><h2 id="一、建立连接与数据交互"><a href="#一、建立连接与数据交互" class="headerlink" title="一、建立连接与数据交互"></a>一、建立连接与数据交互</h2><p>与 mysql 交互的方式，我目前共使用 4 种。其中采用管理员身份运行<code>命令行提示符（cmd）</code>查看 <code>mysql</code>，其操作图示可另写一篇。这里就不占篇幅了。mysql的可视化图形界面工具，我目前并没有用到，也没有迫切使用它的需要。另外 3 种方式都是通过 python 脚本进行。</p><h3 id="情境A：python-演算得出数据，想要写入数据库"><a href="#情境A：python-演算得出数据，想要写入数据库" class="headerlink" title="情境A：python 演算得出数据，想要写入数据库"></a>情境A：python 演算得出数据，想要写入数据库</h3><p>python 脚本已得到表格类大量数据，想要一次性写入数据库，常用代码如下：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token comment"># 与 mysql 建立连接</span><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engineconn_eng <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://username:password@localhost:3306/databasename'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>  <span class="token comment"># 调用 pandas 的方法，数据写入mysql</span>pd<span class="token punctuation">.</span>io<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>your_df<span class="token punctuation">,</span> <span class="token string">"table_name"</span><span class="token punctuation">,</span> conn_eng<span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'append'</span><span class="token punctuation">,</span>index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre></div></figure><p>表格类数据，我用的是 <code>pandas</code> 的 <code>dataframe</code> 结构。<code>pd.io.sql.to_sql()</code> 的参数还有许多其它用途，但上面这种是我个人使用最高频的。效果是：无需自己提前建表，将自动建新表。美中不足是：表的列属性自动生成，通常不合心意，还需检查和修改。</p><p>如果不想用 <code>pd.io.sql.to_sql()</code> 或者想更精细、复杂的操作，则用到下面的情境C。</p><h3 id="情境B：python-脚本想从-mysql-拿到数据"><a href="#情境B：python-脚本想从-mysql-拿到数据" class="headerlink" title="情境B：python 脚本想从 mysql 拿到数据"></a>情境B：python 脚本想从 mysql 拿到数据</h3><p>如果已经存在某个表格，想要向该表格提交某条指令，需返回数据，我用的是 <code>pandas</code>的<code>read_sql ()</code> ，返回的数据类型是 <code>pandas</code> 的 <code>dataframe</code>。sql 查询语句挺好写的，具体总结在本文下方。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pymysql<span class="token comment"># 与 mysql 建立连接</span>conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span><span class="token string">'username'</span><span class="token punctuation">,</span><span class="token string">'password'</span><span class="token punctuation">,</span><span class="token string">'databasename'</span><span class="token punctuation">)</span><span class="token comment"># sql 语句定义为一个字符串</span>sql_search <span class="token operator">=</span> <span class="token string">'select question_id from topic_monitor where is_title=0 ;'</span><span class="token comment"># 调用 pandas 的 read_sql() 方法拿到 dataframe 结构的数据</span>question_ids <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql_search<span class="token punctuation">,</span>conn<span class="token punctuation">)</span><span class="token comment"># 关闭连接</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="情境C：python-脚本单方面向-mysql-发出指令，无需拿到数据"><a href="#情境C：python-脚本单方面向-mysql-发出指令，无需拿到数据" class="headerlink" title="情境C：python 脚本单方面向 mysql 发出指令，无需拿到数据"></a>情境C：python 脚本单方面向 mysql 发出指令，无需拿到数据</h3><p>如果已经存在某个表格，想要向该表格提交某条指令而无需返回数据时，比如：建表、对数据的增改删、对列的名称、列的属性修改等，代码如下。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pymysql<span class="token comment"># 与 mysql 建立连接</span>conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span><span class="token string">'username'</span><span class="token punctuation">,</span><span class="token string">'password'</span><span class="token punctuation">,</span><span class="token string">'databasename'</span><span class="token punctuation">)</span>cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># sql 语句定义为一个字符串，插入一行数据</span>sql_insert <span class="token operator">=</span> <span class="token string">'INSERT INTO questions(q_id,q_title,q_description,q_keywords,q_people,q_pageview,time) VALUES( "'</span>\                <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>quesition_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'", "'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>one<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">'", "'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>one<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'", "'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>one<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'", "'</span> \                <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>one<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'", "'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>one<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'", "'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'");'</span> <span class="token comment"># sql 语句定义为一个字符串，修改某个数据（另一个表格）</span>sql_update <span class="token operator">=</span> <span class="token string">'update topic_monitor SET is_title="1" where question_id = "'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>quesition_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'";'</span><span class="token comment"># 提交指令</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_insert<span class="token punctuation">)</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_update<span class="token punctuation">)</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 插入一行数据；仅当该数据与表格已有数据不重复时才插入，否则就不会插入</span>sql_insert <span class="token operator">=</span> <span class="token string">'INSERT INTO `topic_monitor`(question_id,is_title,q_type,topic_id,time) SELECT "'</span>\                    <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'", "0", "0","'</span>  <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>topic_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'", "'</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">+</span> '" FROM DUAL WHERE NOT EXISTS<span class="token punctuation">(</span>\                    SELECT question_id FROM topic_monitor WHERE question_id <span class="token operator">=</span> <span class="token string">"' + x[0] + '"</span><span class="token punctuation">)</span>'cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_insert<span class="token punctuation">)</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 关闭连接</span>cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><p>通过上面几种实用情况可以看到，<code>python</code> 与 <code>mysql</code> 实现交互的过程，通常分为：建立连接、把sql语句定义为字符串，提交指令、关闭连接。核心的技能在于 sql语句；除了定义sql语句字符串，其余3个处理都是固定的写法。</p><p>我在最初一个月的实践中，最常出现的错误有：</p><ul><li>值的引用没有加上引号；</li><li>符号错乱：多一个符号，少一个符号；</li><li>值的类型不符合：不管 mysql 表格中该值是数，还是文本，在定义 sql 语句的字符串时，对每个值都需要转化为字符串；</li><li>拷贝自己的代码时，忘记修改databasename。</li></ul><h2 id="二、sql语句：搜索查询"><a href="#二、sql语句：搜索查询" class="headerlink" title="二、sql语句：搜索查询"></a>二、sql语句：搜索查询</h2><p>搜索是指在数据库的某个表格中查询符合特定条件的数据，并返回查询结果。其基本结构为：</p><p><code>SELECT 【范围】FROM table_name 【条件】;</code> 其中，范围是必须指定的，而条件可有可无。</p><h3 id="变量A：范围，是指返回查询结果的范围。"><a href="#变量A：范围，是指返回查询结果的范围。" class="headerlink" title="变量A：范围，是指返回查询结果的范围。"></a>变量A：范围，是指返回查询结果的范围。</h3><p>返回该表格的所有字段，用 * 表达：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM table_name ;</code></pre></div></figure><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/9/27/16d72eb3fa3da2c1~tplv-t2oaga2asx-zoom-in-crop-mark:3402:0:0:0.awebp" alt="image"></p><p>仅返回该表格的某个字段：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT column_name FROM table_name ;</code></pre></div></figure><p>仅返回该表格的多个字段：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT column_name_1,column_name_3,column_name_3 FROM table_name ;</code></pre></div></figure><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/9/27/16d72ea94e130ac7~tplv-t2oaga2asx-zoom-in-crop-mark:3402:0:0:0.awebp" alt="image"></p><p>仅返回符合条件的数据个数：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT count(*) FROM table_name ;</code></pre></div></figure><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/9/27/16d72ea94e262e64~tplv-t2oaga2asx-zoom-in-crop-mark:3402:0:0:0.awebp" alt="image"></p><h3 id="变量B：条件是指，期望返回的数据满足哪些条件。"><a href="#变量B：条件是指，期望返回的数据满足哪些条件。" class="headerlink" title="变量B：条件是指，期望返回的数据满足哪些条件。"></a>变量B：条件是指，期望返回的数据满足哪些条件。</h3><p>不限定条件：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM table_name ;</code></pre></div></figure><p>数值类：某个字段（数值类型的，比如double或者int），数值比较的操作符都可以使用比如，大于<code>&gt;</code>，小于<code>&lt;</code>，等于 <code>=</code> ，大于等于 <code>&gt;=</code> ，小于等于 <code>&lt;=</code> ：</p><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/9/27/16d72eb3fa5311f5~tplv-t2oaga2asx-zoom-in-crop-mark:3402:0:0:0.awebp" alt="image"></p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM table_name WHERE num_column_name &gt;&#x3D; 1;</code></pre></div></figure><p>文本类：某个字段（字符串类型的，比如char，text）：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM table_name WHERE str_column_name like “%your_str%”;</code></pre></div></figure><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/9/27/16d72ea94e682c22~tplv-t2oaga2asx-zoom-in-crop-mark:3402:0:0:0.awebp" alt="image"></p><p>也可以表达多个条件，<code>and</code>，<code>or</code>等可用于表达条件之间的关系：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM table_name WHERE num_column_name_1 &gt;&#x3D; 1 and  str_column_name like “%your_str%” ;</code></pre></div></figure><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/9/27/16d72eb3fa478de0~tplv-t2oaga2asx-zoom-in-crop-mark:3402:0:0:0.awebp" alt="image"></p><h2 id="三、sql语句：修改表属性"><a href="#三、sql语句：修改表属性" class="headerlink" title="三、sql语句：修改表属性"></a>三、sql语句：修改表属性</h2><p>横向的一整条数据，叫做行；竖向的一整条数据，叫作列。列的名字，叫做 <code>column</code>，这是通用的知识点。</p><p>这段时间的实战中，我完全没有用到修改表的名称、重设index等知识点。最常用的，就是对列进行操作。每个列具备：列的名称、列的属性、列的数值。</p><p>列的名称，需要留心不使用保留词。我的技巧是，尽量用一些<code>_</code>来表达该数据，比如 <code>article_title</code>，<code>press_date</code> 这种命名虽然稍长，但易读，也不会装上保留词。</p><p>列的属性包括：类型，最大长度，是否为空，默认值，是否重复，是否为索引。通常，直接通过 <code>pandas</code> 的 <code>pd.io.sql.to_sql()</code> 一次性创建表格并保存数据时，列的默认属性并不合需求。要么提前自己定义表的结构，设置好每列属性；要么事后检查列属性，并逐列修改。所以，列的属性设定、修改是高频基础知识点。</p><p>列的数值，即除了列名称外的、该列其它值。修改某个值，也是高频操作。不过我把这个知识点放到第四部分了。</p><p>对列的名称、列的属性进行修改，主要的关键词都是 <code>ALTER</code>，具体又分为以下几种情况。</p><h3 id="情境A：新增一列。关键词-ADD"><a href="#情境A：新增一列。关键词-ADD" class="headerlink" title="情境A：新增一列。关键词 ADD"></a>情境A：新增一列。关键词 <code>ADD</code></h3><p>在你所指定的 <code>column_name</code> 后面定义列的属性。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">ALTER TABLE table_name ADD COLUMN column_name char(20);</code></pre></div></figure><h3 id="情境B：修改某列的名称。关键词-CHANGE"><a href="#情境B：修改某列的名称。关键词-CHANGE" class="headerlink" title="情境B：修改某列的名称。关键词 CHANGE"></a>情境B：修改某列的名称。关键词 <code>CHANGE</code></h3><p>在修改列名的同时也可以重新指定列的属性。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">ALTER TABLE table_name CHANGE old_column_name new_column_name char(50);</code></pre></div></figure><h3 id="情境C：修改某列的属性。关键词是-MODIFY"><a href="#情境C：修改某列的属性。关键词是-MODIFY" class="headerlink" title="情境C：修改某列的属性。关键词是 MODIFY"></a>情境C：修改某列的属性。关键词是 <code>MODIFY</code></h3><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">ALTER TABLE table_name MODIFY column_name char(100);</code></pre></div></figure><h2 id="四、sql语句：数据的增改删"><a href="#四、sql语句：数据的增改删" class="headerlink" title="四、sql语句：数据的增改删"></a>四、sql语句：数据的增改删</h2><p>通常提到数据库操作时，四字以蔽之：增删改查。</p><ul><li>查询，请看第二部分。关键词是 <code>SELECT</code>。</li><li>对数据所依赖的属性的增、改，请看第三部分。关键词是 <code>ALTER</code>。</li><li>数据的增加，在第一部分的数据交互中也给出实例，就不重复了。关键词是<code>INSERT</code>。</li><li>数据的修改，关键词是 <code>UPDATE</code>。</li><li>数据（甚至表格、库）的删除，关键词是<code>DELETE</code>。</li></ul><p>数据的修改，副关键词是 <code>set</code> 。</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">UPDATE table_name SET columns_name &#x3D; new_value 【条件】;</code></pre></div></figure><p>新数值如果是数值类型的，则直接写数值即可；如果是文本类型的，必须要加上双引号，比如，<code>“your_new_value”</code>。</p><p>如果把【条件】部分不写，就相当于修改整列的值；想要修改特定范围，就要用到条件表达式，这和前面的查询部分是一致的，就不再重复。</p><p>数据的删除，对于新手来说，是必须警惕的操作。因为一旦误操作，你将无力挽回。即便是职业程序员，也可能犯下无疑删库的惨剧。其基本语句为：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">DELETE FROM table_name【条件】;</code></pre></div></figure><p>想要修改特定范围，就要用到条件表达式，这和前面的查询部分也是一致的，稍微啰嗦两句：不要对自己设定的条件太自信，最好先用搜索语句检查一下，然后再执行删除语句。</p><ul><li>删除单行数据：添加能唯一标识该行数据的条件语句。</li><li>删除多行数据：添加能标识该范围的条件语句。</li><li>删除整张表格：<strong>你是认真的吗？没有写错表格名字吧？！</strong> 做这项操作前，必须确认清楚自己的意图，毕竟一旦发生，无可挽回。</li></ul><p>如果条件留空，将保留表结构，而删除所有数据行。想要删除整张表格，什么都不留下，则执行：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">DELETE TABLE table_name;</code></pre></div></figure><p>俗称的“删库”就是删掉整个数据库，虽然实战中几乎不会用到，但作为新手经常手误，在练习阶段安全起见，最好还是专门创建一个 database 用于练手，练完直接删掉整个练习库：</p><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">DELETE DATABASE database_name;</code></pre></div></figure><p>如果简单总结下过去一个月，使用<code>mysql</code>的体验，那就是：除了<code>mysql</code> 的安装激活太麻烦，数据的增删改查比操作文本方便太多了！！完全值得容忍安装激活的麻烦。另外 <code>mysql</code> 常用语法确实简单、非常有规律。</p><p>希望我的总结带给你帮助。鼓励我继续分享，那就请点个赞吧！</p>]]></content>
    
    
    <categories>
      
      <category>数据分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>Python</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何让SQL提高一个台阶？</title>
    <link href="/2022/11/11/%E5%A6%82%E4%BD%95%E8%AE%A9SQL%E6%8F%90%E9%AB%98%E4%B8%80%E4%B8%AA%E5%8F%B0%E9%98%B6%EF%BC%9F/"/>
    <url>/2022/11/11/%E5%A6%82%E4%BD%95%E8%AE%A9SQL%E6%8F%90%E9%AB%98%E4%B8%80%E4%B8%AA%E5%8F%B0%E9%98%B6%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<blockquote><p>MySQl 专栏持续更新 不说晦涩难懂的东西 尽量输出容易理解 和 使用的SQL技巧 和 初中级开发不是很常用的但很有用的知识</p><p>欢迎查看👉🏻👉🏻👉🏻<a href="https://juejin.cn/column/7157955810826387470" title="https://juejin.cn/column/7157955810826387470">SQL 专栏</a> 查漏补缺 指教一二</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9572ab2e6c3545dbaa4b2b75f4a3b6c1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="src=http __img2.biaoqingjia.com_biaoqing_201810_2c3993f64eec252da6d674f9d80fc4e9.gif&amp;refer=http __img2.biaoqingjia.gif"></p><p>每一次写博客对技术都会有更深入的理解 积少成多 百天计划我也想看看自己有多少成长 祝君好运 工作顺利</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>SQL 写不好 加班少不了 日常工作中SQL 是必不可少的一项技术 但是很多人不会过多的去关注SQL问题 一是数据量小 二是没有意识到索引的重要性 本文主要是整理 SQL失效场景 如果里面的细节你都知道 那你一定是学习能力比较好的人 膜拜 写完这篇文章 我感觉自己之前知道的真的是 “目录” 没有明白其中的内容 如果你能跟着节奏看完文章 一定会有收获 至少我写完感觉思维通透很多 以后百分之九十的 SQl索引问题 和 面试这方面问题都能拿捏两</p><p><code>文章 字数 四千余字 观看时长十分钟 练习时长两个半小时</code></p><h2 id="基础数据准备"><a href="#基础数据准备" class="headerlink" title="基础数据准备"></a>基础数据准备</h2><p>准备一个数据表作为 数据演示 这里面一共 创建了三个索引</p><ul><li>联合索引 <code>sname</code>, <code>s_code</code>, <code>address</code></li><li>主键索引 <code>id</code></li><li>普通索引 <code>height</code></li></ul><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">SET NAMES utf8mb4;SET FOREIGN_KEY_CHECKS &#x3D; 0;-- ------------------------------ Table structure for student-- ----------------------------DROP TABLE IF EXISTS &#96;student&#96;;CREATE TABLE &#96;student&#96;  (  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,  &#96;sname&#96; varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,  &#96;s_code&#96; int(100) NULL DEFAULT NULL,  &#96;address&#96; varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,  &#96;height&#96; double NULL DEFAULT NULL,  &#96;classid&#96; int(11) NULL DEFAULT NULL,  &#96;create_time&#96; datetime(0) NOT NULL ON UPDATE CURRENT_TIMESTAMP(0),  PRIMARY KEY (&#96;id&#96;) USING BTREE,  INDEX &#96;普通索引&#96;(&#96;height&#96;) USING BTREE,  INDEX &#96;联合索引&#96;(&#96;sname&#96;, &#96;s_code&#96;, &#96;address&#96;) USING BTREE) ENGINE &#x3D; InnoDB AUTO_INCREMENT &#x3D; 5 CHARACTER SET &#x3D; utf8 COLLATE &#x3D; utf8_general_ci ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ Records of student-- ----------------------------INSERT INTO &#96;student&#96; VALUES (1, &#39;学生1&#39;, 1, &#39;上海&#39;, 170, 1, &#39;2022-11-02 20:44:14&#39;);INSERT INTO &#96;student&#96; VALUES (2, &#39;学生2&#39;, 2, &#39;北京&#39;, 180, 2, &#39;2022-11-02 20:44:16&#39;);INSERT INTO &#96;student&#96; VALUES (3, &#39;变成派大星&#39;, 3, &#39;京东&#39;, 185, 3, &#39;2022-11-02 20:44:19&#39;);INSERT INTO &#96;student&#96; VALUES (4, &#39;学生4&#39;, 4, &#39;联通&#39;, 190, 4, &#39;2022-11-02 20:44:25&#39;);</code></pre></div></figure><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>上面的SQL 我们已经创建好基本的数据 在验证之前 先带着几个问题</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a517883c2f734ed9aad32fe69341e5b2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>我们先从上往下进行验证</p><h2 id="最左匹配原则"><a href="#最左匹配原则" class="headerlink" title="最左匹配原则"></a>最左匹配原则</h2><p>写在前面：我很早之前就听说过数据库的最左匹配原则，当时是通过各大博客论坛了解的，但是这些博客的局限性在于它们对最左匹配原则的描述就像一些数学定义一样，往往都是列出123点，满足这123点就能匹配上索引，否则就不能。 最左匹配原则就是指在联合索引中，如果你的 SQL 语句中用到了联合索引中的最左边的索引，那么这条 SQL 语句就可以利用这个联合索引去进行匹配，我们上面建立了联合索引 可以用来测试最左匹配原则 <code>sname</code>, <code>s_code</code>, <code>address</code></p><p>请看下面SQL语句 进行思考 是否会走索引</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">-- 联合索引 sname,s_code,address1、select create_time from student where sname &#x3D; &quot;变成派大星&quot;  -- 会走索引吗？2、select create_time from student where s_code &#x3D; 1   -- 会走索引吗？3、select create_time from student where address &#x3D; &quot;上海&quot;  -- 会走索引吗？4、select create_time from student where address &#x3D; &quot;上海&quot; and s_code &#x3D; 1 -- 会走索引吗？5、select create_time from student where address &#x3D; &quot;上海&quot; and sname &#x3D; &quot;变成派大星&quot;  -- 会走索引吗？6、select create_time from student where sname &#x3D; &quot;变成派大星&quot; and address &#x3D; &quot;上海&quot;  -- 会走索引吗？7、select create_time from student where sname &#x3D; &quot;变成派大星&quot; and s_code &#x3D; 1 and address &#x3D; &quot;上海&quot;  -- 会走索引吗？</code></pre></div></figure><p>凭你的经验 哪些会使用到索引呢 ？ 可以先思考一下 在心中记下数字</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/783520d8f38b4e259e8f6d7b65a05103~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p><strong>走索引例子</strong></p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">EXPLAIN  select create_time from student where sname &#x3D; &quot;变成派大星&quot;  -- 会走索引吗？</code></pre></div></figure><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d253165cfba04252aa4c4a219b697a81~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p><strong>未走索引例子</strong></p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">EXPLAIN select create_time from student where address &#x3D; &quot;上海&quot; and s_code &#x3D; 1 -- 会走索引吗？</code></pre></div></figure><p>走的全表扫描 rows &#x3D; 4 <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9395730bd49645f1848278ff1d7d2467~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"> 如果不知道<code>EXPLAIN</code> 是什么的 或者看不懂分析出来的数据的话 建议去看看另一篇文章<a href="https://juejin.cn/post/7161254854571065375" title="https://juejin.cn/post/7161254854571065375">分析命令EXPLAIN超详解</a></p><p>如果你内心的答案没有全部说对就接着往下看</p><p>最左匹配原则顾名思义：最左优先，以最左边的为起点任何连续的索引都能匹配上。<strong>同时遇到范围查询(&gt;、&lt;、between、like)就会停止匹配</strong>。<br>例如：s_code &#x3D; 2 如果建立(<code>sname</code>, <code>s_code</code>)顺序的索引，是匹配不到(<code>sname</code>, <code>s_code</code>)索引的;</p><p>但是如果查询条件是sname &#x3D; “变成派大星” and s_code &#x3D; 2或者a&#x3D;1(又或者是s_code &#x3D; 2 and sname &#x3D; “变成派大星” )就可以，<strong>因为优化器会自动调整<code>sname</code>, <code>s_code</code>的顺序</strong>。再比如sname &#x3D; “变成派大星” and s_code &gt; 1 and address &#x3D; “上海” <code>address是用不到索引的</code>，因为s_code字段是一个范围查询，它之后的字段会停止匹配。</p><p>不带范围查询 索引使用类型 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62cf1fbb4d694a32b1374a7621259924~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>带范围使用类型</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8bf03bef225405b83de31f9ffcdd1af~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>根据上一篇文章的讲解 可以明白 ref 和range的含义 级别还是相差很多的</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd7c90f9067344fdaa91724d0f6882f1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>为什么左链接一定要遵循最左缀原则呢？</p><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>看过一个比较好玩的回答</p><blockquote><p>你可以认为联合索引是闯关游戏的设计<br>例如你这个联合索引是state&#x2F;city&#x2F;zipCode<br>那么state就是第一关 city是第二关， zipCode就是第三关<br>你必须匹配了第一关，才能匹配第二关，匹配了第一关和第二关，才能匹配第三关</p></blockquote><p>这样描述不算完全准确 但是确实是这种思想</p><p>要想理解联合索引的最左匹配原则，先来理解下索引的底层原理。索引的底层是一颗B+树，那么联合索引的底层也就是一颗B+树，只不过联合索引的B+树节点中存储的是键值。由于构建一棵B+树只能根据一个值来确定索引关系，所以数据库依赖联合索引最左的字段来构建 文字比较抽象 我们看一下</p><p>加入我们建立 A,B 联合索引 他们在底层储存是什么样子呢？</p><ul><li>橙色代表字段 A</li><li>浅绿色 代表字段B</li></ul><p>图解： <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a35b2ec784eb48109fe2916eade3c248~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>我们可以看出几个特点</p><ul><li>A 是有顺序的 1，1，2，2，3，4</li><li>B 是没有顺序的 1，2，1，4，1，2 这个是散列的</li><li>如果A是等值的时候 B是有序的 例如 （1，1），（1，2） 这里的B有序的 （2，1）,(2,4) B 也是有序的</li></ul><p>这里应该就能看出 如果没有A的支持 B的索引是散列的 不是连续的</p><p>再细致一点 我们重新创建一个表</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">DROP TABLE IF EXISTS &#96;leftaffix&#96;;CREATE TABLE &#96;leftaffix&#96;  (  &#96;a&#96; int(11) NOT NULL AUTO_INCREMENT,  &#96;b&#96; int(11) NULL DEFAULT NULL,  &#96;c&#96; int(11) NULL DEFAULT NULL,  &#96;d&#96; int(11) NULL DEFAULT NULL,  &#96;e&#96; varchar(11) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,  PRIMARY KEY (&#96;a&#96;) USING BTREE,  INDEX &#96;联合索引&#96;(&#96;b&#96;, &#96;c&#96;, &#96;d&#96;) USING BTREE) ENGINE &#x3D; InnoDB AUTO_INCREMENT &#x3D; 8 CHARACTER SET &#x3D; utf8 COLLATE &#x3D; utf8_general_ci ROW_FORMAT &#x3D; Dynamic; -- ------------------------------ Records of leftaffix-- ----------------------------INSERT INTO &#96;leftaffix&#96; VALUES (1, 1, 1, 1, &#39;1&#39;);INSERT INTO &#96;leftaffix&#96; VALUES (2, 2, 2, 2, &#39;2&#39;);INSERT INTO &#96;leftaffix&#96; VALUES (3, 3, 2, 2, &#39;3&#39;);INSERT INTO &#96;leftaffix&#96; VALUES (4, 3, 1, 1, &#39;4&#39;);INSERT INTO &#96;leftaffix&#96; VALUES (5, 2, 3, 5, &#39;5&#39;);INSERT INTO &#96;leftaffix&#96; VALUES (6, 6, 4, 4, &#39;6&#39;);INSERT INTO &#96;leftaffix&#96; VALUES (7, 8, 8, 8, &#39;7&#39;);SET FOREIGN_KEY_CHECKS &#x3D; 1;</code></pre></div></figure><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39277837f4fb4f8d8f4707ae5a597880~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><blockquote><p>在创建索引树的时候会对数据进行排序 根据最左缀原则 会先通过 B 进行排序 也就是 如果出现值相同就 根据 C 排序 如果 C相同就根据D 排序 排好顺序之后就是如下图：</p></blockquote><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/311f0f59b47141a185b466f26df0d2e0~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><blockquote><p>索引的生成就会根据图二的顺序进行生成 我们看一下 生成后的树状数据是什么样子</p></blockquote><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb22bb31c6f14d3683164388042bc0f1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><blockquote><p>解释一些这个树状图 首先根据图二的排序 我们知道顺序 是 1111a 2222b 所以 在第三层 我们可以看到 1111a 在第一层 2222b在第二层 因为 111 &lt; 222 所以 111 进入第二层 然后得出第一层</p></blockquote><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5393546a6d59417388538798c34ca04f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>简化一下就是这个样子</p><p>但是这种顺序是相对的。这是因为MySQL创建联合索引的规则是首先会对联合索引的最左边<code>第一个字段排序</code>，在第一个字段的排序基础上，然后在对第二个字段进行排序。所以B&#x3D;2这种查询条件没有办法利用索引。</p><p>看到这里还可以明白一个道理 为什么我们建立索引的时候不推荐建立在经常改变的字段 因为这样的话我们的索引结构就要跟着你的改变而改动 所以很消耗性能</p><h3 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h3><p>前提 如果创建 b,c,d 联合索引面</p><ul><li>如果 我where 后面的条件是<code>c = 1 and d = 1</code>为什么不能走索引呢 如果没有b的话 你查询的值相当于 <code>*11</code> 我们都知道<code>*</code>是所有的意思也就是我能匹配到所有的数据</li><li>如果 我 where 后面是 <code>b = 1 and d =1</code> 为什么会走索引呢？ 你等于查询的数据是 <code>1*1</code> 我可以通过前面 1 进行索引匹配 所以就可以走索引</li><li>最左缀匹配原则的最重要的就是 第一个字段</li></ul><p>我们接着看下一个失效场景</p><h2 id="select"><a href="#select" class="headerlink" title="select *"></a>select *</h2><h3 id="思考-1"><a href="#思考-1" class="headerlink" title="思考"></a>思考</h3><p>首先提出问题 <code>select *</code> 一定会索引失效吗？</p><h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><p>如果你的心里答案是 会失效那就接着往下看</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f81456c6434c4beda1388db375956a17~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>细心的同学能够发现 即便我使用了select * 依然会走索引 这是为什么呢？</p><p>首先我们在上一个验证中创建了联合索引 我们使用B&#x3D;1 会走索引</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c32c8aa321f3458b95a00ae04ec8c37b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d5e676c05644c1aaaf62a5f214354b3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>也就是 Select * 在一些情况下是会走索引的 那么什么时候不会走索引呢</p><blockquote><p>经过测试 在查询返回结果集大约总数据的25%就不会走索引了 进而全表扫描 这里也有一个知识点 也就是为什么范围查找会索引失效的原因</p></blockquote><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/641cc7d7b0ad4d04aa9417f721ca7be1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>上图就是索引失效的情况</p><p>范围查找也不是一定会索引失效 下面情况就会索引生效就是 级别低 生效的原因是因为缩小了范围</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05fab88741414b70896dedc185d6a3ff~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><h3 id="小总结-1"><a href="#小总结-1" class="headerlink" title="小总结"></a>小总结</h3><ul><li>select * 只有在返回结果集数量大于总结果集的25% 就会造成索引失效 如果小于 不会造成索引失效但是会降低索引的效率</li><li>范围查找有概率索引失效但是 但是在特定的情况下会生效 范围小就会使用 也可以理解为 返回结果集小就会使用索引</li></ul><h2 id="使用函数"><a href="#使用函数" class="headerlink" title="使用函数"></a>使用函数</h2><p>使用在Select 后面使用函数可以使用索引 但是下面这种做法就不能</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/48f8fee5fda042b4a21ba190a68dbca2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b22c7170e6bd4c9084e6f0dc01521412~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>因为索引保存的是索引字段的原始值，而不是经过函数计算后的值，自然就没办法走索引了。</p><p>不过，从 MySQL 8.0 开始，索引特性增加了函数索引，即可以针对函数计算后的值建立一个索引，也就是说该索引的值是函数计算后的值，所以就可以通过扫描索引来查询数据。</p><p>这种写法我没使用过 感觉情况比较少 也比较容易注意到这种写法</p><h2 id="计算操作"><a href="#计算操作" class="headerlink" title="计算操作"></a>计算操作</h2><p>这个情况和上面一样 之所以会导致索引失效是因为改变了索引原来的值 在树中找不到对应的数据只能全表扫描</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c4ce2c6583a4107aab778669bf1b775~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"> 因为索引保存的是索引字段的原始值，而不是 b - 1 表达式计算后的值，所以无法走索引，只能通过把索引字段的取值都取出来，然后依次进行表达式的计算来进行条件判断，因此采用的就是全表扫描的方式。</p><p>下面这种计算方式就会使用索引</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab31b17d52f44d4297c1a10248c97f33~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>Java比较熟悉的可能会有点疑问，这种对索引进行简单的表达式计算，在代码特殊处理下，应该是可以做到索引扫描的，比方将 b - 1 &#x3D; 6 变成 b &#x3D; 6 - 1。 是的，是能够实现，但是 MySQL 还是偷了这个懒，没有实现。</p><h3 id="小总结-2"><a href="#小总结-2" class="headerlink" title="小总结"></a>小总结</h3><p>总而言之 言而总之 只要是影响到索引列的值 索引就是失效</p><h2 id="Like"><a href="#Like" class="headerlink" title="Like %"></a>Like %</h2><p>这个真的是难受哦 因为经常使用这个 所以还是要小心点 在看为什么失效之前 我们先看一下 Like % 的解释</p><ol><li><strong>%百分号通配符:</strong> 表示任何字符出现任意次数(可以是0次).</li><li><strong>_下划线通配符:</strong> 表示只能匹配单个字符,不能多也不能少,就是一个字符.</li><li><strong>like操作符:</strong> LIKE作用是指示mysql后面的搜索模式是利用通配符而不是直接相等匹配进行比较.</li></ol><p><strong>注意:</strong> 如果在使用like操作符时,后面的没有使用通用匹配符效果是和&#x3D;一致的,</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">SELECT * FROM products WHERE products.prod_name like &#39;1000&#39;;</code></pre></div></figure><p>2.匹配包含”Li”的记录(包括记录”Li”) :</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">SELECT* FROM products WHERE products.prod_name like &#39;%Li%&#39;;</code></pre></div></figure><p>3.匹配以”Li”结尾的记录(包括记录”Li”,不包括记录”Li “,也就是Li后面有空格的记录,这里需要注意)</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">SELECT * FROM products WHERE products.prod_name like &#39;%Li&#39;;</code></pre></div></figure><p>在左不走 在右走</p><p><code>右：</code> 虽然走 但是索引级别比较低主要是模糊查询 范围比较大 所以索引级别就比较低 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0fd95c00a9f44ffbed872907e23bd76~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p><code>左：</code> 这个范围非常大 所以没有使用索引的必要了 这个可能不是很好优化 还好不是一直拼接上面的</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/183762e539b04420b6db1acc4a7cabbb~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><h3 id="小总结-3"><a href="#小总结-3" class="headerlink" title="小总结"></a>小总结</h3><p>索引的时候和查询范围关系也很大 范围过大造成索引没有意义从而失效的情况也不少</p><h2 id="使用Or导致索引失效"><a href="#使用Or导致索引失效" class="headerlink" title="使用Or导致索引失效"></a>使用Or导致索引失效</h2><p>这个原因就更简单了</p><p>在 WHERE 子句中，如果在 OR 前的条件列是索引列，而在 OR 后的条件列不是索引列，那么索引会失效 举个例子，比如下面的查询语句，b 是主键，e 是普通列，从执行计划的结果看，是走了全表扫描。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5fe15263f1414f058690cb11a02fdbbe~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>这个的优化方式就是 在Or的时候两边都加上索引</p><p>就会使用索引 避免全表扫描 <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2924e8c883046a793416a7e9f9307e4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><h2 id="in使用不当"><a href="#in使用不当" class="headerlink" title="in使用不当"></a>in使用不当</h2><p>首先使用In 不是一定会造成全表扫描的 <strong>IN肯定会走索引，但是当IN的取值范围较大时会导致索引失效，走全表扫描</strong></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8c6239288d63424f97463355bd4c459c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a515623c61a403b86af444c7db46fa9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><p>in 在结果集 大于30%的时候索引失效</p><h2 id="not-in-和-In的失效场景相同"><a href="#not-in-和-In的失效场景相同" class="headerlink" title="not in 和 In的失效场景相同"></a>not in 和 In的失效场景相同</h2><h2 id="order-By"><a href="#order-By" class="headerlink" title="order By"></a>order By</h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/664a7329241840e888d5569d4b0e3475~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"> 这一个主要是Mysql 自身优化的问题 我们都知道OrderBy 是排序 那就代表我需要对数据进行排序 如果我走索引 索引是排好序的 但是我需要回表 消耗时间 另一种 我直接全表扫描排序 不用回表 也就是</p><ul><li>走索引 + 回表</li><li>不走索引 直接全表扫描</li></ul><p>Mysql 认为直接全表扫面的速度比 回表的速度快所以就直接走索引了 在Order By 的情况下 走全表扫描反而是更好的选择</p><h2 id="子查询会走索引吗"><a href="#子查询会走索引吗" class="headerlink" title="子查询会走索引吗"></a>子查询会走索引吗</h2><p>答案是会 但是使用不好就不会</p><h2 id="大总结"><a href="#大总结" class="headerlink" title="大总结"></a>大总结</h2><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f7104ac9d684ce3b4fe43e97b6afaf2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="图片.png"></p><ul><li>如果你是直接跳到这里 看看文章有多长 <code>建议收藏</code></li><li>如果你一步步看到这里 感觉有点帮助 <code>赞赞来一个</code></li><li>如果感觉文章有问题 建议评论区指出 <code>会修正</code></li></ul><p>周五愉快 文章完结🥰</p><p>持续更新SQL相关系列 可追更 不可催更</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bed95998e47144b4a49e8a42246ece50~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="0bd2663ecc3e21c3a51f382cec4bb8b6.gif"></p><p><em><strong>本文正在参加<a href="https://juejin.cn/post/7160601544600567845" title="https://juejin.cn/post/7160601544600567845">「技术专题19期 漫谈数据库技术」</a>活动</strong></em></p>]]></content>
    
    
    <categories>
      
      <category>数据分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>SQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于 Hexo 从零开始搭建个人博客</title>
    <link href="/2022/11/11/%E5%9F%BA%E4%BA%8E%20Hexo%20%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    <url>/2022/11/11/%E5%9F%BA%E4%BA%8E%20Hexo%20%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<hr><blockquote><p>阅读本篇前，请先阅读前几篇文章：<br><a href="https://tzy1997.com/articles/hexo1601/">基于 Hexo 从零开始搭建个人博客（一）</a><br><a href="https://tzy1997.com/articles/hexo1602/">基于 Hexo 从零开始搭建个人博客（二）</a><br><a href="https://tzy1997.com/articles/hexo1603/">基于 Hexo 从零开始搭建个人博客（三）</a></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><a href="https://tzy1997.com/articles/hexo1604/#%E5%89%8D%E8%A8%80" title="前言"></a>前言</h2><ol><li>博客搭建过程遇到任何问题，优先在本页面搜索，检查是否已经有该配置教程。</li><li>遇到问题可以优先在文章评论区留言，注意留言时请填写正确的邮箱以确保能收到站长的回复。</li><li>实在解决不了的问题可添加博主 Wechat ，添加好友时请备注自己的姓名+专业，如 张三 计算机科学与技术。</li></ol><h2 id="Front-matter"><a href="#Front-matter" class="headerlink" title="Front-matter"></a><a href="https://tzy1997.com/articles/hexo1604/#Front-matter" title="Front-matter"></a>Front-matter</h2><p><strong>Front-matter</strong> 是 <strong>markdown</strong> 文件最上方以<code>---</code>分隔的区域，用于指定个别档案的变数。</p><ul><li>Page Front-matter 用于页面配置</li><li>Post Front-matter 用于文章页配置</li></ul><p>如果标注可选的参数，可根据自己需要添加，不用全部都写在markdown里</p><h3 id="Page-Front-matter"><a href="#Page-Front-matter" class="headerlink" title="Page Front-matter"></a><a href="https://tzy1997.com/articles/hexo1604/#Page-Front-matter" title="Page Front-matter"></a>Page Front-matter</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">---title:date:updated:type:comments:description:keywords:top_img:mathjax:katex:aside:aplayer:highlight_shrink:---</code></pre></div></figure><table><thead><tr><th>写法</th><th>解释</th></tr></thead><tbody><tr><td>title</td><td>【必需】页面标题</td></tr><tr><td>date</td><td>【必需】页面创建日期</td></tr><tr><td>type</td><td>【必需】标籤、分类和友情链接三个页面需要配置</td></tr><tr><td>updated</td><td>【可选】页面更新日期</td></tr><tr><td>description</td><td>【可选】页面描述</td></tr><tr><td>keywords</td><td>【可选】页面关键字</td></tr><tr><td>comments</td><td>【可选】显示页面评论模块(默认 true)</td></tr><tr><td>top_img</td><td>【可选】页面顶部图片</td></tr><tr><td>mathjax</td><td>【可选】显示mathjax(当设置mathjax的per_page: false时，才需要配置，默认 false)</td></tr><tr><td>katex</td><td>【可选】显示katex(当设置katex的per_page: false时，才需要配置，默认 false)</td></tr><tr><td>aside</td><td>【可选】显示侧边栏 (默认 true)</td></tr><tr><td>aplayer</td><td>【可选】在需要的页面加载aplayer的js和css,请参考文章下面的音乐 配置</td></tr><tr><td>highlight_shrink</td><td>【可选】配置代码框是否展开(true&#x2F;false)(默认为设置中highlight_shrink的配置)</td></tr></tbody></table><h3 id="Post-Front-matter"><a href="#Post-Front-matter" class="headerlink" title="Post Front-matter"></a><a href="https://tzy1997.com/articles/hexo1604/#Post-Front-matter" title="Post Front-matter"></a>Post Front-matter</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">---title:date:updated:tags:categories:keywords:description:top_img:comments:cover:toc:toc_number:toc_style_simple:copyright:copyright_author:copyright_author_href:copyright_url:copyright_info:mathjax:katex:aplayer:highlight_shrink:aside:---</code></pre></div></figure><table><thead><tr><th>写法</th><th>解释</th></tr></thead><tbody><tr><td>title</td><td>【必需】文章标题</td></tr><tr><td>date</td><td>【必需】文章创建日期</td></tr><tr><td>updated</td><td>【可选】文章更新日期</td></tr><tr><td>tags</td><td>【可选】文章标籤</td></tr><tr><td>categories</td><td>【可选】文章分类</td></tr><tr><td>keywords</td><td>【可选】文章关键字</td></tr><tr><td>description</td><td>【可选】文章描述</td></tr><tr><td>top_img</td><td>【可选】文章顶部图片</td></tr><tr><td>cover</td><td>【可选】文章缩略图(如果没有设置top_img,文章页顶部将显示缩略图，可设为false&#x2F;图片地址&#x2F;留空)</td></tr><tr><td>comments</td><td>【可选】显示文章评论模块(默认 true)</td></tr><tr><td>toc</td><td>【可选】显示文章TOC(默认为设置中toc的enable配置)</td></tr><tr><td>toc_number</td><td>【可选】显示toc_number(默认为设置中toc的number配置)</td></tr><tr><td>toc_style_simple</td><td>【可选】显示 toc 简洁模式</td></tr><tr><td>copyright</td><td>【可选】显示文章版权模块(默认为设置中post_copyright的enable配置)</td></tr><tr><td>copyright_author</td><td>【可选】文章版权模块的文章作者</td></tr><tr><td>copyright_author_href</td><td>【可选】文章版权模块的文章作者链接</td></tr><tr><td>copyright_url</td><td>【可选】文章版权模块的文章连结链接</td></tr><tr><td>copyright_info</td><td>【可选】文章版权模块的版权声明文字</td></tr><tr><td>mathjax</td><td>【可选】显示mathjax(当设置mathjax的per_page: false时，才需要配置，默认 false)</td></tr><tr><td>katex</td><td>【可选】显示katex(当设置katex的per_page: false时，才需要配置，默认 false)</td></tr><tr><td>aplayer</td><td>【可选】在需要的页面加载aplayer的js和css,请参考文章下面的音乐 配置</td></tr><tr><td>highlight_shrink</td><td>【可选】配置代码框是否展开(true&#x2F;false)(默认为设置中highlight_shrink的配置)</td></tr><tr><td>aside</td><td>【可选】显示侧边栏 (默认 true)</td></tr></tbody></table><blockquote><p>注意：我的博客根目录路径为 【G:&#x2F;hexo-blog&#x2F;blog-demo】，下文所说的根目录都是此路径，将用<code>[BlogRoot]</code>代替。如果不清楚根目录路径，请回到教程 <a href="https://tzy1997.com/articles/hexo1602/">基于 Hexo 从零开始搭建个人博客（二）</a>，查看你执行<code>hexo init xxx</code>这条命令时所选择的路径，例如我选择的路径是【G:&#x2F;hexo-blog】，我的博客根目录即为【G:&#x2F;hexo-blog&#x2F;xxx】。</p></blockquote><h2 id="标签页"><a href="#标签页" class="headerlink" title="标签页"></a><a href="https://tzy1997.com/articles/hexo1604/#%E6%A0%87%E7%AD%BE%E9%A1%B5" title="标签页"></a>标签页</h2><ol><li><p>前往你的Hexo博客根目录，打开cmd命令窗口执行<code>hexo new page tags</code>。</p></li><li><p>在【BlogRoot&#x2F;source&#x2F;】会生成一个含有<code>index.md</code>文件的<code>tags</code>文件夹。</p><p><a href="https://bu.dusays.com/2022/05/29/62937c8344bbb.jpg"><img src="https://bu.dusays.com/2022/01/14/1ff50a00bd75c.gif"></a></p></li><li><p>修改【BlogRoot&#x2F;source&#x2F;tags&#x2F;index.md】，添加<code>type: &quot;tags&quot;</code>。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">---title: tagsdate: 2022-05-29 21:42:56type: &quot;tags&quot;---</code></pre></div></figure></li></ol><h2 id="分类页"><a href="#分类页" class="headerlink" title="分类页"></a><a href="https://tzy1997.com/articles/hexo1604/#%E5%88%86%E7%B1%BB%E9%A1%B5" title="分类页"></a>分类页</h2><ol><li><p>前往你的Hexo博客根目录，打开cmd命令窗口执行<code>hexo new page categories</code>。</p></li><li><p>在【BlogRoot&#x2F;source&#x2F;】会生成一个含有<code>index.md</code>文件的<code>categories</code>文件夹。</p><p><a href="https://bu.dusays.com/2022/05/29/62937c8627deb.jpg"><img src="https://bu.dusays.com/2022/01/14/1ff50a00bd75c.gif"></a></p></li><li><p>修改【BlogRoot&#x2F;source&#x2F;categories&#x2F;index.md】，添加<code>type: &quot;categories&quot;</code>。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">---title: categoriesdate: 2022-05-29 21:57:07type: &quot;categories&quot;---</code></pre></div></figure></li></ol><h2 id="友情链接"><a href="#友情链接" class="headerlink" title="友情链接"></a><a href="https://tzy1997.com/articles/hexo1604/#%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5" title="友情链接"></a>友情链接</h2><h3 id="创建友情链接页面"><a href="#创建友情链接页面" class="headerlink" title="创建友情链接页面"></a><a href="https://tzy1997.com/articles/hexo1604/#%E5%88%9B%E5%BB%BA%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5%E9%A1%B5%E9%9D%A2" title="创建友情链接页面"></a>创建友情链接页面</h3><ol><li><p>前往你的Hexo博客根目录，打开cmd命令窗口执行<code>hexo new page link</code>。</p></li><li><p>在【BlogRoot&#x2F;source&#x2F;】会生成一个含有<code>index.md</code>文件的<code>link</code>文件夹。</p><p><a href="https://bu.dusays.com/2022/05/29/629385dc3918c.jpg"><img src="https://bu.dusays.com/2022/01/14/1ff50a00bd75c.gif"></a></p></li><li><p>修改【BlogRoot&#x2F;source&#x2F;link&#x2F;index.md】，添加<code>type: &quot;link&quot;</code>。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">---title: linkdate: 2022-05-29 22:03:35type: &quot;link&quot;---</code></pre></div></figure></li></ol><h3 id="友情链接页面添加友链信息"><a href="#友情链接页面添加友链信息" class="headerlink" title="友情链接页面添加友链信息"></a><a href="https://tzy1997.com/articles/hexo1604/#%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5%E9%A1%B5%E9%9D%A2%E6%B7%BB%E5%8A%A0%E5%8F%8B%E9%93%BE%E4%BF%A1%E6%81%AF" title="友情链接页面添加友链信息"></a>友情链接页面添加友链信息</h3><p>前往Hexo博客目录（【BlogRoot&#x2F;source&#x2F;_data】）创建一个文件<code>link.yml</code>（如果沒有 _data 文件夹，请自行创建）。</p><p><a href="https://bu.dusays.com/2022/05/29/629385e182b48.jpg"><img src="https://bu.dusays.com/2022/01/14/1ff50a00bd75c.gif"></a></p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">- class_name: 友情链接  class_desc: 那些人，那些事  link_list:    - name: 唐志远の博客      link: https:&#x2F;&#x2F;tzy1997.com&#x2F;      avatar: https:&#x2F;&#x2F;bu.dusays.com&#x2F;2022&#x2F;01&#x2F;14&#x2F;cd5ffd485f867.jpg      descr: 古今之成大事者，不惟有超世之才，亦必有坚忍不拔之志。- class_name: 网站  class_desc: 值得推荐的网站  link_list:    - name: Twitter      link: https:&#x2F;&#x2F;twitter.com&#x2F;      avatar: https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;05&#x2F;14&#x2F;5VyHPQqR6LWF39a.png      descr: 社交分享平台</code></pre></div></figure><p><code>class_name</code>和<code>class_desc</code>支持 html 格式，如不需要，也可以留空。</p><p>如果你想设置成本站友链页的效果，请参考教程：<a href="https://tzy1997.com/articles/0xiipgum/">基于Butterfly的外挂标签引入</a> 。</p><h2 id="图库"><a href="#图库" class="headerlink" title="图库"></a><a href="https://tzy1997.com/articles/hexo1604/#%E5%9B%BE%E5%BA%93" title="图库"></a>图库</h2><p>图库页面只是普通的页面，你只需要<code>hexo new page xxxxx</code>创建你的页面就行。</p><p>然后使用标签外挂 <a href="https://butterfly.js.org/posts/4aa8abbe/#Gallery%E7%9B%B8%E5%86%8A%E5%9C%96%E5%BA%AB">galleryGroup</a>，具体用法请查看对应的内容。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&lt;div class&#x3D;&quot;gallery-group-main&quot;&gt;&#123;% galleryGroup &#39;壁纸&#39; &#39;收藏的一些壁纸&#39; &#39;&#x2F;Gallery&#x2F;wallpaper&#39; https:&#x2F;&#x2F;bu.dusays.com&#x2F;2021&#x2F;03&#x2F;06&#x2F;38a2c5cd8b44e.jpg %&#125;&#123;% galleryGroup &#39;漫威&#39; &#39;关于漫威的图片&#39; &#39;&#x2F;Gallery&#x2F;marvel&#39; https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;8t97aVlp4hgyBGu.jpg %&#125;&#123;% galleryGroup &#39;OH MY GIRL&#39; &#39;关于OH MY GIRL的图片&#39; &#39;&#x2F;Gallery&#x2F;ohmygirl&#39; https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;hOqbQ3BIwa6KWpo.jpg %&#125;&lt;&#x2F;div&gt;</code></pre></div></figure><p><img src="https://bu.dusays.com/2022/01/14/1ff50a00bd75c.gif" alt="Group Image Gallery"></p><p>壁纸</p><p>收藏的一些壁纸</p><p><a href="https://tzy1997.com/Gallery/wallpaper"></a></p><p><img src="https://bu.dusays.com/2022/01/14/1ff50a00bd75c.gif" alt="Group Image Gallery"></p><p>漫威</p><p>关于漫威的图片</p><p><a href="https://tzy1997.com/Gallery/marvel"></a></p><p><img src="https://bu.dusays.com/2022/01/14/1ff50a00bd75c.gif" alt="Group Image Gallery"></p><p>OH MY GIRL</p><p>关于OH MY GIRL的图片</p><p><a href="https://tzy1997.com/Gallery/ohmygirl"></a></p><h3 id="子页面"><a href="#子页面" class="headerlink" title="子页面"></a><a href="https://tzy1997.com/articles/hexo1604/#%E5%AD%90%E9%A1%B5%E9%9D%A2" title="子页面"></a>子页面</h3><p>子页面也是普通的页面，你只需要<code>hexo new page xxxxx</code>创建你的页面就行。</p><p>然后使用标签外挂 <a href="https://butterfly.js.org/posts/4aa8abbe/#Gallery%E7%9B%B8%E5%86%8A">gallery</a>，具体用法请查看对应的内容。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">&#123;% gallery %&#125;![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;Fze9jchtnyJXMHN.jpg)![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;ryLVePaqkYm4TEK.jpg)![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;gEy5Zc1Ai6VuO4N.jpg)![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;d6QHbytlSYO4FBG.jpg)![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;6nepIJ1xTgufatZ.jpg)![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;E7Jvr4eIPwUNmzq.jpg)![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;mh19anwBSWIkGlH.jpg)![](https:&#x2F;&#x2F;i.loli.net&#x2F;2019&#x2F;12&#x2F;25&#x2F;2tu9JC8ewpBFagv.jpg)&#123;% endgallery %&#125;</code></pre></div></figure><p>如果你想要使用 <code>/photo/ohmygirl</code> 这样的链接显示你的图片内容</p><p>你可以把创建好的 <code>ohmygirl</code>整个文件夹移到 <code>photo</code>文件夹里去</p><h2 id="404页面"><a href="#404页面" class="headerlink" title="404页面"></a><a href="https://tzy1997.com/articles/hexo1604/#404%E9%A1%B5%E9%9D%A2" title="404页面"></a>404页面</h2><p>主題內置了一个简单的404页面，可在设置中开放。</p><blockquote><p>如需本地预览，请访问 <a href="http://localhost:4000/404.html">http://localhost:4000/404.html</a></p></blockquote><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">error_404:  enable: true  subtitle: &quot;页面沒有找到&quot;  background: </code></pre></div></figure><p>版权声明: 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://tzy1997.com/">唐志远の博客</a>！</p><p>打赏</p><ul><li><p><a href="https://bu.dusays.com/2022/05/17/6283c3f127558.jpg"><img src="https://bu.dusays.com/2022/05/17/6283c3f127558.jpg" alt="wechat"></a></p><p>wechat</p></li><li><p><a href="https://bu.dusays.com/2022/05/17/6283c3ee6d872.jpg"><img src="https://bu.dusays.com/2022/05/17/6283c3ee6d872.jpg" alt="alipay"></a></p><p>alipay</p></li></ul><hr>]]></content>
    
    
    <categories>
      
      <category>博客</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python 系统模块常用方法</title>
    <link href="/2022/11/11/python%E4%B8%ADsys%EF%BC%8Cos%EF%BC%8Ctime%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/2022/11/11/python%E4%B8%ADsys%EF%BC%8Cos%EF%BC%8Ctime%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="sys模块"><a href="#sys模块" class="headerlink" title="sys模块"></a>sys模块</h2><h3 id="sys-argv-实现从程序外部向程序传递参数。"><a href="#sys-argv-实现从程序外部向程序传递参数。" class="headerlink" title="sys.argv: 实现从程序外部向程序传递参数。"></a>sys.argv: 实现从程序外部向程序传递参数。</h3><p>位置参数argv[0]代表py文件本身，运行方法 python xx.py 参数1，参数2 。。</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">self <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>name <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>age <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token keyword">print</span> self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age</code></pre></div></figure><h3 id="sys-getdefaultencoding-获取系统当前编码，一般默认为ascii。"><a href="#sys-getdefaultencoding-获取系统当前编码，一般默认为ascii。" class="headerlink" title="sys.getdefaultencoding(): 获取系统当前编码，一般默认为ascii。"></a>sys.getdefaultencoding(): 获取系统当前编码，一般默认为ascii。</h3><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span> sys<span class="token punctuation">.</span>getdefaultencoding<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="sys-setdefaultencoding-设置系统默认编码，"><a href="#sys-setdefaultencoding-设置系统默认编码，" class="headerlink" title="sys.setdefaultencoding(): 设置系统默认编码，"></a>sys.setdefaultencoding(): 设置系统默认编码，</h3><p>执行dir（sys）时不会看到这个方法，在解释器中执行不通过，<br>可以先执行reload(sys)，在执行 setdefaultencoding(‘utf8’)，<br>此时将系统默认编码设置为utf8。（python2.7中可能需要这么做）</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="sys-path-获取指定模块搜索路径的字符串集合"><a href="#sys-path-获取指定模块搜索路径的字符串集合" class="headerlink" title="sys.path: 获取指定模块搜索路径的字符串集合"></a>sys.path: 获取指定模块搜索路径的字符串集合</h3><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">sys<span class="token punctuation">.</span>path</code></pre></div></figure><h3 id="sys-platform-获取当前系统平台。"><a href="#sys-platform-获取当前系统平台。" class="headerlink" title="sys.platform: 获取当前系统平台。"></a>sys.platform: 获取当前系统平台。</h3><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span> sys<span class="token punctuation">.</span>platform</code></pre></div></figure><h3 id="sys-exit"><a href="#sys-exit" class="headerlink" title="sys.exit()"></a>sys.exit()</h3><p>功能：执行到主程序末尾，解释器自动退出，但是如果需要中途退出程序，<br>可以调用sys.exit函数，带有一个可选的整数参数返回给调用它的程序，<br>表示你可以在主程序中捕获对sys.exit的调用。（0是正常退出，其他为异常）’’’</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span> <span class="token string">'第%s次:'</span> <span class="token operator">%</span> i<span class="token punctuation">,</span> i    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">'第五次退出'</span>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code></pre></div></figure><h2 id="os模块"><a href="#os模块" class="headerlink" title="os模块"></a>os模块</h2><h3 id="1-os-name-——判断现在正在实用的平台，Windows-返回-‘nt’-Linux-返回’posix’"><a href="#1-os-name-——判断现在正在实用的平台，Windows-返回-‘nt’-Linux-返回’posix’" class="headerlink" title="1. os.name()——判断现在正在实用的平台，Windows 返回 ‘nt’; Linux 返回’posix’"></a>1. os.name()——判断现在正在实用的平台，Windows 返回 ‘nt’; Linux 返回’posix’</h3><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span> os<span class="token punctuation">.</span>name<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div></figure><h3 id="2-os-getcwd-——得到当前工作的目录。"><a href="#2-os-getcwd-——得到当前工作的目录。" class="headerlink" title="2. os.getcwd()——得到当前工作的目录。"></a>2. os.getcwd()——得到当前工作的目录。</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.getcwd()</code></pre></div></figure><h3 id="3-os-listdir-——指定所有目录下所有的文件和目录名。"><a href="#3-os-listdir-——指定所有目录下所有的文件和目录名。" class="headerlink" title="3. os.listdir()——指定所有目录下所有的文件和目录名。"></a>3. os.listdir()——指定所有目录下所有的文件和目录名。</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.listdir(&#39;.&#39;)</code></pre></div></figure><h3 id="4-os-remove-——删除指定文件"><a href="#4-os-remove-——删除指定文件" class="headerlink" title="4. os.remove()——删除指定文件"></a>4. os.remove()——删除指定文件</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">os.remove(&#39;aaa.txt&#39;)</code></pre></div></figure><h3 id="5-os-rmdir-——删除指定目录"><a href="#5-os-rmdir-——删除指定目录" class="headerlink" title="5. os.rmdir()——删除指定目录"></a>5. os.rmdir()——删除指定目录</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">os.rmdir(&#39;C:&#x2F;&#x2F;Users&#x2F;xiaoxinsoso&#x2F;Desktop&#x2F;aaa&#39;)</code></pre></div></figure><h3 id="6-os-mkdir-——创建目录-注意：这样只能建立一层，要想递归建立可用：os-makedirs"><a href="#6-os-mkdir-——创建目录-注意：这样只能建立一层，要想递归建立可用：os-makedirs" class="headerlink" title="6. os.mkdir()——创建目录,注意：这样只能建立一层，要想递归建立可用：os.makedirs()"></a>6. os.mkdir()——创建目录,注意：这样只能建立一层，要想递归建立可用：os.makedirs()</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">os.makedirs(&#39;aaa&#x2F;aaa&#39;)</code></pre></div></figure><h3 id="7-os-path-isfile-——判断指定对象是否为文件。是返回True-否则False"><a href="#7-os-path-isfile-——判断指定对象是否为文件。是返回True-否则False" class="headerlink" title="7. os.path.isfile()——判断指定对象是否为文件。是返回True, 否则False"></a>7. os.path.isfile()——判断指定对象是否为文件。是返回True, 否则False</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.isfile(&#39;ccc.txt&#39;)print os.path.isfile(&#39;aaa&#39;)</code></pre></div></figure><h3 id="8-os-path-isdir-——判断指定对象是否为目录。是True-否则False。例："><a href="#8-os-path-isdir-——判断指定对象是否为目录。是True-否则False。例：" class="headerlink" title="8. os.path.isdir()——判断指定对象是否为目录。是True, 否则False。例："></a>8. os.path.isdir()——判断指定对象是否为目录。是True, 否则False。例：</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.isdir(&#39;aaa&#39;)print os.path.isdir(&#39;ccc.txt&#39;)</code></pre></div></figure><h3 id="9-os-path-exists-——检验指定的对象是否存在。是True-否则False-例："><a href="#9-os-path-exists-——检验指定的对象是否存在。是True-否则False-例：" class="headerlink" title="9. os.path.exists()——检验指定的对象是否存在。是True, 否则False.例："></a>9. os.path.exists()——检验指定的对象是否存在。是True, 否则False.例：</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.exists(&#39;bbb&#39;)print os.path.exists(&#39;aaa&#39;)print os.path.exists(&#39;ccc.txt&#39;)</code></pre></div></figure><h3 id="10-os-path-split-——返回路径的目录和文件名。例："><a href="#10-os-path-split-——返回路径的目录和文件名。例：" class="headerlink" title="10. os.path.split()——返回路径的目录和文件名。例："></a>10. os.path.split()——返回路径的目录和文件名。例：</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.split(&#39;C:&#x2F;&#x2F;Users&#x2F;xiaoxinsoso&#x2F;Desktop&#x2F;aaa&#x2F;ccc.txt&#39;)</code></pre></div></figure><h3 id="11-os-getcwd-——获得当前工作的目录"><a href="#11-os-getcwd-——获得当前工作的目录" class="headerlink" title="11. os.getcwd()——获得当前工作的目录"></a>11. os.getcwd()——获得当前工作的目录</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.getcwd()</code></pre></div></figure><h3 id="12-os-system-——执行shell命令。"><a href="#12-os-system-——执行shell命令。" class="headerlink" title="12. os.system()——执行shell命令。"></a>12. os.system()——执行shell命令。</h3><p>注意：此处运行shell命令时，如果要调用python之前的变量，可以用如下方式：</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">var &#x3D; 123os.environ[&#39;var&#39;] &#x3D; str(var) os.system(&#39;echo $var&#39;)os.system(&#39;dir&#39;)</code></pre></div></figure><h3 id="13-os-chdir-——改变目录到指定目录"><a href="#13-os-chdir-——改变目录到指定目录" class="headerlink" title="13. os.chdir()——改变目录到指定目录"></a>13. os.chdir()——改变目录到指定目录</h3><h3 id="14-os-path-getsize-——获得文件的大小，如果为目录，返回0"><a href="#14-os-path-getsize-——获得文件的大小，如果为目录，返回0" class="headerlink" title="14. os.path.getsize()——获得文件的大小，如果为目录，返回0"></a>14. os.path.getsize()——获得文件的大小，如果为目录，返回0</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.getsize(&#39;ccc.txt&#39;)</code></pre></div></figure><h3 id="15-os-path-abspath-——获得绝对路径。例："><a href="#15-os-path-abspath-——获得绝对路径。例：" class="headerlink" title="15. os.path.abspath()——获得绝对路径。例："></a>15. os.path.abspath()——获得绝对路径。例：</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.abspath(&#39;.&#39;)</code></pre></div></figure><h3 id="16-os-path-join-path-name-——连接目录和文件名。例："><a href="#16-os-path-join-path-name-——连接目录和文件名。例：" class="headerlink" title="16. os.path.join(path, name)——连接目录和文件名。例："></a>16. os.path.join(path, name)——连接目录和文件名。例：</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.join(&#39;c:&#x2F;&#x2F;user&#x2F;xiaoxinsoso&#x2F;&#39;, &#39;wenjian.txt&#39;)</code></pre></div></figure><h3 id="17-os-path-basename-path-——返回文件名"><a href="#17-os-path-basename-path-——返回文件名" class="headerlink" title="17. os.path.basename(path)——返回文件名"></a>17. os.path.basename(path)——返回文件名</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.basename(&#39;ccc.txt&#39;)</code></pre></div></figure><h3 id="18-os-path-dirname-path-——返回文件路径"><a href="#18-os-path-dirname-path-——返回文件路径" class="headerlink" title="18. os.path.dirname(path)——返回文件路径"></a>18. os.path.dirname(path)——返回文件路径</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print os.path.dirname(&#39;C:&#x2F;&#x2F;Users&#x2F;xiaoxinsoso&#x2F;Desktop&#x2F;aaa&#x2F;ccc.txt&#39;)</code></pre></div></figure><h3 id="19-获得程序所在的实际目录"><a href="#19-获得程序所在的实际目录" class="headerlink" title="19. 获得程序所在的实际目录"></a>19. 获得程序所在的实际目录</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    print os.path.realpath(sys.argv[0])    print os.path.split(os.path.realpath(sys.argv[0]))    print os.path.split(os.path.realpath(sys.argv[0]))[0]</code></pre></div></figure><h2 id="time模块"><a href="#time模块" class="headerlink" title="time模块"></a>time模块</h2><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">ticks &#x3D; time.time()print &quot;当前时间戳为:&quot;, ticks</code></pre></div></figure><h3 id="获取当前时间"><a href="#获取当前时间" class="headerlink" title="获取当前时间"></a>获取当前时间</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">localtime &#x3D; time.localtime(time.time())print &quot;本地时间为 :&quot;, localtime</code></pre></div></figure><h3 id="获取格式化的时间"><a href="#获取格式化的时间" class="headerlink" title="获取格式化的时间"></a>获取格式化的时间</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">localtime &#x3D; time.asctime(time.localtime(time.time()))print &quot;本地时间为 :&quot;, localtime</code></pre></div></figure><h3 id="格式化日期"><a href="#格式化日期" class="headerlink" title="格式化日期"></a>格式化日期</h3><h3 id="格式化成2017-01-22-16-36-27形式"><a href="#格式化成2017-01-22-16-36-27形式" class="headerlink" title="格式化成2017-01-22 16:36:27形式"></a>格式化成2017-01-22 16:36:27形式</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime())</code></pre></div></figure><h3 id="格式化成Sun-Jan-22-16-36-27-2017形式"><a href="#格式化成Sun-Jan-22-16-36-27-2017形式" class="headerlink" title="格式化成Sun Jan 22 16:36:27 2017形式"></a>格式化成Sun Jan 22 16:36:27 2017形式</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">print time.strftime(&quot;%a %b %d %H:%M:%S %Y&quot;, time.localtime())</code></pre></div></figure><h3 id="将格式字符串转换为时间戳"><a href="#将格式字符串转换为时间戳" class="headerlink" title="将格式字符串转换为时间戳"></a>将格式字符串转换为时间戳</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">a &#x3D; &quot;Sat Mar 28 22:24:24 2016&quot;print time.mktime(time.strptime(a, &quot;%a %b %d %H:%M:%S %Y&quot;))</code></pre></div></figure><h3 id="获取某月日历"><a href="#获取某月日历" class="headerlink" title="获取某月日历"></a>获取某月日历</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">cal &#x3D; calendar.month(2017, 1)print &quot;以下输出2016年1月份的日历:&quot;print cal</code></pre></div></figure><h2 id="datetime模块"><a href="#datetime模块" class="headerlink" title="datetime模块"></a>datetime模块</h2><h3 id="datetime类型时间"><a href="#datetime类型时间" class="headerlink" title="datetime类型时间"></a>datetime类型时间</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">now &#x3D; datetime.datetime.now()print nownow &#x3D; date time.datetime.now()yes_time &#x3D; now + date time.timedelta(days&#x3D;-1)    # 前一天的时间</code></pre></div></figure><h3 id="datetime转string"><a href="#datetime转string" class="headerlink" title="datetime转string"></a>datetime转string</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">strdatetime &#x3D; now.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)     strdatetime1&#x3D; now.strftime(&quot;%Y-%m-%d&quot;)     print strdatetimeprint strdatetime1</code></pre></div></figure><h3 id="string转datetime"><a href="#string转datetime" class="headerlink" title="string转datetime"></a>string转datetime</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">datetime1 &#x3D; datetime.datetime.strptime(strdatetime1, &quot;%Y-%m-%d&quot;)print datetime1</code></pre></div></figure><h3 id="datetime转时间戳"><a href="#datetime转时间戳" class="headerlink" title="datetime转时间戳"></a>datetime转时间戳</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">time_time &#x3D; time.mktime(datetime1.timetuple())print time_time</code></pre></div></figure><h3 id="时间戳转string"><a href="#时间戳转string" class="headerlink" title="时间戳转string"></a>时间戳转string</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">time1 &#x3D; time.strftime(&#39;%Y-%m-%d&#39;,time.localtime(time_time))print time1</code></pre></div></figure><h3 id="date转datetime"><a href="#date转datetime" class="headerlink" title="date转datetime"></a>date转datetime</h3><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">date1 &#x3D; datetime.date(2012, 11, 19)date &#x3D; datetime.date.today()print dateprint datetime.datetime.strptime(str(date),&#39;%Y-%m-%d&#39;) #将date转换为str，在由str转换为datetimeprint datetime.datetime.strptime(str(date1),&#39;%Y-%m-%d&#39;) #将date转换为str，在由str转换为datetime</code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>开发</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask项目配置</title>
    <link href="/2022/11/11/%E7%AC%AC%E4%BA%8C%E8%8A%82%EF%BC%9A%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%20-%20Python%E6%A1%86%E6%9E%B6Flask%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%20-%20%E7%9F%A5%E4%BA%86%E4%BC%A0%E8%AF%BE/"/>
    <url>/2022/11/11/%E7%AC%AC%E4%BA%8C%E8%8A%82%EF%BC%9A%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%20-%20Python%E6%A1%86%E6%9E%B6Flask%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%20-%20%E7%9F%A5%E4%BA%86%E4%BC%A0%E8%AF%BE/</url>
    
    <content type="html"><![CDATA[<p>本教材由知了传课辛苦制作而成，仅供学习使用，请勿用于商业用途！如进行转载请务必注明出处！谢谢！</p><h2 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h2><h2 id="一、设置为DEBUG模式："><a href="#一、设置为DEBUG模式：" class="headerlink" title="一、设置为DEBUG模式："></a>一、设置为DEBUG模式：</h2><p>默认情况下<code>flask</code>不会开启<code>DEBUG</code>模式，开启<code>DEBUG</code>模式后，flask会在每次保存代码的时候自动的重新载入代码，并且如果代码有错误，会在终端进行提示。<br><img src="https://www.zlkt.net/media/course/2UZz2JSDySff5o8CPeqPRN.png" alt="image.png"><br>如果一切正常，会在终端打印以下信息：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">*</span> Restarting <span class="token keyword">with</span> stat<span class="token operator">*</span> Debugger <span class="token keyword">is</span> active!<span class="token operator">*</span> Debugger pin code<span class="token punctuation">:</span> <span class="token number">294</span><span class="token operator">-</span><span class="token number">745</span><span class="token operator">-</span><span class="token number">044</span><span class="token operator">*</span> Running on http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token operator">/</span> <span class="token punctuation">(</span>Press CTRL<span class="token operator">+</span>C to quit<span class="token punctuation">)</span></code></pre></div></figure><p>需要注意的是，只能在开发环境下开启<code>DEBUG</code>模式，因为<code>DEBUG</code>模式会带来非常大的安全隐患。</p><h2 id="二、配置文件："><a href="#二、配置文件：" class="headerlink" title="二、配置文件："></a>二、配置文件：</h2><p><code>Flask</code>项目的配置，都是通过<code>app.config</code>对象来进行配置的。比如要配置一个项目的<code>SECRET_KEY</code>，那么可以使用<code>app.config[&#39;SECRET_KEY&#39;] = &quot;xxx&quot;</code>来进行设置，在<code>Flask</code>项目中，有四种方式进行项目的配置：</p><ol><li><p>直接硬编码：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxx"</span></code></pre></div></figure></li><li><p>因为<code>app.config</code>是<code>flask.config.Config</code>的实例，而<code>Config</code>类是继承自<code>dict</code>，因此可以通过<code>update</code>方法：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>update<span class="token punctuation">(</span>   DEBUG<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>   SECRET_KEY<span class="token operator">=</span><span class="token string">'...'</span><span class="token punctuation">)</span></code></pre></div></figure></li><li><p>如果你的配置项特别多，你可以把所有的配置项都放在一个模块中，然后通过加载模块的方式进行配置，假设有一个<code>settings.py</code>模块，专门用来存储配置项的，此时你可以通过<code>app.config.from_object()</code>方法进行加载，并且该方法既可以接收模块的的字符串名称，也可以模块对象：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 1. 通过模块字符串</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span><span class="token string">'settings'</span><span class="token punctuation">)</span><span class="token comment"># 2. 通过模块对象</span><span class="token keyword">import</span> settingsapp<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>settings<span class="token punctuation">)</span></code></pre></div></figure></li><li><p>也可以通过另外一个方法加载，该方法就是<code>app.config.from_pyfile()</code>，该方法传入一个文件名，通常是以<code>.py</code>结尾的文件，但也不限于只使用<code>.py</code>后缀的文件：</p><figure><div class="code-wrapper"><pre class="language-python" data-language="python"><code class="language-python">app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_pyfile<span class="token punctuation">(</span><span class="token string">'settings.py'</span><span class="token punctuation">,</span>silent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment"># silent=True表示如果配置文件不存在的时候不抛出异常，默认是为False，会抛出异常。</span></code></pre></div></figure></li></ol><p><code>Flask</code>项目内置了许多的配置项，所有的内置配置项，可以在<a href="https://flask.palletsprojects.com/en/2.0.x/config/">这里查看</a>。</p>]]></content>
    
    
    <categories>
      
      <category>开发</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>Python</tag>
      
      <tag>Flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
