

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="../../../../img/m.jpeg">
  <link rel="icon" href="../../../../img/m.jpeg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Marsh">
  <meta name="keywords" content="">
  
    <meta name="description" content="有情怀，有干货，微信搜索【三太子敖丙】关注这个不一样的程序员。 本文 GitHub github.com&#x2F;JavaFamily 已收录，有一线大厂面试完整考点、资料以及我的系列文章。原文链接:https:&#x2F;&#x2F;juejin.cn&#x2F;post&#x2F;6895507965899063310#heading-1  前言这天我正在午休呢，公司DBA就把我喊醒了，说某库出现大量慢SQL，很快啊，很快，我还">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL优化">
<meta property="og:url" content="http://example.com/2022/11/15/MySQL%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="MARSH">
<meta property="og:description" content="有情怀，有干货，微信搜索【三太子敖丙】关注这个不一样的程序员。 本文 GitHub github.com&#x2F;JavaFamily 已收录，有一线大厂面试完整考点、资料以及我的系列文章。原文链接:https:&#x2F;&#x2F;juejin.cn&#x2F;post&#x2F;6895507965899063310#heading-1  前言这天我正在午休呢，公司DBA就把我喊醒了，说某库出现大量慢SQL，很快啊，很快，我还">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1526488807855-309186804587?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2371&q=80">
<meta property="article:published_time" content="2022-11-15T11:30:00.000Z">
<meta property="article:modified_time" content="2022-11-15T12:07:05.677Z">
<meta property="article:author" content="Marsh">
<meta property="article:tag" content="转载">
<meta property="article:tag" content="SQL">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1526488807855-309186804587?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2371&q=80">
  
  
  
  <title>MySQL优化 - MARSH</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="../../../../css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="../../../../css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="../../../../css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="../css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":false,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"img/emoji-hover.jpg"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="../../../../js/utils.js" ></script>
  <script  src="../../../../js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="../../../../index.html">
      <strong>MARSH</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../index.html">
                
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                
                分类
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../categories">
                    
                    全部
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90">
                    
                    数据分析
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0">
                    
                    机器学习
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../categories/%E5%89%8D%E7%AB%AF">
                    
                    前端
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../categories/%E5%90%8E%E7%AB%AF">
                    
                    后端
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../categories/%E5%8D%9A%E5%AE%A2">
                    
                    博客
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../categories/%E5%85%B6%E4%BB%96">
                    
                    其他
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                
                标签
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags">
                    
                    全部
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/%E5%8E%9F%E5%88%9B">
                    
                    原创
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/%E8%BD%AC%E8%BD%BD">
                    
                    转载
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/SQL">
                    
                    SQL
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Python">
                    
                    Python
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Sklearn">
                    
                    SKlearn
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Pytorch">
                    
                    Pytorch
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Flask">
                    
                    Flask
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/CSS">
                    
                    CSS
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/JavaScript">
                    
                    JavaScript
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Vue">
                    
                    Vue
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Golang">
                    
                    Golang
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Markdown">
                    
                    Markdown
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="../../../../tags/Hexo">
                    
                    Hexo
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../about/">
                
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://images.unsplash.com/photo-1526488807855-309186804587?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2371&q=80') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MySQL优化"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Marsh
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-15 19:30" pubdate>
          2022年11月15日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          106 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL优化</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2022年11月15日 晚上
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>有情怀，有干货，微信搜索【<strong>三太子敖丙</strong>】关注这个不一样的程序员。</p>
<p>本文 <strong>GitHub</strong> <a href="https://link.juejin.cn/?target=https://github.com/AobingJava/JavaFamily" title="https://github.com/AobingJava/JavaFamily">github.com&#x2F;JavaFamily</a> 已收录，有一线大厂面试完整考点、资料以及我的系列文章。<br>原文链接:<a target="_blank" rel="noopener" href="https://juejin.cn/post/6895507965899063310#heading-1">https://juejin.cn/post/6895507965899063310#heading-1</a></p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这天我正在午休呢，公司DBA就把我喊醒了，说某库出现大量慢SQL，很快啊，很快，我还没反应过来，库就挂了，我心想现在的用户不讲武德啊，怎么在我睡觉的时候大量请求呢。</p>
<p>这是很常见的一个场景哈，因为很多业务开始数据量级不大，所以写sql的时候就没注意性能，等量级上去，很多业务就需要做调优了，在电商公司工作的这几年我也总结了不少，下面就分享给大家吧。</p>
<p>在代码开发过程中，我们都会遵循一些SQL开发规范去编写高质量SQL，来提高接口的Response Time(RT)，对一些核心接口要求RT在100ms以内甚至更低。</p>
<p>由于业务前期数据量比较小，基本都能满足这个要求，但随着业务量的增长，数据量也随之增加，对应接口的SQL耗时也在变长，直接影响了用户的体验，这时候就需要对SQL进行优化。</p>
<p>优化点主要包括SQL规范性检查，表结构索引检查，SQL优化案例分析，下面从这三方面结合实际案例聊聊如何优化SQL。</p>
<h2 id="SQL规范性检查"><a href="#SQL规范性检查" class="headerlink" title="SQL规范性检查"></a>SQL规范性检查</h2><p>每个公司都有自己的MySQL开发规范，基本上大同小异，这里罗列一些比较重要的，我工作期间经常接触的给大家。</p>
<h3 id="select检查"><a href="#select检查" class="headerlink" title="select检查"></a>select检查</h3><p><strong>UDF用户自定义函数</strong></p>
<p>SQL语句的select后面使用了自定义函数UDF，SQL返回多少行，那么UDF函数就会被调用多少次，这是非常影响性能的。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#getOrderNo是用户自定义一个函数用户来根据order_sn来获取订单编号
select id, payment_id, order_sn, getOrderNo(order_sn) 
from payment_transaction 
where status &#x3D; 1 and create_time 
between &#39;2020-10-01 10:00:00&#39; and &#39;2020-10-02 10:00:00&#39;;</code></pre></div></figure>

<p><strong>text类型检查</strong></p>
<p>如果select出现text类型的字段，就会消耗大量的网络和IO带宽，由于返回的内容过大超过max_allowed_packet设置会导致程序报错，需要评估谨慎使用。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#表request_log的中content是text类型。
select user_id, content, status, url, type 
from request_log 
where user_id &#x3D; 32121;</code></pre></div></figure>

<p><strong>group_concat谨慎使用</strong></p>
<p>gorup_concat是一个字符串聚合函数，会影响SQL的响应时间，如果返回的值过大超过了max_allowed_packet设置会导致程序报错。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select batch_id, group_concat(name) from buffer_batch 
where status &#x3D; 0 and create_time 
between &#39;2020-10-01 10:00:00&#39; and &#39;2020-10-02 10:00:00&#39;;</code></pre></div></figure>

<p><strong>内联子查询</strong></p>
<p>在select后面有子查询的情况称为内联子查询，SQL返回多少行，子查询就需要执行过多少次，严重影响SQL性能。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id,(select rule_name from member_rule limit 1) as rule_name, member_id, member_type, member_name, status  
from member_info m 
where status &#x3D; 1 and create_time 
between &#39;2020-09-02 10:00:00&#39; and &#39;2020-10-01 10:00:00&#39;;</code></pre></div></figure>

<h3 id="from检查"><a href="#from检查" class="headerlink" title="from检查"></a>from检查</h3><p><strong>表的链接方式</strong></p>
<p>在MySQL中不建议使用Left Join，即使ON过滤条件列索引，一些情况也不会走索引，导致大量的数据行被扫描，SQL性能变得很差，同时要清楚ON和Where的区别。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">SELECT a.member_id,a.create_time,b.active_time 
FROM operation_log a 
LEFT JOIN member_info b ON a.member_id &#x3D; b.member_id 
where  b.&#96;status&#96; &#x3D; 1
and a.create_time 
between &#39;2020-10-01 00:00:00&#39; 
and &#39;2020-10-30 00:00:00&#39; 
limit 100, 0;</code></pre></div></figure>

<p><strong>子查询</strong></p>
<p>由于MySQL的基于成本的优化器CBO对子查询的处理能力比较弱，不建议使用子查询，可以改写成Inner Join。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select b.member_id,b.member_type, a.create_time,a.device_model 
from member_operation_log a 
inner join (select member_id,member_type from member_base_info where &#96;status&#96; &#x3D; 1
and create_time between &#39;2020-10-01 00:00:00&#39; and &#39;2020-10-30 00:00:00&#39;) 
as b on a.member_id &#x3D; b.member_id;</code></pre></div></figure>

<h3 id="where检查"><a href="#where检查" class="headerlink" title="where检查"></a>where检查</h3><p><strong>索引列被运算</strong></p>
<p>当一个字段被索引，同时出现where条件后面，是不能进行任何运算，会导致索引失效。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#device_no列上有索引，由于使用了ltrim函数导致索引失效
select id, name , phone, address, device_no 
from users where ltrim(device_no) &#x3D; &#39;Hfs1212121&#39;;
#balance列有索引,由于做了运算导致索引失效
select account_no, balance from accounts 
where balance + 100 &#x3D; 10000 
and status &#x3D; 1;</code></pre></div></figure>

<p><strong>类型转换</strong></p>
<p>对于Int类型的字段，传varchar类型的值是可以走索引，MySQL内部自动做了隐式类型转换；相反对于varchar类型字段传入Int值是无法走索引的，应该做到对应的字段类型传对应的值总是对的。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#user_id是bigint类型，传入varchar值发生了隐式类型转换，可以走索引。
select id, name , phone, address, device_no 
from users where user_id &#x3D; &#39;23126&#39;;
#card_no是varchar(20)，传入int值是无法走索引
select id, name , phone, address, device_no 
from users 
where card_no &#x3D; 2312612121;</code></pre></div></figure>

<p><strong>列字符集</strong></p>
<p>从MySQL 5.6开始建议所有对象字符集应该使用用utf8mb4，包括MySQL实例字符集，数据库字符集，表字符集，列字符集。避免在关联查询Join时字段字符集不匹配导致索引失效，同时目前只有utf8mb4支持emoji表情存储。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">character_set_server  &#x3D;  utf8mb4    #数据库实例字符集
character_set_connection &#x3D; utf8mb4  #连接字符集
character_set_database &#x3D; utf8mb4    #数据库字符集
character_set_results &#x3D; utf8mb4     #结果集字符集</code></pre></div></figure>

<h3 id="group-by检查"><a href="#group-by检查" class="headerlink" title="group by检查"></a>group by检查</h3><p><strong>前缀索引</strong></p>
<p>group by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#device_no字段类型varchar(200)，创建了前缀索引。
mysql&gt; alter table users add index idx_device_no(device_no(64));

mysql&gt; select device_no, count(*) from users where create_time between &#39;2020-10-01 00:00:00&#39; and &#39;2020-10-30 00:00:00&#39; group by device_no;</code></pre></div></figure>

<p><strong>函数运算</strong></p>
<p>假设需要统计某月每天的新增用户量，参考如下SQL语句，虽然可以走create_time的索引，但是不能消除排序，可以考虑冗余一个字段stats_date date类型来解决这种问题。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select DATE_FORMAT(create_time, &#39;%Y-%m-%d&#39;), count(*) 
from users where create_time 
between &#39;2020-09-01 00:00:00&#39; and &#39;2020-09-30 23:59:59&#39; 
group by DATE_FORMAT(create_time, &#39;%Y-%m-%d&#39;);</code></pre></div></figure>

<h3 id="order-by检查"><a href="#order-by检查" class="headerlink" title="order by检查"></a>order by检查</h3><p><strong>前缀索引</strong></p>
<p>order by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</p>
<p><strong>字段顺序</strong></p>
<p>排序字段顺序，asc&#x2F;desc升降要跟索引保持一致，充分利用索引的有序性来消除排序带来的CPU开销。</p>
<h3 id="limit检查"><a href="#limit检查" class="headerlink" title="limit检查"></a>limit检查</h3><p><strong>limit m,n要慎重</strong></p>
<p>对于limit m, n分页查询，越往后面翻页即m越大的情况下SQL的耗时会越来越长，对于这种应该先取出主键id，然后通过主键id跟原表进行Join关联查询。</p>
<h2 id="表结构检查"><a href="#表结构检查" class="headerlink" title="表结构检查"></a>表结构检查</h2><h3 id="表-amp-列名关键字"><a href="#表-amp-列名关键字" class="headerlink" title="表&amp;列名关键字"></a>表&amp;列名关键字</h3><p>在数据库设计建模阶段，对表名及字段名设置要合理，不能使用MySQL的关键字，如desc, order, status, group等。同时建议设置lower_case_table_names &#x3D; 1表名不区分大小写。</p>
<h3 id="表存储引擎"><a href="#表存储引擎" class="headerlink" title="表存储引擎"></a>表存储引擎</h3><p>对于OLTP业务系统，建议使用InnoDB引擎获取更好的性能，可以通过参数default_storage_engine控制。</p>
<h3 id="AUTO-INCREMENT属性"><a href="#AUTO-INCREMENT属性" class="headerlink" title="AUTO_INCREMENT属性"></a>AUTO_INCREMENT属性</h3><p>建表的时候主键id带有AUTO_INCREMENT属性，而且AUTO_INCREMENT&#x3D;1，在InnoDB内部是通过一个系统全局变量dict_sys.row_id来计数，row_id是一个8字节的bigint unsigned，InnoDB在设计时只给row_id保留了6个字节的长度，这样row_id取值范围就是0到2^48 - 1，如果id的值达到了最大值，下一个值就从0开始继续循环递增，在代码中禁止指定主键id值插入。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#新插入的id值会从10001开始，这是不对的，应该从1开始。
create table booking( &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;主键id&#39;,......) engine &#x3D; InnoDB auto_increment &#x3D; 10000;

#指定了id值插入，后续自增就会从该值开始+1，索引禁止指定id值插入。
insert into booking(id, book_sn) values(1234551121, &#39;N12121&#39;);</code></pre></div></figure>

<h3 id="NOT-NULL属性"><a href="#NOT-NULL属性" class="headerlink" title="NOT NULL属性"></a>NOT NULL属性</h3><p>根据业务含义，尽量将字段都添加上NOT NULL DEFAULT VALUE属性，如果列值存储了大量的NULL，会影响索引的稳定性。</p>
<h3 id="DEFAULT属性"><a href="#DEFAULT属性" class="headerlink" title="DEFAULT属性"></a>DEFAULT属性</h3><p>在创建表的时候，建议每个字段尽量都有默认值，禁止DEFAULT NULL，而是对字段类型填充响应的默认值。</p>
<h3 id="COMMENT属性"><a href="#COMMENT属性" class="headerlink" title="COMMENT属性"></a>COMMENT属性</h3><p>字段的备注要能明确该字段的作用，尤其是某些表示状态的字段，要显式的写出该字段所有可能的状态数值以及该数值的含义。</p>
<h3 id="TEXT类型"><a href="#TEXT类型" class="headerlink" title="TEXT类型"></a>TEXT类型</h3><p>不建议使用Text数据类型，一方面由于传输大量的数据包可能会超过max_allowed_packet设置导致程序报错，另一方面表上的DML操作都会变的很慢，建议采用es或者对象存储OSS来存储和检索。</p>
<h2 id="索引检查"><a href="#索引检查" class="headerlink" title="索引检查"></a>索引检查</h2><h3 id="索引属性"><a href="#索引属性" class="headerlink" title="索引属性"></a>索引属性</h3><p>索引基数指的是被索引的列唯一值的个数，唯一值越多接近表的count(*)说明索引的选择率越高，通过索引扫描的行数就越少，性能就越高，例如主键id的选择率是100%，在MySQL中尽量所有的update都使用主键id去更新，因为id是聚集索引存储着整行数据，不需要回表，性能是最高的。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">mysql&gt; select count(*) from member_info;
+----------+
| count(*) |
+----------+
|   148416 |
+----------+
1 row in set (0.35 sec)

mysql&gt; show index from member_base_info;
+------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table            | Non_unique | Key_name                   | Seq_in_index | Column_name       | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| member_info |          0 | PRIMARY                    |            1 | id                | A         |      131088 | NULL     | NULL   |      | BTREE      |         |               |
| member_info |          0 | uk_member_id               |            1 | member_id         | A         |      131824 | NULL     | NULL   |      | BTREE      |         |               |
| member_info |          1 | idx_create_time            |            1 | create_time       | A         |        6770 | NULL     | NULL   |      | BTREE      |         |               |
+------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
#Table： 表名
#Non_unique ：是否为unique index，0-是，1-否。
#Key_name：索引名称
#Seq_in_index：索引中的顺序号，单列索引-都是1；复合索引-根据索引列的顺序从1开始递增。
#Column_name：索引的列名
#Collation：排序顺序，如果没有指定asc&#x2F;desc，默认都是升序ASC。
#Cardinality：索引基数-索引列唯一值的个数。
#sub_part：前缀索引的长度；例如index (member_name(10)，长度就是10。
#Packed：索引的组织方式，默认是NULL。
#Null：YES:索引列包含Null值；&#39;&#39;:索引不包含Null值。
#Index_type：默认是BTREE，其他的值FULLTEXT，HASH，RTREE。
#Comment：在索引列中没有被描述的信息，例如索引被禁用。
#Index_comment：创建索引时的备注。</code></pre></div></figure>

<h3 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h3><p>对于变长字符串类型varchar(m)，为了减少key_len，可以考虑创建前缀索引，但是前缀索引不能消除group by， order by带来排序开销。如果字段的实际最大值比m小很多，建议缩小字段长度。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">alter table member_info add index idx_member_name_part(member_name(10));</code></pre></div></figure>

<h3 id="复合索引顺序"><a href="#复合索引顺序" class="headerlink" title="复合索引顺序"></a>复合索引顺序</h3><p>有很多人喜欢在创建复合索引的时候，总以为前导列一定是唯一值多的列，例如索引index idx_create_time_status(create_time, status)，这个索引往往是无法命中，因为扫描的IO次数太多，总体的cost的比全表扫描还大，CBO最终的选择是走full table scan。</p>
<p>MySQL遵循的是索引最左匹配原则，对于复合索引，从左到右依次扫描索引列，到遇到第一个范围查询（&gt;&#x3D;, &gt;,&lt;, &lt;&#x3D;, between ….. and ….）就停止扫描，索引正确的索引顺序应该是index idx_status_create_time(status, create_time)。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select account_no, balance from accounts where status &#x3D; 1 and create_time between &#39;2020-09-01 00:00:00&#39; and &#39;2020-09-30 23:59:59&#39;;</code></pre></div></figure>

<h3 id="时间列索引"><a href="#时间列索引" class="headerlink" title="时间列索引"></a>时间列索引</h3><p>对于默认字段created_at(create_time)、updated_at(update_time)这种默认就应该创建索引，这一般来说是默认的规则。</p>
<h2 id="SQL优化案例"><a href="#SQL优化案例" class="headerlink" title="SQL优化案例"></a>SQL优化案例</h2><p>通过对慢查询的监控告警，经常发现一些SQL语句where过滤字段都有索引，但是由于SQL写法的问题导致索引失效，下面二个案例告诉大家如何通过SQL改写来查询。可以通过以下SQL来捞取最近5分钟的慢查询进行告警。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select CONCAT( &#39;# Time: &#39;, DATE_FORMAT(start_time, &#39;%y%m%d %H%i%s&#39;), &#39;\n&#39;, &#39;# User@Host: &#39;, user_host, &#39;\n&#39;, &#39;# Query_time: &#39;, TIME_TO_SEC(query_time),  &#39;  Lock_time: &#39;, TIME_TO_SEC(lock_time), &#39;  Rows_sent: &#39;, rows_sent, &#39;  Rows_examined: &#39;, rows_examined, &#39;\n&#39;, sql_text, &#39;;&#39; ) FROM mysql.slow_log where start_time between current_timestamp and date_add(CURRENT_TIMESTAMP,INTERVAL -5 MINUTE);</code></pre></div></figure>

<h3 id="慢查询SQL"><a href="#慢查询SQL" class="headerlink" title="慢查询SQL"></a>慢查询SQL</h3><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| 2020-10-02 19:17:23 | w_mini_user[w_mini_user] @  [10.200.20.11] | 00:00:02   | 00:00:00  |         9 |        443117 | mini_user |              0 |         0 | 168387936 | select id,club_id,reason,status,type,created_time,invite_id,falg_admin,file_id from t_user_msg where 1 and (team_id in (3212) and app_id is not null) or (invite_id&#x3D;12395 or applicant_id&#x3D;12395) order by created_time desc limit 0,10; | 1219921665 |</code></pre></div></figure>

<p>从慢查询slow_log可以看到，执行时间2s，扫描了443117行，只返回了9行，这是不合理的。</p>
<h3 id="SQL分析"><a href="#SQL分析" class="headerlink" title="SQL分析"></a>SQL分析</h3><figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">#原始SQL，频繁访问的接口，目前执行时间2s。
select id,team_id,reason,status,type,created_time,invite_id,falg_admin,file_id from t_user_msg where 1 and (team_id in (3212) and app_id is not null) or (invite_id&#x3D;12395 or app_id&#x3D;12395) order by created_time desc limit 0,10;

#执行计划
+----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+
| id | select_type | table        | type  | possible_keys                   | key        | key_len | ref  | rows | Extra       |
+----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+
|  1 | SIMPLE      | t_user_msg | index | invite_id,app_id,team_id | created_time | 5       | NULL |   10 | Using where |
+----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre></div></figure>

<p>从执行计划可以看到，表上有单列索引invite_id,app_id,team_id,created_time，走的是create_time的索引，而且type&#x3D;index索引全扫描，因为create_time没有出现在where条件后，只出现在order by后面，只能是type&#x3D;index，这也预示着表数据量越大该SQL越慢，我们期望是走三个单列索引invite_id，app_id，team_id，然后type&#x3D;index_merge操作。</p>
<p>按照常规思路，对于OR条件拆分两部分，分别进行分析。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id, ……. 
from t_user_msg 
where 1 and  **(team_id in (3212) and app_id is not null)** 
order by created_time desc limit 0,10;</code></pre></div></figure>

<p>从执行计划看走的是team_id的索引，没有问题。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| id | select_type | table        | type | possible_keys        | key     | key_len | ref   | rows | Extra                       |
+----+-------------+--------------+------+----------------------+---------+---------+-------+------+-----------------------------+
|  1 | SIMPLE      | t_user_msg | ref  | app_id,team_id | team_id | 8       | const |   30 | Using where; Using filesort |</code></pre></div></figure>

<p>再看另外一个sql语句：</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id, ……. from t_user_msg where 1 and  **(invite_id&#x3D;12395 or app_id&#x3D;12395)** order by created_time desc limit 0,10;</code></pre></div></figure>

<p>从执行计划上看，分别走的是invite_id,app_id的单列索引，同时做了index_merge合并操作，也没有问题。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| id | select_type | table        | type        | possible_keys           | key                     | key_len | ref  | rows | Extra                                                             |
+----+-------------+--------------+-------------+-------------------------+-------------------------+---------+------+------+-------------------------------------------------------------------+
|  1 | SIMPLE      | t_user_msg | index_merge | invite_id,app_id | invite_id,app_id | 9,9     | NULL |    2 | Using union(invite_id,app_id); Using where; Using filesort |</code></pre></div></figure>

<p><strong>通过上面的分析，第一部分SQL走的执行计划走team_id索引没问题，第二部分SQL分别走invite_id,app_id索引并且index_merge也没问题，为什么两部分SQL进行OR关联之后走create_time的单列索引呢，不应该是三个单列索引的index_merge吗？</strong></p>
<p><strong>index_merge默认是在优化器选项是开启的，主要是将多个范围扫描的结果集合并成一个，可以通过变量查看。</strong></p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">mysql &gt;select @@optimizer_switch;
| index_merge&#x3D;on,index_merge_union&#x3D;on,index_merge_sort_union&#x3D;on,index_merge_intersection&#x3D;on,</code></pre></div></figure>

<p>其他三个字段都传入的是具体的值，而且都走了相应的索引，只能怀疑app_id is not null这个条件影响了CBO对最终执行计划的选择，去掉这个条件来看执行计划，竟然走了三个单列索引且type&#x3D;index_merge，那下面只要搞定<strong>app_id is not null</strong>这个条件就OK了吧。</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">| id | select_type | table        | type        | possible_keys                   | key                             | key_len | ref  | rows | Extra                                                                     |
+----+-------------+--------------+-------------+---------------------------------+---------------------------------+---------+------+------+---------------------------------------------------------------------------+
|  1 | SIMPLE      | t_user_msg | index_merge | invite_id,app_id,teadm_id | team_id,invite_id,app_id | 8,9,9   | NULL |   32 | Using union(team_id,invite_id,app_id); Using where; Using filesort |</code></pre></div></figure>

<h3 id="SQL改写"><a href="#SQL改写" class="headerlink" title="SQL改写"></a>SQL改写</h3><p>通过上面分析得知，条件app_id is not null影响了CBO的选择，下面进行改造。</p>
<p><strong>改写优化1</strong></p>
<p>根据SQL开发规范改写，将OR改写成Union All方式即可，最终的SQL如下：</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id, ……. from (
select id, ……. from t_user_msg where **1 and (club_id in (5821) and applicant_id is not null)**
        **union all** select id, ……. from t_user_msg where **1 and invitee_id&#x3D;&#39;146737&#39;**
        **union all** select id, ……. from  t_user_msg where **1 and app_id&#x3D;&#39;146737&#39;**
       ) as a order by created_time desc limit 0,10;</code></pre></div></figure>

<p>一般情况下，Java代码和SQL是分开的，SQL是配置在xml文件中，根据业务需求，除了team_id是必填，其他两个都是可选的，所以这种改写虽然能提高SQL执行效率，但不适合这种业务场景。</p>
<p><strong>改写优化2</strong></p>
<p>app_id is not null 改写为**IFNULL(app_id, 0) &gt;0)**，最终的SQL为：</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id,team_id,reason,status,type,created_time,invite_id,falg_admin,file_id from t_user_msg where 1 and (team_id in (3212) and **IFNULL(app_id, 0) &gt;0)**) or (invite_id&#x3D;12395 or app_id&#x3D;12395) order by created_time desc limit 0,10;</code></pre></div></figure>

<p><strong>改写优化3</strong></p>
<p>将字段app_id bigint(20) DEFAULT NULL，变更为app_id bigint(20) <strong>NOT NULL DEFAULT 0</strong>，同时更新将app_id is null的时候全部更新成0，就可以将条件app_id is not null 转换为app_id &gt; 0，最终的SQL为：</p>
<figure><div class="code-wrapper"><pre class="language-SQL" data-language="SQL"><code class="language-SQL">select id,team_id,reason,status,type,created_at,invite_id,falg_admin,file_id 
from t_user_msg 
where 1 and (team_id in (3212) and **app_id &gt; 0)**) or (invite_id&#x3D;12395 or app_id&#x3D;12395) 
order by created_time desc limit 0,10;</code></pre></div></figure>

<p>从执行计划看，两种改写优化方式都走三个单列索引，执行时间从2s降低至10ms，线上采用的是<strong>优化1</strong>的方式，如果一开始能遵循MySQL开发规范就就会避免问题的发生。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面介绍了SQL规范性检查，表结构检查，索引检查以及通过SQL改写来优化查询，在编写代码的过程，如果能提前做这些规范性检查，评估出自己认为理想的执行计划，然后通过explain解析出MySQL CBO的执行计划，两者做对比分析差异，弄清楚自己的选择和CBO的不同，不但能够编写高质量的SQL，同时也能清楚CBO的工作原理。</p>
<blockquote>
<p>文章持续更新，可以微信搜一搜「 <strong>三太子敖丙</strong> 」第一时间阅读，回复【<strong>资料</strong>】有我准备的一线大厂面试资料和简历模板，本文 <strong>GitHub</strong> <a href="https://link.juejin.cn/?target=https://github.com/AobingJava/JavaFamily" title="https://github.com/AobingJava/JavaFamily">github.com&#x2F;JavaFamily</a> 已经收录，有大厂面试完整考点，欢迎Star。</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="../../../../categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" class="category-chain-item">数据分析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="../../../../tags/%E8%BD%AC%E8%BD%BD/">#转载</a>
      
        <a href="../../../../tags/SQL/">#SQL</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MySQL优化</div>
      <div>http://example.com/2022/11/15/MySQL优化/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Marsh</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年11月15日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2022年11月15日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="../../16/%E6%8A%80%E6%9C%AF%E5%AF%BC%E8%88%AA/" title="技术导航">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">技术导航</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="../Python%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86/" title="Python高级内容">
                        <span class="hidden-mobile">Python高级内容</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"JThobepyUWZ8wrCKpWzo5Vju-gzGzoHsz","appKey":"5l7p5rk6oXtEIST5bExEAMrT","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  




  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      京ICP证123456号
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=123456789"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="../../../../img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>京公网安备12345678号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="../../../../js/events.js" ></script>
<script  src="../../../../js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="../../../../js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="../../../../js/local-search.js" ></script>

  <script defer src="../../../../js/leancloud.js" ></script>




  
<script src="../js/custom.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="../../../../js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
